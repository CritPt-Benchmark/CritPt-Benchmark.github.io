<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Checkpoint-3</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.codehilite .hll { background-color: #ffffcc }
.codehilite { background: #f8f8f8; }
.codehilite .c { color: #3D7B7B; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #F00 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666 } /* Operator */
.codehilite .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #9C6500 } /* Comment.Preproc */
.codehilite .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.codehilite .gr { color: #E40000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #008400 } /* Generic.Inserted */
.codehilite .go { color: #717171 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #04D } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #687822 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #00F; font-weight: bold } /* Name.Class */
.codehilite .no { color: #800 } /* Name.Constant */
.codehilite .nd { color: #A2F } /* Name.Decorator */
.codehilite .ni { color: #717171; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #00F } /* Name.Function */
.codehilite .nl { color: #767600 } /* Name.Label */
.codehilite .nn { color: #00F; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #A2F; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #BBB } /* Text.Whitespace */
.codehilite .mb { color: #666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666 } /* Literal.Number.Float */
.codehilite .mh { color: #666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666 } /* Literal.Number.Oct */
.codehilite .sa { color: #BA2121 } /* Literal.String.Affix */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .dl { color: #BA2121 } /* Literal.String.Delimiter */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #A45A77 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #00F } /* Name.Function.Magic */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .vm { color: #19177C } /* Name.Variable.Magic */
.codehilite .il { color: #666 } /* Literal.Number.Integer.Long */

</style>
<style>
    :root {
  --bg: #ffffff;
  --fg: #222222;
  --muted: #555555;
  --border: #e0e0e0;
  --accent: #005fcc;
  --code-bg: #f6f8fa;
  --role-user: #0ea5e9;
  --role-assistant: #22c55e;
  --role-system: #9ca3af;
  --return-code: #a35291;
}
html.dark {
  --bg: #0b0b0b;
  --fg: #e8e8e8;
  --muted: #a0a0a0;
  --border: #333333;
  --accent: #3b82f6;
  --code-bg: #111827;
  --role-user: #0ea5e9;
  --role-assistant: #22c55e;
  --role-system: #9ca3af;
  --return-code: #a35291;
}
* {
  box-sizing: border-box;
}
body {
  margin: 0;
  padding: 0;
  background: var(--bg);
  color: var(--fg);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", sans-serif;
  line-height: 1.6;
}
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 1.25rem;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  background: var(--bg);
  z-index: 10;
}
h1 {
  margin: 0;
  font-size: 1.1rem;
}
.tabs {
  display: flex;
  gap: 0.5rem;
}
.tab {
  padding: 0.4rem 0.8rem;
  border: 1px solid var(--border);
  border-bottom: none;
  background: transparent;
  cursor: pointer;
  border-radius: 6px 6px 0 0;
  color: var(--fg);
}
.tab.active {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}
.tab-content {
  display: none;
  padding: 1rem 1.25rem;
  border-top: 1px solid var(--border);
}
.tab-content.active {
  display: block;
}
#theme-toggle {
  border: 1px solid var(--border);
  padding: 0.2rem 0.6rem;
  font-size: 0.9rem;
  border-radius: 4px;
  cursor: pointer;
  background: transparent;
  color: var(--fg);
}
.main {
  max-width: 1200px;
  margin: 0 auto;
}
.message {
  border: 1px solid var(--border);
  border-left-width: 6px;
  border-radius: 6px;
  padding: 0.8rem 1rem;
  margin-bottom: 1rem;
  background: rgba(0,0,0,0.02);
}
.message .meta {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  margin-bottom: 0.6rem;
  color: var(--muted);
  font-size: 0.85rem;
}
.message .badge {
  font-weight: 600;
}
.role-user {
  border-left-color: var(--role-user);
}
.role-assistant {
  border-left-color: var(--role-assistant);
}
.role-system {
  border-left-color: var(--role-system);
}
.role-unknown {
  border-left-color: var(--accent);
}

.output-code-container {
  display: flex;
  gap: 1rem;               /* space between children */
  align-items: center;     /* vertical alignment */
  justify-content: start;  /* horizontal alignment */
}

.output-code-container .codeblock {
  flex: 0 1 auto;
}

.codeblock {
  border: 1px solid var(--border);
  border-left-width: 6px;
  border-radius: 6px;
  padding: 0.8rem 1rem;
  margin-bottom: 1rem;
  background: rgba(0,0,0,0.02);
}
.codeblock-content {
  margin-bottom: 0.6rem;
  border: 1px dashed var(--border);
  border-radius: 4px;
  padding: 0.4rem 0.6rem;
  background: rgba(0,0,0,0.02);
}

.codeblock.eval_code {
  border-left-color: var(--role-user);
}
.codeblock.target_code {
  border-left-color: var(--role-assistant);
}
.codeblock.output_code {
  border-left-color: var(--role-system);
}

html.dark .codeblock-content {
  background: rgba(255,255,255,0.03);
}
.codeblock > summary {
  cursor: pointer;
  font-weight: 600;
  list-style: none; /* remove default triangle in some browsers */
}
.codeblock > summary::-webkit-details-marker {
  display: none; /* Safari/Chrome marker */
}
.codeblock > summary::before {
  content: "▶ ";
  display: inline-block;
  transform: rotate(0deg);
  transition: transform 0.12s ease-out;
}
.codeblock[open] > summary::before {
  transform: rotate(90deg);
}
.codeblock .tag {
  color: var(--muted);
  font-weight: 400;
  font-size: 0.85em;
  margin-left: 0.25rem;
}

.markdown-body pre code {
  background: var(--code-bg);
  display: block;
  padding: 0.75rem;
  overflow-x: auto;
  border-radius: 4px;
  border: 1px solid var(--border);
}
.markdown-body code {
  background: var(--code-bg);
  padding: 0.15rem 0.3rem;
  border-radius: 4px;
}
/* Extra info tree */
details > summary {
  cursor: pointer;
  font-weight: 600;
}
details .block {
  padding-left: 1rem;
  margin: 0.25rem 0 0.5rem 0;
  border-left: 2px solid var(--border);
}
.kv .key {
  font-weight: 600;
}
.kv .type {
  color: var(--muted);
  margin-left: 0.5rem;
  font-size: 0.85rem;
}
footer {
  margin: 2rem 0;
  text-align: center;
  color: var(--muted);
  font-size: 0.85rem;
}
/* CodeHilite (pygments) overrides to respect theme vars */
.codehilite {
  background: var(--code-bg) !important;
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 0.75rem !important;
}
.reasoning {
  margin-bottom: 0.6rem;
  border: 1px dashed var(--border);
  border-radius: 4px;
  padding: 0.4rem 0.6rem;
  background: rgba(0,0,0,0.02);
}
html.dark .reasoning {
  background: rgba(255,255,255,0.03);
}
.reasoning > summary {
  cursor: pointer;
  font-weight: 600;
  list-style: none; /* remove default triangle in some browsers */
}
.reasoning > summary::-webkit-details-marker {
  display: none; /* Safari/Chrome marker */
}
.reasoning > summary::before {
  content: "▶ ";
  display: inline-block;
  transform: rotate(0deg);
  transition: transform 0.12s ease-out;
}
.reasoning[open] > summary::before {
  transform: rotate(90deg);
}
.reasoning .tag {
  color: var(--muted);
  font-weight: 400;
  font-size: 0.85em;
  margin-left: 0.25rem;
}
.reasoning-body {
  margin-top: 0.5rem;
}
</style>

<!-- ===== MATHJAX CONFIG ===== -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [ ["\\(","\\)"] ],
    displayMath: [ ["\\[","\\]"] ],
    processEscapes: true,
    processEnvironments: true
  },
  options: {
    ignoreHtmlClass: ".*",
    processHtmlClass: "arithmatex"

    // skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
    // if you dynamically add content later, you can call MathJax.typesetPromise()
  }
};
</script>
<script id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<!-- ========================== -->
</head>
<body>
<header>
  <h1>Checkpoint-3</h1>
  <div>
    <button id="theme-toggle" aria-label="toggle dark mode">🌓</button>
  </div>
</header>

<div class="main">
  
<article class="message role-system">
    <div class="meta">
        <span class="badge">System</span>
        <span class="idx">#0</span>
    </div>
    <div class="content markdown-body"><p>You are a physics research assistant specializing in solving complex, research-level problems using precise, step-by-step reasoning.</p>
<p><strong>Input</strong>
Problems will be provided in Markdown format.</p>
<p><strong>Output (Markdown format)</strong></p>
<ol>
<li><strong>Step-by-Step Derivation</strong> - Show every non-trivial step in the solution.  Justify steps using relevant physical laws, theorems, mathematical identities or numerical codes.</li>
<li><strong>Mathematical Typesetting</strong> - Use LaTeX for all mathematics:  <code>$...$</code> for inline expressions, <code>$$...$$</code> for display equations.</li>
<li><strong>Conventions and Units</strong> - Follow the unit system and conventions specified in the problem.</li>
<li>
<p><strong>Final Answer</strong> - At the end of the solution,  start a new line with <strong>&ldquo;Final Answer:&rdquo;</strong>, and present the final result.</p>
<p>For final answers involving values, follow the precision requirements specified in the problem.
If no precision is specified:
- If an exact value is possible, provide it (e.g., \$\sqrt(2)\$, \$\pi/4\$).
- If exact form is not feasible, retain at least 12 significant digits in the result. </p>
</li>
<li>
<p><strong>Formatting Compliance</strong> - If the user requests a specific output format (e.g., code, table),  provide the final answer accordingly.</p>
</li>
</ol></div>
</article>


<article class="message role-user">
    <div class="meta">
        <span class="badge">User</span>
        <span class="idx">#1</span>
    </div>
    <div class="content markdown-body"><h1 id="problem-setup">Problem setup:</h1>
<p>In quantum error correction, you encode quantum states into logical states made of many qubits in order to improve their resilience to errors. In quantum error detection, you do the same but can only detect the presence of errors and not correct them. In this problem, we will consider a single [[4,2,2]] quantum error detection code, which encodes two logical qubits into four physical qubits, and investigate how robust logical quantum operations in this code are to quantum errors.</p>
<p>Our convention is that the four physical qubits in the [[4,2,2]] code are labelled 0,1,2,3. The two logical qubits are labelled A and B. The stabilizers are <span class="arithmatex">\(XXXX\)</span> and <span class="arithmatex">\(ZZZZ\)</span>, where <span class="arithmatex">\(X\)</span> and <span class="arithmatex">\(Z\)</span> are Pauli matrices. The logical <span class="arithmatex">\(X\)</span> and <span class="arithmatex">\(Z\)</span> operators on the two qubits are <span class="arithmatex">\(X_A = XIXI\)</span>, <span class="arithmatex">\(X_B=XXII\)</span>, <span class="arithmatex">\(Z_A = ZZII\)</span>, <span class="arithmatex">\(Z_B = ZIZI\)</span>, up to multiplication by stabilizers.</p>
<p>We will consider different state preparation circuits consisting of controlled not <span class="arithmatex">\(CNOT_{ij}\)</span> gates, where <span class="arithmatex">\(CNOT_{ij}\)</span> has control qubit <span class="arithmatex">\(i\)</span> and target qubit <span class="arithmatex">\(j\)</span>. As a simple model of quantum errors in hardware, we will suppose that each <span class="arithmatex">\(CNOT_{ij}\)</span> gate in the circuit has a two qubit depolarizing error channel following it that produces one of the 15 non-identity two-qubit Paulis with equal probability <span class="arithmatex">\(p/15\)</span>. The probability <span class="arithmatex">\(p\)</span> indicates the probability of an error in a single two-qubit gate. We will assess the logical infidelity of certain state preparation protocols as a function of the physical infidelity <span class="arithmatex">\(p\)</span>.</p>
<h1 id="subproblems">Checkpoints</h1>
<h2 id="subproblem-1">Checkpoint 1</h2>
<p>Suppose that we wish to prepare a logical two-qubit GHZ state  <span class="arithmatex">\((|00\rangle_{AB}+|11\rangle_{AB})/\sqrt{2}\)</span> in the [[4,2,2]] code. To do so, we use the following state preparation circuit:</p>
<div class="arithmatex">\[
(CNOT_{03}) (H_0) (CNOT_{21}) (H_2).
\]</div>
<p>Note that this equation is written in matrix multiplication order, while the quantum operations in the circuit occur in the reverse order (from right-to-left in the above equation). <span class="arithmatex">\(H\)</span> is a single-qubit Hadamard gate.</p>
<p>What is the physical state fidelity of the final physical 4-qubit state at the end of the circuit as a function of the two-qubit gate error rate <span class="arithmatex">\(p\)</span>?</p></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#2</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Pauli matrices</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="c1"># Tensor product utility</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">reduce</span>

<span class="k">def</span><span class="w"> </span><span class="nf">kron</span><span class="p">(</span><span class="o">*</span><span class="n">ops</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">,</span> <span class="n">ops</span><span class="p">)</span>

<span class="c1"># 4-qubit basis: qubits ordered (0,1,2,3)</span>

<span class="c1"># Build CNOT_ij unitary on 4 qubits</span>

<span class="k">def</span><span class="w"> </span><span class="nf">CNOT_ij</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">):</span>
    <span class="c1"># Build projector form: |0&gt;&lt;0|_i ⊗ I + |1&gt;&lt;1|_i ⊗ X_j</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">ops0</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">]</span>
    <span class="n">ops1</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">]</span>
    <span class="n">ops0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">P0</span>
    <span class="n">ops1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">P1</span>
    <span class="c1"># X on j for second term</span>
    <span class="n">ops1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span>
    <span class="k">return</span> <span class="n">kron</span><span class="p">(</span><span class="o">*</span><span class="n">ops0</span><span class="p">)</span> <span class="o">+</span> <span class="n">kron</span><span class="p">(</span><span class="o">*</span><span class="n">ops1</span><span class="p">)</span>

<span class="c1"># Hadamard on qubit q (others identity)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">H_q</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">]</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">H</span>
    <span class="k">return</span> <span class="n">kron</span><span class="p">(</span><span class="o">*</span><span class="n">ops</span><span class="p">)</span>

<span class="c1"># Two-qubit Pauli labels and matrices</span>
<span class="n">Psingle</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">]</span>
<span class="n">Pnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>

<span class="c1"># Build two-qubit Pauli on a specified pair (a,b) with order qubit index 0..3</span>

<span class="k">def</span><span class="w"> </span><span class="nf">two_qubit_pauli_on_pair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">pb</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">]</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">Psingle</span><span class="p">[</span><span class="n">pa</span><span class="p">]</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">Psingle</span><span class="p">[</span><span class="n">pb</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">kron</span><span class="p">(</span><span class="o">*</span><span class="n">ops</span><span class="p">)</span>

<span class="c1"># Circuit unitaries (ideal): U = CNOT_03 * H0 * CNOT_21 * H2</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">@</span> <span class="n">H_q</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">@</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">@</span> <span class="n">H_q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Initial |0000&gt;</span>
<span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">psi0</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
<span class="n">psi_ideal</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">psi0</span>
<span class="n">rho_ideal</span> <span class="o">=</span> <span class="n">psi_ideal</span> <span class="o">@</span> <span class="n">psi_ideal</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>

<span class="c1"># Build the noisy rho(p) symbolically as sum over errors with weights</span>
<span class="c1"># But we&#39;ll just compute the coefficient of fidelity as a function of p by summing contributions</span>

<span class="c1"># Enumerate two-qubit paulis on pair (2,1) and (0,3)</span>
<span class="n">non_id_pairs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">Pnames</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">+</span><span class="n">Pnames</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
        <span class="n">non_id_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">name</span><span class="p">))</span>

<span class="c1"># Build the list of 16 two-qubit paulies and classify which are identity</span>
<span class="n">pairs</span> <span class="o">=</span> <span class="n">non_id_pairs</span>

<span class="c1"># Let&#39;s compute the probability weight that maps to fidelity 1: we check for each pair of errors whether</span>
<span class="c1"># E03 * U * E21 * ... acting on |0000&gt; equals psi_ideal up to global phase. We can test overlap squared ~1.</span>

<span class="c1"># Build E for pair (2,1) and (0,3)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fidelity_weight</span><span class="p">():</span>
    <span class="c1"># We&#39;ll compute count of (pauli on 03, on 21) that leave the state invariant up to phase.</span>
    <span class="n">survivors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a03</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">b03</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">E03</span> <span class="o">=</span> <span class="n">two_qubit_pauli_on_pair</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">a03</span><span class="p">,</span> <span class="n">b03</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">a21</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">b21</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                    <span class="n">E21</span> <span class="o">=</span> <span class="n">two_qubit_pauli_on_pair</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">a21</span><span class="p">,</span> <span class="n">b21</span><span class="p">)</span>
                    <span class="c1"># Build final state with this error model: errors applied after CNOTs</span>
                    <span class="c1"># That is: first H2, then CNOT21, then error E21, then H0, then CNOT03, then error E03</span>
                    <span class="n">psi</span> <span class="o">=</span> <span class="n">E03</span> <span class="o">@</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">@</span> <span class="n">H_q</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">@</span> <span class="n">E21</span> <span class="o">@</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">@</span> <span class="n">H_q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi0</span>
                    <span class="c1"># Overlap magnitude</span>
                    <span class="n">overlap</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi_ideal</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">psi</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">overlap</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">):</span>
                        <span class="n">survivors</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="n">a03</span><span class="p">,</span><span class="n">b03</span><span class="p">),(</span><span class="n">a21</span><span class="p">,</span><span class="n">b21</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">survivors</span>

<span class="n">survivors</span> <span class="o">=</span> <span class="n">fidelity_weight</span><span class="p">()</span>
<span class="n">len_survivors</span><span class="p">,</span> <span class="n">survivors</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#3</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 99, in &lt;module&gt;
NameError: name &#39;len_survivors&#39; is not defined. Did you mean: &#39;survivors&#39;?
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#4</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="nb">len</span><span class="p">(</span><span class="n">survivors</span><span class="p">),</span> <span class="n">survivors</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span>
</code></pre></div></div>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#5</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
NameError: name &#39;survivors&#39; is not defined
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#6</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="c1"># Re-run the computation quickly</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">reduce</span>

<span class="k">def</span><span class="w"> </span><span class="nf">kron</span><span class="p">(</span><span class="o">*</span><span class="n">ops</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">,</span> <span class="n">ops</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">CNOT_ij</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">)</span>
    <span class="n">ops0</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">]</span>
    <span class="n">ops1</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">]</span>
    <span class="n">ops0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">P0</span>
    <span class="n">ops1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">P1</span>
    <span class="n">ops1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span>
    <span class="k">return</span> <span class="n">kron</span><span class="p">(</span><span class="o">*</span><span class="n">ops0</span><span class="p">)</span> <span class="o">+</span> <span class="n">kron</span><span class="p">(</span><span class="o">*</span><span class="n">ops1</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">H_q</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">]</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">H</span>
    <span class="k">return</span> <span class="n">kron</span><span class="p">(</span><span class="o">*</span><span class="n">ops</span><span class="p">)</span>

<span class="n">Psingle</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">]</span>

<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">@</span> <span class="n">H_q</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">@</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">@</span> <span class="n">H_q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">)</span>
<span class="n">psi0</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">)</span>
<span class="n">psi_ideal</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">psi0</span>

<span class="n">survivors</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">a03</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">b03</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">E03</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">Psingle</span><span class="p">[</span><span class="n">a03</span><span class="p">],</span> <span class="n">I</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">Psingle</span><span class="p">[</span><span class="n">b03</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">a21</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">b21</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="n">E21</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">Psingle</span><span class="p">[</span><span class="n">b21</span><span class="p">],</span> <span class="n">Psingle</span><span class="p">[</span><span class="n">a21</span><span class="p">],</span> <span class="n">I</span><span class="p">)</span>  <span class="c1"># careful: pair (2,1)</span>
                <span class="n">psi</span> <span class="o">=</span> <span class="n">E03</span> <span class="o">@</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">@</span> <span class="n">H_q</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">@</span> <span class="n">E21</span> <span class="o">@</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">@</span> <span class="n">H_q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi0</span>
                <span class="n">overlap</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi_ideal</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">psi</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">overlap</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
                    <span class="n">survivors</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="n">a03</span><span class="p">,</span><span class="n">b03</span><span class="p">),(</span><span class="n">a21</span><span class="p">,</span><span class="n">b21</span><span class="p">)))</span>

<span class="nb">len</span><span class="p">(</span><span class="n">survivors</span><span class="p">),</span> <span class="n">survivors</span><span class="p">[:</span><span class="mi">12</span><span class="p">]</span>
</code></pre></div></div>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#7</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>&#39;&#39;
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#8</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">survivors</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">survivors</span><span class="p">[:</span><span class="mi">16</span><span class="p">])</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#9</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
NameError: name &#39;survivors&#39; is not defined
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#10</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="c1"># Recompute succinctly and print</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">);</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">);</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">reduce</span>

<span class="k">def</span><span class="w"> </span><span class="nf">kron</span><span class="p">(</span><span class="o">*</span><span class="n">ops</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">,</span> <span class="n">ops</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">CNOT_ij</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">)</span>
    <span class="n">ops0</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">]</span>
    <span class="n">ops1</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">]</span>
    <span class="n">ops0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">P0</span>
    <span class="n">ops1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">P1</span>
    <span class="n">ops1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span>
    <span class="k">return</span> <span class="n">kron</span><span class="p">(</span><span class="o">*</span><span class="n">ops0</span><span class="p">)</span> <span class="o">+</span> <span class="n">kron</span><span class="p">(</span><span class="o">*</span><span class="n">ops1</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">H_q</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">]</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">H</span>
    <span class="k">return</span> <span class="n">kron</span><span class="p">(</span><span class="o">*</span><span class="n">ops</span><span class="p">)</span>

<span class="n">Psingle</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">]</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">@</span> <span class="n">H_q</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">@</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">@</span> <span class="n">H_q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">)</span>
<span class="n">psi0</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">)</span>
<span class="n">psi_ideal</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">psi0</span>

<span class="n">survivors</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">a03</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">b03</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">E03</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">Psingle</span><span class="p">[</span><span class="n">a03</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">Psingle</span><span class="p">[</span><span class="n">b03</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">a21</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">b21</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="n">E21</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">Psingle</span><span class="p">[</span><span class="n">b21</span><span class="p">],</span> <span class="n">Psingle</span><span class="p">[</span><span class="n">a21</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">psi</span> <span class="o">=</span> <span class="n">E03</span> <span class="o">@</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">@</span> <span class="n">H_q</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">@</span> <span class="n">E21</span> <span class="o">@</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">@</span> <span class="n">H_q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi0</span>
                <span class="n">ov</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi_ideal</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">psi</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ov</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
                    <span class="n">survivors</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="n">a03</span><span class="p">,</span><span class="n">b03</span><span class="p">),(</span><span class="n">a21</span><span class="p">,</span><span class="n">b21</span><span class="p">)))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number survivors =&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">survivors</span><span class="p">))</span>
<span class="c1"># Show which two-qubit paulis on each pair survive (indexes 0:I,1:X,2:Y,3:Z)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">survivors</span><span class="p">[:</span><span class="mi">20</span><span class="p">])</span>
</code></pre></div></div>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#11</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>number survivors = 16
[((0, 0), (0, 0)), ((0, 0), (1, 1)), ((0, 0), (2, 2)), ((0, 0), (3, 3)), ((1, 1), (0, 0)), ((1, 1), (1, 1)), ((1, 1), (2, 2)), ((1, 1), (3, 3)), ((2, 2), (0, 0)), ((2, 2), (1, 1)), ((2, 2), (2, 2)), ((2, 2), (3, 3)), ((3, 3), (0, 0)), ((3, 3), (1, 1)), ((3, 3), (2, 2)), ((3, 3), (3, 3))]
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#12</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">);</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">);</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">reduce</span>

<span class="k">def</span><span class="w"> </span><span class="nf">kron</span><span class="p">(</span><span class="o">*</span><span class="n">ops</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">,</span> <span class="n">ops</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">CNOT_ij</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">)</span>
    <span class="n">ops0</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">]</span>
    <span class="n">ops1</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">]</span>
    <span class="n">ops0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">P0</span>
    <span class="n">ops1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">P1</span>
    <span class="n">ops1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span>
    <span class="k">return</span> <span class="n">kron</span><span class="p">(</span><span class="o">*</span><span class="n">ops0</span><span class="p">)</span> <span class="o">+</span> <span class="n">kron</span><span class="p">(</span><span class="o">*</span><span class="n">ops1</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">H_q</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">]</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">H</span>
    <span class="k">return</span> <span class="n">kron</span><span class="p">(</span><span class="o">*</span><span class="n">ops</span><span class="p">)</span>

<span class="n">Psingle</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">]</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">@</span> <span class="n">H_q</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">@</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">@</span> <span class="n">H_q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">)</span>
<span class="n">psi0</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">)</span>
<span class="n">psi_ideal</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">psi0</span>
<span class="n">rho_ideal</span> <span class="o">=</span> <span class="n">psi_ideal</span> <span class="o">@</span> <span class="n">psi_ideal</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>

<span class="c1"># Build final density matrix under the channel parameter p</span>

<span class="k">def</span><span class="w"> </span><span class="nf">rho_of_p</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">16</span><span class="p">,</span><span class="mi">16</span><span class="p">),</span> <span class="nb">complex</span><span class="p">)</span>
    <span class="c1"># enumerate E21 and E03 errors and accumulate weights</span>
    <span class="k">for</span> <span class="n">a03</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">b03</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">weight03</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">a03</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">b03</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="mi">15</span><span class="p">)</span>
            <span class="n">E03</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">Psingle</span><span class="p">[</span><span class="n">a03</span><span class="p">],</span> <span class="n">I</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">Psingle</span><span class="p">[</span><span class="n">b03</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">a21</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">b21</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                    <span class="n">weight21</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">a21</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">b21</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="mi">15</span><span class="p">)</span>
                    <span class="n">E21</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">Psingle</span><span class="p">[</span><span class="n">b21</span><span class="p">],</span> <span class="n">Psingle</span><span class="p">[</span><span class="n">a21</span><span class="p">],</span> <span class="n">I</span><span class="p">)</span>
                    <span class="n">psi</span> <span class="o">=</span> <span class="n">E03</span> <span class="o">@</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">@</span> <span class="n">H_q</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">@</span> <span class="n">E21</span> <span class="o">@</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">@</span> <span class="n">H_q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi0</span>
                    <span class="n">rho</span> <span class="o">+=</span> <span class="n">weight03</span> <span class="o">*</span> <span class="n">weight21</span> <span class="o">*</span> <span class="p">(</span><span class="n">psi</span> <span class="o">@</span> <span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rho</span>

<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]:</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">rho_of_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi_ideal</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">rho</span> <span class="o">@</span> <span class="n">psi_ideal</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">real</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="s1">&#39;vs formula&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">p</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#13</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.9999999999999992</span><span class="w"> </span><span class="n">vs</span><span class="w"> </span><span class="kr">for</span><span class="n">mula</span><span class="w"> </span><span class="mf">1.0</span>
<span class="mf">0.01</span><span class="w"> </span><span class="mf">0.9840639999999993</span><span class="w"> </span><span class="n">vs</span><span class="w"> </span><span class="kr">for</span><span class="n">mula</span><span class="w"> </span><span class="mf">0.9840639999999999</span>
<span class="mf">0.1</span><span class="w"> </span><span class="mf">0.8463999999999989</span><span class="w"> </span><span class="n">vs</span><span class="w"> </span><span class="kr">for</span><span class="n">mula</span><span class="w"> </span><span class="mf">0.8464</span>
<span class="mf">0.2</span><span class="w"> </span><span class="mf">0.7056000000000002</span><span class="w"> </span><span class="n">vs</span><span class="w"> </span><span class="kr">for</span><span class="n">mula</span><span class="w"> </span><span class="mf">0.7055999999999999</span>
<span class="mf">0.5</span><span class="w"> </span><span class="mf">0.3599999999999996</span><span class="w"> </span><span class="n">vs</span><span class="w"> </span><span class="kr">for</span><span class="n">mula</span><span class="w"> </span><span class="mf">0.36</span>

<span class="mf">1.0</span><span class="w"> </span><span class="mf">0.039999999999999994</span><span class="w"> </span><span class="n">vs</span><span class="w"> </span><span class="kr">for</span><span class="n">mula</span><span class="w"> </span><span class="mf">0.03999999999999998</span>
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#14</span>
    </div>
    <div class="content markdown-body"><ol>
<li>Step-by-Step Derivation</li>
</ol>
<ul>
<li>Ideal state prepared by the circuit</li>
<li>Start from |0000⟩.</li>
<li>Apply H2: puts qubit 2 in (|0⟩ + |1⟩)/√2.</li>
<li>Apply CNOT21 (control 2 → target 1): prepares a Bell pair on qubits (2,1), |Φ+⟩21 = (|00⟩ + |11⟩)/√2.</li>
<li>Apply H0 and then CNOT03 (control 0 → target 3): prepares a Bell pair on qubits (0,3), |Φ+⟩03 = (|00⟩ + |11⟩)/√2.</li>
<li>Hence the ideal final state is the product of two Bell pairs</li>
</ul>
<div class="arithmatex">\[
|\psi_{\text{ideal}}\rangle = |\Phi^+\rangle_{03}\otimes|\Phi^+\rangle_{21}.
\]</div>
<div class="codehilite"><pre><span></span><code>In the computational basis (qubits ordered 0,1,2,3):
</code></pre></div>

<div class="arithmatex">\[
|\psi_{\text{ideal}}\rangle = \tfrac{1}{2}\big(|0000\rangle + |0110\rangle + |1001\rangle + |1111\rangle\big).
\]</div>
<ul>
<li>
<p>This state is a code state stabilized by the given code stabilizers <span class="arithmatex">\(XXXX\)</span>, <span class="arithmatex">\(ZZZZ\)</span> and by the logical Bell stabilizers <span class="arithmatex">\(Z_AZ_B=IZZI\)</span> and <span class="arithmatex">\(X_AX_B=IXXI\)</span>.</p>
</li>
<li>
<p>Noise model and where it acts</p>
</li>
<li>A two-qubit depolarizing channel acts after each CNOT:<ul>
<li>After CNOT21, a channel on qubits (2,1).</li>
<li>After CNOT03, a channel on qubits (0,3).</li>
</ul>
</li>
<li>Each channel applies <span class="arithmatex">\(II\)</span> with probability <span class="arithmatex">\(1-p\)</span>, and one of the 15 non-identity two-qubit Paulis with probability <span class="arithmatex">\(p/15\)</span> each.</li>
<li>
<p>The two channels are independent and act on disjoint pairs, so the total error is <span class="arithmatex">\(E_{03}\otimes E_{21}\)</span>.</p>
</li>
<li>
<p>Fidelity for a Bell pair under two-qubit depolarizing noise</p>
</li>
<li>For a Bell state <span class="arithmatex">\(|\Phi^+\rangle\)</span>, the Pauli operators that leave the state invariant (up to an irrelevant global phase) are precisely</li>
</ul>
<div class="arithmatex">\[
\{II,\; XX,\; YY,\; ZZ\}.
\]</div>
<ul>
<li>Therefore, for a single two-qubit depolarizing channel with parameter <span class="arithmatex">\(p\)</span>,</li>
</ul>
<div class="arithmatex">\[
F_{\text{pair}}(p) = \Pr(II) + \Pr(XX) + \Pr(YY) + \Pr(ZZ) = (1-p) + 3\cdot \frac{p}{15} = 1 - \frac{4}{5}p.
\]</div>
<ul>
<li>Total four-qubit fidelity</li>
<li>Since the ideal state is a product <span class="arithmatex">\(|\Phi^+\rangle_{03}\otimes|\Phi^+\rangle_{21}\)</span> and the two channels are independent on the two disjoint pairs, the total fidelity factorizes:</li>
</ul>
<div class="arithmatex">\[
F_{\text{phys}}(p) = \big(F_{\text{pair}}(p)\big)^2 = \left(1 - \frac{4}{5}p\right)^2.
\]</div>
<ol start="2">
<li>Mathematical Typesetting</li>
</ol>
<ul>
<li>Final expression:</li>
</ul>
<div class="arithmatex">\[
F_{\text{phys}}(p) = \left(1 - \frac{4}{5}p\right)^2 = 1 - \frac{8}{5}p + \frac{16}{25}p^2.
\]</div>
<ol start="3">
<li>Conventions and Units</li>
</ol>
<ul>
<li>Probabilities are dimensionless. The parameter <span class="arithmatex">\(p\in[0,1]\)</span> is the error probability per two-qubit gate.</li>
</ul>
<ol start="4">
<li>Final Answer:
<span class="arithmatex">\(F_{\text{phys}}(p) = \left(1 - \dfrac{4}{5}p\right)^2 = 1 - \dfrac{8}{5}p + \dfrac{16}{25}p^2.\)</span></li>
</ol></div>
</article>


<article class="message role-user">
    <div class="meta">
        <span class="badge">User</span>
        <span class="idx">#15</span>
    </div>
    <div class="content markdown-body"><p>The correct answer is:
$
F_{\rm{physical}}=(1-\frac{12}{15}p)^2
$</p>
<p>Now let&rsquo;s solve the next Checkpoint.</p>
<h2 id="subproblem-2">Checkpoint 2</h2>
<p>Suppose that we wish to prepare a logical two-qubit GHZ state  <span class="arithmatex">\((|00\rangle_{AB}+|11\rangle_{AB})/\sqrt{2}\)</span> in the [[4,2,2]] code. To do so, we use the following state preparation circuit:</p>
<div class="arithmatex">\[
(CNOT_{03}) (H_0) (CNOT_{21}) (H_2).
\]</div>
<p>Note that this equation is written in matrix multiplication order, while the quantum operations in the circuit occur in the reverse order (from right-to-left in the above equation). <span class="arithmatex">\(H\)</span> is a single-qubit Hadamard gate.</p>
<p>What is the logical state fidelity of the final 2-qubit logical state at the end of the circuit as a function of the two-qubit gate error rate <span class="arithmatex">\(p\)</span>, assuming the state is post-selected on all detectable errors in the code?</p></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#16</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">reduce</span>

<span class="c1"># Single-qubit Paulis</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="n">Psingle</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">]</span>

<span class="c1"># Kronecker helper</span>
<span class="n">kron</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">ops</span><span class="p">:</span> <span class="n">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">,</span> <span class="n">ops</span><span class="p">)</span>

<span class="c1"># Build circuit</span>

<span class="k">def</span><span class="w"> </span><span class="nf">CNOT_ij</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">)</span>
    <span class="n">ops0</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">]</span>
    <span class="n">ops1</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">]</span>
    <span class="n">ops0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">P0</span>
    <span class="n">ops1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">P1</span>
    <span class="n">ops1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span>
    <span class="k">return</span> <span class="n">kron</span><span class="p">(</span><span class="o">*</span><span class="n">ops0</span><span class="p">)</span> <span class="o">+</span> <span class="n">kron</span><span class="p">(</span><span class="o">*</span><span class="n">ops1</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">H_q</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">]</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">H</span>
    <span class="k">return</span> <span class="n">kron</span><span class="p">(</span><span class="o">*</span><span class="n">ops</span><span class="p">)</span>

<span class="c1"># Circuit: U = CNOT_03 * H0 * CNOT_21 * H2</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">@</span> <span class="n">H_q</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">@</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">@</span> <span class="n">H_q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]],</span> <span class="nb">complex</span><span class="p">)</span>
<span class="n">psi0</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">)</span>
<span class="n">psi_ideal</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">psi0</span>

<span class="c1"># Stabilizers S1=XXXX, S2=ZZZZ</span>
<span class="n">S1</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">)</span>
<span class="n">S2</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">)</span>

<span class="c1"># Logical operators (one representative choice matching problem statement)</span>
<span class="n">XA</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">I</span><span class="p">)</span>
<span class="n">XB</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">I</span><span class="p">)</span>
<span class="n">ZA</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">I</span><span class="p">)</span>
<span class="n">ZB</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">I</span><span class="p">)</span>

<span class="c1"># Logical stabilizers of |Phi+&gt;_AB in code space</span>
<span class="n">Lstab</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="n">XA</span><span class="nd">@XB</span><span class="p">,</span> <span class="n">ZA</span><span class="nd">@ZB</span><span class="p">,</span> <span class="p">(</span><span class="n">XA</span><span class="nd">@XB</span><span class="p">)</span><span class="o">@</span><span class="p">(</span><span class="n">ZA</span><span class="nd">@ZB</span><span class="p">)]</span>

<span class="c1"># Enumerate all two-qubit Pauli on pairs (0,3) and (2,1)</span>
<span class="c1"># Build E_total(P03, P21)</span>

<span class="n">Ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">]</span>

<span class="c1"># Function to classify a 4-qubit Pauli E as accepted and as good (leaves psi_ideal up to phase)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">is_in_normalizer</span><span class="p">(</span><span class="n">E</span><span class="p">):</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">E</span><span class="nd">@S1</span> <span class="o">-</span> <span class="n">S1</span><span class="nd">@E</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">E</span><span class="nd">@S2</span> <span class="o">-</span> <span class="n">S2</span><span class="nd">@E</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c1</span> <span class="ow">and</span> <span class="n">c2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">leaves_state</span><span class="p">(</span><span class="n">E</span><span class="p">):</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">E</span> <span class="o">@</span> <span class="n">psi_ideal</span>
    <span class="n">ov</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi_ideal</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">psi</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ov</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">)</span>

<span class="c1"># Precompute acceptance and good masks for each pair of local paulis</span>
<span class="n">accepted</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">leaves</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">a03</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">b03</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">E03</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">Ops</span><span class="p">[</span><span class="n">a03</span><span class="p">],</span> <span class="n">I</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">Ops</span><span class="p">[</span><span class="n">b03</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">a21</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">b21</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="n">E21</span> <span class="o">=</span> <span class="n">kron</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">Ops</span><span class="p">[</span><span class="n">b21</span><span class="p">],</span> <span class="n">Ops</span><span class="p">[</span><span class="n">a21</span><span class="p">],</span> <span class="n">I</span><span class="p">)</span>
                <span class="n">E</span> <span class="o">=</span> <span class="n">E03</span> <span class="o">@</span> <span class="n">E21</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">a03</span><span class="p">,</span><span class="n">b03</span><span class="p">,</span><span class="n">a21</span><span class="p">,</span><span class="n">b21</span><span class="p">)</span>
                <span class="n">accepted</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_in_normalizer</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
                <span class="n">leaves</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">leaves_state</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>

<span class="c1"># Count categories for sanity</span>
<span class="n">n_acc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">accepted</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="n">n_leave</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span> <span class="ow">and</span> <span class="n">accepted</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">leaves</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total combos:&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="o">*</span><span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;Accepted (normalizer):&#39;</span><span class="p">,</span> <span class="n">n_acc</span><span class="p">,</span> <span class="s1">&#39;Good within accepted:&#39;</span><span class="p">,</span> <span class="n">n_leave</span><span class="p">)</span>

<span class="c1"># As expected: normalizer has size 64; E_total restricted to product of two local 2-qubit pauli sets gives 256 combos; acceptance 64</span>

<span class="c1"># Build weights for each key given depolarizing probability p</span>

<span class="k">def</span><span class="w"> </span><span class="nf">weights_of_p</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="c1"># weights for each local 2-qubit pauli on a pair</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">b</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">w</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">p</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">/</span><span class="mi">15</span>
    <span class="k">return</span> <span class="n">w</span>

<span class="c1"># Compute acceptance probability and conditional fidelity</span>

<span class="k">def</span><span class="w"> </span><span class="nf">acceptance_and_fidelity</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">w03</span> <span class="o">=</span> <span class="n">weights_of_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">w21</span> <span class="o">=</span> <span class="n">weights_of_p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">Pacc</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">Pgood</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">a03</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">b03</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">a21</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">b21</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">a03</span><span class="p">,</span><span class="n">b03</span><span class="p">,</span><span class="n">a21</span><span class="p">,</span><span class="n">b21</span><span class="p">)</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="n">w03</span><span class="p">[</span><span class="n">a03</span><span class="p">,</span><span class="n">b03</span><span class="p">]</span><span class="o">*</span><span class="n">w21</span><span class="p">[</span><span class="n">a21</span><span class="p">,</span><span class="n">b21</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">accepted</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                        <span class="n">Pacc</span> <span class="o">+=</span> <span class="n">w</span>
                        <span class="k">if</span> <span class="n">leaves</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                            <span class="n">Pgood</span> <span class="o">+=</span> <span class="n">w</span>
    <span class="n">Fcond</span> <span class="o">=</span> <span class="n">Pgood</span><span class="o">/</span><span class="n">Pacc</span> <span class="k">if</span> <span class="n">Pacc</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="mf">1.0</span>
    <span class="k">return</span> <span class="n">Pacc</span><span class="p">,</span> <span class="n">Fcond</span>

<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]:</span>
    <span class="n">Pacc</span><span class="p">,</span> <span class="n">Fcond</span> <span class="o">=</span> <span class="n">acceptance_and_fidelity</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;Pacc=&#39;</span><span class="p">,</span> <span class="n">Pacc</span><span class="p">,</span> <span class="s1">&#39;F_logical=&#39;</span><span class="p">,</span> <span class="n">Fcond</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#17</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>Total combos: 256 Accepted (normalizer): 64 Good within accepted: 16
0.0 Pacc= 1.0 F_logical= 1.0
0.01 Pacc= 0.9840853333333347 F_logical= 0.9999783216631608
0.1 Pacc= 0.848533333333331 F_logical= 0.9974858579509766
0.2 Pacc= 0.7141333333333368 F_logical= 0.9880507841672854
0.5 Pacc= 0.4133333333333337 F_logical= 0.8709677419354832

1.0 Pacc= 0.25333333333333335 F_logical= 0.15789473684210525
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#18</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Build classify functions as before</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">]</span>

<span class="c1"># Parity functions for a 2-qubit operator P⊗Q</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parity_counts_2q</span><span class="p">(</span><span class="n">Pa</span><span class="p">,</span> <span class="n">Pb</span><span class="p">):</span>
    <span class="c1"># returns e_z = (#Z or Y) mod 2, e_x = (#X or Y) mod 2 on the two-qubit pair</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">single_labels</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">I</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;I&#39;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;X&#39;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;Y&#39;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;Z&#39;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="n">la</span> <span class="o">=</span> <span class="n">single_labels</span><span class="p">(</span><span class="n">Pa</span><span class="p">)</span>
    <span class="n">lb</span> <span class="o">=</span> <span class="n">single_labels</span><span class="p">(</span><span class="n">Pb</span><span class="p">)</span>
    <span class="n">e_z</span> <span class="o">=</span> <span class="p">(</span><span class="n">la</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">lb</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">])</span>
    <span class="n">e_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">la</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">lb</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">e_z</span> <span class="o">%</span> <span class="mi">2</span><span class="p">,</span> <span class="n">e_x</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># Count distributions across 2-qubit paulis</span>
<span class="n">classes</span> <span class="o">=</span> <span class="p">{(</span><span class="n">ez</span><span class="p">,</span><span class="n">ex</span><span class="p">):</span><span class="mi">0</span> <span class="k">for</span> <span class="n">ez</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]}</span>
<span class="n">classes_nonid</span> <span class="o">=</span> <span class="p">{(</span><span class="n">ez</span><span class="p">,</span><span class="n">ex</span><span class="p">):</span><span class="mi">0</span> <span class="k">for</span> <span class="n">ez</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]}</span>

<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">ez</span><span class="p">,</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">parity_counts_2q</span><span class="p">(</span><span class="n">Ops</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">Ops</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
        <span class="n">classes</span><span class="p">[(</span><span class="n">ez</span><span class="p">,</span><span class="n">ex</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">a</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">b</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">classes_nonid</span><span class="p">[(</span><span class="n">ez</span><span class="p">,</span><span class="n">ex</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">classes</span><span class="p">,</span> <span class="n">classes_nonid</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#19</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>&#39;&#39;
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#20</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;All 2-qubit paulis counts by parity (ez,ex):&#39;</span><span class="p">,</span> <span class="n">classes</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Non-identity counts by parity (ez,ex):&#39;</span><span class="p">,</span> <span class="n">classes_nonid</span><span class="p">)</span>
</code></pre></div></div>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#21</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
NameError: name &#39;classes&#39; is not defined
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#22</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="c1"># Re-run quickly</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parity_counts_2q</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">]</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lab</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">I</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;I&#39;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;X&#39;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;Y&#39;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;Z&#39;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="n">la</span> <span class="o">=</span> <span class="n">lab</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="n">lb</span> <span class="o">=</span> <span class="n">lab</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">ez</span> <span class="o">=</span> <span class="p">(</span><span class="n">la</span> <span class="ow">in</span> <span class="s1">&#39;ZY&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">lb</span> <span class="ow">in</span> <span class="s1">&#39;ZY&#39;</span><span class="p">)</span>
    <span class="n">ex</span> <span class="o">=</span> <span class="p">(</span><span class="n">la</span> <span class="ow">in</span> <span class="s1">&#39;XY&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">lb</span> <span class="ow">in</span> <span class="s1">&#39;XY&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">ez</span><span class="o">%</span><span class="mi">2</span><span class="p">,</span> <span class="n">ex</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span>

<span class="n">classes</span> <span class="o">=</span> <span class="p">{(</span><span class="n">ez</span><span class="p">,</span><span class="n">ex</span><span class="p">):</span><span class="mi">0</span> <span class="k">for</span> <span class="n">ez</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]}</span>
<span class="n">classes_nonid</span> <span class="o">=</span> <span class="p">{(</span><span class="n">ez</span><span class="p">,</span><span class="n">ex</span><span class="p">):</span><span class="mi">0</span> <span class="k">for</span> <span class="n">ez</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]}</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">Ops</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">Ops</span><span class="p">:</span>
        <span class="n">ez</span><span class="p">,</span><span class="n">ex</span> <span class="o">=</span> <span class="n">parity_counts_2q</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="n">classes</span><span class="p">[(</span><span class="n">ez</span><span class="p">,</span><span class="n">ex</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">a</span> <span class="ow">is</span> <span class="n">I</span> <span class="ow">and</span> <span class="n">b</span> <span class="ow">is</span> <span class="n">I</span><span class="p">):</span>
            <span class="n">classes_nonid</span><span class="p">[(</span><span class="n">ez</span><span class="p">,</span><span class="n">ex</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classes_nonid</span><span class="p">)</span>
</code></pre></div></div>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#23</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>{(0, 0): 4, (0, 1): 4, (1, 0): 4, (1, 1): 4}
{(0, 0): 3, (0, 1): 4, (1, 0): 4, (1, 1): 4}
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#24</span>
    </div>
    <div class="content markdown-body"><ol>
<li>Step-by-Step Derivation</li>
</ol>
<ul>
<li>Ideal state prepared by the circuit</li>
<li>Start from |0000⟩.</li>
<li>Apply H2, then CNOT21: prepares a Bell pair on (2,1): |Φ+⟩21 = (|00⟩ + |11⟩)/√2.</li>
<li>Apply H0, then CNOT03: prepares a Bell pair on (0,3): |Φ+⟩03 = (|00⟩ + |11⟩)/√2.</li>
<li>Hence the ideal final 4-qubit state is the product</li>
</ul>
<div class="arithmatex">\[
|\psi_{\text{ideal}}\rangle = |\Phi^+\rangle_{03}\otimes|\Phi^+\rangle_{21}.
\]</div>
<div class="codehilite"><pre><span></span><code>This is a valid code state stabilized by S = {XXXX, ZZZZ}, and for the logical Bell state on A,B it is also stabilized by the logical operators X_AX_B = IXXI and Z_AZ_B = IZZI.
</code></pre></div>

<ul>
<li>Noise model and placement</li>
<li>A two-qubit depolarizing channel acts after each CNOT:<ul>
<li>After CNOT21, a channel on qubits (2,1).</li>
<li>After CNOT03, a channel on qubits (0,3).</li>
</ul>
</li>
<li>Each channel applies II with probability 1 − p, and one of the 15 non-identity two-qubit Paulis with probability p/15 each.</li>
<li>
<p>The two channels are independent and on disjoint pairs; thus the net error is E = E03 ⊗ E21, and because they occur after the CNOTs and on disjoint qubits, they commute with the subsequent gates and are effectively applied at the end to |ψideal⟩.</p>
</li>
<li>
<p>Post-selection on detectable errors</p>
</li>
<li>We post-select on measuring +1 for both stabilizers XXXX and ZZZZ. For a code state, an error E is accepted iff E commutes with both stabilizers, i.e., E lies in the normalizer N(S).</li>
<li>Characterize commutation by parities. For a 4-qubit Pauli P0⊗P1⊗P2⊗P3:<ul>
<li>Commutation with XXXX requires an even number of factors in {Z,Y}.</li>
<li>Commutation with ZZZZ requires an even number of factors in {X,Y}.</li>
</ul>
</li>
<li>Since E = E03 ⊗ E21 with E03 on (0,3) and E21 on (2,1), define for each pair (e_z, e_x) parities:<ul>
<li>e_z = parity of the count of {Z,Y} on the two qubits of the pair,</li>
<li>e_x = parity of the count of {X,Y} on the two qubits of the pair.</li>
</ul>
</li>
<li>Acceptance requires the parity vectors to match across the two pairs:</li>
</ul>
<div class="arithmatex">\[
(e_z^{03}, e_x^{03}) = (e_z^{21}, e_x^{21}).
\]</div>
<ul>
<li>Counting on a single two-qubit pair</li>
<li>Among the 16 two-qubit Paulis, the parity classes (e_z,e_x) are equally populated: 4 elements each.</li>
<li>
<p>Among the 15 non-identity operators, the counts by parity are:</p>
<ul>
<li>(0,0): 3 elements (XX, YY, ZZ),</li>
<li>(0,1): 4 elements,</li>
<li>(1,0): 4 elements,</li>
<li>(1,1): 4 elements.</li>
</ul>
</li>
<li>
<p>Acceptance probability Pacc(p)</p>
</li>
<li>Sum weights over all accepted combinations (E03, E21). There are three cases:
    1) (II, II): 1 combination, weight (1 − p)^2.
    2) Exactly one non-identity (say on one pair): accepted only if it is in class (0,0), i.e., 3 choices on that pair; total 2×3 combinations, each with weight (1 − p)·(p/15).
    3) Both non-identity: accepted if parity classes match across pairs; number of such combinations is
       3^2 + 4^2 + 4^2 + 4^2 = 57,
       each with weight (p/15)^2.</li>
<li>Therefore,</li>
</ul>
<div class="arithmatex">\[
    P_{\text{acc}}(p)
      &amp;= (1-p)^2 + 2\cdot 3\,(1-p)\frac{p}{15} + 57\left(\frac{p}{15}\right)^2 \\
      &amp;= 1 - \frac{24}{15}p + \frac{64}{75}p^2.
\]</div>
<ul>
<li>“Good” (logically correct) accepted events</li>
<li>The target logical Bell state |Φ+⟩AB is stabilized (up to global phase) by the logical operators {I, X_AX_B, Z_AZ_B, Y_AY_B}. At the physical level, this corresponds to applying on each Bell pair one of {II, XX, YY, ZZ}.</li>
<li>Thus “good” events are exactly those for which each pair’s two-qubit Pauli is in the (0,0) class. Counting and weighting:
    1) (II, II): 1 combination, weight (1 − p)^2.
    2) Exactly one non-identity, in (0,0): 2×3 combinations, each of weight (1 − p)(p/15).
    3) Both non-identity, both in (0,0): 3×3 = 9 combinations, each of weight (p/15)^2.</li>
<li>Hence</li>
</ul>
<div class="arithmatex">\[
    P_{\text{good}}(p)
      &amp;= (1-p)^2 + 2\cdot 3\,(1-p)\frac{p}{15} + 9\left(\frac{p}{15}\right)^2 \\
      &amp;= \Big((1-p) + 3\frac{p}{15}\Big)^2 \\
      &amp;= \left(1 - \frac{12}{15}p\right)^2.
\]</div>
<ul>
<li>Logical state fidelity after post-selection</li>
<li>The conditional logical fidelity is the fraction of accepted runs that are “good”:</li>
</ul>
<div class="arithmatex">\[
F_{\text{logical}}(p) = \frac{P_{\text{good}}(p)}{P_{\text{acc}}(p)} = \frac{\left(1 - \frac{12}{15}p\right)^2}{1 - \frac{24}{15}p + \frac{64}{75}p^2}.
\]</div>
<ul>
<li>Small-p expansion shows first-order cancellation due to post-selection:</li>
</ul>
<div class="arithmatex">\[
F_{\text{logical}}(p) = 1 - \frac{16}{75}p^2 + O(p^3).
\]</div>
<ol start="2">
<li>Mathematical Typesetting</li>
</ol>
<ul>
<li>Key expressions are displayed above.</li>
</ul>
<ol start="3">
<li>Conventions and Units</li>
</ol>
<ul>
<li>Probability p ∈ [0,1] is dimensionless; fidelity is dimensionless.</li>
</ul>
<ol start="4">
<li>Final Answer:
<span class="arithmatex">\(F_{\text{logical}}(p) = \dfrac{\left(1 - \dfrac{12}{15}p\right)^2}{1 - \dfrac{24}{15}p + \dfrac{64}{75}p^2} = \dfrac{\left(1 - \dfrac{4}{5}p\right)^2}{1 - \dfrac{8}{5}p + \dfrac{64}{75}p^2}.\)</span></li>
</ol></div>
</article>


<article class="message role-user">
    <div class="meta">
        <span class="badge">User</span>
        <span class="idx">#25</span>
    </div>
    <div class="content markdown-body"><p>The correct answer is:
$
F_{\rm{logical}}=1 - \frac{\frac{16}{75}p^2}{1-\frac{8}{5}p + \frac{64}{75}p^2}
$</p>
<p>Now let&rsquo;s solve the next Checkpoint.</p>
<h2 id="subproblem-3">Checkpoint 3</h2>
<p>Suppose that we prepare a logical two-qubit <span class="arithmatex">\(|00\rangle_{AB}\)</span> state in the [[4,2,2]] code. To do so, we introduce an ancilla qubit, qubit 4, and use the following state preparation circuit:</p>
<div class="arithmatex">\[
M_4 (CNOT_{04}) (CNOT_{34}) (CNOT_{23}) (CNOT_{10}) (CNOT_{12}) (H_1)
\]</div>
<p>Note that this equation is written in matrix multiplication order, while the quantum operations in the circuit occur in the reverse order (from right-to-left in the above equation). <span class="arithmatex">\(H\)</span> is a single-qubit Hadamard gate and <span class="arithmatex">\(M\)</span> is a single-qubit measurement. The ancilla is used to detect errors in the state preparation circuit and makes the circuit fault-tolerant. If the ancilla measurement is <span class="arithmatex">\(|0\rangle\)</span> (<span class="arithmatex">\(|1\rangle\)</span>), the state preparation succeeds (fails).</p>
<p>What is the logical state fidelity of the final 2-qubit logical state at the end of the circuit as a function of two-qubit gate error rate <span class="arithmatex">\(p\)</span>, assuming the state is post-selected on all detectable errors in the code and on the ancilla qubit measuring <span class="arithmatex">\(|0\rangle\)</span>?</p></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#26</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>

<span class="c1"># Symplectic representation for 5-qubit Paulis: bitstrings z[5], x[5]</span>
<span class="c1"># Conjugation by CNOT(c,t):</span>
<span class="c1">#   x_t ^= x_c</span>
<span class="c1">#   z_c ^= z_t</span>

<span class="k">def</span><span class="w"> </span><span class="nf">conj_cnot</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">^=</span> <span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
    <span class="n">z</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">^=</span> <span class="n">z</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>

<span class="c1"># Build local 2-qubit pauli on pair (i,j)</span>
<span class="c1"># map single label to (z,x) bits: I:(0,0), X:(0,1), Z:(1,0), Y:(1,1)</span>
<span class="n">label_to_bits</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">:(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">:(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)}</span>  <span class="c1"># order: I,X,Y,Z</span>

<span class="n">pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>  <span class="c1"># after each CNOT in time order H1, CNOT12,...,</span>
<span class="c1"># So subsequent gates for index k are CNOTs in pairs[k+1:]</span>

<span class="c1"># For each insertion site k, produce list of 16 resulting 10-bit bitstrings after propagating to end (before measurement)</span>
<span class="n">S</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pa</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span>
            <span class="n">za</span><span class="p">,</span> <span class="n">xa</span> <span class="o">=</span> <span class="n">label_to_bits</span><span class="p">[</span><span class="n">pa</span><span class="p">]</span>
            <span class="n">zb</span><span class="p">,</span> <span class="n">xb</span> <span class="o">=</span> <span class="n">label_to_bits</span><span class="p">[</span><span class="n">pb</span><span class="p">]</span>
            <span class="n">z</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">za</span><span class="p">;</span> <span class="n">x</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">xa</span>
            <span class="n">z</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">zb</span><span class="p">;</span> <span class="n">x</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">xb</span>
            <span class="c1"># propagate through subsequent CNOTs from k+1 to end</span>
            <span class="k">for</span> <span class="n">c2</span><span class="p">,</span> <span class="n">t2</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">conj_cnot</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
            <span class="c1"># pack to 10-bit integer [z0..z4, x0..x4]</span>
            <span class="n">bint</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">bint</span> <span class="o">|=</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">i</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">bint</span> <span class="o">|=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
            <span class="n">arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bint</span><span class="p">)</span>
    <span class="n">S</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>

<span class="c1"># Sanity: identity at each site should map to 0 bitstring</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">S</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>

<span class="c1"># Build distribution vector for each site with parameter p: d_k (length 1024)</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">10</span>

<span class="c1"># We&#39;ll compute P_acc(p) and P_good(p) using XOR convolution via FWT</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fwt_xor</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">h</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">h</span><span class="p">):</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="n">v</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="n">h</span><span class="p">]</span>
                <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">+</span><span class="n">v</span>
                <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">-</span><span class="n">v</span>
        <span class="n">h</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">inv</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">/=</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">a</span>

<span class="c1"># classification functions</span>

<span class="k">def</span><span class="w"> </span><span class="nf">accept_mask_bint</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
    <span class="c1"># ancilla index 4: x4 must be 0</span>
    <span class="n">x4</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="mi">4</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">x4</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># data parities</span>
    <span class="n">x_parity</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">z_parity</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">x_parity</span> <span class="o">^=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="n">i</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span>
        <span class="n">z_parity</span> <span class="o">^=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x_parity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">z_parity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># logical operator anticommute bits for data part</span>
<span class="c1"># Compute x_A=(x0+x1) mod 2, x_B=(x0+x2) mod 2 as anticommute with Z_A, Z_B</span>

<span class="k">def</span><span class="w"> </span><span class="nf">xA_xB_from_bint</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
    <span class="c1"># Data x bits: positions 5..8</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span>
    <span class="n">x3</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span>
    <span class="n">xA</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span> <span class="o">^</span> <span class="n">x1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span>
    <span class="n">xB</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span> <span class="o">^</span> <span class="n">x2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">xA</span><span class="p">,</span> <span class="n">xB</span>

<span class="c1"># Build accept mask and good mask arrays of length 1024</span>
<span class="n">acc_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="n">good_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">accept_mask_bint</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="n">acc_mask</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">xA</span><span class="p">,</span> <span class="n">xB</span> <span class="o">=</span> <span class="n">xA_xB_from_bint</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">xA</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xB</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">good_mask</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Build site distributions in transform domain once for numeric p values</span>

<span class="k">def</span><span class="w"> </span><span class="nf">site_distribution_transforms</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">dTs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="c1"># identity index 0 weight 1-p, others p/15 uniformly but there can be duplicates mapping to same bint</span>
        <span class="c1"># accumulate weights for non-identity entries</span>
        <span class="c1"># arr has length 16 with arr[0]==0</span>
        <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">-</span><span class="n">p</span>
        <span class="c1"># accumulate p/15 to each arr[j] for j&gt;0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">16</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">p</span><span class="o">/</span><span class="mi">15</span>
        <span class="n">dT</span> <span class="o">=</span> <span class="n">fwt_xor</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">dTs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dT</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dTs</span>

<span class="c1"># Compute distribution of E_final and Pacc, Pgood</span>

<span class="k">def</span><span class="w"> </span><span class="nf">acceptance_and_fidelity</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">dTs</span> <span class="o">=</span> <span class="n">site_distribution_transforms</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c1"># multiply pointwise transforms</span>
    <span class="n">prodT</span> <span class="o">=</span> <span class="n">dTs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">prodT</span> <span class="o">=</span> <span class="n">prodT</span> <span class="o">*</span> <span class="n">dTs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">fwt_xor</span><span class="p">(</span><span class="n">prodT</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># length 1024</span>
    <span class="c1"># ensure non-negative typical rounding</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">Pacc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="n">acc_mask</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">Pgood</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="n">good_mask</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">Pgood</span> <span class="o">/</span> <span class="n">Pacc</span> <span class="k">if</span> <span class="n">Pacc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1.0</span>
    <span class="k">return</span> <span class="n">Pacc</span><span class="p">,</span> <span class="n">Pgood</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">dist</span>

<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]:</span>
    <span class="n">Pacc</span><span class="p">,</span> <span class="n">Pgood</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">acceptance_and_fidelity</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;Pacc=&#39;</span><span class="p">,</span> <span class="n">Pacc</span><span class="p">,</span> <span class="s1">&#39;Pgood=&#39;</span><span class="p">,</span> <span class="n">Pgood</span><span class="p">,</span> <span class="s1">&#39;F=&#39;</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#27</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="mf">0.0</span><span class="w"> </span><span class="n">Pacc</span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="n">Pgood</span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="n">F</span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span>
<span class="mf">0.001</span><span class="w"> </span><span class="n">Pacc</span><span class="o">=</span><span class="w"> </span><span class="mf">0.9954760436293117</span><span class="w"> </span><span class="n">Pgood</span><span class="o">=</span><span class="w"> </span><span class="mf">0.9954754046527048</span><span class="w"> </span><span class="n">F</span><span class="o">=</span><span class="w"> </span><span class="mf">0.9999993581195539</span>
<span class="mf">0.01</span><span class="w"> </span><span class="n">Pacc</span><span class="o">=</span><span class="w"> </span><span class="mf">0.9555956743560909</span><span class="w"> </span><span class="n">Pgood</span><span class="o">=</span><span class="w"> </span><span class="mf">0.9555326923008884</span><span class="w"> </span><span class="n">F</span><span class="o">=</span><span class="w"> </span><span class="mf">0.9999340913140435</span>
<span class="mf">0.05</span><span class="w"> </span><span class="n">Pacc</span><span class="o">=</span><span class="w"> </span><span class="mf">0.7956173988345682</span><span class="w"> </span><span class="n">Pgood</span><span class="o">=</span><span class="w"> </span><span class="mf">0.7941416466962963</span><span class="w"> </span><span class="n">F</span><span class="o">=</span><span class="w"> </span><span class="mf">0.9981451484841413</span>
<span class="mf">0.1</span><span class="w"> </span><span class="n">Pacc</span><span class="o">=</span><span class="w"> </span><span class="mf">0.6313155735703704</span><span class="w"> </span><span class="n">Pgood</span><span class="o">=</span><span class="w"> </span><span class="mf">0.6258801866271605</span><span class="w"> </span><span class="n">F</span><span class="o">=</span><span class="w"> </span><span class="mf">0.9913903803885744</span>
<span class="mf">0.2</span><span class="w"> </span><span class="n">Pacc</span><span class="o">=</span><span class="w"> </span><span class="mf">0.39882243919012356</span><span class="w"> </span><span class="n">Pgood</span><span class="o">=</span><span class="w"> </span><span class="mf">0.38048496071111115</span><span class="w"> </span><span class="n">F</span><span class="o">=</span><span class="w"> </span><span class="mf">0.9540209459722232</span>
<span class="mf">0.5</span><span class="w"> </span><span class="n">Pacc</span><span class="o">=</span><span class="w"> </span><span class="mf">0.14752790123456788</span><span class="w"> </span><span class="n">Pgood</span><span class="o">=</span><span class="w"> </span><span class="mf">0.0816474074074074</span><span class="w"> </span><span class="n">F</span><span class="o">=</span><span class="w"> </span><span class="mf">0.5534370564764481</span>

<span class="mf">1.0</span><span class="w"> </span><span class="n">Pacc</span><span class="o">=</span><span class="w"> </span><span class="mf">0.1250014814814815</span><span class="w"> </span><span class="n">Pgood</span><span class="o">=</span><span class="w"> </span><span class="mf">0.03164049382716049</span><span class="w"> </span><span class="n">F</span><span class="o">=</span><span class="w"> </span><span class="mf">0.253120950665276</span>
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#28</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Use the previous functions acceptance_and_fidelity</span>

<span class="c1"># Fit polynomials Pacc(p) and Pgood(p) of degree &lt;=5 using values at 6 points</span>
<span class="n">ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">vals_acc</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">vals_good</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ps</span><span class="p">:</span>
    <span class="n">Pacc</span><span class="p">,</span> <span class="n">Pgood</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">acceptance_and_fidelity</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">vals_acc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pacc</span><span class="p">)</span>
    <span class="n">vals_good</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pgood</span><span class="p">)</span>
<span class="n">vals_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vals_acc</span><span class="p">)</span>
<span class="n">vals_good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vals_good</span><span class="p">)</span>

<span class="c1"># Vandermonde matrix</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">ps</span><span class="o">**</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
<span class="n">coeff_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">vals_acc</span><span class="p">)</span>
<span class="n">coeff_good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">vals_good</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;coeff_acc:&#39;</span><span class="p">,</span> <span class="n">coeff_acc</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;coeff_good:&#39;</span><span class="p">,</span> <span class="n">coeff_good</span><span class="p">)</span>

<span class="c1"># Check fit</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.9</span><span class="p">]:</span>
    <span class="n">Pacc_est</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">coeff_acc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">Pgood_est</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">coeff_good</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">Pacc</span><span class="p">,</span> <span class="n">Pgood</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">acceptance_and_fidelity</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;acc diff&#39;</span><span class="p">,</span> <span class="n">Pacc</span><span class="o">-</span><span class="n">Pacc_est</span><span class="p">,</span> <span class="s1">&#39;good diff&#39;</span><span class="p">,</span> <span class="n">Pgood</span><span class="o">-</span><span class="n">Pgood_est</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#29</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 10, in &lt;module&gt;
NameError: name &#39;acceptance_and_fidelity&#39; is not defined
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#30</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>

<span class="c1"># Reconstruct needed functions quickly from previous cell by reusing definitions</span>
<span class="c1"># We&#39;ll regenerate everything necessary</span>

<span class="k">def</span><span class="w"> </span><span class="nf">conj_cnot</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">^=</span> <span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
    <span class="n">z</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">^=</span> <span class="n">z</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>

<span class="n">label_to_bits</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">:(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">:(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)}</span>
<span class="n">pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>
<span class="n">S</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pa</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span>
            <span class="n">za</span><span class="p">,</span> <span class="n">xa</span> <span class="o">=</span> <span class="n">label_to_bits</span><span class="p">[</span><span class="n">pa</span><span class="p">]</span>
            <span class="n">zb</span><span class="p">,</span> <span class="n">xb</span> <span class="o">=</span> <span class="n">label_to_bits</span><span class="p">[</span><span class="n">pb</span><span class="p">]</span>
            <span class="n">z</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">za</span><span class="p">;</span> <span class="n">x</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">xa</span>
            <span class="n">z</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">zb</span><span class="p">;</span> <span class="n">x</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">xb</span>
            <span class="k">for</span> <span class="n">c2</span><span class="p">,</span> <span class="n">t2</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">conj_cnot</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
            <span class="n">bint</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">bint</span> <span class="o">|=</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">i</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">bint</span> <span class="o">|=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
            <span class="n">arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bint</span><span class="p">)</span>
    <span class="n">S</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">10</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fwt_xor</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">h</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">h</span><span class="p">):</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="n">v</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="n">h</span><span class="p">]</span>
                <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">+</span><span class="n">v</span>
                <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">-</span><span class="n">v</span>
        <span class="n">h</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">inv</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">/=</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">a</span>

<span class="c1"># acceptance masks</span>
<span class="n">acc_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="n">good_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">x4</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="mi">4</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">x4</span><span class="p">:</span> <span class="k">continue</span>
    <span class="n">z_par</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x_par</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">z_par</span> <span class="o">^=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span>
        <span class="n">x_par</span> <span class="o">^=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="n">i</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">z_par</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x_par</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">acc_mask</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span>
        <span class="n">xA</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">^</span> <span class="n">x1</span>
        <span class="n">xB</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">^</span> <span class="n">x2</span>
        <span class="k">if</span> <span class="n">xA</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">xB</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">good_mask</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">def</span><span class="w"> </span><span class="nf">site_distribution_transforms</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">dTs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">-</span><span class="n">p</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">16</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">p</span><span class="o">/</span><span class="mi">15</span>
        <span class="n">dTs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fwt_xor</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dTs</span>


<span class="k">def</span><span class="w"> </span><span class="nf">acceptance_and_fidelity</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">dTs</span> <span class="o">=</span> <span class="n">site_distribution_transforms</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">prodT</span> <span class="o">=</span> <span class="n">dTs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">prodT</span> <span class="o">*=</span> <span class="n">dTs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">fwt_xor</span><span class="p">(</span><span class="n">prodT</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">Pacc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="n">acc_mask</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">Pgood</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="n">good_mask</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">Pgood</span><span class="o">/</span><span class="n">Pacc</span> <span class="k">if</span> <span class="n">Pacc</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="mf">1.0</span>
    <span class="k">return</span> <span class="n">Pacc</span><span class="p">,</span> <span class="n">Pgood</span><span class="p">,</span> <span class="n">F</span>

<span class="n">ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">vals_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">acceptance_and_fidelity</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ps</span><span class="p">])</span>
<span class="n">vals_good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">acceptance_and_fidelity</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ps</span><span class="p">])</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">ps</span><span class="o">**</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
<span class="n">coeff_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">vals_acc</span><span class="p">)</span>
<span class="n">coeff_good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">vals_good</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;coeff_acc:&#39;</span><span class="p">,</span> <span class="n">coeff_acc</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;coeff_good:&#39;</span><span class="p">,</span> <span class="n">coeff_good</span><span class="p">)</span>

<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.9</span><span class="p">]:</span>
    <span class="n">Pacc_est</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">coeff_acc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">Pgood_est</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">coeff_good</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">Pacc</span><span class="p">,</span> <span class="n">Pgood</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="n">acceptance_and_fidelity</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;acc diff&#39;</span><span class="p">,</span> <span class="n">Pacc</span><span class="o">-</span><span class="n">Pacc_est</span><span class="p">,</span> <span class="s1">&#39;good diff&#39;</span><span class="p">,</span> <span class="n">Pgood</span><span class="o">-</span><span class="n">Pgood_est</span><span class="p">)</span>
</code></pre></div></div>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#31</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>coeff_acc: [ 1.         -4.53333333  9.38666667 -9.70903704  5.0163358  -1.03563062]
coeff_good: [ 1.         -4.53333333  8.74666667 -8.68503704  4.40952099 -0.90617679]
0.1 acc diff -6.661338147750939e-16 good diff -2.220446049250313e-16
0.3 acc diff -4.440892098500626e-16 good diff -2.7755575615628914e-17
0.5 acc diff -2.498001805406602e-16 good diff 1.8041124150158794e-16
0.7 acc diff -9.43689570931383e-16 good diff -1.5265566588595902e-16
0.9 acc diff 1.0269562977782698e-15 good diff 6.661338147750939e-16
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#32</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>

<span class="n">coeff_acc_float</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.533333333333333</span><span class="p">,</span> <span class="mf">9.386666666666667</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.709037037037037</span><span class="p">,</span> <span class="mf">5.016335800865801</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0356306172839506</span><span class="p">]</span>
<span class="n">coeff_good_float</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.533333333333333</span><span class="p">,</span> <span class="mf">8.746666666666666</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.685037037037037</span><span class="p">,</span> <span class="mf">4.409520987654321</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.9061767901234566</span><span class="p">]</span>

<span class="c1"># approximate with denominator bounded by e.g., 15**5</span>
<span class="n">Dmax</span> <span class="o">=</span> <span class="mi">15</span><span class="o">**</span><span class="mi">6</span>

<span class="n">coeff_acc_rat</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">(</span><span class="n">Dmax</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">coeff_acc_float</span><span class="p">]</span>
<span class="n">coeff_good_rat</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">(</span><span class="n">Dmax</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">coeff_good_float</span><span class="p">]</span>
<span class="n">coeff_acc_rat</span><span class="p">,</span> <span class="n">coeff_good_rat</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#33</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>&#39;&#39;
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#34</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="c1"># display as fractions</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">coeff_rat</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;acc&#39;</span><span class="p">,</span> <span class="n">coeff_acc_rat</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;good&#39;</span><span class="p">,</span> <span class="n">coeff_good_rat</span><span class="p">)]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">coeff_rat</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
</code></pre></div></div>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#35</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 2, in &lt;module&gt;
NameError: name &#39;coeff_acc_rat&#39; is not defined
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#36</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="n">coeff_acc_float</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.533333333333333</span><span class="p">,</span> <span class="mf">9.386666666666667</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.709037037037037</span><span class="p">,</span> <span class="mf">5.016335800865801</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0356306172839506</span><span class="p">]</span>
<span class="n">coeff_good_float</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.533333333333333</span><span class="p">,</span> <span class="mf">8.746666666666666</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.685037037037037</span><span class="p">,</span> <span class="mf">4.409520987654321</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.9061767901234566</span><span class="p">]</span>
<span class="n">Dmax</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
<span class="n">coeff_acc_rat</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">(</span><span class="n">Dmax</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">coeff_acc_float</span><span class="p">]</span>
<span class="n">coeff_good_rat</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">(</span><span class="n">Dmax</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">coeff_good_float</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;acc:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">coeff_acc_rat</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;good:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">coeff_good_rat</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</code></pre></div></div>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#37</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="n">acc</span><span class="o">:</span>
<span class="mi">1</span>
<span class="o">-</span><span class="mi">68</span><span class="o">/</span><span class="mi">15</span>
<span class="mi">704</span><span class="o">/</span><span class="mi">75</span>
<span class="o">-</span><span class="mi">32768</span><span class="o">/</span><span class="mi">3375</span>
<span class="mi">1655594011</span><span class="o">/</span><span class="mi">330040507</span>
<span class="o">-</span><span class="mi">262144</span><span class="o">/</span><span class="mi">253125</span>
<span class="n">good</span><span class="o">:</span>
<span class="mi">1</span>
<span class="o">-</span><span class="mi">68</span><span class="o">/</span><span class="mi">15</span>
<span class="mi">656</span><span class="o">/</span><span class="mi">75</span>
<span class="o">-</span><span class="mi">29312</span><span class="o">/</span><span class="mi">3375</span>
<span class="mi">223232</span><span class="o">/</span><span class="mi">50625</span>
<span class="o">-</span><span class="mi">229376</span><span class="o">/</span><span class="mi">253125</span>
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#38</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>

<span class="c1"># Setup mapping as earlier for bitstrings S[k] etc.</span>

<span class="k">def</span><span class="w"> </span><span class="nf">conj_cnot_bits</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">^=</span> <span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
    <span class="n">z</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">^=</span> <span class="n">z</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>

<span class="n">label_to_bits</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">:(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">:(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)}</span>
<span class="n">pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>
<span class="n">S</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pa</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span>
            <span class="n">za</span><span class="p">,</span> <span class="n">xa</span> <span class="o">=</span> <span class="n">label_to_bits</span><span class="p">[</span><span class="n">pa</span><span class="p">]</span>
            <span class="n">zb</span><span class="p">,</span> <span class="n">xb</span> <span class="o">=</span> <span class="n">label_to_bits</span><span class="p">[</span><span class="n">pb</span><span class="p">]</span>
            <span class="n">z</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">za</span><span class="p">;</span> <span class="n">x</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">xa</span>
            <span class="n">z</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">zb</span><span class="p">;</span> <span class="n">x</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">xb</span>
            <span class="k">for</span> <span class="n">c2</span><span class="p">,</span> <span class="n">t2</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">conj_cnot_bits</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
            <span class="n">bint</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">bint</span> <span class="o">|=</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">i</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">bint</span> <span class="o">|=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
            <span class="n">arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bint</span><span class="p">)</span>
    <span class="n">S</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">10</span>

<span class="c1"># Build per-site arrays A_k (constant term) and B_k (coefficient of p) in transform domain</span>
<span class="c1"># For site k: d_k(b;p) = A_k(b) + p * B_k(b), with A_k(b) = delta_{b,0}, and B_k(0)=-1, B_k(b!=0)=n_k(b)/15</span>

<span class="n">A_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">B_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span><span class="o">*</span><span class="n">N</span>
    <span class="n">B</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span><span class="o">*</span><span class="n">N</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="c1"># identity mapping index 0 occurs once</span>
    <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># count multiplicities for b!=0 among the 15 non-identity entries</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">16</span><span class="p">):</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">counts</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="n">counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">B</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="n">cnt</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
    <span class="n">A_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">B_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>

<span class="c1"># Walsh-Hadamard Transform for Fractions</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fwt_xor_frac</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:]</span>  <span class="c1"># copy</span>
    <span class="k">while</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">h</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">h</span><span class="p">):</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="n">v</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="n">h</span><span class="p">]</span>
                <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span> <span class="o">+</span> <span class="n">v</span>
                <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span> <span class="o">-</span> <span class="n">v</span>
        <span class="n">h</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">a</span>

<span class="c1"># forward transforms for A_k and B_k</span>
<span class="n">AT_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fwt_xor_frac</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="k">for</span> <span class="n">A</span> <span class="ow">in</span> <span class="n">A_list</span><span class="p">]</span>
<span class="n">BT_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fwt_xor_frac</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="k">for</span> <span class="n">B</span> <span class="ow">in</span> <span class="n">B_list</span><span class="p">]</span>

<span class="c1"># Multiply across sites: For each frequency index f, compute poly P_f(p) = prod_k (AT_k[f] + p * BT_k[f])</span>
<span class="c1"># Return coefficients C[d][f] for d=0..5 as Fractions</span>
<span class="n">DcoeffT</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span><span class="o">*</span><span class="n">N</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>  <span class="c1"># init zeros</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="c1"># start with degree-0 polynomial &#39;1&#39;</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span><span class="o">*</span><span class="mi">5</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">AT_list</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">f</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">BT_list</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">f</span><span class="p">]</span>
        <span class="c1"># multiply coeffs by (a + p b)</span>
        <span class="n">new</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span><span class="o">*</span><span class="mi">6</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">new</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+=</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">*</span> <span class="n">a</span>
                <span class="k">if</span> <span class="n">d</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">new</span><span class="p">[</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">new</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">DcoeffT</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>

<span class="c1"># Inverse transform: divide by N=1024</span>
<span class="n">invN</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">Dcoeff</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">inv</span> <span class="o">=</span> <span class="n">fwt_xor_frac</span><span class="p">(</span><span class="n">DcoeffT</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>
    <span class="n">inv</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">invN</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inv</span><span class="p">]</span>
    <span class="n">Dcoeff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inv</span><span class="p">)</span>

<span class="c1"># Define masks</span>
<span class="n">acc_mask</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span><span class="o">*</span><span class="n">N</span>
<span class="n">good_mask</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span><span class="o">*</span><span class="n">N</span>
<span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">x4</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="mi">4</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">x4</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">z_par</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x_par</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">z_par</span> <span class="o">^=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span>
        <span class="n">x_par</span> <span class="o">^=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="n">i</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">z_par</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">x_par</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">acc_mask</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span>
        <span class="n">xA</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">^</span> <span class="n">x1</span>
        <span class="n">xB</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">^</span> <span class="n">x2</span>
        <span class="k">if</span> <span class="n">xA</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">xB</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">good_mask</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Sum coefficients over masks to get Pacc(p) and Pgood(p)</span>
<span class="n">Pacc_coeffs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span><span class="o">*</span><span class="mi">6</span>
<span class="n">Pgood_coeffs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span><span class="o">*</span><span class="mi">6</span>
<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">Pacc_coeffs</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Dcoeff</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="k">if</span> <span class="n">acc_mask</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
    <span class="n">Pgood_coeffs</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Dcoeff</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="k">if</span> <span class="n">good_mask</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Pacc coefficients by degree 0..5:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Pacc_coeffs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Pgood coefficients by degree 0..5:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Pgood_coeffs</span><span class="p">)</span>

<span class="c1"># Check by evaluating polynomials at a few p values and comparing numeric earlier acceptance_and_fidelity results</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]:</span>
    <span class="n">Pacc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">Pacc_coeffs</span><span class="p">[</span><span class="n">d</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">**</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">Pgood</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">Pgood_coeffs</span><span class="p">[</span><span class="n">d</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">**</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">Pacc_num</span><span class="p">,</span> <span class="n">Pgood_num</span><span class="p">,</span> <span class="n">F_num</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># We&#39;ll recompute using earlier float method quickly</span>
    <span class="c1"># Rebuild site distributions</span>
    <span class="c1"># But we skip due to interplay; Instead just print values</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;p=&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="s1">&#39;Pacc poly&#39;</span><span class="p">,</span> <span class="n">Pacc</span><span class="p">,</span> <span class="s1">&#39;Pgood poly&#39;</span><span class="p">,</span> <span class="n">Pgood</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#39</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>Pacc coefficients by degree 0..5:
[Fraction(1, 1), Fraction(-68, 15), Fraction(704, 75), Fraction(-32768, 3375), Fraction(253952, 50625), Fraction(-262144, 253125)]
Pgood coefficients by degree 0..5:
[Fraction(1, 1), Fraction(-68, 15), Fraction(656, 75), Fraction(-29312, 3375), Fraction(223232, 50625), Fraction(-229376, 253125)]
p= 0.0 Pacc poly 1.0 Pgood poly 1.0
p= 0.1 Pacc poly 0.6313155735703703 Pgood poly 0.6258801866271604
p= 0.2 Pacc poly 0.39882243919012345 Pgood poly 0.38048496071111104
p= 0.5 Pacc poly 0.14752790123456802 Pgood poly 0.08164740740740722
p= 1.0 Pacc poly 0.12500148148148216 Pgood poly 0.031640493827159055
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#40</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>

<span class="n">Pacc</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">68</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">704</span><span class="p">,</span><span class="mi">75</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">,</span><span class="mi">3375</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">253952</span><span class="p">,</span><span class="mi">50625</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">262144</span><span class="p">,</span><span class="mi">253125</span><span class="p">)]</span>
<span class="n">Pgood</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">68</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">656</span><span class="p">,</span><span class="mi">75</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">29312</span><span class="p">,</span><span class="mi">3375</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">223232</span><span class="p">,</span><span class="mi">50625</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">229376</span><span class="p">,</span><span class="mi">253125</span><span class="p">)]</span>

<span class="c1"># series for ratio up to p^5</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ratio_series</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">den</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="c1"># compute coefficients a_k for (sum n_k p^k)/(sum d_k p^k)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span><span class="o">*</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">den</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># sum_{j=0}^k d_j a_{k-j} = n_k</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">num</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">-=</span> <span class="n">den</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="n">j</span><span class="p">]</span>
        <span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">/</span><span class="n">den</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">a</span>

<span class="n">series</span> <span class="o">=</span> <span class="n">ratio_series</span><span class="p">(</span><span class="n">Pgood</span><span class="p">,</span> <span class="n">Pacc</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">series</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#41</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>&#39;&#39;
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#42</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="n">Pacc</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">68</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">704</span><span class="p">,</span><span class="mi">75</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">,</span><span class="mi">3375</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">253952</span><span class="p">,</span><span class="mi">50625</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">262144</span><span class="p">,</span><span class="mi">253125</span><span class="p">)]</span>
<span class="n">Pgood</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">68</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">656</span><span class="p">,</span><span class="mi">75</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">29312</span><span class="p">,</span><span class="mi">3375</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">223232</span><span class="p">,</span><span class="mi">50625</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">229376</span><span class="p">,</span><span class="mi">253125</span><span class="p">)]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">ratio_series</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">den</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span><span class="o">*</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">den</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">num</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">-=</span> <span class="n">den</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="n">j</span><span class="p">]</span>
        <span class="n">a</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">/</span><span class="n">den</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">a</span>

<span class="n">series</span> <span class="o">=</span> <span class="n">ratio_series</span><span class="p">(</span><span class="n">Pgood</span><span class="p">,</span> <span class="n">Pacc</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
<span class="nb">print</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">series</span><span class="p">])</span>
</code></pre></div></div>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#43</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="k">[Fraction(1, 1), Fraction(0, 1), Fraction(-16, 25), Fraction(-704, 375), Fraction(-10496, 3375), Fraction(-216064, 84375)]</span>
<span class="k">[1.0, 0.0, -0.64, -1.8773333333333333, -3.1099259259259258, -2.5607585185185187]</span>
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#44</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="n">Pacc</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">68</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">704</span><span class="p">,</span><span class="mi">75</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">,</span><span class="mi">3375</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">253952</span><span class="p">,</span><span class="mi">50625</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">262144</span><span class="p">,</span><span class="mi">253125</span><span class="p">)]</span>
<span class="n">Pgood</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">68</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">656</span><span class="p">,</span><span class="mi">75</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">29312</span><span class="p">,</span><span class="mi">3375</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">223232</span><span class="p">,</span><span class="mi">50625</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">229376</span><span class="p">,</span><span class="mi">253125</span><span class="p">)]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">poly_val</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>
    <span class="n">s</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coeffs</span><span class="p">):</span>
        <span class="n">s</span><span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">**</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>

<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]:</span>
    <span class="n">Paccv</span><span class="o">=</span><span class="n">poly_val</span><span class="p">(</span><span class="n">Pacc</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
    <span class="n">Pgoodv</span><span class="o">=</span><span class="n">poly_val</span><span class="p">(</span><span class="n">Pgood</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">Pgoodv</span><span class="o">/</span><span class="n">Paccv</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#45</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="mf">0.01</span><span class="w"> </span><span class="mf">0.9999340913140434</span>
<span class="mf">0.05</span><span class="w"> </span><span class="mf">0.9981451484841417</span>
<span class="mf">0.1</span><span class="w"> </span><span class="mf">0.9913903803885744</span>
<span class="mf">0.2</span><span class="w"> </span><span class="mf">0.9540209459722232</span>
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#46</span>
    </div>
    <div class="content markdown-body"><ol>
<li>Step-by-Step Derivation</li>
</ol>
<ul>
<li>Ideal target and circuit</li>
<li>Data qubits (0,1,2,3) start in |0000⟩ and ancilla (4) in |0⟩.</li>
<li>Apply, right-to-left: H1, CNOT12, CNOT10, CNOT23, CNOT34, CNOT04, then measure M4.</li>
<li>With no errors, the data end in</li>
</ul>
<div class="arithmatex">\[
|\psi_{\text{ideal}}\rangle_{0123}=\frac{|0000\rangle+|1111\rangle}{\sqrt{2}},
\]</div>
<div class="codehilite"><pre><span></span><code>while the ancilla deterministically measures |0⟩. This code state is the logical |00⟩AB of the [[4,2,2]] code (it is +1 eigenstate of Z_A=ZZII and Z_B=ZIZI, and of the stabilizers XXXX, ZZZZ).
</code></pre></div>

<ul>
<li>Noise model</li>
<li>After each of the five CNOTs, a two-qubit depolarizing channel acts on the gate’s two qubits: II with probability 1−p and any of the 15 non-identity two-qubit Paulis with probability p/15 each.</li>
<li>
<p>The five CNOTs (and their error locations, from earliest to latest) are on pairs:
    (1,2), (1,0), (2,3), (3,4), (0,4).</p>
</li>
<li>
<p>Pauli-frame propagation (Clifford-symplectic)</p>
</li>
<li>The circuit is Clifford, so any sequence of Pauli errors propagates to a single effective Pauli at the end of the circuit. Represent Paulis by their binary symplectic vector (z|x) over 5 qubits.</li>
<li>Conjugation by CNOT(c→t) acts on bits as:<ul>
<li>x_t ← x_t ⊕ x_c,</li>
<li>z_c ← z_c ⊕ z_t,
and leaves the other bits unchanged.</li>
</ul>
</li>
<li>
<p>For each insertion point k and each of the 16 local two-qubit Paulis on its pair, propagate (z|x) forward through the remaining CNOTs to obtain a final 10-bit string b_k ∈ {0,1}^10. The overall effective Pauli is the XOR sum b = b_1 ⊕ b_2 ⊕ b_3 ⊕ b_4 ⊕ b_5.</p>
</li>
<li>
<p>Post-selection criteria</p>
</li>
<li>Ancilla post-selection: The ancilla is measured in the Z basis and ideally is |0⟩. A final ancilla Pauli of type X or Y flips/rejects; acceptance requires no X on ancilla: x4=0 (z4 arbitrary).</li>
<li>
<p>Code error-detection post-selection: The final data Pauli must commute with both stabilizers XXXX and ZZZZ. In symplectic bits this is exactly:</p>
<ul>
<li>even parity of data z bits: z0⊕z1⊕z2⊕z3 = 0,</li>
<li>even parity of data x bits: x0⊕x1⊕x2⊕x3 = 0.</li>
</ul>
</li>
<li>
<p>Logical success condition (fidelity with |00⟩AB)</p>
</li>
<li>Within the normalizer, the induced logical Pauli on A,B is determined by its commutation with ZA, XA, ZB, XB. For our chosen logicals,<ul>
<li>x_A = (x0 ⊕ x1) = anticomm(E_data, Z_A),</li>
<li>z_A = (z0 ⊕ z2) = anticomm(E_data, X_A),</li>
<li>x_B = (x0 ⊕ x2) = anticomm(E_data, Z_B),</li>
<li>z_B = (z0 ⊕ z1) = anticomm(E_data, X_B).</li>
</ul>
</li>
<li>The logical |00⟩AB is +1 eigenstate of Z_A and Z_B. Therefore any accepted event whose induced logical Pauli contains an X on A or on B (i.e., x_A=1 or x_B=1) flips |00⟩. Logical Z-type byproducts (z_A, z_B) leave |00⟩ unchanged.</li>
<li>
<p>Hence, among accepted events, “good” = those with x_A=0 and x_B=0.</p>
</li>
<li>
<p>Exact evaluation via XOR convolution</p>
</li>
<li>At each of the five CNOT locations, the local error variable takes value 0 (identity) with weight 1−p and one of 15 propagated bitstrings with weight p/15 each (possibly with multiplicities). The five independent contributions add by XOR to yield the final bitstring b. The corresponding distribution is an XOR convolution of five mixtures.</li>
<li>Using the fast Walsh–Hadamard transform for XOR-convolutions (and exact rational arithmetic), one obtains:<ul>
<li>Acceptance probability:</li>
</ul>
</li>
</ul>
<div class="arithmatex">\[
      P_{\text{acc}}(p)
      &amp;= 1 - \frac{68}{15}p + \frac{704}{75}p^2 - \frac{32768}{3375}p^3 \\
      &amp;\quad + \frac{253952}{50625}p^4 - \frac{262144}{253125}p^5.
\]</div>
<div class="codehilite"><pre><span></span><code>- “Good” (logically correct) probability:
</code></pre></div>

<div class="arithmatex">\[
      P_{\text{good}}(p)
      &amp;= 1 - \frac{68}{15}p + \frac{656}{75}p^2 - \frac{29312}{3375}p^3 \\
      &amp;\quad + \frac{223232}{50625}p^4 - \frac{229376}{253125}p^5.
\]</div>
<ul>
<li>The logical state fidelity conditioned on post-selection is</li>
</ul>
<div class="arithmatex">\[
F_{\text{logical}}(p)=\frac{P_{\text{good}}(p)}{P_{\text{acc}}(p)}.
\]</div>
<ul>
<li>Small-p expansion</li>
<li>Expanding the ratio gives</li>
</ul>
<div class="arithmatex">\[
F_{\text{logical}}(p)=1 - \frac{16}{25}p^2 - \frac{704}{375}p^3 - \frac{10496}{3375}p^4 - \frac{216064}{84375}p^5 + O(p^6),
\]</div>
<div class="codehilite"><pre><span></span><code>showing first-order cancellation (no p term) from the fault-tolerant detection and that the leading degradation is quadratic.
</code></pre></div>

<ol start="2">
<li>Mathematical Typesetting</li>
</ol>
<ul>
<li>Final closed-form expression:</li>
</ul>
<div class="arithmatex">\[
F_{\text{logical}}(p)=\frac{1 - \frac{68}{15}p + \frac{656}{75}p^2 - \frac{29312}{3375}p^3 + \frac{223232}{50625}p^4 - \frac{229376}{253125}p^5}{1 - \frac{68}{15}p + \frac{704}{75}p^2 - \frac{32768}{3375}p^3 + \frac{253952}{50625}p^4 - \frac{262144}{253125}p^5}.
\]</div>
<ol start="3">
<li>Conventions and Units</li>
</ol>
<ul>
<li>p ∈ [0,1] is the two-qubit gate error probability per CNOT.</li>
<li>Fidelity is dimensionless.</li>
</ul>
<ol start="4">
<li>Final Answer:
<span class="arithmatex">\(F_{\text{logical}}(p) = \dfrac{1 - \dfrac{68}{15}p + \dfrac{656}{75}p^2 - \dfrac{29312}{3375}p^3 + \dfrac{223232}{50625}p^4 - \dfrac{229376}{253125}p^5}{1 - \dfrac{68}{15}p + \dfrac{704}{75}p^2 - \dfrac{32768}{3375}p^3 + \dfrac{253952}{50625}p^4 - \dfrac{262144}{253125}p^5}\,.\)</span></li>
</ol></div>
</article>


<article class="message role-user">
    <div class="meta">
        <span class="badge">User</span>
        <span class="idx">#47</span>
    </div>
    <div class="content markdown-body"><p>Populate your final answer into the code template provided below. This step is purely for formatting/display purposes. No additional reasoning or derivation should be performed. Do not import any modules or packages beyond what is provided in the template.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">answer</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the expression of the logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    at the end of the circuit as a function of two-qubit gate error rate $p$.</span>

<span class="sd">    Inputs</span>
<span class="sd">    ----------</span>
<span class="sd">    p: sympy.Symbol, two-qubit gate error rate, $p$</span>

<span class="sd">    Outputs</span>
<span class="sd">    ----------</span>
<span class="sd">    F_logical: sympy.Expr, logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------ FILL IN YOUR RESULTS BELOW ------------------</span>
    <span class="n">F_logical</span> <span class="o">=</span> <span class="o">...</span>  <span class="c1"># a SymPy expression of inputs</span>
    <span class="c1"># ---------------------------------------------------------------</span>

    <span class="k">return</span> <span class="n">F_logical</span>
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#48</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">answer</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the expression of the logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    at the end of the circuit as a function of two-qubit gate error rate $p$.</span>

<span class="sd">    Inputs</span>
<span class="sd">    ----------</span>
<span class="sd">    p: sympy.Symbol, two-qubit gate error rate, $p$</span>

<span class="sd">    Outputs</span>
<span class="sd">    ----------</span>
<span class="sd">    F_logical: sympy.Expr, logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------ FILL IN YOUR RESULTS BELOW ------------------</span>
    <span class="n">numerator</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mi">1</span>
        <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">68</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span><span class="o">*</span><span class="n">p</span>
        <span class="o">+</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">656</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span>
        <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">29312</span><span class="p">,</span> <span class="mi">3375</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">3</span>
        <span class="o">+</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">223232</span><span class="p">,</span> <span class="mi">50625</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">4</span>
        <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">229376</span><span class="p">,</span> <span class="mi">253125</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">5</span>
    <span class="p">)</span>
    <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mi">1</span>
        <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">68</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span><span class="o">*</span><span class="n">p</span>
        <span class="o">+</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">704</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span>
        <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">32768</span><span class="p">,</span> <span class="mi">3375</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">3</span>
        <span class="o">+</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">253952</span><span class="p">,</span> <span class="mi">50625</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">4</span>
        <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">262144</span><span class="p">,</span> <span class="mi">253125</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">5</span>
    <span class="p">)</span>
    <span class="n">F_logical</span> <span class="o">=</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span>  <span class="c1"># a SymPy expression of inputs</span>
    <span class="c1"># ---------------------------------------------------------------</span>

    <span class="k">return</span> <span class="n">F_logical</span>
</code></pre></div></div>
</article>

</div>

<footer>
  Generated at 2025-09-24T22:02:12.082394
</footer>

<script>
(function() {
  // Tabs
  const tabs = document.querySelectorAll('.tab');
  const panels = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      panels.forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      const target = document.querySelector(tab.dataset.target);
      if (target) target.classList.add('active');
    });
  });

  // Theme toggle
  const toggleBtn = document.getElementById('theme-toggle');
  function setTheme(dark) {
    if (dark) {
      document.documentElement.classList.add('dark');
      localStorage.setItem('dark', '1');
    } else {
      document.documentElement.classList.remove('dark');
      localStorage.setItem('dark', '0');
    }
  }
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const stored = localStorage.getItem('dark');
  setTheme(stored === null ? prefersDark : stored === '1');

  toggleBtn.addEventListener('click', () => {
    const isDark = document.documentElement.classList.contains('dark');
    setTheme(!isDark);
  });
})();
</script>
</body>
</html>