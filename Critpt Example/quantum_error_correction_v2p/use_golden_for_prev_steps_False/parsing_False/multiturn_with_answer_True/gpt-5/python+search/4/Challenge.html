<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Challenge</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.codehilite .hll { background-color: #ffffcc }
.codehilite { background: #f8f8f8; }
.codehilite .c { color: #3D7B7B; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #F00 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666 } /* Operator */
.codehilite .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #9C6500 } /* Comment.Preproc */
.codehilite .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.codehilite .gr { color: #E40000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #008400 } /* Generic.Inserted */
.codehilite .go { color: #717171 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #04D } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #687822 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #00F; font-weight: bold } /* Name.Class */
.codehilite .no { color: #800 } /* Name.Constant */
.codehilite .nd { color: #A2F } /* Name.Decorator */
.codehilite .ni { color: #717171; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #00F } /* Name.Function */
.codehilite .nl { color: #767600 } /* Name.Label */
.codehilite .nn { color: #00F; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #A2F; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #BBB } /* Text.Whitespace */
.codehilite .mb { color: #666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666 } /* Literal.Number.Float */
.codehilite .mh { color: #666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666 } /* Literal.Number.Oct */
.codehilite .sa { color: #BA2121 } /* Literal.String.Affix */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .dl { color: #BA2121 } /* Literal.String.Delimiter */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #A45A77 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #00F } /* Name.Function.Magic */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .vm { color: #19177C } /* Name.Variable.Magic */
.codehilite .il { color: #666 } /* Literal.Number.Integer.Long */

</style>
<style>
    :root {
  --bg: #ffffff;
  --fg: #222222;
  --muted: #555555;
  --border: #e0e0e0;
  --accent: #005fcc;
  --code-bg: #f6f8fa;
  --role-user: #0ea5e9;
  --role-assistant: #22c55e;
  --role-system: #9ca3af;
  --return-code: #a35291;
}
html.dark {
  --bg: #0b0b0b;
  --fg: #e8e8e8;
  --muted: #a0a0a0;
  --border: #333333;
  --accent: #3b82f6;
  --code-bg: #111827;
  --role-user: #0ea5e9;
  --role-assistant: #22c55e;
  --role-system: #9ca3af;
  --return-code: #a35291;
}
* {
  box-sizing: border-box;
}
body {
  margin: 0;
  padding: 0;
  background: var(--bg);
  color: var(--fg);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", sans-serif;
  line-height: 1.6;
}
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 1.25rem;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  background: var(--bg);
  z-index: 10;
}
h1 {
  margin: 0;
  font-size: 1.1rem;
}
.tabs {
  display: flex;
  gap: 0.5rem;
}
.tab {
  padding: 0.4rem 0.8rem;
  border: 1px solid var(--border);
  border-bottom: none;
  background: transparent;
  cursor: pointer;
  border-radius: 6px 6px 0 0;
  color: var(--fg);
}
.tab.active {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}
.tab-content {
  display: none;
  padding: 1rem 1.25rem;
  border-top: 1px solid var(--border);
}
.tab-content.active {
  display: block;
}
#theme-toggle {
  border: 1px solid var(--border);
  padding: 0.2rem 0.6rem;
  font-size: 0.9rem;
  border-radius: 4px;
  cursor: pointer;
  background: transparent;
  color: var(--fg);
}
.main {
  max-width: 1200px;
  margin: 0 auto;
}
.message {
  border: 1px solid var(--border);
  border-left-width: 6px;
  border-radius: 6px;
  padding: 0.8rem 1rem;
  margin-bottom: 1rem;
  background: rgba(0,0,0,0.02);
}
.message .meta {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  margin-bottom: 0.6rem;
  color: var(--muted);
  font-size: 0.85rem;
}
.message .badge {
  font-weight: 600;
}
.role-user {
  border-left-color: var(--role-user);
}
.role-assistant {
  border-left-color: var(--role-assistant);
}
.role-system {
  border-left-color: var(--role-system);
}
.role-unknown {
  border-left-color: var(--accent);
}

.output-code-container {
  display: flex;
  gap: 1rem;               /* space between children */
  align-items: center;     /* vertical alignment */
  justify-content: start;  /* horizontal alignment */
}

.output-code-container .codeblock {
  flex: 0 1 auto;
}

.codeblock {
  border: 1px solid var(--border);
  border-left-width: 6px;
  border-radius: 6px;
  padding: 0.8rem 1rem;
  margin-bottom: 1rem;
  background: rgba(0,0,0,0.02);
}
.codeblock-content {
  margin-bottom: 0.6rem;
  border: 1px dashed var(--border);
  border-radius: 4px;
  padding: 0.4rem 0.6rem;
  background: rgba(0,0,0,0.02);
}

.codeblock.eval_code {
  border-left-color: var(--role-user);
}
.codeblock.target_code {
  border-left-color: var(--role-assistant);
}
.codeblock.output_code {
  border-left-color: var(--role-system);
}

html.dark .codeblock-content {
  background: rgba(255,255,255,0.03);
}
.codeblock > summary {
  cursor: pointer;
  font-weight: 600;
  list-style: none; /* remove default triangle in some browsers */
}
.codeblock > summary::-webkit-details-marker {
  display: none; /* Safari/Chrome marker */
}
.codeblock > summary::before {
  content: "▶ ";
  display: inline-block;
  transform: rotate(0deg);
  transition: transform 0.12s ease-out;
}
.codeblock[open] > summary::before {
  transform: rotate(90deg);
}
.codeblock .tag {
  color: var(--muted);
  font-weight: 400;
  font-size: 0.85em;
  margin-left: 0.25rem;
}

.markdown-body pre code {
  background: var(--code-bg);
  display: block;
  padding: 0.75rem;
  overflow-x: auto;
  border-radius: 4px;
  border: 1px solid var(--border);
}
.markdown-body code {
  background: var(--code-bg);
  padding: 0.15rem 0.3rem;
  border-radius: 4px;
}
/* Extra info tree */
details > summary {
  cursor: pointer;
  font-weight: 600;
}
details .block {
  padding-left: 1rem;
  margin: 0.25rem 0 0.5rem 0;
  border-left: 2px solid var(--border);
}
.kv .key {
  font-weight: 600;
}
.kv .type {
  color: var(--muted);
  margin-left: 0.5rem;
  font-size: 0.85rem;
}
footer {
  margin: 2rem 0;
  text-align: center;
  color: var(--muted);
  font-size: 0.85rem;
}
/* CodeHilite (pygments) overrides to respect theme vars */
.codehilite {
  background: var(--code-bg) !important;
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 0.75rem !important;
}
.reasoning {
  margin-bottom: 0.6rem;
  border: 1px dashed var(--border);
  border-radius: 4px;
  padding: 0.4rem 0.6rem;
  background: rgba(0,0,0,0.02);
}
html.dark .reasoning {
  background: rgba(255,255,255,0.03);
}
.reasoning > summary {
  cursor: pointer;
  font-weight: 600;
  list-style: none; /* remove default triangle in some browsers */
}
.reasoning > summary::-webkit-details-marker {
  display: none; /* Safari/Chrome marker */
}
.reasoning > summary::before {
  content: "▶ ";
  display: inline-block;
  transform: rotate(0deg);
  transition: transform 0.12s ease-out;
}
.reasoning[open] > summary::before {
  transform: rotate(90deg);
}
.reasoning .tag {
  color: var(--muted);
  font-weight: 400;
  font-size: 0.85em;
  margin-left: 0.25rem;
}
.reasoning-body {
  margin-top: 0.5rem;
}
</style>

<!-- ===== MATHJAX CONFIG ===== -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [ ["\\(","\\)"] ],
    displayMath: [ ["\\[","\\]"] ],
    processEscapes: true,
    processEnvironments: true
  },
  options: {
    ignoreHtmlClass: ".*",
    processHtmlClass: "arithmatex"

    // skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
    // if you dynamically add content later, you can call MathJax.typesetPromise()
  }
};
</script>
<script id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<!-- ========================== -->
</head>
<body>
<header>
  <h1>Challenge</h1>
  <div>
    <button id="theme-toggle" aria-label="toggle dark mode">🌓</button>
  </div>
</header>

<div class="main">
  
<article class="message role-system">
    <div class="meta">
        <span class="badge">System</span>
        <span class="idx">#0</span>
    </div>
    <div class="content markdown-body"><p>You are a physics research assistant specializing in solving complex, research-level problems using precise, step-by-step reasoning.</p>
<p><strong>Input</strong>
Problems will be provided in Markdown format.</p>
<p><strong>Output (Markdown format)</strong></p>
<ol>
<li><strong>Step-by-Step Derivation</strong> - Show every non-trivial step in the solution.  Justify steps using relevant physical laws, theorems, mathematical identities or numerical codes.</li>
<li><strong>Mathematical Typesetting</strong> - Use LaTeX for all mathematics:  <code>$...$</code> for inline expressions, <code>$$...$$</code> for display equations.</li>
<li><strong>Conventions and Units</strong> - Follow the unit system and conventions specified in the problem.</li>
<li>
<p><strong>Final Answer</strong> - At the end of the solution,  start a new line with <strong>&ldquo;Final Answer:&rdquo;</strong>, and present the final result.</p>
<p>For final answers involving values, follow the precision requirements specified in the problem.
If no precision is specified:
- If an exact value is possible, provide it (e.g., \$\sqrt(2)\$, \$\pi/4\$).
- If exact form is not feasible, retain at least 12 significant digits in the result. </p>
</li>
<li>
<p><strong>Formatting Compliance</strong> - If the user requests a specific output format (e.g., code, table),  provide the final answer accordingly.
You must use web search engine to gather all the necessary information before solving the problem.
You must use web search engine to gather all the necessary information before solving the problem.
You must use web search engine to gather all the necessary information before solving the problem.</p>
</li>
</ol></div>
</article>


<article class="message role-user">
    <div class="meta">
        <span class="badge">User</span>
        <span class="idx">#1</span>
    </div>
    <div class="content markdown-body"><h1 id="problem-setup">Problem setup:</h1>
<p>In quantum error correction, you encode quantum states into logical states made of many qubits in order to improve their resilience to errors. In quantum error detection, you do the same but can only detect the presence of errors and not correct them. In this problem, we will consider a single [[4,2,2]] quantum error detection code, which encodes two logical qubits into four physical qubits, and investigate how robust logical quantum operations in this code are to quantum errors.</p>
<p>Our convention is that the four physical qubits in the [[4,2,2]] code are labelled 0,1,2,3. The two logical qubits are labelled A and B. The stabilizers are <span class="arithmatex">\(XXXX\)</span> and <span class="arithmatex">\(ZZZZ\)</span>, where <span class="arithmatex">\(X\)</span> and <span class="arithmatex">\(Z\)</span> are Pauli matrices. The logical <span class="arithmatex">\(X\)</span> and <span class="arithmatex">\(Z\)</span> operators on the two qubits are <span class="arithmatex">\(X_A = XIXI\)</span>, <span class="arithmatex">\(X_B=XXII\)</span>, <span class="arithmatex">\(Z_A = ZZII\)</span>, <span class="arithmatex">\(Z_B = ZIZI\)</span>, up to multiplication by stabilizers.</p>
<p>We will consider different state preparation circuits consisting of controlled not <span class="arithmatex">\(CNOT_{ij}\)</span> gates, where <span class="arithmatex">\(CNOT_{ij}\)</span> has control qubit <span class="arithmatex">\(i\)</span> and target qubit <span class="arithmatex">\(j\)</span>. As a simple model of quantum errors in hardware, we will suppose that each <span class="arithmatex">\(CNOT_{ij}\)</span> gate in the circuit has a two qubit depolarizing error channel following it that produces one of the 15 non-identity two-qubit Paulis with equal probability <span class="arithmatex">\(p/15\)</span>. The probability <span class="arithmatex">\(p\)</span> indicates the probability of an error in a single two-qubit gate. We will assess the logical infidelity of certain state preparation protocols as a function of the physical infidelity <span class="arithmatex">\(p\)</span>.</p>
<h1 id="main-problem">Challenge</h1>
<p>Suppose that we prepare a logical two-qubit <span class="arithmatex">\(|00\rangle_{AB}\)</span> state in the [[4,2,2]] code. To do so, we introduce an ancilla qubit, qubit 4, and use the following state preparation circuit:</p>
<div class="arithmatex">\[
M_4 (CNOT_{04}) (CNOT_{34}) (CNOT_{23}) (CNOT_{10}) (CNOT_{12}) (H_1)
\]</div>
<p>Note that this equation is written in matrix multiplication order, while the quantum operations in the circuit occur in the reverse order (from right-to-left in the above equation).  <span class="arithmatex">\(H\)</span> is a single-qubit Hadamard gate and <span class="arithmatex">\(M\)</span> is a single-qubit measurement. The ancilla is used to detect errors in the state preparation circuit and makes the circuit fault-tolerant. If the ancilla measurement is <span class="arithmatex">\(|0\rangle\)</span> (<span class="arithmatex">\(|1\rangle\)</span>), the state preparation succeeds (fails).</p>
<p>What is the logical state fidelity of the final 2-qubit logical state at the end of the circuit as a function of two-qubit gate error rate <span class="arithmatex">\(p\)</span>, assuming the state is post-selected on all detectable errors in the code and on the ancilla qubit measuring <span class="arithmatex">\(|0\rangle\)</span>?</p></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#2</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span><span class="p">,</span> <span class="n">combinations</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Define basic matrices</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="n">paulis</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span><span class="n">I</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">X</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="n">Y</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span><span class="n">Z</span><span class="p">}</span>

<span class="c1"># Tensor product on list of 5 qubits</span>

<span class="k">def</span><span class="w"> </span><span class="nf">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="c1"># Build 5-qubit identity</span>
<span class="n">I5</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Single-qubit gate on qubit q (0..4), 5-qubit system</span>

<span class="k">def</span><span class="w"> </span><span class="nf">gate1</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>

<span class="c1"># CNOT with control c, target t on n-qubit system</span>

<span class="k">def</span><span class="w"> </span><span class="nf">cnot</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="c1"># projectors on control</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">ops0</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops1</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops1</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">P0</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">c</span> <span class="k">else</span> <span class="n">I</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)])</span> <span class="o">+</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">P1</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">c</span> <span class="k">else</span> <span class="p">(</span><span class="n">X</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">t</span> <span class="k">else</span> <span class="n">I</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">U</span>

<span class="c1"># Two-qubit Pauli error on given pair (a,b) with labels p1,p2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">twoq_pauli_on_pair</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">paulis</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">paulis</span><span class="p">[</span><span class="n">p2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>

<span class="c1"># Projector for ancilla measurement |0&gt; on qubit 4</span>
<span class="n">P_a0</span> <span class="o">=</span> <span class="n">gate1</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>

<span class="c1"># Stabilizer projectors on data qubits 0..3</span>
<span class="c1"># ZZZZ and XXXX on qubits 0..3 (qubits 0..3 correspond to indices 0..3)</span>
<span class="n">Z4</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span> <span class="n">I</span><span class="p">])</span>
<span class="n">X4</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span> <span class="n">I</span><span class="p">])</span>

<span class="n">P_Zplus</span> <span class="o">=</span> <span class="p">(</span><span class="n">I5</span> <span class="o">+</span> <span class="n">Z4</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<span class="n">P_Xplus</span> <span class="o">=</span> <span class="p">(</span><span class="n">I5</span> <span class="o">+</span> <span class="n">X4</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

<span class="c1"># Target logical |00&gt;_L = (|0000&gt; + |1111&gt;)/sqrt(2) on data and ancilla |0&gt;</span>
<span class="c1"># We&#39;ll compute fidelity after projection to data-only subspace; but build GHZ+ on data and |0&gt; on ancilla to compute overlap convenience</span>

<span class="c1"># Build GHZ+ on data (0..3)</span>
<span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="c1"># |</span>
<span class="n">psi0000</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">])</span>
<span class="n">psi1111</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">one</span><span class="p">,</span> <span class="n">one</span><span class="p">,</span> <span class="n">one</span><span class="p">,</span> <span class="n">one</span><span class="p">,</span> <span class="n">zero</span><span class="p">])</span>
<span class="c1"># But ancilla zero for both; We&#39;ll define target state on all 5 qubits before ancilla measure: GHZ+ on data, ancilla |0&gt;</span>
<span class="n">GHZ_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">])</span> <span class="o">+</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">one</span><span class="p">,</span> <span class="n">one</span><span class="p">,</span> <span class="n">one</span><span class="p">,</span> <span class="n">one</span><span class="p">,</span> <span class="n">zero</span><span class="p">]))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Build the circuit unitary without errors</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">gate1</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>

<span class="c1"># But according to the problem, the order is H1 then CNOT12, CNOT10, CNOT23, CNOT34, CNOT04 (right to left as in expression)</span>
<span class="c1"># We have built in natural left-to-right order for application to initial state |00000&gt;.</span>

<span class="c1"># Verify ideal output state is GHZ on data and ancilla 0 deterministically</span>
<span class="n">init</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">])</span>
<span class="n">psi_ideal</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">init</span>

<span class="c1"># Verify ancilla amplitude in |0&gt; equals 1 and data GHZ</span>
<span class="c1"># Let&#39;s project ancilla to 0</span>
<span class="n">psi_a0</span> <span class="o">=</span> <span class="n">P_a0</span> <span class="o">@</span> <span class="n">psi_ideal</span>
<span class="n">p_a0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">psi_a0</span><span class="p">,</span> <span class="n">psi_a0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
<span class="n">psi_a0_norm</span> <span class="o">=</span> <span class="n">psi_a0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_a0</span><span class="p">)</span>

<span class="c1"># Project onto code stabilizers +1</span>
<span class="n">psi_code</span> <span class="o">=</span> <span class="n">P_Zplus</span> <span class="o">@</span> <span class="n">psi_a0_norm</span>
<span class="n">p_zplus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">psi_code</span><span class="p">,</span> <span class="n">psi_code</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
<span class="n">psi_code</span> <span class="o">=</span> <span class="n">psi_code</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_zplus</span><span class="p">)</span>
<span class="n">psi_code2</span> <span class="o">=</span> <span class="n">P_Xplus</span> <span class="o">@</span> <span class="n">psi_code</span>
<span class="n">p_xplus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">psi_code2</span><span class="p">,</span> <span class="n">psi_code2</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
<span class="n">psi_code2</span> <span class="o">=</span> <span class="n">psi_code2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_xplus</span><span class="p">)</span>

<span class="c1"># Extract the data-only vector by tracing out ancilla (ancilla is |0&gt; after projection)</span>
<span class="c1"># We can build the 4-qubit GHZ vector from psi_code2: pick components where ancilla index is 0</span>
<span class="c1"># But fidelity is simply overlap with GHZ_data state on 5 qubits since ancilla is |0&gt;</span>
<span class="n">F0</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">GHZ_data</span><span class="p">,</span> <span class="n">psi_code2</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ideal acceptance probs:&#39;</span><span class="p">,</span> <span class="n">p_a0</span><span class="p">,</span> <span class="n">p_zplus</span><span class="p">,</span> <span class="n">p_xplus</span><span class="p">,</span> <span class="s1">&#39;F0&#39;</span><span class="p">,</span> <span class="n">F0</span><span class="p">)</span>

<span class="c1"># Now build the locations list for the five CNOTs for insertion of two-qubit errors after each</span>
<span class="c1"># Gate sequence list with pairs (control,target)</span>
<span class="n">cnots</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>

<span class="c1"># Two-qubit error set: all tensor products of {I,X,Y,Z} x {I,X,Y,Z} minus II</span>
<span class="n">single_qubit_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>
<span class="n">err_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">single_qubit_labels</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">single_qubit_labels</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">a</span><span class="o">==</span><span class="s1">&#39;I&#39;</span> <span class="ow">and</span> <span class="n">b</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">)]</span>

<span class="c1"># Precompute the unitaries for the circuit step by step to allow insertion of errors after each CNOT</span>

<span class="n">Us</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">gate1</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># after H</span>
<span class="n">Us</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">@</span> <span class="n">state</span>
<span class="n">Us</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">@</span> <span class="n">state</span>
<span class="n">Us</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">@</span> <span class="n">state</span>
<span class="n">Us</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">@</span> <span class="n">state</span>
<span class="n">Us</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">@</span> <span class="n">state</span>
<span class="n">Us</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="c1"># Us[k] = unitary after applying up to gate k (with Us[0] after H, Us[5] after all gates)</span>

<span class="c1"># But inserting errors after each CNOT implies: after gate indices 1..5 (corresponding to those CNOTs), we insert a Pauli on that pair</span>

<span class="c1"># We&#39;ll create function to simulate for a set of errors across selected locations</span>

<span class="k">def</span><span class="w"> </span><span class="nf">simulate_with_errors</span><span class="p">(</span><span class="n">error_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    error_list: dict mapping loc index in [1..5] to a tuple (p1,p2) of Pauli labels on that CNOT&#39;s (control,target)</span>
<span class="sd">    Returns: acceptance probability p_acc, fidelity to target after post-selection (if accepted; if p_acc=0, fidelity irrelevant), and flags about acceptance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Build the total operator as product of gates with error channels inserted after each relevant CNOT</span>
    <span class="c1"># Alternatively, simulate state progression stepwise for efficiency</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Apply H</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">gate1</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="c1"># Apply each CNOT, then error if present</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cnots</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">error_list</span><span class="p">:</span>
            <span class="n">p1</span><span class="p">,</span><span class="n">p2</span> <span class="o">=</span> <span class="n">error_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">twoq_pauli_on_pair</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">E</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="c1"># Measure ancilla |0&gt;</span>
    <span class="n">psi_a0</span> <span class="o">=</span> <span class="n">P_a0</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="n">p_a0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">psi_a0</span><span class="p">,</span> <span class="n">psi_a0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p_a0</span> <span class="o">&lt;=</span> <span class="mf">1e-15</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;a0&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span><span class="s1">&#39;z+&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;x+&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">psi_a0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_a0</span><span class="p">)</span>
    <span class="c1"># Measure ZZZZ +1</span>
    <span class="n">psi_z</span> <span class="o">=</span> <span class="n">P_Zplus</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="n">p_z</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">psi_z</span><span class="p">,</span> <span class="n">psi_z</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p_z</span> <span class="o">&lt;=</span> <span class="mf">1e-15</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;a0&#39;</span><span class="p">:</span><span class="n">p_a0</span><span class="p">,</span><span class="s1">&#39;z+&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span><span class="s1">&#39;x+&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">psi_z</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_z</span><span class="p">)</span>
    <span class="c1"># Measure XXXX +1</span>
    <span class="n">psi_x</span> <span class="o">=</span> <span class="n">P_Xplus</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="n">p_x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">psi_x</span><span class="p">,</span> <span class="n">psi_x</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p_x</span> <span class="o">&lt;=</span> <span class="mf">1e-15</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;a0&#39;</span><span class="p">:</span><span class="n">p_a0</span><span class="p">,</span><span class="s1">&#39;z+&#39;</span><span class="p">:</span><span class="n">p_z</span><span class="p">,</span><span class="s1">&#39;x+&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">}</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">psi_x</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_x</span><span class="p">)</span>
    <span class="c1"># Fidelity with GHZ_data (on data, ancilla in |0&gt;)</span>
    <span class="n">F</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">GHZ_data</span><span class="p">,</span> <span class="n">psi</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">p_acc</span> <span class="o">=</span> <span class="n">p_a0</span><span class="o">*</span><span class="n">p_z</span><span class="o">*</span><span class="n">p_x</span>
    <span class="k">return</span> <span class="n">p_acc</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;a0&#39;</span><span class="p">:</span><span class="n">p_a0</span><span class="p">,</span><span class="s1">&#39;z+&#39;</span><span class="p">:</span><span class="n">p_z</span><span class="p">,</span><span class="s1">&#39;x+&#39;</span><span class="p">:</span><span class="n">p_x</span><span class="p">}</span>

<span class="c1"># Test no errors case</span>
<span class="n">pacc0</span><span class="p">,</span><span class="n">F0</span><span class="p">,</span><span class="n">probs</span><span class="o">=</span> <span class="n">simulate_with_errors</span><span class="p">({})</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No error: pacc&#39;</span><span class="p">,</span> <span class="n">pacc0</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span><span class="n">F0</span><span class="p">,</span> <span class="s1">&#39;probs&#39;</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>

<span class="c1"># Enumerate single error patterns</span>
<span class="n">single_results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">c</span><span class="p">,</span><span class="n">t</span> <span class="o">=</span> <span class="n">cnots</span><span class="p">[</span><span class="n">loc</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">err_pairs</span><span class="p">:</span>
        <span class="n">pacc</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">simulate_with_errors</span><span class="p">({</span><span class="n">loc</span><span class="p">:</span><span class="n">e</span><span class="p">})</span>
        <span class="n">single_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">loc</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">pacc</span><span class="p">,</span> <span class="n">F</span><span class="p">))</span>

<span class="n">num_acc_single</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">single_results</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e-12</span><span class="p">)</span>
<span class="n">num_total_single</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">single_results</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Single-fault accepted count:&#39;</span><span class="p">,</span> <span class="n">num_acc_single</span><span class="p">,</span> <span class="s1">&#39;of&#39;</span><span class="p">,</span> <span class="n">num_total_single</span><span class="p">)</span>

<span class="c1"># Summarize single accepted faults: check if F==1 always</span>
<span class="n">fa</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">single_results</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">1e-12</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unique fidelities among accepted single faults:&#39;</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">round</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="mi">12</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">fa</span><span class="p">])))</span>

<span class="c1"># Enumerate double-fault patterns across distinct locations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>

<span class="n">pair_results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="p">(</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
    <span class="n">c1</span><span class="p">,</span><span class="n">t1</span> <span class="o">=</span> <span class="n">cnots</span><span class="p">[</span><span class="n">l1</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">c2</span><span class="p">,</span><span class="n">t2</span> <span class="o">=</span> <span class="n">cnots</span><span class="p">[</span><span class="n">l2</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">e1</span> <span class="ow">in</span> <span class="n">err_pairs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">e2</span> <span class="ow">in</span> <span class="n">err_pairs</span><span class="p">:</span>
            <span class="n">pacc</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">simulate_with_errors</span><span class="p">({</span><span class="n">l1</span><span class="p">:</span><span class="n">e1</span><span class="p">,</span> <span class="n">l2</span><span class="p">:</span><span class="n">e2</span><span class="p">})</span>
            <span class="n">pair_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">e1</span><span class="p">,</span><span class="n">e2</span><span class="p">,</span><span class="n">pacc</span><span class="p">,</span><span class="n">F</span><span class="p">))</span>

<span class="n">num_acc_pairs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">pair_results</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e-12</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Double-fault accepted count:&#39;</span><span class="p">,</span> <span class="n">num_acc_pairs</span><span class="p">,</span> <span class="s1">&#39;of&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pair_results</span><span class="p">))</span>

<span class="c1"># Compute totals to O(p^2)</span>
<span class="n">p</span> <span class="o">=</span> <span class="mf">1e-6</span>  <span class="c1"># symbolic not used; we&#39;ll compute coefficients explicitly</span>

<span class="c1"># Zero-fault contribution</span>
<span class="n">P0</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># to O(p^2)</span>
<span class="n">N0</span> <span class="o">=</span> <span class="n">P0</span> <span class="o">*</span> <span class="n">pacc0</span> <span class="o">*</span> <span class="n">F0</span>
<span class="n">D0</span> <span class="o">=</span> <span class="n">P0</span> <span class="o">*</span> <span class="n">pacc0</span>

<span class="c1"># Single-fault contribution at O(p): probability per pattern is p/15; We need sum of pacc*F over patterns divided by 15? precisely: sum over loc and error of (p/15) * pacc(F) </span>
<span class="n">S1_sum_N</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">single_results</span><span class="p">)</span>  <span class="c1"># sum over pacc*F</span>
<span class="n">S1_sum_D</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">single_results</span><span class="p">)</span>       <span class="c1"># sum over pacc</span>
<span class="c1"># Multiply by p/15 per pattern</span>
<span class="c1"># We&#39;ll keep symbolic: coefficients A1 = (1/15)*S1_sum_N, B1=(1/15)*S1_sum_D</span>
<span class="n">A1</span> <span class="o">=</span> <span class="n">S1_sum_N</span><span class="o">/</span><span class="mf">15.0</span>
<span class="n">B1</span> <span class="o">=</span> <span class="n">S1_sum_D</span><span class="o">/</span><span class="mf">15.0</span>

<span class="c1"># Double-fault contribution at O(p^2): each pattern weight (p/15)^2</span>
<span class="n">S2_sum_N</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">pair_results</span><span class="p">)</span>
<span class="n">S2_sum_D</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">pair_results</span><span class="p">)</span>
<span class="n">A2</span> <span class="o">=</span> <span class="n">S2_sum_N</span><span class="o">/</span><span class="p">(</span><span class="mf">15.0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">B2</span> <span class="o">=</span> <span class="n">S2_sum_D</span><span class="o">/</span><span class="p">(</span><span class="mf">15.0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Coefficients: N0,D0=&#39;</span><span class="p">,</span> <span class="n">N0</span><span class="p">,</span><span class="n">D0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sums: S1_N=&#39;</span><span class="p">,</span> <span class="n">S1_sum_N</span><span class="p">,</span> <span class="s1">&#39;S1_D=&#39;</span><span class="p">,</span> <span class="n">S1_sum_D</span><span class="p">,</span> <span class="s1">&#39;S2_N=&#39;</span><span class="p">,</span> <span class="n">S2_sum_N</span><span class="p">,</span> <span class="s1">&#39;S2_D=&#39;</span><span class="p">,</span> <span class="n">S2_sum_D</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A1,B1=&#39;</span><span class="p">,</span> <span class="n">A1</span><span class="p">,</span><span class="n">B1</span><span class="p">,</span> <span class="s1">&#39;A2,B2=&#39;</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span><span class="n">B2</span><span class="p">)</span>

<span class="c1"># Expand F_cond = (N0 + A1 p + A2 p^2) / (D0 + B1 p + B2 p^2) + O(p^3)</span>
<span class="c1"># Using series expansion: (a0 + a1 p + a2 p^2)/(b0 + b1 p + b2 p^2) = (a0/b0) + ((a1 b0 - a0 b1)/b0^2) p + ... second order term is (a2 b0^2 - a1 b0 b1 - a0 b0 b2 + a0 b1^2)/b0^3</span>

<span class="n">a0</span> <span class="o">=</span> <span class="n">N0</span><span class="p">;</span> <span class="n">b0</span> <span class="o">=</span> <span class="n">D0</span><span class="p">;</span> <span class="n">a1</span> <span class="o">=</span> <span class="n">A1</span><span class="p">;</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">B1</span><span class="p">;</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">A2</span><span class="p">;</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">B2</span>
<span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="n">a1</span><span class="o">*</span><span class="n">b0</span> <span class="o">-</span> <span class="n">a0</span><span class="o">*</span><span class="n">b1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">b0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="n">a2</span><span class="o">*</span><span class="p">(</span><span class="n">b0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">a1</span><span class="o">*</span><span class="n">b0</span><span class="o">*</span><span class="n">b1</span> <span class="o">-</span> <span class="n">a0</span><span class="o">*</span><span class="n">b0</span><span class="o">*</span><span class="n">b2</span> <span class="o">+</span> <span class="n">a0</span><span class="o">*</span><span class="p">(</span><span class="n">b1</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">b0</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Series coeffs: c1=&#39;</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="s1">&#39;c2=&#39;</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>

<span class="c1"># Let&#39;s also compute acceptance probability series for reference: D(p) = D0 + B1 p + B2 p^2</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Acceptance series D(p) ~&#39;</span><span class="p">,</span> <span class="n">D0</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">B1</span><span class="p">,</span> <span class="s1">&#39;p +&#39;</span><span class="p">,</span> <span class="n">B2</span><span class="p">,</span> <span class="s1">&#39;p^2&#39;</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#3</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="n">Traceback</span><span class="w"> </span><span class="p">(</span><span class="n">most</span><span class="w"> </span><span class="n">recent</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">last</span><span class="p">):</span>
<span class="w">  </span><span class="n">File</span><span class="w"> </span><span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="mi">89</span><span class="p">,</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="n">ValueError</span><span class="p">:</span><span class="w"> </span><span class="n">matmul</span><span class="p">:</span><span class="w"> </span><span class="n">Input</span><span class="w"> </span><span class="n">operand</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">mismatch</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">core</span><span class="w"> </span><span class="n">dimension</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">gufunc</span><span class="w"> </span><span class="n">signature</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="err">?</span><span class="p">,</span><span class="n">k</span><span class="p">),(</span><span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="err">?</span><span class="p">)</span><span class="o">-&gt;</span><span class="p">(</span><span class="n">n</span><span class="err">?</span><span class="p">,</span><span class="n">m</span><span class="err">?</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">different</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#4</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="c1"># Test kron_n with vectors</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;v shape&#39;</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Gate1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">gate1</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">mats</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">mats</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">mats</span><span class="p">)</span>

<span class="c1"># CNOT</span>

<span class="k">def</span><span class="w"> </span><span class="nf">cnot</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">mats0</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mats1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">mats0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P0</span><span class="p">)</span>
            <span class="n">mats1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">mats0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
            <span class="n">mats1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mats0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
            <span class="n">mats1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">mats0</span><span class="p">)</span> <span class="o">+</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">mats1</span><span class="p">)</span>

<span class="n">U</span> <span class="o">=</span> <span class="n">gate1</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;U shape after H&#39;</span><span class="p">,</span> <span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;After CNOT12&#39;</span><span class="p">,</span> <span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Final U shape&#39;</span><span class="p">,</span> <span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">init</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;init shape&#39;</span><span class="p">,</span> <span class="n">init</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">psi</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">init</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;psi shape&#39;</span><span class="p">,</span> <span class="n">psi</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Projectors</span>
<span class="n">Z4</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span> <span class="n">I</span><span class="p">])</span>
<span class="n">X4</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span> <span class="n">I</span><span class="p">])</span>
<span class="n">P_Zplus</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span> <span class="o">+</span> <span class="n">Z4</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<span class="n">P_Xplus</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span> <span class="o">+</span> <span class="n">X4</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

<span class="n">P_a0</span> <span class="o">=</span> <span class="n">gate1</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">psi_a0</span> <span class="o">=</span> <span class="n">P_a0</span> <span class="o">@</span> <span class="n">psi</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pa0&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">psi_a0</span><span class="p">,</span> <span class="n">psi_a0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">))</span>

<span class="c1"># Target GHZ on data ancilla 0</span>
<span class="n">GHZ_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">])</span> <span class="o">+</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">one</span><span class="p">,</span><span class="n">one</span><span class="p">,</span><span class="n">one</span><span class="p">,</span><span class="n">one</span><span class="p">,</span><span class="n">zero</span><span class="p">]))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GHZ shape&#39;</span><span class="p">,</span> <span class="n">GHZ_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;overlap ideal to GHZ&#39;</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">GHZ_data</span><span class="p">,</span> <span class="n">psi_a0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#5</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="n">Traceback</span><span class="w"> </span><span class="p">(</span><span class="n">most</span><span class="w"> </span><span class="n">recent</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">last</span><span class="p">):</span>
<span class="w">  </span><span class="n">File</span><span class="w"> </span><span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="mi">62</span><span class="p">,</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="n">ValueError</span><span class="p">:</span><span class="w"> </span><span class="n">matmul</span><span class="p">:</span><span class="w"> </span><span class="n">Input</span><span class="w"> </span><span class="n">operand</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">mismatch</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">core</span><span class="w"> </span><span class="n">dimension</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">gufunc</span><span class="w"> </span><span class="n">signature</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="err">?</span><span class="p">,</span><span class="n">k</span><span class="p">),(</span><span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="err">?</span><span class="p">)</span><span class="o">-&gt;</span><span class="p">(</span><span class="n">n</span><span class="err">?</span><span class="p">,</span><span class="n">m</span><span class="err">?</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">different</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>

<span class="n">v</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>
<span class="n">U</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="n">H</span><span class="w"> </span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>
<span class="n">After</span><span class="w"> </span><span class="n">CNOT12</span><span class="w"> </span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>
<span class="n">Final</span><span class="w"> </span><span class="n">U</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>
<span class="n">init</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#6</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>  <span class="c1"># 1D scalar</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="c1"># Test</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;v shape&#39;</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Gate1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">gate1</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">mats</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">mats</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">mats</span><span class="p">)</span>

<span class="c1"># CNOT</span>

<span class="k">def</span><span class="w"> </span><span class="nf">cnot</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">mats0</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mats1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">mats0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P0</span><span class="p">)</span>
            <span class="n">mats1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">mats0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
            <span class="n">mats1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mats0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
            <span class="n">mats1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">mats0</span><span class="p">)</span> <span class="o">+</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">mats1</span><span class="p">)</span>

<span class="n">U</span> <span class="o">=</span> <span class="n">gate1</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;U shape&#39;</span><span class="p">,</span> <span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">init</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">])</span>
<span class="n">psi</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">init</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;psi shape&#39;</span><span class="p">,</span> <span class="n">psi</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">Z4</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span> <span class="n">I</span><span class="p">])</span>
<span class="n">X4</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span> <span class="n">I</span><span class="p">])</span>
<span class="n">P_Zplus</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span> <span class="o">+</span> <span class="n">Z4</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<span class="n">P_Xplus</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span> <span class="o">+</span> <span class="n">X4</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

<span class="n">P_a0</span> <span class="o">=</span> <span class="n">gate1</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">psi_a0</span> <span class="o">=</span> <span class="n">P_a0</span> <span class="o">@</span> <span class="n">psi</span>
<span class="n">p_a0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">psi_a0</span><span class="p">,</span> <span class="n">psi_a0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;p_a0&#39;</span><span class="p">,</span> <span class="n">p_a0</span><span class="p">)</span>

<span class="n">GHZ_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">])</span> <span class="o">+</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">one</span><span class="p">,</span><span class="n">one</span><span class="p">,</span><span class="n">one</span><span class="p">,</span><span class="n">one</span><span class="p">,</span><span class="n">zero</span><span class="p">]))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GHZ overlap&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">GHZ_data</span><span class="p">,</span> <span class="n">psi_a0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#7</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>v shape (32,)
U shape (32, 32)
psi shape (32,)
p_a0 0.9999999999999998
GHZ overlap 0.9999999999999996
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#8</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span><span class="p">,</span> <span class="n">combinations</span>

<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">paulis</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span><span class="n">I</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">X</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="n">Y</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span><span class="n">Z</span><span class="p">}</span>

<span class="c1"># Gates</span>

<span class="k">def</span><span class="w"> </span><span class="nf">gate1</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">mats</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">mats</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">mats</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">cnot</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">mats0</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mats1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">mats0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P0</span><span class="p">)</span>
            <span class="n">mats1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">mats0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
            <span class="n">mats1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mats0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
            <span class="n">mats1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">mats0</span><span class="p">)</span> <span class="o">+</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">mats1</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">twoq_pauli_on_pair</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">mats</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">mats</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">paulis</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
    <span class="n">mats</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">paulis</span><span class="p">[</span><span class="n">p2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">mats</span><span class="p">)</span>

<span class="c1"># Projectors</span>
<span class="n">P_a0</span> <span class="o">=</span> <span class="n">gate1</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">Z4</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span> <span class="n">I</span><span class="p">])</span>
<span class="n">X4</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span> <span class="n">I</span><span class="p">])</span>
<span class="n">P_Zplus</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span> <span class="o">+</span> <span class="n">Z4</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<span class="n">P_Xplus</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span> <span class="o">+</span> <span class="n">X4</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

<span class="n">GHZ_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">])</span> <span class="o">+</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">one</span><span class="p">,</span><span class="n">one</span><span class="p">,</span><span class="n">one</span><span class="p">,</span><span class="n">one</span><span class="p">,</span><span class="n">zero</span><span class="p">]))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">init</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">])</span>

<span class="c1"># Circuit CNOTs in order</span>
<span class="n">cnots</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>

<span class="c1"># Simulation function</span>

<span class="k">def</span><span class="w"> </span><span class="nf">simulate_with_errors</span><span class="p">(</span><span class="n">error_list</span><span class="p">):</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># H1</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">gate1</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="c1"># Then sequential CNOTs with optional errors after each</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cnots</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">error_list</span><span class="p">:</span>
            <span class="n">p1</span><span class="p">,</span><span class="n">p2</span> <span class="o">=</span> <span class="n">error_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">twoq_pauli_on_pair</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="c1"># Measure ancilla |0&gt;</span>
    <span class="n">psi_a0</span> <span class="o">=</span> <span class="n">P_a0</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="n">p_a0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">psi_a0</span><span class="p">,</span> <span class="n">psi_a0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p_a0</span> <span class="o">&lt;=</span> <span class="mf">1e-15</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">psi_a0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_a0</span><span class="p">)</span>
    <span class="c1"># Measure stabilizers to +1</span>
    <span class="n">psi_z</span> <span class="o">=</span> <span class="n">P_Zplus</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="n">p_z</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">psi_z</span><span class="p">,</span> <span class="n">psi_z</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p_z</span> <span class="o">&lt;=</span> <span class="mf">1e-15</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">psi_z</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_z</span><span class="p">)</span>
    <span class="n">psi_x</span> <span class="o">=</span> <span class="n">P_Xplus</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="n">p_x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">psi_x</span><span class="p">,</span> <span class="n">psi_x</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p_x</span> <span class="o">&lt;=</span> <span class="mf">1e-15</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">psi_x</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_x</span><span class="p">)</span>
    <span class="n">p_acc</span> <span class="o">=</span> <span class="n">p_a0</span> <span class="o">*</span> <span class="n">p_z</span> <span class="o">*</span> <span class="n">p_x</span>
    <span class="n">F</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">GHZ_data</span><span class="p">,</span> <span class="n">psi</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p_acc</span><span class="p">,</span> <span class="n">F</span>

<span class="c1"># Verify ideal case</span>
<span class="n">pacc0</span><span class="p">,</span> <span class="n">F0</span> <span class="o">=</span> <span class="n">simulate_with_errors</span><span class="p">({})</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No error pacc,F= &#39;</span><span class="p">,</span> <span class="n">pacc0</span><span class="p">,</span> <span class="n">F0</span><span class="p">)</span>

<span class="c1"># Enumerate single fault patterns</span>
<span class="n">single_qubit_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>
<span class="n">err_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">single_qubit_labels</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">single_qubit_labels</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">a</span><span class="o">==</span><span class="s1">&#39;I&#39;</span> <span class="ow">and</span> <span class="n">b</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">)]</span>

<span class="n">single_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">err_pairs</span><span class="p">:</span>
        <span class="n">pacc</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="n">simulate_with_errors</span><span class="p">({</span><span class="n">loc</span><span class="p">:</span><span class="n">e</span><span class="p">})</span>
        <span class="n">single_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">loc</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">pacc</span><span class="p">,</span> <span class="n">F</span><span class="p">))</span>

<span class="n">num_acc_single</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">pacc</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="n">single_list</span> <span class="k">if</span> <span class="n">pacc</span><span class="o">&gt;</span><span class="mf">1e-12</span><span class="p">)</span>
<span class="n">unique_fid_single</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">round</span><span class="p">(</span><span class="n">F</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">pacc</span><span class="p">,</span><span class="n">F</span> <span class="ow">in</span> <span class="n">single_list</span> <span class="k">if</span> <span class="n">pacc</span><span class="o">&gt;</span><span class="mf">1e-12</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Single acc count&#39;</span><span class="p">,</span> <span class="n">num_acc_single</span><span class="p">,</span> <span class="s1">&#39;unique fidelities&#39;</span><span class="p">,</span> <span class="n">unique_fid_single</span><span class="p">)</span>

<span class="c1"># Enumerate double faults</span>
<span class="n">pair_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>
<span class="k">for</span> <span class="n">l1</span><span class="p">,</span><span class="n">l2</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">e1</span> <span class="ow">in</span> <span class="n">err_pairs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">e2</span> <span class="ow">in</span> <span class="n">err_pairs</span><span class="p">:</span>
            <span class="n">pacc</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="n">simulate_with_errors</span><span class="p">({</span><span class="n">l1</span><span class="p">:</span><span class="n">e1</span><span class="p">,</span> <span class="n">l2</span><span class="p">:</span><span class="n">e2</span><span class="p">})</span>
            <span class="n">pair_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">e1</span><span class="p">,</span><span class="n">e2</span><span class="p">,</span><span class="n">pacc</span><span class="p">,</span><span class="n">F</span><span class="p">))</span>

<span class="n">num_acc_pairs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="o">*</span><span class="n">_</span><span class="p">,</span><span class="n">pacc</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="n">pair_list</span> <span class="k">if</span> <span class="n">pacc</span><span class="o">&gt;</span><span class="mf">1e-12</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Double acc count&#39;</span><span class="p">,</span> <span class="n">num_acc_pairs</span><span class="p">,</span> <span class="s1">&#39;of&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pair_list</span><span class="p">))</span>

<span class="c1"># Compute series coefficients up to O(p^2)</span>
<span class="c1"># Zero fault: weight (1-p)^5 ~ 1 - 5p + 10p^2; acceptance 1; fidelity 1.</span>
<span class="c1"># We&#39;ll derive general expansion using sums</span>

<span class="c1"># Sums at order p and p^2</span>
<span class="n">S1_N</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pacc</span><span class="o">*</span><span class="n">F</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">pacc</span><span class="p">,</span><span class="n">F</span> <span class="ow">in</span> <span class="n">single_list</span><span class="p">)</span>
<span class="n">S1_D</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pacc</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">pacc</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="n">single_list</span><span class="p">)</span>
<span class="n">S2_N</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pacc</span><span class="o">*</span><span class="n">F</span> <span class="k">for</span> <span class="o">*</span><span class="n">_</span><span class="p">,</span><span class="n">pacc</span><span class="p">,</span><span class="n">F</span> <span class="ow">in</span> <span class="n">pair_list</span><span class="p">)</span>
<span class="n">S2_D</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pacc</span> <span class="k">for</span> <span class="o">*</span><span class="n">_</span><span class="p">,</span><span class="n">pacc</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="n">pair_list</span><span class="p">)</span>

<span class="n">A1</span> <span class="o">=</span> <span class="n">S1_N</span><span class="o">/</span><span class="mf">15.0</span>
<span class="n">B1</span> <span class="o">=</span> <span class="n">S1_D</span><span class="o">/</span><span class="mf">15.0</span>
<span class="n">A2</span> <span class="o">=</span> <span class="n">S2_N</span><span class="o">/</span><span class="p">(</span><span class="mf">15.0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">B2</span> <span class="o">=</span> <span class="n">S2_D</span><span class="o">/</span><span class="p">(</span><span class="mf">15.0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># The total numerator and denominator up to p^2 including zero-fault factor (1-p)^5</span>
<span class="c1"># N(p) ~ (1-5p+10p^2)*1  + A1 p + A2 p^2   (since zero-fault acceptance=1 and F=1)</span>
<span class="c1"># D(p) ~ (1-5p+10p^2)*1  + B1 p + B2 p^2</span>

<span class="c1"># Expand to get F_cond series</span>
<span class="n">N0</span><span class="p">,</span> <span class="n">D0</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span>
<span class="n">a1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.0</span> <span class="o">+</span> <span class="n">A1</span>
<span class="n">b1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.0</span> <span class="o">+</span> <span class="n">B1</span>
<span class="c1"># second order: 10 from zero-fault plus A2; also there is cross term from (-5p)^2? Already accounted by 10p^2 from (1-p)^5 expansion precisely, yes</span>
<span class="c1">#  (1-p)^5 = 1 - 5p + 10p^2 + O(p^3)</span>
<span class="n">a2</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">+</span> <span class="n">A2</span>
<span class="n">b2</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">+</span> <span class="n">B2</span>

<span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="n">a1</span><span class="o">*</span><span class="n">D0</span> <span class="o">-</span> <span class="n">N0</span><span class="o">*</span><span class="n">b1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">D0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="n">a2</span><span class="o">*</span><span class="p">(</span><span class="n">D0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">a1</span><span class="o">*</span><span class="n">D0</span><span class="o">*</span><span class="n">b1</span> <span class="o">-</span> <span class="n">N0</span><span class="o">*</span><span class="n">D0</span><span class="o">*</span><span class="n">b2</span> <span class="o">+</span> <span class="n">N0</span><span class="o">*</span><span class="p">(</span><span class="n">b1</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">D0</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sums: S1_N&#39;</span><span class="p">,</span> <span class="n">S1_N</span><span class="p">,</span> <span class="s1">&#39;S1_D&#39;</span><span class="p">,</span> <span class="n">S1_D</span><span class="p">,</span> <span class="s1">&#39;S2_N&#39;</span><span class="p">,</span> <span class="n">S2_N</span><span class="p">,</span> <span class="s1">&#39;S2_D&#39;</span><span class="p">,</span> <span class="n">S2_D</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A1,B1=&#39;</span><span class="p">,</span> <span class="n">A1</span><span class="p">,</span> <span class="n">B1</span><span class="p">,</span> <span class="s1">&#39;A2,B2=&#39;</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">B2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Series coeffs: c1=&#39;</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="s1">&#39;c2=&#39;</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#9</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="nx">Traceback</span><span class="w"> </span><span class="p">(</span><span class="nx">most</span><span class="w"> </span><span class="nx">recent</span><span class="w"> </span><span class="nx">call</span><span class="w"> </span><span class="nx">last</span><span class="p">):</span>
<span class="w">  </span><span class="nx">File</span><span class="w"> </span><span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">line</span><span class="w"> </span><span class="mi">134</span><span class="p">,</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">&lt;</span><span class="nx">module</span><span class="p">&gt;</span>
<span class="w">  </span><span class="nx">File</span><span class="w"> </span><span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">line</span><span class="w"> </span><span class="mi">134</span><span class="p">,</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">&lt;</span><span class="nx">genexpr</span><span class="p">&gt;</span>
<span class="nx">TypeError</span><span class="p">:</span><span class="w"> </span><span class="nx">unsupported</span><span class="w"> </span><span class="nx">operand</span><span class="w"> </span><span class="k">type</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">*</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">float</span><span class="err">&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">NoneType</span><span class="err">&#39;</span>

<span class="nx">No</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="nx">pacc</span><span class="p">,</span><span class="nx">F</span><span class="p">=</span><span class="w">  </span><span class="m m-Double">1.0000000000000002</span><span class="w"> </span><span class="m m-Double">1.0</span>
<span class="nx">Single</span><span class="w"> </span><span class="nx">acc</span><span class="w"> </span><span class="nx">count</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="nx">unique</span><span class="w"> </span><span class="nx">fidelities</span><span class="w"> </span><span class="p">[</span><span class="m m-Double">1.0</span><span class="p">]</span>
<span class="nx">Double</span><span class="w"> </span><span class="nx">acc</span><span class="w"> </span><span class="nx">count</span><span class="w"> </span><span class="mi">282</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="mi">2250</span>
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#10</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="c1"># Recompute sums with guards</span>
<span class="n">S1_N</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">S1_D</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">pacc</span><span class="p">,</span><span class="n">F</span> <span class="ow">in</span> <span class="n">single_list</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">pacc</span><span class="o">&gt;</span><span class="mf">1e-12</span><span class="p">:</span>
        <span class="n">S1_N</span> <span class="o">+=</span> <span class="n">pacc</span><span class="o">*</span><span class="n">F</span>
        <span class="n">S1_D</span> <span class="o">+=</span> <span class="n">pacc</span>

<span class="n">S2_N</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">S2_D</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="k">for</span> <span class="o">*</span><span class="n">_</span><span class="p">,</span><span class="n">pacc</span><span class="p">,</span><span class="n">F</span> <span class="ow">in</span> <span class="n">pair_list</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">pacc</span><span class="o">&gt;</span><span class="mf">1e-12</span><span class="p">:</span>
        <span class="n">S2_N</span> <span class="o">+=</span> <span class="n">pacc</span><span class="o">*</span><span class="n">F</span>
        <span class="n">S2_D</span> <span class="o">+=</span> <span class="n">pacc</span>

<span class="n">A1</span> <span class="o">=</span> <span class="n">S1_N</span><span class="o">/</span><span class="mf">15.0</span>
<span class="n">B1</span> <span class="o">=</span> <span class="n">S1_D</span><span class="o">/</span><span class="mf">15.0</span>
<span class="n">A2</span> <span class="o">=</span> <span class="n">S2_N</span><span class="o">/</span><span class="p">(</span><span class="mf">15.0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">B2</span> <span class="o">=</span> <span class="n">S2_D</span><span class="o">/</span><span class="p">(</span><span class="mf">15.0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="n">N0</span><span class="p">,</span> <span class="n">D0</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span>
<span class="n">a1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.0</span> <span class="o">+</span> <span class="n">A1</span>
<span class="n">b1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.0</span> <span class="o">+</span> <span class="n">B1</span>
<span class="n">a2</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">+</span> <span class="n">A2</span>
<span class="n">b2</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">+</span> <span class="n">B2</span>

<span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="n">a1</span> <span class="o">-</span> <span class="n">b1</span><span class="p">)</span>
<span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="n">a2</span> <span class="o">-</span> <span class="n">a1</span><span class="o">*</span><span class="n">b1</span> <span class="o">-</span> <span class="n">b2</span> <span class="o">+</span> <span class="n">b1</span><span class="o">*</span><span class="n">b1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A1,B1=&#39;</span><span class="p">,</span> <span class="n">A1</span><span class="p">,</span> <span class="n">B1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A2,B2=&#39;</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">B2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Series coeffs: c1=&#39;</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="s1">&#39;c2=&#39;</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#11</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 4, in &lt;module&gt;
NameError: name &#39;single_list&#39; is not defined
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#12</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span><span class="p">,</span> <span class="n">combinations</span>

<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">paulis</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span><span class="n">I</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">X</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="n">Y</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span><span class="n">Z</span><span class="p">}</span>

<span class="c1"># Gates and errors</span>

<span class="k">def</span><span class="w"> </span><span class="nf">gate1</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">mats</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">mats</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">mats</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">cnot</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">mats0</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mats1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">mats0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P0</span><span class="p">)</span>
            <span class="n">mats1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">mats0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
            <span class="n">mats1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mats0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
            <span class="n">mats1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">mats0</span><span class="p">)</span> <span class="o">+</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">mats1</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">twoq_pauli_on_pair</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">mats</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">mats</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">paulis</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
    <span class="n">mats</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">paulis</span><span class="p">[</span><span class="n">p2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">mats</span><span class="p">)</span>

<span class="c1"># Projectors</span>
<span class="n">P_a0</span> <span class="o">=</span> <span class="n">gate1</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">Z4</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span> <span class="n">I</span><span class="p">])</span>
<span class="n">X4</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span> <span class="n">I</span><span class="p">])</span>
<span class="n">P_Zplus</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span> <span class="o">+</span> <span class="n">Z4</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<span class="n">P_Xplus</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span> <span class="o">+</span> <span class="n">X4</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

<span class="n">GHZ_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">])</span> <span class="o">+</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">one</span><span class="p">,</span><span class="n">one</span><span class="p">,</span><span class="n">one</span><span class="p">,</span><span class="n">one</span><span class="p">,</span><span class="n">zero</span><span class="p">]))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">init</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">])</span>

<span class="n">cnots</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">simulate_with_errors</span><span class="p">(</span><span class="n">error_list</span><span class="p">):</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">gate1</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cnots</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">error_list</span><span class="p">:</span>
            <span class="n">p1</span><span class="p">,</span><span class="n">p2</span> <span class="o">=</span> <span class="n">error_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">twoq_pauli_on_pair</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="n">psi_a0</span> <span class="o">=</span> <span class="n">P_a0</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="n">p_a0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">psi_a0</span><span class="p">,</span> <span class="n">psi_a0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p_a0</span> <span class="o">&lt;=</span> <span class="mf">1e-15</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">psi_a0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_a0</span><span class="p">)</span>
    <span class="n">psi_z</span> <span class="o">=</span> <span class="n">P_Zplus</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="n">p_z</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">psi_z</span><span class="p">,</span> <span class="n">psi_z</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p_z</span> <span class="o">&lt;=</span> <span class="mf">1e-15</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">psi_z</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_z</span><span class="p">)</span>
    <span class="n">psi_x</span> <span class="o">=</span> <span class="n">P_Xplus</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="n">p_x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">psi_x</span><span class="p">,</span> <span class="n">psi_x</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p_x</span> <span class="o">&lt;=</span> <span class="mf">1e-15</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">psi_x</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_x</span><span class="p">)</span>
    <span class="n">p_acc</span> <span class="o">=</span> <span class="n">p_a0</span> <span class="o">*</span> <span class="n">p_z</span> <span class="o">*</span> <span class="n">p_x</span>
    <span class="n">F</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">GHZ_data</span><span class="p">,</span> <span class="n">psi</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p_acc</span><span class="p">,</span> <span class="n">F</span>

<span class="c1"># Verify ideal case</span>
<span class="n">pacc0</span><span class="p">,</span> <span class="n">F0</span> <span class="o">=</span> <span class="n">simulate_with_errors</span><span class="p">({})</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ideal pacc,F:&#39;</span><span class="p">,</span> <span class="n">pacc0</span><span class="p">,</span> <span class="n">F0</span><span class="p">)</span>

<span class="n">single_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>
<span class="n">err_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">single_labels</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">single_labels</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">a</span><span class="o">==</span><span class="s1">&#39;I&#39;</span> <span class="ow">and</span> <span class="n">b</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">)]</span>

<span class="n">single_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">err_pairs</span><span class="p">:</span>
        <span class="n">pacc</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="n">simulate_with_errors</span><span class="p">({</span><span class="n">loc</span><span class="p">:</span><span class="n">e</span><span class="p">})</span>
        <span class="n">single_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">loc</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">pacc</span><span class="p">,</span> <span class="n">F</span><span class="p">))</span>

<span class="n">num_acc_single</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">pacc</span><span class="p">,</span><span class="n">F</span> <span class="ow">in</span> <span class="n">single_list</span> <span class="k">if</span> <span class="n">pacc</span><span class="o">&gt;</span><span class="mf">1e-12</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accepted single faults:&#39;</span><span class="p">,</span> <span class="n">num_acc_single</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accepted single unique fidelities:&#39;</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">F</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">pacc</span><span class="p">,</span><span class="n">F</span> <span class="ow">in</span> <span class="n">single_list</span> <span class="k">if</span> <span class="n">pacc</span><span class="o">&gt;</span><span class="mf">1e-12</span><span class="p">)))</span>

<span class="n">pair_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">l1</span><span class="p">,</span><span class="n">l2</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">e1</span> <span class="ow">in</span> <span class="n">err_pairs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">e2</span> <span class="ow">in</span> <span class="n">err_pairs</span><span class="p">:</span>
            <span class="n">pacc</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="n">simulate_with_errors</span><span class="p">({</span><span class="n">l1</span><span class="p">:</span><span class="n">e1</span><span class="p">,</span> <span class="n">l2</span><span class="p">:</span><span class="n">e2</span><span class="p">})</span>
            <span class="n">pair_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">e1</span><span class="p">,</span><span class="n">e2</span><span class="p">,</span><span class="n">pacc</span><span class="p">,</span><span class="n">F</span><span class="p">))</span>

<span class="n">num_acc_pairs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="o">*</span><span class="n">_</span><span class="p">,</span><span class="n">pacc</span><span class="p">,</span><span class="n">F</span> <span class="ow">in</span> <span class="n">pair_list</span> <span class="k">if</span> <span class="n">pacc</span><span class="o">&gt;</span><span class="mf">1e-12</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accepted double faults:&#39;</span><span class="p">,</span> <span class="n">num_acc_pairs</span><span class="p">,</span> <span class="s1">&#39;of&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pair_list</span><span class="p">))</span>

<span class="n">S1_N</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pacc</span><span class="o">*</span><span class="n">F</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">pacc</span><span class="p">,</span><span class="n">F</span> <span class="ow">in</span> <span class="n">single_list</span> <span class="k">if</span> <span class="n">pacc</span><span class="o">&gt;</span><span class="mf">1e-12</span><span class="p">)</span>
<span class="n">S1_D</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pacc</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">pacc</span><span class="p">,</span><span class="n">F</span> <span class="ow">in</span> <span class="n">single_list</span> <span class="k">if</span> <span class="n">pacc</span><span class="o">&gt;</span><span class="mf">1e-12</span><span class="p">)</span>
<span class="n">S2_N</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pacc</span><span class="o">*</span><span class="n">F</span> <span class="k">for</span> <span class="o">*</span><span class="n">_</span><span class="p">,</span><span class="n">pacc</span><span class="p">,</span><span class="n">F</span> <span class="ow">in</span> <span class="n">pair_list</span> <span class="k">if</span> <span class="n">pacc</span><span class="o">&gt;</span><span class="mf">1e-12</span><span class="p">)</span>
<span class="n">S2_D</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pacc</span> <span class="k">for</span> <span class="o">*</span><span class="n">_</span><span class="p">,</span><span class="n">pacc</span><span class="p">,</span><span class="n">F</span> <span class="ow">in</span> <span class="n">pair_list</span> <span class="k">if</span> <span class="n">pacc</span><span class="o">&gt;</span><span class="mf">1e-12</span><span class="p">)</span>

<span class="n">A1</span> <span class="o">=</span> <span class="n">S1_N</span><span class="o">/</span><span class="mf">15.0</span>
<span class="n">B1</span> <span class="o">=</span> <span class="n">S1_D</span><span class="o">/</span><span class="mf">15.0</span>
<span class="n">A2</span> <span class="o">=</span> <span class="n">S2_N</span><span class="o">/</span><span class="p">(</span><span class="mf">15.0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">B2</span> <span class="o">=</span> <span class="n">S2_D</span><span class="o">/</span><span class="p">(</span><span class="mf">15.0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Zero-fault expansion contributes (1-p)^5 = 1 - 5 p + 10 p^2</span>
<span class="c1"># N(p) ~ (1 - 5p +10p^2) + A1 p + A2 p^2</span>
<span class="c1"># D(p) ~ (1 - 5p +10p^2) + B1 p + B2 p^2</span>

<span class="c1"># series for F = N/D = 1 + c1 p + c2 p^2 + ...</span>
<span class="n">a1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.0</span> <span class="o">+</span> <span class="n">A1</span>
<span class="n">b1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.0</span> <span class="o">+</span> <span class="n">B1</span>
<span class="n">a2</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">+</span> <span class="n">A2</span>
<span class="n">b2</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">+</span> <span class="n">B2</span>
<span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="n">a1</span> <span class="o">-</span> <span class="n">b1</span><span class="p">)</span>
<span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="n">a2</span> <span class="o">-</span> <span class="n">a1</span><span class="o">*</span><span class="n">b1</span> <span class="o">-</span> <span class="n">b2</span> <span class="o">+</span> <span class="n">b1</span><span class="o">*</span><span class="n">b1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sums: S1_N&#39;</span><span class="p">,</span> <span class="n">S1_N</span><span class="p">,</span> <span class="s1">&#39;S1_D&#39;</span><span class="p">,</span> <span class="n">S1_D</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sums: S2_N&#39;</span><span class="p">,</span> <span class="n">S2_N</span><span class="p">,</span> <span class="s1">&#39;S2_D&#39;</span><span class="p">,</span> <span class="n">S2_D</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A1,B1&#39;</span><span class="p">,</span> <span class="n">A1</span><span class="p">,</span> <span class="n">B1</span><span class="p">,</span> <span class="s1">&#39;A2,B2&#39;</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">B2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Series coefficients: c1&#39;</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>

<span class="c1"># For completeness, we can also compute exact F_cond(p) polynomial up to p^2 coefficients and then present.</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#13</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>Ideal pacc,F: 1.0000000000000002 1.0
Accepted single faults: 7
Accepted single unique fidelities: [1.0]
Accepted double faults: 282 of 2250
Sums: S1_N 7.000000000000001 S1_D 7.000000000000001
Sums: S2_N 138.00000000000003 S2_D 282.00000000000006
A1,B1 0.46666666666666673 0.46666666666666673 A2,B2 0.6133333333333335 1.2533333333333336
Series coefficients: c1 0.0 c2 -0.6400000000000006
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#14</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span><span class="p">,</span> <span class="n">combinations</span>

<span class="c1"># Setup identical functions as before</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">paulis</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span><span class="n">I</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">X</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="n">Y</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span><span class="n">Z</span><span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">gate1</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">mats</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">mats</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">mats</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">cnot</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">mats0</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mats1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">mats0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P0</span><span class="p">)</span>
            <span class="n">mats1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">mats0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
            <span class="n">mats1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mats0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
            <span class="n">mats1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">mats0</span><span class="p">)</span> <span class="o">+</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">mats1</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">twoq_pauli_on_pair</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="n">mats</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span>
    <span class="n">mats</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">paulis</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
    <span class="n">mats</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">paulis</span><span class="p">[</span><span class="n">p2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">mats</span><span class="p">)</span>

<span class="n">P_a0</span> <span class="o">=</span> <span class="n">gate1</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">),</span><span class="mi">4</span><span class="p">)</span>
<span class="n">Z4</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">I</span><span class="p">])</span>
<span class="n">X4</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">I</span><span class="p">])</span>
<span class="n">P_Zplus</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span> <span class="o">+</span> <span class="n">Z4</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<span class="n">P_Xplus</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span> <span class="o">+</span> <span class="n">X4</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

<span class="n">init</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">])</span>
<span class="n">GHZ_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">])</span> <span class="o">+</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">one</span><span class="p">,</span><span class="n">one</span><span class="p">,</span><span class="n">one</span><span class="p">,</span><span class="n">one</span><span class="p">,</span><span class="n">zero</span><span class="p">]))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">cnots</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">simulate_with_errors</span><span class="p">(</span><span class="n">error_list</span><span class="p">):</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">gate1</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cnots</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">error_list</span><span class="p">:</span>
            <span class="n">p1</span><span class="p">,</span><span class="n">p2</span> <span class="o">=</span> <span class="n">error_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">twoq_pauli_on_pair</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="n">psi_a0</span> <span class="o">=</span> <span class="n">P_a0</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="n">p_a0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">psi_a0</span><span class="p">,</span><span class="n">psi_a0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p_a0</span><span class="o">&lt;=</span><span class="mf">1e-12</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">psi_a0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_a0</span><span class="p">)</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="p">(</span><span class="n">P_Zplus</span> <span class="o">@</span> <span class="n">psi</span><span class="p">);</span> <span class="n">p_z</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">psi</span><span class="p">,</span><span class="n">psi</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p_z</span><span class="o">&lt;=</span><span class="mf">1e-12</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">psi</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_z</span><span class="p">)</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="p">(</span><span class="n">P_Xplus</span> <span class="o">@</span> <span class="n">psi</span><span class="p">);</span> <span class="n">p_x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">psi</span><span class="p">,</span><span class="n">psi</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p_x</span><span class="o">&lt;=</span><span class="mf">1e-12</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">psi</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_x</span><span class="p">)</span>
    <span class="n">p_acc</span> <span class="o">=</span> <span class="n">p_a0</span><span class="o">*</span><span class="n">p_z</span><span class="o">*</span><span class="n">p_x</span>
    <span class="n">F</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">GHZ_data</span><span class="p">,</span> <span class="n">psi</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p_acc</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">psi</span>

<span class="n">single_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>
<span class="n">err_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">single_labels</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">single_labels</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">a</span><span class="o">==</span><span class="s1">&#39;I&#39;</span> <span class="ow">and</span> <span class="n">b</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">)]</span>

<span class="n">accepted</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">c</span><span class="p">,</span><span class="n">t</span> <span class="o">=</span> <span class="n">cnots</span><span class="p">[</span><span class="n">loc</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">err_pairs</span><span class="p">:</span>
        <span class="n">pacc</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">simulate_with_errors</span><span class="p">({</span><span class="n">loc</span><span class="p">:</span><span class="n">e</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">pacc</span><span class="o">&gt;</span><span class="mf">1e-12</span><span class="p">:</span>
            <span class="n">accepted</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">loc</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">pacc</span><span class="p">,</span><span class="n">F</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accepted singles:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">accepted</span><span class="p">))</span>
<span class="k">for</span> <span class="n">loc</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">pacc</span><span class="p">,</span><span class="n">F</span> <span class="ow">in</span> <span class="n">accepted</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;loc&#39;</span><span class="p">,</span><span class="n">loc</span><span class="p">,</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="s1">&#39;pacc&#39;</span><span class="p">,</span><span class="n">pacc</span><span class="p">,</span><span class="s1">&#39;F&#39;</span><span class="p">,</span><span class="n">F</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#15</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>Accepted singles: 7
loc 1 error (&#39;X&#39;, &#39;X&#39;) pacc 1.0000000000000002 F 1.0
loc 1 error (&#39;Y&#39;, &#39;Y&#39;) pacc 1.0000000000000002 F 1.0
loc 1 error (&#39;Z&#39;, &#39;Z&#39;) pacc 1.0000000000000002 F 1.0
loc 2 error (&#39;Z&#39;, &#39;Z&#39;) pacc 1.0000000000000002 F 1.0
loc 3 error (&#39;Z&#39;, &#39;Z&#39;) pacc 1.0000000000000002 F 1.0
loc 4 error (&#39;Z&#39;, &#39;Z&#39;) pacc 1.0000000000000002 F 1.0
loc 5 error (&#39;I&#39;, &#39;Z&#39;) pacc 1.0000000000000002 F 1.0
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#16</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span>

<span class="c1"># Reuse functions from previous run by redefining them quickly</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">paulis</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span><span class="n">I</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">X</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="n">Y</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span><span class="n">Z</span><span class="p">}</span>

<span class="n">single_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>
<span class="n">err_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">single_labels</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">single_labels</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">gate1</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">mats</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">mats</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">mats</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">cnot</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">mats0</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mats1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">mats0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P0</span><span class="p">)</span>
            <span class="n">mats1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">mats0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
            <span class="n">mats1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mats0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
            <span class="n">mats1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">mats0</span><span class="p">)</span> <span class="o">+</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">mats1</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">twoq_pauli_on_pair</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="n">mats</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span>
    <span class="n">mats</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">paulis</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
    <span class="n">mats</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">paulis</span><span class="p">[</span><span class="n">p2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">mats</span><span class="p">)</span>

<span class="n">P_a0</span> <span class="o">=</span> <span class="n">gate1</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">),</span><span class="mi">4</span><span class="p">)</span>
<span class="n">Z4</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">I</span><span class="p">])</span>
<span class="n">X4</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">I</span><span class="p">])</span>
<span class="n">P_Zplus</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span> <span class="o">+</span> <span class="n">Z4</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<span class="n">P_Xplus</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span> <span class="o">+</span> <span class="n">X4</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

<span class="n">init</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">])</span>
<span class="n">GHZ_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">])</span> <span class="o">+</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">one</span><span class="p">,</span><span class="n">one</span><span class="p">,</span><span class="n">one</span><span class="p">,</span><span class="n">one</span><span class="p">,</span><span class="n">zero</span><span class="p">]))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">cnots</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">simulate_once</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">gate1</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnots</span><span class="p">:</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">cnot</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="c1"># Two-qubit depolarizing after gate</span>
        <span class="k">if</span> <span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">:</span>
            <span class="c1"># choose one of 15 non-identity equally likely</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
            <span class="c1"># map k to err_pairs excluding (&#39;I&#39;,&#39;I&#39;)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">err_pairs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="s1">&#39;I&#39;</span> <span class="ow">and</span> <span class="n">b</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">idx</span><span class="o">==</span><span class="n">k</span><span class="p">:</span>
                    <span class="n">psi</span> <span class="o">=</span> <span class="n">twoq_pauli_on_pair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
                    <span class="k">break</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># Measurements: ancilla 0, then projectors</span>
    <span class="n">psi_a0</span> <span class="o">=</span> <span class="n">P_a0</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="n">p_a0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">psi_a0</span><span class="p">,</span> <span class="n">psi_a0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
    <span class="k">if</span> <span class="n">p_a0</span> <span class="o">&lt;</span> <span class="mf">1e-15</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">psi_a0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_a0</span><span class="p">)</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">P_Zplus</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="n">p_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">psi</span><span class="p">,</span> <span class="n">psi</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
    <span class="k">if</span> <span class="n">p_z</span> <span class="o">&lt;</span> <span class="mf">1e-15</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">psi</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_z</span><span class="p">)</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">P_Xplus</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="n">p_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">psi</span><span class="p">,</span> <span class="n">psi</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
    <span class="k">if</span> <span class="n">p_x</span> <span class="o">&lt;</span> <span class="mf">1e-15</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">psi</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_x</span><span class="p">)</span>
    <span class="n">F</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">GHZ_data</span><span class="p">,</span> <span class="n">psi</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">estimate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">20000</span><span class="p">):</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Fsum</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">ok</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="n">simulate_once</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="n">acc</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">Fsum</span> <span class="o">+=</span> <span class="n">F</span>
    <span class="k">return</span> <span class="n">acc</span><span class="o">/</span><span class="n">N</span><span class="p">,</span> <span class="p">(</span><span class="n">Fsum</span><span class="o">/</span><span class="n">acc</span> <span class="k">if</span> <span class="n">acc</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mf">5e-3</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">,</span> <span class="mf">2e-2</span><span class="p">]:</span>
    <span class="n">acc</span><span class="p">,</span> <span class="n">Fbar</span> <span class="o">=</span> <span class="n">estimate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;p=</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">: acceptance≈</span><span class="si">{</span><span class="n">acc</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">, conditional fidelity≈</span><span class="si">{</span><span class="n">Fbar</span><span class="si">:</span><span class="s1">.8f</span><span class="si">}</span><span class="s1">, 1-0.64 p^2≈</span><span class="si">{</span><span class="mi">1</span><span class="o">-</span><span class="mf">0.64</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">p</span><span class="si">:</span><span class="s1">.8f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#17</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>p=0.001: acceptance≈0.995000, conditional fidelity≈1.00000000, 1-0.64 p^2≈0.99999936
p=0.005: acceptance≈0.979000, conditional fidelity≈1.00000000, 1-0.64 p^2≈0.99998400
p=0.01: acceptance≈0.954400, conditional fidelity≈1.00000000, 1-0.64 p^2≈0.99993600
p=0.02: acceptance≈0.923400, conditional fidelity≈0.99978341, 1-0.64 p^2≈0.99974400
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#18</span>
    </div>
    <div class="content markdown-body"><p>1) Step-by-step derivation</p>
<ul>
<li>Code, logicals, and stabilizers</li>
<li>We use the [[4,2,2]] stabilizer code with generators S = {XXXX, ZZZZ} on physical qubits 0,1,2,3; logical Paulis are (up to stabilizers) XA = XIXI, XB = XXII, ZA = ZZII, ZB = ZIZI, and the logical computational basis includes
    |00⟩L = (|0000⟩ + |1111⟩)/√2, etc. (<a href="https://errorcorrectionzoo.org/c/stab_4_2_2?utm_source=openai">errorcorrectionzoo.org</a>)</li>
<li>
<p>Post-selection onto the code space is the projection Πcode = Π(XXXX,+) Π(ZZZZ,+) with Π(M,+) = (I+M)/2. This is the standard stabilizer-projector identity. (<a href="https://quantumcomputing.stackexchange.com/questions/41506/why-is-this-the-projection-operator-on-a-stabilizer-code-subspace?utm_source=openai">quantumcomputing.stackexchange.com</a>)</p>
</li>
<li>
<p>Circuit and the ideal output</p>
</li>
<li>The circuit (right-to-left order): H1 → CNOT12 → CNOT10 → CNOT23 → CNOT34 → CNOT04, then measure ancilla M4.</li>
<li>
<p>Using the usual CNOT propagation rules (Paulis map to Paulis), the first four gates produce the 4-qubit GHZ state (|0000⟩+|1111⟩)/√2 on data qubits 0–3, and the last two CNOTs prepare the ancilla to be measured in |0⟩ in the no-fault case (i.e., acceptance with probability 1). (<a href="https://en.wikipedia.org/wiki/Controlled_NOT_gate?utm_source=openai">en.wikipedia.org</a>, <a href="https://rainij.github.io/solutions-qcqi-nielsen-chuang/chapter_10.html?utm_source=openai">rainij.github.io</a>)</p>
</li>
<li>
<p>Noise model and acceptance</p>
</li>
<li>After each of the five CNOTs we apply an independent 2-qubit depolarizing channel:
    E(ρ) = (1−p)ρ + (p/15) ∑P≠II P ρ P, where the sum runs over the 15 non-identity two-qubit Paulis on the control–target pair. (Two-qubit version of the standard depolarizing channel.) (<a href="https://en.wikipedia.org/wiki/Quantum_depolarizing_channel?utm_source=openai">en.wikipedia.org</a>, <a href="https://quantumchannelzoo.org/channel/depolarizing?utm_source=openai">quantumchannelzoo.org</a>)</li>
<li>
<p>We post-select on: (i) ancilla measurement outcome |0⟩, (ii) code-space projections Π(ZZZZ,+), Π(XXXX,+). The corresponding post-selection probability for a given fault pattern is the product of the three projector expectations (Born rule with projectors). (<a href="https://quantumcomputing.stackexchange.com/questions/41506/why-is-this-the-projection-operator-on-a-stabilizer-code-subspace?utm_source=openai">quantumcomputing.stackexchange.com</a>)</p>
</li>
<li>
<p>Organization of the calculation</p>
</li>
<li>Let N(p) be the total (unnormalized) accepted “correct-state weight” and D(p) the total acceptance probability:
    N(p) = ∑fault patterns P(pattern) Pacc(pattern) Fpattern,
    D(p) = ∑fault patterns P(pattern) Pacc(pattern),
    where Fpattern is the fidelity of the post-selected output with |00⟩L for that pattern. The conditional logical-state fidelity is
    Fcond(p) = N(p)/D(p).</li>
<li>
<p>We expand to second order in p (since the circuit is designed to be fault-tolerant, the linear term will cancel):
    (1−p)^5 = 1 − 5p + 10p^2 + O(p^3).</p>
</li>
<li>
<p>Exhaustive Pauli-path count (single- and double-fault analysis)</p>
</li>
<li>We enumerate all single-fault patterns (5 locations × 15 non-identity Paulis = 75 cases) and all two-fault patterns (C(5,2) × 15^2 = 2250 cases), propagate Pauli faults through the circuit, and apply the three projectors (ancilla |0⟩ and the two stabilizers) to check acceptance and compute the final fidelity to |00⟩L.</li>
<li>Pauli propagation identities used: CNOT12 X1 = X1 X2 CNOT12, CNOT12 Z2 = Z1 Z2 CNOT12, etc., i.e., X on control and Z on target propagate; X on target and Z on control do not propagate. (<a href="https://rainij.github.io/solutions-qcqi-nielsen-chuang/chapter_10.html?utm_source=openai">rainij.github.io</a>, <a href="https://qiskit.qotlabs.org/learning/courses/foundations-of-quantum-error-correction/fault-tolerant-quantum-computing/controlling-error-propagation?utm_source=openai">qiskit.qotlabs.org</a>)</li>
</ul>
<p>Results of the exact count (verified by a stabilizer-level simulator):
  - Zero-fault case: accepted with probability 1 and fidelity 1.
  - Single-faults: only 7 out of 75 are accepted; all 7 have fidelity 1 (they are harmless because they equal stabilizers or logical Z-type operations that stabilize |00⟩L).
    The seven benign single-faults are:
    (i) after CNOT12: XX, YY, ZZ on qubits (1,2);
    (ii) after CNOT10: ZZ on (1,0);
    (iii) after CNOT23: ZZ on (2,3);
    (iv) after CNOT34: ZZ on (3,4);
    (v) after CNOT04: IZ on (0,4) (Z on ancilla only).
    These all pass ancilla=0 and Πcode and leave the logical state unchanged. (Consistency with CNOT error propagation and the fact that Z-logicals have +1 eigenvalue on |00⟩L.) (<a href="https://qiskit.qotlabs.org/learning/courses/foundations-of-quantum-error-correction/fault-tolerant-quantum-computing/controlling-error-propagation?utm_source=openai">qiskit.qotlabs.org</a>)
  - Two-faults: among the 2250 patterns, 282 are accepted by the post-selection; among those, 138 are benign (final state still |00⟩L) and 144 are harmful (they map within the code space to a different logical basis state, so fidelity 0 against |00⟩L). These accepted two-fault events therefore determine the leading drop in fidelity.</p>
<ul>
<li>Assemble the series</li>
<li>Write
    N(p) = (1−5p+10p^2) · 1 + A1 p + A2 p^2 + O(p^3),
    D(p) = (1−5p+10p^2) · 1 + B1 p + B2 p^2 + O(p^3),
    with
    A1 = (1/15) ∑single pacc·F = 7/15,  B1 = (1/15) ∑single pacc = 7/15,
    A2 = (1/15^2) ∑double pacc·F = 138/225 = 46/75,
    B2 = (1/15^2) ∑double pacc = 282/225 = 94/75.</li>
<li>Since A1 = B1, the linear term cancels in the ratio N/D. The second-order coefficient is
    c2 = (A2 − B2) = (46/75) − (94/75) = −48/75 = −16/25.</li>
<li>
<p>Therefore
    Fcond(p) = 1 − (16/25) p^2 + O(p^3) = 1 − 0.64 p^2 + O(p^3).</p>
</li>
<li>
<p>Acceptance probability (for reference)</p>
</li>
<li>
<p>From the same count,
    Pacc(p) = D(p) = 1 − (68/15) p + (94/75) p^2 + O(p^3),
    consistent with the fact that almost all single faults are detected (only 7/75 survive at O(p)). (CNOT error propagation and stabilizer post-selection explain the strong linear rejection.) (<a href="https://qiskit.qotlabs.org/learning/courses/foundations-of-quantum-error-correction/fault-tolerant-quantum-computing/controlling-error-propagation?utm_source=openai">qiskit.qotlabs.org</a>)</p>
</li>
<li>
<p>Numerical cross-check</p>
</li>
<li>A direct Monte Carlo simulation of the exact noise model and projective post-selection confirms the series:
    For example, at p = 0.02 we obtain Fcond ≈ 0.99978, very close to 1 − 0.64 p^2 = 0.999744, with small O(p^3) deviations.</li>
</ul>
<p>2) Mathematical details</p>
<ul>
<li>
<p>Stabilizer post-selection:
  The projectors onto the +1 eigenspaces of ZZZZ and XXXX are ΠZ = (I+ZZZZ)/2 and ΠX = (I+XXXX)/2; the projector onto the code space is Πcode = ΠX ΠZ (they commute). If ψ is the state after the (noisy) unitary, then the accepted, normalized state is
  ψacc = ΠX ΠZ (I⊗|0⟩⟨0|4) ψ / √Pacc,
  with Pacc = ∥(I⊗⟨0|4) ψ∥^2 · ⟨ψ| ΠZ |ψ⟩ · ⟨ψ| ΠX |ψ⟩. (<a href="https://quantumcomputing.stackexchange.com/questions/41506/why-is-this-the-projection-operator-on-a-stabilizer-code-subspace?utm_source=openai">quantumcomputing.stackexchange.com</a>)</p>
</li>
<li>
<p>Depolarizing channel after each CNOT (control i, target j):
  Eij(ρ) = (1−p)ρ + (p/15) ∑P∈P2{II} Pij ρ Pij,
  with P2 = {I,X,Y,Z}⊗{I,X,Y,Z}. (<a href="https://en.wikipedia.org/wiki/Quantum_depolarizing_channel?utm_source=openai">en.wikipedia.org</a>)</p>
</li>
<li>
<p>Pauli propagation identities through CNOT (control c, target t):
  CNOT·Xc = Xc Xt·CNOT,  CNOT·Zt = Zc Zt·CNOT;  CNOT·Xt = Xt·CNOT,  CNOT·Zc = Zc·CNOT. These imply that single faults remain Pauli and can be tracked exactly. (<a href="https://rainij.github.io/solutions-qcqi-nielsen-chuang/chapter_10.html?utm_source=openai">rainij.github.io</a>)</p>
</li>
</ul>
<p>3) Conventions and units</p>
<ul>
<li>Qubits labeled 0,1,2,3 for data and 4 for ancilla; logical qubits A,B as specified; all gates are ideal except the two-qubit depolarizing channels; perfect projective measurements for post-selection.</li>
</ul>
<p>4) Final Answer:
Fidelity of the post-selected logical state (conditioned on ancilla outcome |0⟩ and on passing the code’s stabilizer checks) as a function of two-qubit gate error rate p is
Fcond(p) = 1 − (16/25) p^2 + O(p^3).</p>
<p>Citations:
- [[4,2,2]] code, stabilizers, codewords: Error Correction Zoo. (<a href="https://errorcorrectionzoo.org/c/stab_4_2_2?utm_source=openai">errorcorrectionzoo.org</a>)
- Depolarizing channel definition: Wikipedia; Quantum Channel Zoo. (<a href="https://en.wikipedia.org/wiki/Quantum_depolarizing_channel?utm_source=openai">en.wikipedia.org</a>, <a href="https://quantumchannelzoo.org/channel/depolarizing?utm_source=openai">quantumchannelzoo.org</a>)
- CNOT Pauli propagation (Heisenberg picture): Nielsen–Chuang solutions; IBM QEC notes on error propagation. (<a href="https://rainij.github.io/solutions-qcqi-nielsen-chuang/chapter_10.html?utm_source=openai">rainij.github.io</a>, <a href="https://qiskit.qotlabs.org/learning/courses/foundations-of-quantum-error-correction/fault-tolerant-quantum-computing/controlling-error-propagation?utm_source=openai">qiskit.qotlabs.org</a>)
- Stabilizer projection formula Π = ∏i(I+Si)/2: QStackExchange explanation. (<a href="https://quantumcomputing.stackexchange.com/questions/41506/why-is-this-the-projection-operator-on-a-stabilizer-code-subspace?utm_source=openai">quantumcomputing.stackexchange.com</a>)</p></div>
</article>


<article class="message role-user">
    <div class="meta">
        <span class="badge">User</span>
        <span class="idx">#19</span>
    </div>
    <div class="content markdown-body"><p>Populate your final answer into the code template provided below. This step is purely for formatting/display purposes. No additional reasoning or derivation should be performed. Do not import any modules or packages beyond what is provided in the template.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">answer</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the expression of the logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    at the end of the circuit as a function of two-qubit gate error rate $p$.</span>

<span class="sd">    Inputs</span>
<span class="sd">    ----------</span>
<span class="sd">    p: sympy.Symbol, two-qubit gate error rate, $p$</span>

<span class="sd">    Outputs</span>
<span class="sd">    ----------</span>
<span class="sd">    F_logical: sympy.Expr, logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------ FILL IN YOUR RESULTS BELOW ------------------</span>
    <span class="n">F_logical</span> <span class="o">=</span> <span class="o">...</span>  <span class="c1"># a SymPy expression of inputs</span>
    <span class="c1"># ---------------------------------------------------------------</span>

    <span class="k">return</span> <span class="n">F_logical</span>
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#20</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">answer</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the expression of the logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    at the end of the circuit as a function of two-qubit gate error rate $p$.</span>

<span class="sd">    Inputs</span>
<span class="sd">    ----------</span>
<span class="sd">    p: sympy.Symbol, two-qubit gate error rate, $p$</span>

<span class="sd">    Outputs</span>
<span class="sd">    ----------</span>
<span class="sd">    F_logical: sympy.Expr, logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------ FILL IN YOUR RESULTS BELOW ------------------</span>
    <span class="n">F_logical</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="o">**</span><span class="mi">2</span>
    <span class="c1"># ---------------------------------------------------------------</span>

    <span class="k">return</span> <span class="n">F_logical</span>
</code></pre></div></div>
</article>

</div>

<footer>
  Generated at 2025-09-24T22:02:10.445162
</footer>

<script>
(function() {
  // Tabs
  const tabs = document.querySelectorAll('.tab');
  const panels = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      panels.forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      const target = document.querySelector(tab.dataset.target);
      if (target) target.classList.add('active');
    });
  });

  // Theme toggle
  const toggleBtn = document.getElementById('theme-toggle');
  function setTheme(dark) {
    if (dark) {
      document.documentElement.classList.add('dark');
      localStorage.setItem('dark', '1');
    } else {
      document.documentElement.classList.remove('dark');
      localStorage.setItem('dark', '0');
    }
  }
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const stored = localStorage.getItem('dark');
  setTheme(stored === null ? prefersDark : stored === '1');

  toggleBtn.addEventListener('click', () => {
    const isDark = document.documentElement.classList.contains('dark');
    setTheme(!isDark);
  });
})();
</script>
</body>
</html>