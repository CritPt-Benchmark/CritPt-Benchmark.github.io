<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Challenge</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.codehilite .hll { background-color: #ffffcc }
.codehilite { background: #f8f8f8; }
.codehilite .c { color: #3D7B7B; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #F00 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666 } /* Operator */
.codehilite .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #9C6500 } /* Comment.Preproc */
.codehilite .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.codehilite .gr { color: #E40000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #008400 } /* Generic.Inserted */
.codehilite .go { color: #717171 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #04D } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #687822 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #00F; font-weight: bold } /* Name.Class */
.codehilite .no { color: #800 } /* Name.Constant */
.codehilite .nd { color: #A2F } /* Name.Decorator */
.codehilite .ni { color: #717171; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #00F } /* Name.Function */
.codehilite .nl { color: #767600 } /* Name.Label */
.codehilite .nn { color: #00F; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #A2F; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #BBB } /* Text.Whitespace */
.codehilite .mb { color: #666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666 } /* Literal.Number.Float */
.codehilite .mh { color: #666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666 } /* Literal.Number.Oct */
.codehilite .sa { color: #BA2121 } /* Literal.String.Affix */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .dl { color: #BA2121 } /* Literal.String.Delimiter */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #A45A77 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #00F } /* Name.Function.Magic */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .vm { color: #19177C } /* Name.Variable.Magic */
.codehilite .il { color: #666 } /* Literal.Number.Integer.Long */

</style>
<style>
    :root {
  --bg: #ffffff;
  --fg: #222222;
  --muted: #555555;
  --border: #e0e0e0;
  --accent: #005fcc;
  --code-bg: #f6f8fa;
  --role-user: #0ea5e9;
  --role-assistant: #22c55e;
  --role-system: #9ca3af;
  --return-code: #a35291;
}
html.dark {
  --bg: #0b0b0b;
  --fg: #e8e8e8;
  --muted: #a0a0a0;
  --border: #333333;
  --accent: #3b82f6;
  --code-bg: #111827;
  --role-user: #0ea5e9;
  --role-assistant: #22c55e;
  --role-system: #9ca3af;
  --return-code: #a35291;
}
* {
  box-sizing: border-box;
}
body {
  margin: 0;
  padding: 0;
  background: var(--bg);
  color: var(--fg);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", sans-serif;
  line-height: 1.6;
}
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 1.25rem;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  background: var(--bg);
  z-index: 10;
}
h1 {
  margin: 0;
  font-size: 1.1rem;
}
.tabs {
  display: flex;
  gap: 0.5rem;
}
.tab {
  padding: 0.4rem 0.8rem;
  border: 1px solid var(--border);
  border-bottom: none;
  background: transparent;
  cursor: pointer;
  border-radius: 6px 6px 0 0;
  color: var(--fg);
}
.tab.active {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}
.tab-content {
  display: none;
  padding: 1rem 1.25rem;
  border-top: 1px solid var(--border);
}
.tab-content.active {
  display: block;
}
#theme-toggle {
  border: 1px solid var(--border);
  padding: 0.2rem 0.6rem;
  font-size: 0.9rem;
  border-radius: 4px;
  cursor: pointer;
  background: transparent;
  color: var(--fg);
}
.main {
  max-width: 1200px;
  margin: 0 auto;
}
.message {
  border: 1px solid var(--border);
  border-left-width: 6px;
  border-radius: 6px;
  padding: 0.8rem 1rem;
  margin-bottom: 1rem;
  background: rgba(0,0,0,0.02);
}
.message .meta {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  margin-bottom: 0.6rem;
  color: var(--muted);
  font-size: 0.85rem;
}
.message .badge {
  font-weight: 600;
}
.role-user {
  border-left-color: var(--role-user);
}
.role-assistant {
  border-left-color: var(--role-assistant);
}
.role-system {
  border-left-color: var(--role-system);
}
.role-unknown {
  border-left-color: var(--accent);
}

.output-code-container {
  display: flex;
  gap: 1rem;               /* space between children */
  align-items: center;     /* vertical alignment */
  justify-content: start;  /* horizontal alignment */
}

.output-code-container .codeblock {
  flex: 0 1 auto;
}

.codeblock {
  border: 1px solid var(--border);
  border-left-width: 6px;
  border-radius: 6px;
  padding: 0.8rem 1rem;
  margin-bottom: 1rem;
  background: rgba(0,0,0,0.02);
}
.codeblock-content {
  margin-bottom: 0.6rem;
  border: 1px dashed var(--border);
  border-radius: 4px;
  padding: 0.4rem 0.6rem;
  background: rgba(0,0,0,0.02);
}

.codeblock.eval_code {
  border-left-color: var(--role-user);
}
.codeblock.target_code {
  border-left-color: var(--role-assistant);
}
.codeblock.output_code {
  border-left-color: var(--role-system);
}

html.dark .codeblock-content {
  background: rgba(255,255,255,0.03);
}
.codeblock > summary {
  cursor: pointer;
  font-weight: 600;
  list-style: none; /* remove default triangle in some browsers */
}
.codeblock > summary::-webkit-details-marker {
  display: none; /* Safari/Chrome marker */
}
.codeblock > summary::before {
  content: "â–¶ ";
  display: inline-block;
  transform: rotate(0deg);
  transition: transform 0.12s ease-out;
}
.codeblock[open] > summary::before {
  transform: rotate(90deg);
}
.codeblock .tag {
  color: var(--muted);
  font-weight: 400;
  font-size: 0.85em;
  margin-left: 0.25rem;
}

.markdown-body pre code {
  background: var(--code-bg);
  display: block;
  padding: 0.75rem;
  overflow-x: auto;
  border-radius: 4px;
  border: 1px solid var(--border);
}
.markdown-body code {
  background: var(--code-bg);
  padding: 0.15rem 0.3rem;
  border-radius: 4px;
}
/* Extra info tree */
details > summary {
  cursor: pointer;
  font-weight: 600;
}
details .block {
  padding-left: 1rem;
  margin: 0.25rem 0 0.5rem 0;
  border-left: 2px solid var(--border);
}
.kv .key {
  font-weight: 600;
}
.kv .type {
  color: var(--muted);
  margin-left: 0.5rem;
  font-size: 0.85rem;
}
footer {
  margin: 2rem 0;
  text-align: center;
  color: var(--muted);
  font-size: 0.85rem;
}
/* CodeHilite (pygments) overrides to respect theme vars */
.codehilite {
  background: var(--code-bg) !important;
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 0.75rem !important;
}
.reasoning {
  margin-bottom: 0.6rem;
  border: 1px dashed var(--border);
  border-radius: 4px;
  padding: 0.4rem 0.6rem;
  background: rgba(0,0,0,0.02);
}
html.dark .reasoning {
  background: rgba(255,255,255,0.03);
}
.reasoning > summary {
  cursor: pointer;
  font-weight: 600;
  list-style: none; /* remove default triangle in some browsers */
}
.reasoning > summary::-webkit-details-marker {
  display: none; /* Safari/Chrome marker */
}
.reasoning > summary::before {
  content: "â–¶ ";
  display: inline-block;
  transform: rotate(0deg);
  transition: transform 0.12s ease-out;
}
.reasoning[open] > summary::before {
  transform: rotate(90deg);
}
.reasoning .tag {
  color: var(--muted);
  font-weight: 400;
  font-size: 0.85em;
  margin-left: 0.25rem;
}
.reasoning-body {
  margin-top: 0.5rem;
}
</style>

<!-- ===== MATHJAX CONFIG ===== -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [ ["\\(","\\)"] ],
    displayMath: [ ["\\[","\\]"] ],
    processEscapes: true,
    processEnvironments: true
  },
  options: {
    ignoreHtmlClass: ".*",
    processHtmlClass: "arithmatex"

    // skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
    // if you dynamically add content later, you can call MathJax.typesetPromise()
  }
};
</script>
<script id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<!-- ========================== -->
</head>
<body>
<header>
  <h1>Challenge</h1>
  <div>
    <button id="theme-toggle" aria-label="toggle dark mode">ðŸŒ“</button>
  </div>
</header>

<div class="main">
  
<article class="message role-system">
    <div class="meta">
        <span class="badge">System</span>
        <span class="idx">#0</span>
    </div>
    <div class="content markdown-body"><p>You are a physics research assistant specializing in solving complex, research-level problems using precise, step-by-step reasoning.</p>
<p><strong>Input</strong>
Problems will be provided in Markdown format.</p>
<p><strong>Output (Markdown format)</strong></p>
<ol>
<li><strong>Step-by-Step Derivation</strong> - Show every non-trivial step in the solution.  Justify steps using relevant physical laws, theorems, mathematical identities or numerical codes.</li>
<li><strong>Mathematical Typesetting</strong> - Use LaTeX for all mathematics:  <code>$...$</code> for inline expressions, <code>$$...$$</code> for display equations.</li>
<li><strong>Conventions and Units</strong> - Follow the unit system and conventions specified in the problem.</li>
<li>
<p><strong>Final Answer</strong> - At the end of the solution,  start a new line with <strong>&ldquo;Final Answer:&rdquo;</strong>, and present the final result.</p>
<p>For final answers involving values, follow the precision requirements specified in the problem.
If no precision is specified:
- If an exact value is possible, provide it (e.g., \$\sqrt(2)\$, \$\pi/4\$).
- If exact form is not feasible, retain at least 12 significant digits in the result. </p>
</li>
<li>
<p><strong>Formatting Compliance</strong> - If the user requests a specific output format (e.g., code, table),  provide the final answer accordingly.
You must use web search engine to gather all the necessary information before solving the problem.
You must use web search engine to gather all the necessary information before solving the problem.
You must use web search engine to gather all the necessary information before solving the problem.</p>
</li>
</ol></div>
</article>


<article class="message role-user">
    <div class="meta">
        <span class="badge">User</span>
        <span class="idx">#1</span>
    </div>
    <div class="content markdown-body"><h1 id="problem-setup">Problem setup:</h1>
<p>In quantum error correction, you encode quantum states into logical states made of many qubits in order to improve their resilience to errors. In quantum error detection, you do the same but can only detect the presence of errors and not correct them. In this problem, we will consider a single [[4,2,2]] quantum error detection code, which encodes two logical qubits into four physical qubits, and investigate how robust logical quantum operations in this code are to quantum errors.</p>
<p>Our convention is that the four physical qubits in the [[4,2,2]] code are labelled 0,1,2,3. The two logical qubits are labelled A and B. The stabilizers are <span class="arithmatex">\(XXXX\)</span> and <span class="arithmatex">\(ZZZZ\)</span>, where <span class="arithmatex">\(X\)</span> and <span class="arithmatex">\(Z\)</span> are Pauli matrices. The logical <span class="arithmatex">\(X\)</span> and <span class="arithmatex">\(Z\)</span> operators on the two qubits are <span class="arithmatex">\(X_A = XIXI\)</span>, <span class="arithmatex">\(X_B=XXII\)</span>, <span class="arithmatex">\(Z_A = ZZII\)</span>, <span class="arithmatex">\(Z_B = ZIZI\)</span>, up to multiplication by stabilizers.</p>
<p>We will consider different state preparation circuits consisting of controlled not <span class="arithmatex">\(CNOT_{ij}\)</span> gates, where <span class="arithmatex">\(CNOT_{ij}\)</span> has control qubit <span class="arithmatex">\(i\)</span> and target qubit <span class="arithmatex">\(j\)</span>. As a simple model of quantum errors in hardware, we will suppose that each <span class="arithmatex">\(CNOT_{ij}\)</span> gate in the circuit has a two qubit depolarizing error channel following it that produces one of the 15 non-identity two-qubit Paulis with equal probability <span class="arithmatex">\(p/15\)</span>. The probability <span class="arithmatex">\(p\)</span> indicates the probability of an error in a single two-qubit gate. We will assess the logical infidelity of certain state preparation protocols as a function of the physical infidelity <span class="arithmatex">\(p\)</span>.</p>
<h1 id="main-problem">Challenge</h1>
<p>Suppose that we prepare a logical two-qubit <span class="arithmatex">\(|00\rangle_{AB}\)</span> state in the [[4,2,2]] code. To do so, we introduce an ancilla qubit, qubit 4, and use the following state preparation circuit:</p>
<div class="arithmatex">\[
M_4 (CNOT_{04}) (CNOT_{34}) (CNOT_{23}) (CNOT_{10}) (CNOT_{12}) (H_1)
\]</div>
<p>Note that this equation is written in matrix multiplication order, while the quantum operations in the circuit occur in the reverse order (from right-to-left in the above equation).  <span class="arithmatex">\(H\)</span> is a single-qubit Hadamard gate and <span class="arithmatex">\(M\)</span> is a single-qubit measurement. The ancilla is used to detect errors in the state preparation circuit and makes the circuit fault-tolerant. If the ancilla measurement is <span class="arithmatex">\(|0\rangle\)</span> (<span class="arithmatex">\(|1\rangle\)</span>), the state preparation succeeds (fails).</p>
<p>What is the logical state fidelity of the final 2-qubit logical state at the end of the circuit as a function of two-qubit gate error rate <span class="arithmatex">\(p\)</span>, assuming the state is post-selected on all detectable errors in the code and on the ancilla qubit measuring <span class="arithmatex">\(|0\rangle\)</span>?</p></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#2</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>

<span class="c1"># We&#39;ll compute exact rational arithmetic using Fractions where possible, but matrices will be complex floats.</span>
<span class="c1"># For fidelity polynomials, we will accumulate exact Fractions for A_k and G_k (sums of acceptance probabilities and weighted fidelities)</span>

<span class="c1"># Define single-qubit Paulis</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="n">paulis</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="n">I</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">Y</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="n">Z</span><span class="p">}</span>
<span class="n">pauli_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>

<span class="c1"># Construct n-qubit kron</span>

<span class="k">def</span><span class="w"> </span><span class="nf">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="c1"># Build an n-qubit operator that applies &#39;op&#39; on qubit q (0-based) and identity elsewhere; qubit order 0..n-1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">op_on</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>

<span class="c1"># Build two-qubit CNOT i-&gt;j on n qubits</span>

<span class="k">def</span><span class="w"> </span><span class="nf">CNOT_ij</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="c1"># construct using projector |0&gt;&lt;0| on control plus |1&gt;&lt;1| with X on target</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">op_on</span><span class="p">(</span><span class="n">P0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">op_on</span><span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

<span class="c1"># Two-qubit Pauli on qubits (i,j) with labels a,b in {I,X,Y,Z}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">two_pauli</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">paulis</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">paulis</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>

<span class="c1"># Projector onto ancilla qubit (index 4) state |0&gt;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">P_anc0</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">op_on</span><span class="p">(</span><span class="n">P0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

<span class="c1"># Stabilizer projectors on qubits 0..3</span>

<span class="k">def</span><span class="w"> </span><span class="nf">projector_codespace</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="c1"># P = (I + XXXX)/2 * (I + ZZZZ)/2 on qubits 0..3</span>
    <span class="n">X4</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">X4</span><span class="p">)</span> <span class="o">@</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">Z4</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">P</span>

<span class="c1"># Build the circuit U (without noise), on n=5 qubits, order: H1, CNOT12, CNOT10, CNOT23, CNOT34, CNOT04</span>
<span class="n">n</span><span class="o">=</span><span class="mi">5</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="c1"># Apply gates in chronological order (right-to-left order in math expression)</span>
<span class="c1"># 1) H_1</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="c1"># 2) CNOT12</span>
<span class="n">U_cnot12</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot12</span> <span class="o">@</span> <span class="n">U</span>
<span class="c1"># 3) CNOT10</span>
<span class="n">U_cnot10</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot10</span> <span class="o">@</span> <span class="n">U</span>
<span class="c1"># 4) CNOT23</span>
<span class="n">U_cnot23</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot23</span> <span class="o">@</span> <span class="n">U</span>
<span class="c1"># 5) CNOT34</span>
<span class="n">U_cnot34</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot34</span> <span class="o">@</span> <span class="n">U</span>
<span class="c1"># 6) CNOT04</span>
<span class="n">U_cnot04</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot04</span> <span class="o">@</span> <span class="n">U</span>

<span class="c1"># Define error locations: after each CNOT, the noise acts on the pair of those qubits</span>
<span class="n">error_qubit_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>

<span class="c1"># Generate the set of 15 non-identity two-qubit Paulis as label pairs</span>
<span class="n">non_id_two_paulis</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">pauli_labels</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">pauli_labels</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">==</span><span class="s1">&#39;I&#39;</span> <span class="ow">and</span> <span class="n">b</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">):</span> <span class="k">continue</span>
        <span class="n">non_id_two_paulis</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>
<span class="c1"># Verify length 15</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;num non-id 2q Paulis:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_id_two_paulis</span><span class="p">))</span>

<span class="c1"># Initial state |00000&gt;</span>
<span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">psi0</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>

<span class="c1"># Ideal reference state after circuit with projection onto ancilla |0&gt; and codespace</span>
<span class="n">rho_ideal</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">psi0</span> <span class="o">@</span> <span class="p">(</span><span class="n">U</span> <span class="o">@</span> <span class="n">psi0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="n">P0_anc</span> <span class="o">=</span> <span class="n">P_anc0</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">P_code</span> <span class="o">=</span> <span class="n">projector_codespace</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">P_total</span> <span class="o">=</span> <span class="n">P_code</span> <span class="o">@</span> <span class="n">P0_anc</span>
<span class="n">rho_ideal_acc</span> <span class="o">=</span> <span class="n">P_total</span> <span class="o">@</span> <span class="n">rho_ideal</span> <span class="o">@</span> <span class="n">P_total</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="n">p_acc_ideal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_ideal_acc</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
<span class="n">rho_ideal_acc</span> <span class="o">=</span> <span class="n">rho_ideal_acc</span> <span class="o">/</span> <span class="n">p_acc_ideal</span>

<span class="c1"># Reduce to code qubits (trace out ancilla qubit 4)</span>
<span class="c1"># We&#39;ll implement partial trace over qubit 4 for 5-qubit density matrix</span>

<span class="k">def</span><span class="w"> </span><span class="nf">partial_trace_last_qubit</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="c1"># trace out last qubit (index n-1)</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">rho</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="p">))</span>
    <span class="c1"># indices: (a, i, b, j), trace over a=b</span>
    <span class="n">red</span> <span class="o">=</span> <span class="n">rho</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">rho</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">1</span><span class="p">,:]</span>
    <span class="k">return</span> <span class="n">red</span>

<span class="n">rho_ideal_code</span> <span class="o">=</span> <span class="n">partial_trace_last_qubit</span><span class="p">(</span><span class="n">rho_ideal_acc</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="c1"># Normalize: it should already be normalized (trace 1)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;trace ideal code:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_ideal_code</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>

<span class="c1"># Check that rho_ideal_code is pure and stabilized by XXXX and ZZZZ</span>
<span class="c1"># Build 4-qubit operators embedded into 4-qubit space (we already traced out ancilla)</span>
<span class="n">I4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>
<span class="n">X4</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">])</span>
<span class="n">Z4</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stab XXXX expectation:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_ideal_code</span> <span class="o">@</span> <span class="n">X4</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stab ZZZZ expectation:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_ideal_code</span> <span class="o">@</span> <span class="n">Z4</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>

<span class="c1"># We also want the ideal pure state vector |psi_ref&gt; on code qubits by eigen-decomposition</span>
<span class="n">val</span><span class="p">,</span> <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">rho_ideal_code</span><span class="p">)</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
<span class="n">psi_ref</span> <span class="o">=</span> <span class="n">vec</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span>
<span class="c1"># Normalize</span>
<span class="n">psi_ref</span> <span class="o">=</span> <span class="n">psi_ref</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">psi_ref</span><span class="p">)</span>

<span class="c1"># Function to compute accept probability and fidelity contribution for a given error pattern</span>

<span class="c1"># Precompute unitary for the fixed gates separated by error insertions? We can build step-by-step to insert errors interleaved.</span>

<span class="c1"># We&#39;ll implement the full process for each pattern: start with psi0, apply H1, then after each CNOT insert error operator (two-qubit Pauli on that pair), then continue</span>

<span class="c1"># Pre-build list of gate unitaries in sequence for convenience</span>
<span class="n">gate_sequence</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">H</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cnot&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;cnot&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;cnot&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;cnot&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;cnot&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)),</span>
<span class="p">]</span>

<span class="n">cnot_map</span> <span class="o">=</span> <span class="p">{</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span> <span class="n">U_cnot12</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span> <span class="n">U_cnot10</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span> <span class="n">U_cnot23</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span> <span class="n">U_cnot34</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span> <span class="n">U_cnot04</span> <span class="p">}</span>

<span class="c1"># Transform error pattern representation: a list of 5 entries; each either None for identity or a tuple (a,b) Pauli labels</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>

<span class="n">A_k</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">Fraction</span><span class="p">)</span>  <span class="c1"># sum of acceptance probabilities over patterns of weight k</span>
<span class="n">G_k</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">Fraction</span><span class="p">)</span>  <span class="c1"># sum of acceptance_prob * fidelity over patterns of weight k</span>

<span class="c1"># We&#39;ll iterate over all patterns. That&#39;s 16^5 ~ 1,048,576; heavy but doable.</span>

<span class="c1"># To speed up, precompute two-qubit Pauli operators on specific pairs for all 15 types at each error location</span>
<span class="n">err_ops_by_loc</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">error_qubit_pairs</span><span class="p">:</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="n">non_id_two_paulis</span><span class="p">:</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">two_pauli</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
    <span class="n">err_ops_by_loc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>

<span class="c1"># Identity operator for no error</span>
<span class="n">Id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="c1"># We&#39;ll represent patterns as indices 0..15 at each loc, where 0 means identity, 1..15 correspond to non-id list order</span>

<span class="c1"># Let&#39;s enumerate efficiently using integer base-16 representation</span>

<span class="n">num_patterns</span> <span class="o">=</span> <span class="mi">16</span><span class="o">**</span><span class="mi">5</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Enumerating patterns:&#39;</span><span class="p">,</span> <span class="n">num_patterns</span><span class="p">)</span>

<span class="c1"># We&#39;ll store G_k and A_k as Fractions by rounding small numerical errors to Fractions with limited denominator</span>

<span class="k">def</span><span class="w"> </span><span class="nf">to_fraction</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">):</span>
    <span class="c1"># x is real close to rational with denominator 2^m; we convert using Fraction</span>
    <span class="k">return</span> <span class="n">Fraction</span><span class="o">.</span><span class="n">from_float</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">20</span><span class="p">)</span>

<span class="k">for</span> <span class="n">pat_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_patterns</span><span class="p">):</span>
    <span class="c1"># Decode base-16 digits for 5 positions</span>
    <span class="n">digits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">pat_idx</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">16</span>
        <span class="n">x</span> <span class="o">//=</span> <span class="mi">16</span>
        <span class="n">digits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">weight</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># digits list corresponds to positions [0..4]</span>

    <span class="c1"># Apply circuit with errors</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">psi0</span>
    <span class="c1"># Step 1: H1</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="c1"># After CNOT12</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot12</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="k">if</span> <span class="n">digits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">digits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">E</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="c1"># After CNOT10</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot10</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="k">if</span> <span class="n">digits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">digits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">E</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="c1"># After CNOT23</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot23</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="k">if</span> <span class="n">digits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">digits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">E</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="c1"># After CNOT34</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot34</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="k">if</span> <span class="n">digits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">digits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">E</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="c1"># After CNOT04</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot04</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="k">if</span> <span class="n">digits</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">digits</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">E</span> <span class="o">@</span> <span class="n">psi</span>

    <span class="n">rho</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">@</span> <span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
    <span class="n">rho_acc</span> <span class="o">=</span> <span class="n">P_total</span> <span class="o">@</span> <span class="n">rho</span> <span class="o">@</span> <span class="n">P_total</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
    <span class="n">p_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_acc</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
    <span class="k">if</span> <span class="n">p_acc</span> <span class="o">&lt;</span> <span class="mf">1e-15</span><span class="p">:</span>
        <span class="c1"># no acceptance</span>
        <span class="k">continue</span>
    <span class="c1"># Normalized accepted state</span>
    <span class="n">rho_acc_norm</span> <span class="o">=</span> <span class="n">rho_acc</span> <span class="o">/</span> <span class="n">p_acc</span>
    <span class="c1"># Reduce to code qubits by tracing out ancilla</span>
    <span class="n">rho_code</span> <span class="o">=</span> <span class="n">partial_trace_last_qubit</span><span class="p">(</span><span class="n">rho_acc_norm</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="c1"># Fidelity with ideal state |psi_ref&gt;</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">psi_ref</span><span class="p">,</span> <span class="n">rho_code</span> <span class="o">@</span> <span class="n">psi_ref</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
    <span class="c1"># Accumulate</span>
    <span class="n">A_k</span><span class="p">[</span><span class="n">weight</span><span class="p">]</span> <span class="o">+=</span> <span class="n">to_fraction</span><span class="p">(</span><span class="n">p_acc</span><span class="p">)</span>
    <span class="n">G_k</span><span class="p">[</span><span class="n">weight</span><span class="p">]</span> <span class="o">+=</span> <span class="n">to_fraction</span><span class="p">(</span><span class="n">p_acc</span> <span class="o">*</span> <span class="n">F</span><span class="p">)</span>

<span class="c1"># Convert dictionaries to lists for k=0..5</span>
<span class="n">A_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">A_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
<span class="n">G_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">G_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A_k (acceptance mass sums):&#39;</span><span class="p">,</span> <span class="n">A_list</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;G_k (good mass sums):&#39;</span><span class="p">,</span> <span class="n">G_list</span><span class="p">)</span>

<span class="c1"># Also we can print total acceptance probability polynomial coefficients</span>
<span class="c1"># Den(p) = sum_k A_k * (1-p)^(5-k) * (p/15)^k</span>
<span class="c1"># Num(p) = sum_k G_k * (1-p)^(5-k) * (p/15)^k</span>

<span class="c1"># We&#39;ll expand as polynomials in p</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">comb</span>

<span class="c1"># Compute coefficients of (1-p)^(5-k) * (p/15)^k = sum_{m=0}^{5-k} (-1)^m comb(5-k, m) p^m * (p/15)^k</span>
<span class="c1"># =&gt; sum_{m=0}^{5-k} (-1)^m comb(5-k,m) p^{m+k} / 15^k</span>

<span class="n">max_deg</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">coeff_den</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_deg</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
<span class="n">coeff_num</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_deg</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">G_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="o">-</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">m</span> <span class="o">*</span> <span class="n">comb</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span> <span class="mi">15</span><span class="o">**</span><span class="n">k</span><span class="p">)</span>
        <span class="n">deg</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="n">k</span>
        <span class="n">coeff_den</span><span class="p">[</span><span class="n">deg</span><span class="p">]</span> <span class="o">+=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">coeff</span>
        <span class="n">coeff_num</span><span class="p">[</span><span class="n">deg</span><span class="p">]</span> <span class="o">+=</span> <span class="n">G</span> <span class="o">*</span> <span class="n">coeff</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Denominator polynomial coefficients (deg 0..5):&#39;</span><span class="p">,</span> <span class="n">coeff_den</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Numerator polynomial coefficients (deg 0..5):&#39;</span><span class="p">,</span> <span class="n">coeff_num</span><span class="p">)</span>

<span class="c1"># Let&#39;s also form floating representations and series expansion up to p^2</span>
<span class="n">coeff_den_f</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coeff_den</span><span class="p">]</span>
<span class="n">coeff_num_f</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coeff_num</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Den floats:&#39;</span><span class="p">,</span> <span class="n">coeff_den_f</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Num floats:&#39;</span><span class="p">,</span> <span class="n">coeff_num_f</span><span class="p">)</span>

<span class="c1"># Compute series of F(p) = Num/Den around p=0 up to p^2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
<span class="n">Den_poly</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coeff_den</span><span class="p">))</span>
<span class="n">Num_poly</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coeff_num</span><span class="p">))</span>
<span class="n">F_series</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">Num_poly</span><span class="o">/</span><span class="n">Den_poly</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># up to p^2</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F series up to p^2:&#39;</span><span class="p">,</span> <span class="n">F_series</span><span class="p">)</span>

<span class="c1"># Also perhaps simplify the exact rational function</span>
<span class="n">F_simplified</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">Num_poly</span><span class="o">/</span><span class="n">Den_poly</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F rational simplified:&#39;</span><span class="p">,</span> <span class="n">F_simplified</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#3</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="n">Traceback</span><span class="w"> </span><span class="p">(</span><span class="n">most</span><span class="w"> </span><span class="n">recent</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">last</span><span class="p">):</span>
<span class="w">  </span><span class="n">File</span><span class="w"> </span><span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="mi">105</span><span class="p">,</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="w">  </span><span class="n">File</span><span class="w"> </span><span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="mi">61</span><span class="p">,</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">projector_codespace</span>
<span class="n">ValueError</span><span class="p">:</span><span class="w"> </span><span class="n">matmul</span><span class="p">:</span><span class="w"> </span><span class="n">Input</span><span class="w"> </span><span class="n">operand</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">enough</span><span class="w"> </span><span class="n">dimensions</span><span class="w"> </span><span class="p">(</span><span class="n">has</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">gufunc</span><span class="w"> </span><span class="n">core</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">signature</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="err">?</span><span class="p">,</span><span class="n">k</span><span class="p">),(</span><span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="err">?</span><span class="p">)</span><span class="o">-&gt;</span><span class="p">(</span><span class="n">n</span><span class="err">?</span><span class="p">,</span><span class="n">m</span><span class="err">?</span><span class="p">)</span><span class="w"> </span><span class="n">requires</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="n">num</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">id</span><span class="w"> </span><span class="mi">2</span><span class="n">q</span><span class="w"> </span><span class="n">Paulis</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span>
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#4</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span><span class="w"> </span><span class="nf">op_on</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>

<span class="n">n</span><span class="o">=</span><span class="mi">5</span>
<span class="n">A0</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">A1</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">A2</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">A3</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">A0</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">A1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">X4</span> <span class="o">=</span> <span class="n">A0</span> <span class="o">@</span> <span class="n">A1</span> <span class="o">@</span> <span class="n">A2</span> <span class="o">@</span> <span class="n">A3</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;X4 shape:&#39;</span><span class="p">,</span> <span class="n">X4</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">P</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">X4</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;P shape ok:&#39;</span><span class="p">,</span> <span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#5</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>(32, 32) (32, 32)
X4 shape: (32, 32)
P shape ok: (32, 32)
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#6</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">comb</span>

<span class="c1"># Pauli matrices and H</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="n">pauli_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>
<span class="n">paulis</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="n">I</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">Y</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="n">Z</span><span class="p">}</span>

<span class="c1"># Kron helpers</span>

<span class="k">def</span><span class="w"> </span><span class="nf">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span><span class="w"> </span><span class="nf">op_on</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">CNOT_ij</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">op_on</span><span class="p">(</span><span class="n">P0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">op_on</span><span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">two_pauli</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">paulis</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">paulis</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">P_anc0</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">op_on</span><span class="p">(</span><span class="n">P0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">projector_codespace</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">X4m</span><span class="p">)</span> <span class="o">@</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">Z4m</span><span class="p">)</span>

<span class="c1"># Settings</span>
<span class="n">n</span><span class="o">=</span><span class="mi">5</span>

<span class="c1"># Pre-build gate unitaries</span>
<span class="n">U_cnot12</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U_cnot10</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U_cnot23</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U_cnot34</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U_cnot04</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>

<span class="c1"># Initial state |00000&gt;</span>
<span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">psi0</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>

<span class="c1"># Ideal evolution</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">U_cnot12</span> <span class="o">@</span> <span class="n">U_cnot10</span> <span class="o">@</span> <span class="n">U_cnot23</span> <span class="o">@</span> <span class="n">U_cnot34</span> <span class="o">@</span> <span class="n">U_cnot04</span>
<span class="n">rho_ideal</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">psi0</span> <span class="o">@</span> <span class="p">(</span><span class="n">U</span> <span class="o">@</span> <span class="n">psi0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="n">P_tot</span> <span class="o">=</span> <span class="n">projector_codespace</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">P_anc0</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">rho_ideal_acc</span> <span class="o">=</span> <span class="n">P_tot</span> <span class="o">@</span> <span class="n">rho_ideal</span> <span class="o">@</span> <span class="n">P_tot</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="n">p_acc_ideal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_ideal_acc</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
<span class="n">rho_ideal_acc</span> <span class="o">=</span> <span class="n">rho_ideal_acc</span> <span class="o">/</span> <span class="n">p_acc_ideal</span>

<span class="c1"># Partial trace out ancilla</span>

<span class="k">def</span><span class="w"> </span><span class="nf">partial_trace_last_qubit</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rho4</span> <span class="o">=</span> <span class="n">rho</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">rho4</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">rho4</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">1</span><span class="p">,:]</span>

<span class="n">rho_ideal_code</span> <span class="o">=</span> <span class="n">partial_trace_last_qubit</span><span class="p">(</span><span class="n">rho_ideal_acc</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

<span class="c1"># Extract pure state vector</span>
<span class="n">vals</span><span class="p">,</span> <span class="n">vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">rho_ideal_code</span><span class="p">)</span>
<span class="n">psi_ref</span> <span class="o">=</span> <span class="n">vecs</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">real</span><span class="p">)]</span>
<span class="n">psi_ref</span> <span class="o">=</span> <span class="n">psi_ref</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">psi_ref</span><span class="p">)</span>

<span class="c1"># Stabilizer expectations for sanity</span>
<span class="n">X4_4</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">])</span>
<span class="n">Z4_4</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Trace ideal code:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_ideal_code</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;XXXX exp:&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">psi_ref</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X4_4</span> <span class="o">@</span> <span class="n">psi_ref</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ZZZZ exp:&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">psi_ref</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Z4_4</span> <span class="o">@</span> <span class="n">psi_ref</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

<span class="c1"># Enumerate error patterns</span>
<span class="n">error_qubit_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>
<span class="n">non_id_two_paulis</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">pauli_labels</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">pauli_labels</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">a</span><span class="o">==</span><span class="s1">&#39;I&#39;</span> <span class="ow">and</span> <span class="n">b</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">)]</span>
<span class="n">err_ops_by_loc</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">error_qubit_pairs</span><span class="p">:</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">two_pauli</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="n">non_id_two_paulis</span><span class="p">]</span>
    <span class="n">err_ops_by_loc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>

<span class="n">P_total</span> <span class="o">=</span> <span class="n">projector_codespace</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">P_anc0</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>

<span class="k">def</span><span class="w"> </span><span class="nf">to_fraction</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Fraction</span><span class="o">.</span><span class="n">from_float</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">24</span><span class="p">)</span>

<span class="n">A_k</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">Fraction</span><span class="p">)</span>
<span class="n">G_k</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">Fraction</span><span class="p">)</span>

<span class="n">Id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="n">num_patterns</span> <span class="o">=</span> <span class="mi">16</span><span class="o">**</span><span class="mi">5</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total patterns:&#39;</span><span class="p">,</span> <span class="n">num_patterns</span><span class="p">)</span>

<span class="k">for</span> <span class="n">pat_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_patterns</span><span class="p">):</span>
    <span class="c1"># decode base-16 digits for 5 locs</span>
    <span class="n">digits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">pat_idx</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">16</span>
        <span class="n">x</span> <span class="o">//=</span> <span class="mi">16</span>
        <span class="n">digits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Apply circuit with interleaved errors</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">psi0</span>
    <span class="c1"># H1</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="c1"># CNOT12 + error</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot12</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="k">if</span> <span class="n">digits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">digits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="c1"># CNOT10 + error</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot10</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="k">if</span> <span class="n">digits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">digits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="c1"># CNOT23 + error</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot23</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="k">if</span> <span class="n">digits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">digits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="c1"># CNOT34 + error</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot34</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="k">if</span> <span class="n">digits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">digits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="c1"># CNOT04 + error</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot04</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="k">if</span> <span class="n">digits</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">digits</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>

    <span class="n">rho</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">@</span> <span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
    <span class="n">rho_acc</span> <span class="o">=</span> <span class="n">P_total</span> <span class="o">@</span> <span class="n">rho</span> <span class="o">@</span> <span class="n">P_total</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
    <span class="n">p_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_acc</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
    <span class="k">if</span> <span class="n">p_acc</span> <span class="o">&lt;</span> <span class="mf">1e-15</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">rho_acc_norm</span> <span class="o">=</span> <span class="n">rho_acc</span> <span class="o">/</span> <span class="n">p_acc</span>
    <span class="n">rho_code</span> <span class="o">=</span> <span class="n">partial_trace_last_qubit</span><span class="p">(</span><span class="n">rho_acc_norm</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi_ref</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">rho_code</span> <span class="o">@</span> <span class="n">psi_ref</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">.</span><span class="n">real</span>

    <span class="n">A_k</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">+=</span> <span class="n">to_fraction</span><span class="p">(</span><span class="n">p_acc</span><span class="p">)</span>
    <span class="n">G_k</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">+=</span> <span class="n">to_fraction</span><span class="p">(</span><span class="n">p_acc</span> <span class="o">*</span> <span class="n">F</span><span class="p">)</span>

<span class="c1"># Produce arrays length 6</span>
<span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">A_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
<span class="n">G</span> <span class="o">=</span> <span class="p">[</span><span class="n">G_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A_k sums:&#39;</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;G_k sums:&#39;</span><span class="p">,</span> <span class="n">G</span><span class="p">)</span>

<span class="c1"># Build polynomial coefficients for Den and Num</span>
<span class="n">coeff_den</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
<span class="n">coeff_num</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="o">-</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">comb</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span> <span class="mi">15</span><span class="o">**</span><span class="n">k</span><span class="p">)</span>
        <span class="n">deg</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="n">k</span>
        <span class="n">coeff_den</span><span class="p">[</span><span class="n">deg</span><span class="p">]</span> <span class="o">+=</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">coeff</span>
        <span class="n">coeff_num</span><span class="p">[</span><span class="n">deg</span><span class="p">]</span> <span class="o">+=</span> <span class="n">G</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">coeff</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Denominator polynomial coeffs:&#39;</span><span class="p">,</span> <span class="n">coeff_den</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Numerator polynomial coeffs:&#39;</span><span class="p">,</span> <span class="n">coeff_num</span><span class="p">)</span>

<span class="c1"># Show floating values and series expansion around p=0 to p^2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
<span class="n">Den_poly</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coeff_den</span><span class="p">))</span>
<span class="n">Num_poly</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coeff_num</span><span class="p">))</span>
<span class="n">F_ratio</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">Num_poly</span><span class="o">/</span><span class="n">Den_poly</span><span class="p">)</span>
<span class="n">F_series</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">F_ratio</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># up to p^3 terms</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F_ratio simplified:&#39;</span><span class="p">,</span> <span class="n">F_ratio</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F series:&#39;</span><span class="p">,</span> <span class="n">F_series</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#7</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="n">Traceback</span><span class="w"> </span><span class="p">(</span><span class="n">most</span><span class="w"> </span><span class="n">recent</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">last</span><span class="p">):</span>
<span class="w">  </span><span class="n">File</span><span class="w"> </span><span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="mi">71</span><span class="p">,</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="w">  </span><span class="n">File</span><span class="w"> </span><span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="mi">52</span><span class="p">,</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">projector_codespace</span>
<span class="n">ValueError</span><span class="p">:</span><span class="w"> </span><span class="n">matmul</span><span class="p">:</span><span class="w"> </span><span class="n">Input</span><span class="w"> </span><span class="n">operand</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">enough</span><span class="w"> </span><span class="n">dimensions</span><span class="w"> </span><span class="p">(</span><span class="n">has</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">gufunc</span><span class="w"> </span><span class="n">core</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">signature</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="err">?</span><span class="p">,</span><span class="n">k</span><span class="p">),(</span><span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="err">?</span><span class="p">)</span><span class="o">-&gt;</span><span class="p">(</span><span class="n">n</span><span class="err">?</span><span class="p">,</span><span class="n">m</span><span class="err">?</span><span class="p">)</span><span class="w"> </span><span class="n">requires</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#8</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span><span class="w"> </span><span class="nf">op_on</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">projector_codespace</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">A0</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">A1</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">A2</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">A3</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shapes:&#39;</span><span class="p">,</span> <span class="n">A0</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">A1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">A2</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">A3</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">A0</span> <span class="o">@</span> <span class="n">A1</span> <span class="o">@</span> <span class="n">A2</span> <span class="o">@</span> <span class="n">A3</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">X4m</span><span class="p">)</span> <span class="o">@</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">Z4m</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Projector shape:&#39;</span><span class="p">,</span> <span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">P</span>

<span class="n">projector_codespace</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#9</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="n">Traceback</span><span class="w"> </span><span class="p">(</span><span class="n">most</span><span class="w"> </span><span class="n">recent</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">last</span><span class="p">):</span>
<span class="w">  </span><span class="n">File</span><span class="w"> </span><span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="w">  </span><span class="n">File</span><span class="w"> </span><span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="mi">26</span><span class="p">,</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">projector_codespace</span>
<span class="n">ValueError</span><span class="p">:</span><span class="w"> </span><span class="n">matmul</span><span class="p">:</span><span class="w"> </span><span class="n">Input</span><span class="w"> </span><span class="n">operand</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">enough</span><span class="w"> </span><span class="n">dimensions</span><span class="w"> </span><span class="p">(</span><span class="n">has</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">gufunc</span><span class="w"> </span><span class="n">core</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">signature</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="err">?</span><span class="p">,</span><span class="n">k</span><span class="p">),(</span><span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="err">?</span><span class="p">)</span><span class="o">-&gt;</span><span class="p">(</span><span class="n">n</span><span class="err">?</span><span class="p">,</span><span class="n">m</span><span class="err">?</span><span class="p">)</span><span class="w"> </span><span class="n">requires</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="n">Shapes</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#10</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span><span class="w"> </span><span class="nf">op_on</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">projector_codespace</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">A0</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">A1</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">A2</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">A3</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">A0</span> <span class="o">@</span> <span class="n">A1</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">B</span> <span class="o">@</span> <span class="n">A2</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">C</span> <span class="o">@</span> <span class="n">A3</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">Z4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">Z4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">Z4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">X4m</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">@</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">Z4m</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">P</span>

<span class="n">P</span> <span class="o">=</span> <span class="n">projector_codespace</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#11</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>(32, 32)
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#12</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">comb</span>

<span class="c1"># Pauli matrices and H</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="n">pauli_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>
<span class="n">paulis</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="n">I</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">Y</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="n">Z</span><span class="p">}</span>

<span class="c1"># Kron helpers</span>

<span class="k">def</span><span class="w"> </span><span class="nf">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span><span class="w"> </span><span class="nf">op_on</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">CNOT_ij</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">op_on</span><span class="p">(</span><span class="n">P0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">op_on</span><span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">two_pauli</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">paulis</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">paulis</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">P_anc0</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">op_on</span><span class="p">(</span><span class="n">P0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">projector_codespace</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">X4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">X4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">X4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">Z4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">Z4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">Z4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">X4m</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">@</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">Z4m</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">P</span>

<span class="c1"># Settings</span>
<span class="n">n</span><span class="o">=</span><span class="mi">5</span>

<span class="c1"># Pre-build gate unitaries</span>
<span class="n">U_cnot12</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U_cnot10</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U_cnot23</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U_cnot34</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U_cnot04</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>

<span class="c1"># Initial state |00000&gt;</span>
<span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">psi0</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>

<span class="c1"># Ideal evolution</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot12</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot10</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot23</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot34</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot04</span> <span class="o">@</span> <span class="n">U</span>

<span class="n">rho_ideal</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">psi0</span> <span class="o">@</span> <span class="p">(</span><span class="n">U</span> <span class="o">@</span> <span class="n">psi0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="n">P_tot</span> <span class="o">=</span> <span class="n">projector_codespace</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">P_anc0</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">rho_ideal_acc</span> <span class="o">=</span> <span class="n">P_tot</span> <span class="o">@</span> <span class="n">rho_ideal</span> <span class="o">@</span> <span class="n">P_tot</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="n">p_acc_ideal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_ideal_acc</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
<span class="n">rho_ideal_acc</span> <span class="o">=</span> <span class="n">rho_ideal_acc</span> <span class="o">/</span> <span class="n">p_acc_ideal</span>

<span class="c1"># Partial trace out ancilla</span>

<span class="k">def</span><span class="w"> </span><span class="nf">partial_trace_last_qubit</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rho4</span> <span class="o">=</span> <span class="n">rho</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">rho4</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">rho4</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">1</span><span class="p">,:]</span>

<span class="n">rho_ideal_code</span> <span class="o">=</span> <span class="n">partial_trace_last_qubit</span><span class="p">(</span><span class="n">rho_ideal_acc</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

<span class="c1"># Extract pure state vector</span>
<span class="n">vals</span><span class="p">,</span> <span class="n">vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">rho_ideal_code</span><span class="p">)</span>
<span class="n">psi_ref</span> <span class="o">=</span> <span class="n">vecs</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">real</span><span class="p">)]</span>
<span class="n">psi_ref</span> <span class="o">=</span> <span class="n">psi_ref</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">psi_ref</span><span class="p">)</span>

<span class="c1"># Sanity: check stabilizer expectations</span>
<span class="n">X4_4</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">X</span><span class="p">])</span>
<span class="n">Z4_4</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Z</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Trace ideal code:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_ideal_code</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;XXXX exp:&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">psi_ref</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X4_4</span> <span class="o">@</span> <span class="n">psi_ref</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ZZZZ exp:&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">psi_ref</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Z4_4</span> <span class="o">@</span> <span class="n">psi_ref</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

<span class="c1"># Enumerate error patterns</span>
<span class="n">error_qubit_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>
<span class="n">non_id_two_paulis</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">pauli_labels</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">pauli_labels</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">a</span><span class="o">==</span><span class="s1">&#39;I&#39;</span> <span class="ow">and</span> <span class="n">b</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">)]</span>
<span class="n">err_ops_by_loc</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">error_qubit_pairs</span><span class="p">:</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">two_pauli</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="n">non_id_two_paulis</span><span class="p">]</span>
    <span class="n">err_ops_by_loc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>

<span class="n">P_total</span> <span class="o">=</span> <span class="n">projector_codespace</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">P_anc0</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>

<span class="k">def</span><span class="w"> </span><span class="nf">to_fraction</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Fraction</span><span class="o">.</span><span class="n">from_float</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">24</span><span class="p">)</span>

<span class="n">A_k</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">Fraction</span><span class="p">)</span>
<span class="n">G_k</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">Fraction</span><span class="p">)</span>

<span class="n">num_patterns</span> <span class="o">=</span> <span class="mi">16</span><span class="o">**</span><span class="mi">5</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total patterns:&#39;</span><span class="p">,</span> <span class="n">num_patterns</span><span class="p">)</span>

<span class="k">for</span> <span class="n">pat_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_patterns</span><span class="p">):</span>
    <span class="c1"># decode base-16 digits for 5 locs</span>
    <span class="n">digits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">pat_idx</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">16</span>
        <span class="n">x</span> <span class="o">//=</span> <span class="mi">16</span>
        <span class="n">digits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">psi</span> <span class="o">=</span> <span class="n">psi0</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot12</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="k">if</span> <span class="n">digits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">digits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot10</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="k">if</span> <span class="n">digits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">digits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot23</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="k">if</span> <span class="n">digits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">digits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot34</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="k">if</span> <span class="n">digits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">digits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot04</span> <span class="o">@</span> <span class="n">psi</span>
    <span class="k">if</span> <span class="n">digits</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">digits</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>

    <span class="n">rho</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">@</span> <span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
    <span class="n">rho_acc</span> <span class="o">=</span> <span class="n">P_total</span> <span class="o">@</span> <span class="n">rho</span> <span class="o">@</span> <span class="n">P_total</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
    <span class="n">p_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_acc</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
    <span class="k">if</span> <span class="n">p_acc</span> <span class="o">&lt;</span> <span class="mf">1e-15</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">rho_acc_norm</span> <span class="o">=</span> <span class="n">rho_acc</span> <span class="o">/</span> <span class="n">p_acc</span>
    <span class="n">rho_code</span> <span class="o">=</span> <span class="n">partial_trace_last_qubit</span><span class="p">(</span><span class="n">rho_acc_norm</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi_ref</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">rho_code</span> <span class="o">@</span> <span class="n">psi_ref</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">.</span><span class="n">real</span>
    <span class="n">A_k</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">+=</span> <span class="n">to_fraction</span><span class="p">(</span><span class="n">p_acc</span><span class="p">)</span>
    <span class="n">G_k</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">+=</span> <span class="n">to_fraction</span><span class="p">(</span><span class="n">p_acc</span> <span class="o">*</span> <span class="n">F</span><span class="p">)</span>

<span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">A_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
<span class="n">G</span> <span class="o">=</span> <span class="p">[</span><span class="n">G_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A_k sums:&#39;</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;G_k sums:&#39;</span><span class="p">,</span> <span class="n">G</span><span class="p">)</span>

<span class="c1"># Build polynomial coefficients</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">comb</span>
<span class="n">coeff_den</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
<span class="n">coeff_num</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="o">-</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">comb</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span> <span class="mi">15</span><span class="o">**</span><span class="n">k</span><span class="p">)</span>
        <span class="n">deg</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="n">k</span>
        <span class="n">coeff_den</span><span class="p">[</span><span class="n">deg</span><span class="p">]</span> <span class="o">+=</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">coeff</span>
        <span class="n">coeff_num</span><span class="p">[</span><span class="n">deg</span><span class="p">]</span> <span class="o">+=</span> <span class="n">G</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">coeff</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Den coeffs:&#39;</span><span class="p">,</span> <span class="n">coeff_den</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Num coeffs:&#39;</span><span class="p">,</span> <span class="n">coeff_num</span><span class="p">)</span>

<span class="c1"># Series expansion via sympy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
<span class="n">Den_poly</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coeff_den</span><span class="p">))</span>
<span class="n">Num_poly</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coeff_num</span><span class="p">))</span>
<span class="n">F_ratio</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">Num_poly</span><span class="o">/</span><span class="n">Den_poly</span><span class="p">)</span>
<span class="n">F_series</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">F_ratio</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F_ratio:&#39;</span><span class="p">,</span> <span class="n">F_ratio</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F_series:&#39;</span><span class="p">,</span> <span class="n">F_series</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#13</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>&#39;&#39;
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#14</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">comb</span>

<span class="c1"># Setup as before but only enumerate up to 2 faults</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">paulis</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="n">I</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">Y</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="n">Z</span><span class="p">}</span>
<span class="n">pauli_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span><span class="w"> </span><span class="nf">op_on</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">CNOT_ij</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">op_on</span><span class="p">(</span><span class="n">P0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">op_on</span><span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">two_pauli</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">paulis</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">paulis</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">P_anc0</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">op_on</span><span class="p">(</span><span class="n">P0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">projector_codespace</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">X4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">X4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">X4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">Z4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">Z4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">Z4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">X4m</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">@</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">Z4m</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">P</span>

<span class="n">n</span><span class="o">=</span><span class="mi">5</span>
<span class="n">U_cnot12</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U_cnot10</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U_cnot23</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U_cnot34</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U_cnot04</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>

<span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">psi0</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>

<span class="n">U</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot12</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot10</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot23</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot34</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot04</span> <span class="o">@</span> <span class="n">U</span>

<span class="n">rho_ideal</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">psi0</span> <span class="o">@</span> <span class="p">(</span><span class="n">U</span> <span class="o">@</span> <span class="n">psi0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="n">P_total</span> <span class="o">=</span> <span class="n">projector_codespace</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">P_anc0</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">rho_ideal_acc</span> <span class="o">=</span> <span class="n">P_total</span> <span class="o">@</span> <span class="n">rho_ideal</span> <span class="o">@</span> <span class="n">P_total</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="n">p_acc_ideal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_ideal_acc</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
<span class="n">rho_ideal_acc</span> <span class="o">=</span> <span class="n">rho_ideal_acc</span> <span class="o">/</span> <span class="n">p_acc_ideal</span>

<span class="c1"># Partial trace out ancilla</span>

<span class="k">def</span><span class="w"> </span><span class="nf">partial_trace_last_qubit</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rho4</span> <span class="o">=</span> <span class="n">rho</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">rho4</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">rho4</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">1</span><span class="p">,:]</span>

<span class="n">rho_ideal_code</span> <span class="o">=</span> <span class="n">partial_trace_last_qubit</span><span class="p">(</span><span class="n">rho_ideal_acc</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="n">vals</span><span class="p">,</span> <span class="n">vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">rho_ideal_code</span><span class="p">)</span>
<span class="n">psi_ref</span> <span class="o">=</span> <span class="n">vecs</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">real</span><span class="p">)]</span>
<span class="n">psi_ref</span> <span class="o">=</span> <span class="n">psi_ref</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">psi_ref</span><span class="p">)</span>

<span class="c1"># Error setup</span>
<span class="n">error_qubit_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>
<span class="n">non_id_two_paulis</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">pauli_labels</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">pauli_labels</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">a</span><span class="o">==</span><span class="s1">&#39;I&#39;</span> <span class="ow">and</span> <span class="n">b</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">)]</span>
<span class="n">err_ops_by_loc</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">error_qubit_pairs</span><span class="p">:</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">two_pauli</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="n">non_id_two_paulis</span><span class="p">]</span>
    <span class="n">err_ops_by_loc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="n">A_k</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">Fraction</span><span class="p">)</span>
<span class="n">G_k</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">Fraction</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">to_fraction</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Fraction</span><span class="o">.</span><span class="n">from_float</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">24</span><span class="p">)</span>

<span class="c1"># Enumerate k=0</span>
<span class="c1"># pattern all zeros</span>
<span class="n">psi</span> <span class="o">=</span> <span class="n">psi0</span>
<span class="n">psi</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
<span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot12</span> <span class="o">@</span> <span class="n">psi</span>
<span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot10</span> <span class="o">@</span> <span class="n">psi</span>
<span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot23</span> <span class="o">@</span> <span class="n">psi</span>
<span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot34</span> <span class="o">@</span> <span class="n">psi</span>
<span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot04</span> <span class="o">@</span> <span class="n">psi</span>
<span class="n">rho</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">@</span> <span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="n">rho_acc</span> <span class="o">=</span> <span class="n">P_total</span> <span class="o">@</span> <span class="n">rho</span> <span class="o">@</span> <span class="n">P_total</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="n">p_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_acc</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
<span class="n">rho_acc_norm</span> <span class="o">=</span> <span class="n">rho_acc</span> <span class="o">/</span> <span class="n">p_acc</span>
<span class="n">rho_code</span> <span class="o">=</span> <span class="n">partial_trace_last_qubit</span><span class="p">(</span><span class="n">rho_acc_norm</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi_ref</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">rho_code</span> <span class="o">@</span> <span class="n">psi_ref</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">.</span><span class="n">real</span>
<span class="n">A_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">to_fraction</span><span class="p">(</span><span class="n">p_acc</span><span class="p">)</span>
<span class="n">G_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">to_fraction</span><span class="p">(</span><span class="n">p_acc</span> <span class="o">*</span> <span class="n">F</span><span class="p">)</span>

<span class="c1"># Enumerate k=1: choose one location and one non-identity Pauli</span>
<span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">psi0</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot12</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="k">if</span> <span class="n">loc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot10</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="k">if</span> <span class="n">loc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot23</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="k">if</span> <span class="n">loc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot34</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="k">if</span> <span class="n">loc</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot04</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="k">if</span> <span class="n">loc</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">@</span> <span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        <span class="n">rho_acc</span> <span class="o">=</span> <span class="n">P_total</span> <span class="o">@</span> <span class="n">rho</span> <span class="o">@</span> <span class="n">P_total</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        <span class="n">p_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_acc</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="k">if</span> <span class="n">p_acc</span> <span class="o">&lt;</span> <span class="mf">1e-15</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">rho_acc_norm</span> <span class="o">=</span> <span class="n">rho_acc</span> <span class="o">/</span> <span class="n">p_acc</span>
        <span class="n">rho_code</span> <span class="o">=</span> <span class="n">partial_trace_last_qubit</span><span class="p">(</span><span class="n">rho_acc_norm</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi_ref</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">rho_code</span> <span class="o">@</span> <span class="n">psi_ref</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">.</span><span class="n">real</span>
        <span class="n">A_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">to_fraction</span><span class="p">(</span><span class="n">p_acc</span><span class="p">)</span>
        <span class="n">G_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">to_fraction</span><span class="p">(</span><span class="n">p_acc</span> <span class="o">*</span> <span class="n">F</span><span class="p">)</span>

<span class="c1"># Enumerate k=2: choose two locations (loc1&lt;loc2), and a Pauli at each (15*15)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>
<span class="k">for</span> <span class="n">loc1</span><span class="p">,</span> <span class="n">loc2</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">idx1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">idx2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">psi0</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot12</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="k">if</span> <span class="n">loc1</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">loc2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># apply the one(s) that match</span>
                <span class="k">if</span> <span class="n">loc1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx1</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
                <span class="k">if</span> <span class="n">loc2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx2</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot10</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="k">if</span> <span class="n">loc1</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">loc2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">loc1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">idx1</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
                <span class="k">if</span> <span class="n">loc2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">idx2</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot23</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="k">if</span> <span class="n">loc1</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">loc2</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">loc1</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">idx1</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
                <span class="k">if</span> <span class="n">loc2</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">idx2</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot34</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="k">if</span> <span class="n">loc1</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">loc2</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">loc1</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">idx1</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
                <span class="k">if</span> <span class="n">loc2</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">idx2</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot04</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="k">if</span> <span class="n">loc1</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">loc2</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">loc1</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">idx1</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
                <span class="k">if</span> <span class="n">loc2</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">idx2</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">@</span> <span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
            <span class="n">rho_acc</span> <span class="o">=</span> <span class="n">P_total</span> <span class="o">@</span> <span class="n">rho</span> <span class="o">@</span> <span class="n">P_total</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
            <span class="n">p_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_acc</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
            <span class="k">if</span> <span class="n">p_acc</span> <span class="o">&lt;</span> <span class="mf">1e-15</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">rho_acc_norm</span> <span class="o">=</span> <span class="n">rho_acc</span> <span class="o">/</span> <span class="n">p_acc</span>
            <span class="n">rho_code</span> <span class="o">=</span> <span class="n">partial_trace_last_qubit</span><span class="p">(</span><span class="n">rho_acc_norm</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi_ref</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">rho_code</span> <span class="o">@</span> <span class="n">psi_ref</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">.</span><span class="n">real</span>
            <span class="n">A_k</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">to_fraction</span><span class="p">(</span><span class="n">p_acc</span><span class="p">)</span>
            <span class="n">G_k</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">to_fraction</span><span class="p">(</span><span class="n">p_acc</span> <span class="o">*</span> <span class="n">F</span><span class="p">)</span>

<span class="c1"># Print A_k and G_k for k=0,1,2</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A_k sums (k=0..2):&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">A_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;G_k sums (k=0..2):&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">G_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>

<span class="c1"># Now build series up to p^2</span>
<span class="c1"># Den â‰ˆ Î£_{k=0}^2 A_k * (1-p)^(5-k) * (p/15)^k</span>
<span class="c1"># Num â‰ˆ Î£_{k=0}^2 G_k * (1-p)^(5-k) * (p/15)^k</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
<span class="n">Den</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">Num</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">Ak</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">A_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">A_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span>
    <span class="n">Gk</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">G_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">G_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span>
    <span class="n">Den</span> <span class="o">+=</span> <span class="n">Ak</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="mi">15</span><span class="p">)</span><span class="o">**</span><span class="n">k</span>
    <span class="n">Num</span> <span class="o">+=</span> <span class="n">Gk</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="mi">15</span><span class="p">)</span><span class="o">**</span><span class="n">k</span>
<span class="n">F_series</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">Num</span><span class="o">/</span><span class="n">Den</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># up to p^2</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F_series up to p^2:&#39;</span><span class="p">,</span> <span class="n">F_series</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#15</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>A_k sums (k=0..2): [Fraction(1, 1), Fraction(7, 1), Fraction(282, 1)]
G_k sums (k=0..2): [Fraction(1, 2), Fraction(7, 2), Fraction(69, 1)]
F_series up to p^2: 1/2 - 8*p**2/25 + O(p**3)
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#16</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">eigvalsh</span>

<span class="c1"># Reuse variables from previous cell (they persist in the python tool? Assume not). Let&#39;s reconstruct minimal elements</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span><span class="w"> </span><span class="nf">op_on</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">CNOT_ij</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">op_on</span><span class="p">(</span><span class="n">P0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">op_on</span><span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">projector_codespace</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">X4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">X4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">X4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">Z4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">Z4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">Z4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">X4m</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">@</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">Z4m</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">P</span>

<span class="k">def</span><span class="w"> </span><span class="nf">P_anc0</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">op_on</span><span class="p">(</span><span class="n">P0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

<span class="n">n</span><span class="o">=</span><span class="mi">5</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">psi0</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
<span class="n">psi</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">psi0</span>
<span class="n">rho</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">@</span> <span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="n">P</span> <span class="o">=</span> <span class="n">projector_codespace</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">P_anc0</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">rho_acc</span> <span class="o">=</span> <span class="n">P</span> <span class="o">@</span> <span class="n">rho</span> <span class="o">@</span> <span class="n">P</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="n">p_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_acc</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;p_acc ideal =&#39;</span><span class="p">,</span> <span class="n">p_acc</span><span class="p">)</span>
<span class="n">rho_acc</span> <span class="o">/=</span> <span class="n">p_acc</span>
<span class="c1"># Trace out ancilla</span>
<span class="n">rho5</span> <span class="o">=</span> <span class="n">rho_acc</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">16</span><span class="p">))</span>
<span class="n">rho_code</span> <span class="o">=</span> <span class="n">rho5</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">rho5</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">1</span><span class="p">,:]</span>
<span class="c1"># Purity</span>
<span class="n">evals</span> <span class="o">=</span> <span class="n">eigvalsh</span><span class="p">(</span><span class="n">rho_code</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;eigenvalues:&#39;</span><span class="p">,</span> <span class="n">evals</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;purity Tr(rho^2)=&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_code</span> <span class="o">@</span> <span class="n">rho_code</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#17</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>p_acc ideal = 0.9999999999999998
eigenvalues: [0.  0.  0.  0.  0.  0.  0.  0.  0.  0.  0.  0.  0.  0.  0.5 0.5]
purity Tr(rho^2)= 0.5
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#18</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span><span class="w"> </span><span class="nf">op_on</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">CNOT_ij</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">op_on</span><span class="p">(</span><span class="n">P0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">op_on</span><span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

<span class="n">n</span><span class="o">=</span><span class="mi">5</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">psi0</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
<span class="n">psi</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">psi0</span>
<span class="c1"># Construct XXXX on qubits 0..3 in 5-qubit space</span>
<span class="n">X4_5</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">X4_5</span> <span class="o">=</span> <span class="n">X4_5</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">X4_5</span> <span class="o">=</span> <span class="n">X4_5</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">X4_5</span> <span class="o">=</span> <span class="n">X4_5</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">Z4_5</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">Z4_5</span> <span class="o">=</span> <span class="n">Z4_5</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">Z4_5</span> <span class="o">=</span> <span class="n">Z4_5</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">Z4_5</span> <span class="o">=</span> <span class="n">Z4_5</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>

<span class="n">ex_X</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X4_5</span> <span class="o">@</span> <span class="n">psi</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="n">ex_Z</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Z4_5</span> <span class="o">@</span> <span class="n">psi</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expect XXXX:&#39;</span><span class="p">,</span> <span class="n">ex_X</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expect ZZZZ:&#39;</span><span class="p">,</span> <span class="n">ex_Z</span><span class="p">)</span>
<span class="c1"># Also ancilla Z expectation (|0&gt; expectation +1)</span>
<span class="n">Z_anc</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ancilla Z:&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Z_anc</span> <span class="o">@</span> <span class="n">psi</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#19</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>Expect XXXX: (0.9999999999999998+0j)
Expect ZZZZ: (0.9999999999999998+0j)
Ancilla Z: (0.9999999999999998+0j)
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#20</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">comb</span>

<span class="c1"># Pauli matrices and H</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="n">pauli_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>
<span class="n">paulis</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="n">I</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">Y</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="n">Z</span><span class="p">}</span>

<span class="c1"># Kron helpers</span>

<span class="k">def</span><span class="w"> </span><span class="nf">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span><span class="w"> </span><span class="nf">op_on</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">CNOT_ij</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">op_on</span><span class="p">(</span><span class="n">P0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">op_on</span><span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">two_pauli</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">paulis</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">paulis</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">P_anc0</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">op_on</span><span class="p">(</span><span class="n">P0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">projector_codespace</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">X4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">X4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">X4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">Z4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">Z4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">Z4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">X4m</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">@</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">Z4m</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">P</span>

<span class="n">n</span><span class="o">=</span><span class="mi">5</span>

<span class="c1"># Gates</span>
<span class="n">U_cnot12</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U_cnot10</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U_cnot23</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U_cnot34</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U_cnot04</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>

<span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">psi0</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>

<span class="c1"># Ideal evolution</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot12</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot10</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot23</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot34</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot04</span> <span class="o">@</span> <span class="n">U</span>

<span class="n">rho_ideal</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">psi0</span> <span class="o">@</span> <span class="p">(</span><span class="n">U</span> <span class="o">@</span> <span class="n">psi0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="n">P_total</span> <span class="o">=</span> <span class="n">projector_codespace</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">P_anc0</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">rho_ideal_acc</span> <span class="o">=</span> <span class="n">P_total</span> <span class="o">@</span> <span class="n">rho_ideal</span> <span class="o">@</span> <span class="n">P_total</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="n">p_acc_ideal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_ideal_acc</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
<span class="n">rho_ideal_acc</span> <span class="o">=</span> <span class="n">rho_ideal_acc</span> <span class="o">/</span> <span class="n">p_acc_ideal</span>

<span class="c1"># Correct partial trace of last qubit (ancilla index 4)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">partial_trace_last_qubit</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rho4</span> <span class="o">=</span> <span class="n">rho</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">dim</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="c1"># indices: (i,a; j,b), trace over a=b</span>
    <span class="k">return</span> <span class="n">rho4</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">rho4</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span>

<span class="n">rho_ideal_code</span> <span class="o">=</span> <span class="n">partial_trace_last_qubit</span><span class="p">(</span><span class="n">rho_ideal_acc</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="c1"># Purity</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;p_acc_ideal:&#39;</span><span class="p">,</span> <span class="n">p_acc_ideal</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;purity Tr(rho^2)=&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_ideal_code</span> <span class="o">@</span> <span class="n">rho_ideal_code</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>

<span class="c1"># Extract psi_ref</span>
<span class="n">vals</span><span class="p">,</span> <span class="n">vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">rho_ideal_code</span><span class="p">)</span>
<span class="n">psi_ref</span> <span class="o">=</span> <span class="n">vecs</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">real</span><span class="p">)]</span>
<span class="n">psi_ref</span> <span class="o">=</span> <span class="n">psi_ref</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">psi_ref</span><span class="p">)</span>
<span class="n">F_check</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi_ref</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">rho_ideal_code</span> <span class="o">@</span> <span class="n">psi_ref</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">.</span><span class="n">real</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F_check vs rho_ideal_code:&#39;</span><span class="p">,</span> <span class="n">F_check</span><span class="p">)</span>

<span class="c1"># Setup errors</span>
<span class="n">error_qubit_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>
<span class="n">non_id_two_paulis</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">pauli_labels</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">pauli_labels</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">a</span><span class="o">==</span><span class="s1">&#39;I&#39;</span> <span class="ow">and</span> <span class="n">b</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">)]</span>
<span class="n">err_ops_by_loc</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">error_qubit_pairs</span><span class="p">:</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">two_pauli</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="n">non_id_two_paulis</span><span class="p">]</span>
    <span class="n">err_ops_by_loc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="n">A_k</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">Fraction</span><span class="p">)</span>
<span class="n">G_k</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">Fraction</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">to_fraction</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Fraction</span><span class="o">.</span><span class="n">from_float</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">24</span><span class="p">)</span>

<span class="c1"># k=0</span>
<span class="n">psi</span> <span class="o">=</span> <span class="n">psi0</span>
<span class="n">psi</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
<span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot12</span> <span class="o">@</span> <span class="n">psi</span>
<span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot10</span> <span class="o">@</span> <span class="n">psi</span>
<span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot23</span> <span class="o">@</span> <span class="n">psi</span>
<span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot34</span> <span class="o">@</span> <span class="n">psi</span>
<span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot04</span> <span class="o">@</span> <span class="n">psi</span>
<span class="n">rho</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">@</span> <span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="n">rho_acc</span> <span class="o">=</span> <span class="n">P_total</span> <span class="o">@</span> <span class="n">rho</span> <span class="o">@</span> <span class="n">P_total</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="n">p_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_acc</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
<span class="n">rho_acc_norm</span> <span class="o">=</span> <span class="n">rho_acc</span> <span class="o">/</span> <span class="n">p_acc</span>
<span class="n">rho_code</span> <span class="o">=</span> <span class="n">partial_trace_last_qubit</span><span class="p">(</span><span class="n">rho_acc_norm</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi_ref</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">rho_code</span> <span class="o">@</span> <span class="n">psi_ref</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">.</span><span class="n">real</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;k=0: p_acc, F=&#39;</span><span class="p">,</span> <span class="n">p_acc</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
<span class="n">A_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">to_fraction</span><span class="p">(</span><span class="n">p_acc</span><span class="p">)</span>
<span class="n">G_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">to_fraction</span><span class="p">(</span><span class="n">p_acc</span> <span class="o">*</span> <span class="n">F</span><span class="p">)</span>

<span class="c1"># k=1</span>
<span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">psi0</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot12</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="k">if</span> <span class="n">loc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot10</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="k">if</span> <span class="n">loc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot23</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="k">if</span> <span class="n">loc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot34</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="k">if</span> <span class="n">loc</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot04</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="k">if</span> <span class="n">loc</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">@</span> <span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        <span class="n">rho_acc</span> <span class="o">=</span> <span class="n">P_total</span> <span class="o">@</span> <span class="n">rho</span> <span class="o">@</span> <span class="n">P_total</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        <span class="n">p_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_acc</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="k">if</span> <span class="n">p_acc</span> <span class="o">&lt;</span> <span class="mf">1e-15</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">rho_acc_norm</span> <span class="o">=</span> <span class="n">rho_acc</span> <span class="o">/</span> <span class="n">p_acc</span>
        <span class="n">rho_code</span> <span class="o">=</span> <span class="n">partial_trace_last_qubit</span><span class="p">(</span><span class="n">rho_acc_norm</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi_ref</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">rho_code</span> <span class="o">@</span> <span class="n">psi_ref</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">.</span><span class="n">real</span>
        <span class="n">A_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">to_fraction</span><span class="p">(</span><span class="n">p_acc</span><span class="p">)</span>
        <span class="n">G_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">to_fraction</span><span class="p">(</span><span class="n">p_acc</span> <span class="o">*</span> <span class="n">F</span><span class="p">)</span>

<span class="c1"># k=2</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>
<span class="k">for</span> <span class="n">loc1</span><span class="p">,</span> <span class="n">loc2</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">idx1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">idx2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">psi0</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot12</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="k">if</span> <span class="n">loc1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx1</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="k">if</span> <span class="n">loc2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx2</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot10</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="k">if</span> <span class="n">loc1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">idx1</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="k">if</span> <span class="n">loc2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">idx2</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot23</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="k">if</span> <span class="n">loc1</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">idx1</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="k">if</span> <span class="n">loc2</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">idx2</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot34</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="k">if</span> <span class="n">loc1</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">idx1</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="k">if</span> <span class="n">loc2</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">idx2</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot04</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="k">if</span> <span class="n">loc1</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">idx1</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="k">if</span> <span class="n">loc2</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">idx2</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">@</span> <span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
            <span class="n">rho_acc</span> <span class="o">=</span> <span class="n">P_total</span> <span class="o">@</span> <span class="n">rho</span> <span class="o">@</span> <span class="n">P_total</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
            <span class="n">p_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_acc</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
            <span class="k">if</span> <span class="n">p_acc</span> <span class="o">&lt;</span> <span class="mf">1e-15</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">rho_acc_norm</span> <span class="o">=</span> <span class="n">rho_acc</span> <span class="o">/</span> <span class="n">p_acc</span>
            <span class="n">rho_code</span> <span class="o">=</span> <span class="n">partial_trace_last_qubit</span><span class="p">(</span><span class="n">rho_acc_norm</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi_ref</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">rho_code</span> <span class="o">@</span> <span class="n">psi_ref</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">.</span><span class="n">real</span>
            <span class="n">A_k</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">to_fraction</span><span class="p">(</span><span class="n">p_acc</span><span class="p">)</span>
            <span class="n">G_k</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">to_fraction</span><span class="p">(</span><span class="n">p_acc</span> <span class="o">*</span> <span class="n">F</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A_k:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">A_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;G_k:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">G_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>

<span class="c1"># Series up to p^2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
<span class="n">Den</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">Num</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">Ak</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">A_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">A_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span>
    <span class="n">Gk</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">G_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">G_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span>
    <span class="n">Den</span> <span class="o">+=</span> <span class="n">Ak</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="mi">15</span><span class="p">)</span><span class="o">**</span><span class="n">k</span>
    <span class="n">Num</span> <span class="o">+=</span> <span class="n">Gk</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="mi">15</span><span class="p">)</span><span class="o">**</span><span class="n">k</span>
<span class="n">F_series</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">Num</span><span class="o">/</span><span class="n">Den</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F_series:&#39;</span><span class="p">,</span> <span class="n">F_series</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#21</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="n">p_acc_ideal</span><span class="o">:</span><span class="w"> </span><span class="mf">0.9999999999999998</span>
<span class="n">purity</span><span class="w"> </span><span class="n">Tr</span><span class="o">(</span><span class="n">rho</span><span class="o">^</span><span class="mi">2</span><span class="o">)=</span><span class="w"> </span><span class="mf">1.0</span>
<span class="n">F_check</span><span class="w"> </span><span class="n">vs</span><span class="w"> </span><span class="n">rho_ideal_code</span><span class="o">:</span><span class="w"> </span><span class="mf">1.0000000000000002</span>
<span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="n">p_acc</span><span class="o">,</span><span class="w"> </span><span class="n">F</span><span class="o">=</span><span class="w"> </span><span class="mf">0.9999999999999998</span><span class="w"> </span><span class="mf">1.0000000000000002</span>
<span class="n">A_k</span><span class="o">:</span><span class="w"> </span><span class="o">[</span><span class="n">Fraction</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">1</span><span class="o">),</span><span class="w"> </span><span class="n">Fraction</span><span class="o">(</span><span class="mi">7</span><span class="o">,</span><span class="w"> </span><span class="mi">1</span><span class="o">),</span><span class="w"> </span><span class="n">Fraction</span><span class="o">(</span><span class="mi">282</span><span class="o">,</span><span class="w"> </span><span class="mi">1</span><span class="o">)]</span>
<span class="n">G_k</span><span class="o">:</span><span class="w"> </span><span class="o">[</span><span class="n">Fraction</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">1</span><span class="o">),</span><span class="w"> </span><span class="n">Fraction</span><span class="o">(</span><span class="mi">7</span><span class="o">,</span><span class="w"> </span><span class="mi">1</span><span class="o">),</span><span class="w"> </span><span class="n">Fraction</span><span class="o">(</span><span class="mi">138</span><span class="o">,</span><span class="w"> </span><span class="mi">1</span><span class="o">)]</span>
<span class="n">F_series</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">16</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">25</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">O</span><span class="o">(</span><span class="n">p</span><span class="o">**</span><span class="mi">3</span><span class="o">)</span>
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#22</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>

<span class="c1"># Reuse definitions</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">pauli_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>
<span class="n">paulis</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="n">I</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">Y</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="n">Z</span><span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span><span class="w"> </span><span class="nf">op_on</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">CNOT_ij</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">op_on</span><span class="p">(</span><span class="n">P0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">op_on</span><span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">two_pauli</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">paulis</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">paulis</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">kron_n</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">P_anc0</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">op_on</span><span class="p">(</span><span class="n">P0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">projector_codespace</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">X4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">X4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">X4m</span> <span class="o">=</span> <span class="n">X4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">Z4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">Z4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">Z4m</span> <span class="o">=</span> <span class="n">Z4m</span> <span class="o">@</span> <span class="n">op_on</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">X4m</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">@</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">Z4m</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">P</span>

<span class="k">def</span><span class="w"> </span><span class="nf">partial_trace_last_qubit</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rho4</span> <span class="o">=</span> <span class="n">rho</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">dim</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">rho4</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">rho4</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span>

<span class="n">n</span><span class="o">=</span><span class="mi">5</span>
<span class="n">U_cnot12</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U_cnot10</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U_cnot23</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U_cnot34</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U_cnot04</span> <span class="o">=</span> <span class="n">CNOT_ij</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">psi0</span> <span class="o">=</span> <span class="n">kron_n</span><span class="p">([</span><span class="n">zero</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>

<span class="c1"># Reference state</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot12</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot10</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot23</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot34</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">U_cnot04</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">rho_ideal</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">psi0</span> <span class="o">@</span> <span class="p">(</span><span class="n">U</span> <span class="o">@</span> <span class="n">psi0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="n">P_total</span> <span class="o">=</span> <span class="n">projector_codespace</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">P_anc0</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">rho_ideal_acc</span> <span class="o">=</span> <span class="n">P_total</span> <span class="o">@</span> <span class="n">rho_ideal</span> <span class="o">@</span> <span class="n">P_total</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
<span class="n">rho_ideal_acc</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_ideal_acc</span><span class="p">)</span>
<span class="n">rho_ref</span> <span class="o">=</span> <span class="n">partial_trace_last_qubit</span><span class="p">(</span><span class="n">rho_ideal_acc</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="c1"># Extract pure reference vector</span>
<span class="n">vals</span><span class="p">,</span> <span class="n">vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">rho_ref</span><span class="p">)</span>
<span class="n">psi_ref</span> <span class="o">=</span> <span class="n">vecs</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">real</span><span class="p">)]</span>
<span class="n">psi_ref</span> <span class="o">=</span> <span class="n">psi_ref</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">psi_ref</span><span class="p">)</span>

<span class="c1"># Errors</span>
<span class="n">affected_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>
<span class="n">non_id_two_paulis</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">pauli_labels</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">pauli_labels</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">a</span><span class="o">==</span><span class="s1">&#39;I&#39;</span> <span class="ow">and</span> <span class="n">b</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">)]</span>
<span class="n">err_ops_by_loc</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">affected_pairs</span><span class="p">:</span>
    <span class="n">err_ops_by_loc</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">two_pauli</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="n">non_id_two_paulis</span><span class="p">])</span>

<span class="n">P_total</span> <span class="o">=</span> <span class="n">projector_codespace</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">P_anc0</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>

<span class="k">def</span><span class="w"> </span><span class="nf">to_fraction</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Fraction</span><span class="o">.</span><span class="n">from_float</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">24</span><span class="p">)</span>

<span class="n">A3</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">G3</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">locs</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">idx1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">idx2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">idx3</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
                <span class="n">psi</span> <span class="o">=</span> <span class="n">psi0</span>
                <span class="n">psi</span> <span class="o">=</span> <span class="n">op_on</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">@</span> <span class="n">psi</span>
                <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot12</span> <span class="o">@</span> <span class="n">psi</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">locs</span><span class="p">:</span>
                    <span class="c1"># order: whichever index matches which location</span>
                    <span class="c1"># We&#39;ll map locs to indices in sequence</span>
                    <span class="k">pass</span>
                <span class="c1"># We&#39;ll apply errors sequentially per location</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">locs</span><span class="p">:</span>
                    <span class="c1"># assign appropriate idx based on position in locs</span>
                    <span class="n">loc_idx</span> <span class="o">=</span> <span class="n">locs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span><span class="p">,</span> <span class="n">idx3</span><span class="p">][</span><span class="n">loc_idx</span><span class="p">]</span>
                    <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
                <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot10</span> <span class="o">@</span> <span class="n">psi</span>
                <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">locs</span><span class="p">:</span>
                    <span class="n">loc_idx</span> <span class="o">=</span> <span class="n">locs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span><span class="p">,</span> <span class="n">idx3</span><span class="p">][</span><span class="n">loc_idx</span><span class="p">]</span>
                    <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
                <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot23</span> <span class="o">@</span> <span class="n">psi</span>
                <span class="k">if</span> <span class="mi">2</span> <span class="ow">in</span> <span class="n">locs</span><span class="p">:</span>
                    <span class="n">loc_idx</span> <span class="o">=</span> <span class="n">locs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span><span class="p">,</span> <span class="n">idx3</span><span class="p">][</span><span class="n">loc_idx</span><span class="p">]</span>
                    <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
                <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot34</span> <span class="o">@</span> <span class="n">psi</span>
                <span class="k">if</span> <span class="mi">3</span> <span class="ow">in</span> <span class="n">locs</span><span class="p">:</span>
                    <span class="n">loc_idx</span> <span class="o">=</span> <span class="n">locs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span><span class="p">,</span> <span class="n">idx3</span><span class="p">][</span><span class="n">loc_idx</span><span class="p">]</span>
                    <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
                <span class="n">psi</span> <span class="o">=</span> <span class="n">U_cnot04</span> <span class="o">@</span> <span class="n">psi</span>
                <span class="k">if</span> <span class="mi">4</span> <span class="ow">in</span> <span class="n">locs</span><span class="p">:</span>
                    <span class="n">loc_idx</span> <span class="o">=</span> <span class="n">locs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span><span class="p">,</span> <span class="n">idx3</span><span class="p">][</span><span class="n">loc_idx</span><span class="p">]</span>
                    <span class="n">psi</span> <span class="o">=</span> <span class="n">err_ops_by_loc</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">@</span> <span class="n">psi</span>
                <span class="n">rho</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">@</span> <span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
                <span class="n">rho_acc</span> <span class="o">=</span> <span class="n">P_total</span> <span class="o">@</span> <span class="n">rho</span> <span class="o">@</span> <span class="n">P_total</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
                <span class="n">p_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">rho_acc</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
                <span class="k">if</span> <span class="n">p_acc</span> <span class="o">&lt;</span> <span class="mf">1e-15</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">rho_acc</span> <span class="o">/=</span> <span class="n">p_acc</span>
                <span class="n">rho_code</span> <span class="o">=</span> <span class="n">partial_trace_last_qubit</span><span class="p">(</span><span class="n">rho_acc</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                <span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi_ref</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">rho_code</span> <span class="o">@</span> <span class="n">psi_ref</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">.</span><span class="n">real</span>
                <span class="n">A3</span> <span class="o">+=</span> <span class="n">to_fraction</span><span class="p">(</span><span class="n">p_acc</span><span class="p">)</span>
                <span class="n">G3</span> <span class="o">+=</span> <span class="n">to_fraction</span><span class="p">(</span><span class="n">p_acc</span> <span class="o">*</span> <span class="n">F</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A3, G3:&#39;</span><span class="p">,</span> <span class="n">A3</span><span class="p">,</span> <span class="n">G3</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#23</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>A3, G3: 4222 1198
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#24</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>

<span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">282</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">4222</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
<span class="n">G</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">138</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">1198</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
<span class="n">Den</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">Num</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">Ak</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span>
    <span class="n">Gk</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">G</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span>
    <span class="n">Den</span> <span class="o">+=</span> <span class="n">Ak</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="mi">15</span><span class="p">)</span><span class="o">**</span><span class="n">k</span>
    <span class="n">Num</span> <span class="o">+=</span> <span class="n">Gk</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="mi">15</span><span class="p">)</span><span class="o">**</span><span class="n">k</span>
<span class="n">F_series</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">Num</span><span class="o">/</span><span class="n">Den</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># up to p^3</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F series up to p^3:&#39;</span><span class="p">,</span> <span class="n">F_series</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#25</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>F series up to p^3: 1 - 16*p**2/25 - 704*p**3/375 + O(p**4)
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#26</span>
    </div>
    <div class="content markdown-body"><p>Step-by-step derivation</p>
<p>1) Code, logicals, and target state
- We use the [[4,2,2]] stabilizer code with generators S = {XXXX, ZZZZ} on physical qubits 0,1,2,3. A standard logical basis is
  |00âŸ©L = (|0000âŸ©+|1111âŸ©)/âˆš2, |01âŸ©L = (|0011âŸ©+|1100âŸ©)/âˆš2,
  |10âŸ©L = (|0101âŸ©+|1010âŸ©)/âˆš2, |11âŸ©L = (|0110âŸ©+|1001âŸ©)/âˆš2. These satisfy the given logical operators X_A=X I X I, X_B=X X I I, Z_A=Z Z I I, Z_B=Z I Z I (up to stabilizers). The target is |00âŸ©AB â‰¡ |00âŸ©L. [Error Correction Zoo entry; stabilizers and codewords. (<a href="https://errorcorrectionzoo.org/c/stab_4_2_2">errorcorrectionzoo.org</a>)]</p>
<p>2) Circuit and noise model
- Circuit (right-to-left in time): H1, CNOT12, CNOT10, CNOT23, CNOT34, CNOT04, M4, where qubit 4 is an ancilla. The circuit ideally prepares |00âŸ©L on data (0â€“3) with ancilla |0âŸ©.
- Two-qubit depolarizing noise: after each CNOTij we apply a Pauli drawn uniformly from the 15 non-identity two-qubit Paulis on qubits i,j with probability p/15; with probability 1âˆ’p no error occurs. This is the standard two-qubit depolarizing channel specialization of the Pauli/depolarizing model. (<a href="https://quantumchannelzoo.org/channel/depolarizing?utm_source=openai">quantumchannelzoo.org</a>, <a href="https://en.wikipedia.org/wiki/Quantum_depolarizing_channel?utm_source=openai">en.wikipedia.org</a>, <a href="https://algassert.com/post/2001?utm_source=openai">algassert.com</a>)</p>
<p>3) Post-selection and figure of merit
- Post-selection: accept only if
  (i) ancilla measurement M4 returns |0âŸ©, and
  (ii) both stabilizers XXXX and ZZZZ measure +1 on the data block (i.e. the state lies in the codespace).
- Let U be the ideal unitary of the circuit (without noise). Define the ideal accepted data state Ïref by applying U to |00000âŸ©, projecting onto ancilla |0âŸ© and the codespace, and tracing out the ancilla. This Ïref = |00âŸ©LâŸ¨00| is pure (verified explicitly below).
- For a given pattern E of Pauli faults, let ÏE be the resulting pure state after the circuit. The accepted (unnormalized) state is Î acc ÏE Î acc with Î acc = (|0âŸ©âŸ¨0|)4 âŠ— [(I+XXXX)/2][(I+ZZZZ)/2]. The acceptance probability for E is pact(E) = Tr[Î acc ÏE]. The normalized accepted data state is ÏE,acc = Tr4[Î acc ÏE Î acc] / pact(E).
- The conditional logical-state fidelity is
  F(p) = âŸ¨00|L Ïacc(p) |00âŸ©L = Num(p)/Den(p),
  where
  Num(p) = Î£E PE(p) pact(E) âŸ¨00|L ÏE,acc |00âŸ©L,  Den(p) = Î£E PE(p) pact(E),
  and PE(p) is the probability of error pattern E given the independent two-qubit depolarizing noise after each of the five CNOTs.</p>
<p>4) Why the linear term in p vanishes (fault-tolerance intuition)
- The code has distance 2 (detects any single-qubit error). The ancilla pattern CNOT34, CNOT04 is a flag that turns any single two-qubit-gate fault that could otherwise propagate to a harmful weight-2 pattern into a detected event (either ancilla flips to |1âŸ© or a stabilizer flips to âˆ’1). Consequently, any single noise event that is accepted must act trivially on the logical state (stabilizer or a Z-type logical which leaves |00âŸ©L invariant), so it does not reduce fidelity. Therefore F(p) = 1 âˆ’ O(p^2). This qualitative statement is standard for flagged, post-selected, distance-2 state-preparation circuits. (We also verify it exactly below by enumeration.)</p>
<p>5) Exact smallâ€‘p expansion by enumerating all accepted 0-, 1-, and 2â€‘fault patterns
- We compute Num(p) and Den(p) exactly up to O(p^2) by stabilizer/state-vector simulation of the 5â€‘qubit circuit, interleaving each CNOT with either identity (prob. 1âˆ’p) or one of the 15 two-qubit Paulis on that gateâ€™s qubits (prob. p/15), followed by the ideal projectors Î acc. For each pattern we accumulate pact(E) and the accepted logical fidelity âŸ¨00|L ÏE,acc |00âŸ©L.
- Grouping by the number k of non-identity faults gives
  Num(p) = Î£k Gk (1âˆ’p)^{5âˆ’k} (p/15)^k,  Den(p) = Î£k Ak (1âˆ’p)^{5âˆ’k} (p/15)^k,
  where Ak = Î£EâˆˆWk pact(E) and Gk = Î£EâˆˆWk pact(E) âŸ¨00|L ÏE,acc |00âŸ©L, with Wk the set of patterns having exactly k non-identity errors.
- Exact enumeration yields
  A0 = 1,  G0 = 1,
  A1 = 7,  G1 = 7,
  A2 = 282, G2 = 138.
  (Interpretation: among all single-fault patterns, the total acceptance â€œmassâ€ is 7 and all accepted ones preserve the target state; at two faults there is accepted weight but roughly half cause a logical flip.)
- Expand (1âˆ’p)^5, (1âˆ’p)^4, (1âˆ’p)^3 to O(p^2), substitute the Ak,Gk above, and form the ratio. Since the linear coefficients match (A1=G1), the O(p) term cancels. The O(p^2) coefficient is the difference of the quadratic coefficients:
  F(p) = 1 âˆ’ (A2 âˆ’ G2)/15^2 Â· p^2 + O(p^3) = 1 âˆ’ (282âˆ’138)/225 Â· p^2 + O(p^3)
       = 1 âˆ’ (144/225) p^2 + O(p^3) = 1 âˆ’ (16/25) p^2 + O(p^3).</p>
<p>6) Optional: cubic term
- Extending the exact enumeration to all 3â€‘fault patterns (still tractable) gives A3 = 4222, G3 = 1198. Including these produces
  F(p) = 1 âˆ’ 16 p^2/25 âˆ’ 704 p^3/375 + O(p^4).</p>
<p>7) Independent checks
- Noiseless circuit prepares a state with expectation values âŸ¨XXXXâŸ©=âŸ¨ZZZZâŸ©=+1 on the data, ancilla Z=+1, and the reduced data state is pure (|00âŸ©L), confirming the reference. This was verified by explicit calculation with the given circuit.</p>
<p>Conventions and units
- All gates are ideal except for the two-qubit depolarizing channel after each CNOT (five CNOTs total). Single-qubit H and the ideal projective measurements are assumed perfect. The parameter p is the per-2q-gate error probability for a non-identity two-qubit Pauli drawn uniformly from the 15 options.</p>
<p>Final Answer:
The logical two-qubit state fidelity of the accepted (post-selected) output is</p>
<p>F(p) = 1 âˆ’ 16 p^2/25 + O(p^3),</p>
<p>i.e., to leading order F(p) = 1 âˆ’ 0.64 p^2 + O(p^3). Including the next term from exact 3â€‘fault enumeration gives</p>
<p>F(p) = 1 âˆ’ 16 p^2/25 âˆ’ 704 p^3/375 + O(p^4).</p>
<p>Citations:
- [[4,2,2]] code, stabilizers, and codewords: Error Correction Zoo, â€œ([[4,2,2]]) Four-qubit code.â€ (<a href="https://errorcorrectionzoo.org/c/stab_4_2_2">errorcorrectionzoo.org</a>)
- Depolarizing/Pauli channel background and equal-weight Pauli-error model: Quantum Channel Zoo (depolarizing channel) and Wikipedia (depolarizing channel). (<a href="https://quantumchannelzoo.org/channel/depolarizing?utm_source=openai">quantumchannelzoo.org</a>, <a href="https://en.wikipedia.org/wiki/Quantum_depolarizing_channel?utm_source=openai">en.wikipedia.org</a>)
- Equal weighting of the 15 non-identity two-qubit Paulis for the 2â€‘qubit depolarizing channel (worked-out perspective): Algassert blog. (<a href="https://algassert.com/post/2001?utm_source=openai">algassert.com</a>)</p></div>
</article>


<article class="message role-user">
    <div class="meta">
        <span class="badge">User</span>
        <span class="idx">#27</span>
    </div>
    <div class="content markdown-body"><p>Populate your final answer into the code template provided below. This step is purely for formatting/display purposes. No additional reasoning or derivation should be performed. Do not import any modules or packages beyond what is provided in the template.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">answer</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the expression of the logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    at the end of the circuit as a function of two-qubit gate error rate $p$.</span>

<span class="sd">    Inputs</span>
<span class="sd">    ----------</span>
<span class="sd">    p: sympy.Symbol, two-qubit gate error rate, $p$</span>

<span class="sd">    Outputs</span>
<span class="sd">    ----------</span>
<span class="sd">    F_logical: sympy.Expr, logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------ FILL IN YOUR RESULTS BELOW ------------------</span>
    <span class="n">F_logical</span> <span class="o">=</span> <span class="o">...</span>  <span class="c1"># a SymPy expression of inputs</span>
    <span class="c1"># ---------------------------------------------------------------</span>

    <span class="k">return</span> <span class="n">F_logical</span>
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#28</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">answer</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the expression of the logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    at the end of the circuit as a function of two-qubit gate error rate $p$.</span>

<span class="sd">    Inputs</span>
<span class="sd">    ----------</span>
<span class="sd">    p: sympy.Symbol, two-qubit gate error rate, $p$</span>

<span class="sd">    Outputs</span>
<span class="sd">    ----------</span>
<span class="sd">    F_logical: sympy.Expr, logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------ FILL IN YOUR RESULTS BELOW ------------------</span>
    <span class="n">F_logical</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">704</span><span class="p">,</span> <span class="mi">375</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">3</span>
    <span class="c1"># ---------------------------------------------------------------</span>

    <span class="k">return</span> <span class="n">F_logical</span>
</code></pre></div></div>
</article>

</div>

<footer>
  Generated at 2025-09-24T22:02:11.142288
</footer>

<script>
(function() {
  // Tabs
  const tabs = document.querySelectorAll('.tab');
  const panels = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      panels.forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      const target = document.querySelector(tab.dataset.target);
      if (target) target.classList.add('active');
    });
  });

  // Theme toggle
  const toggleBtn = document.getElementById('theme-toggle');
  function setTheme(dark) {
    if (dark) {
      document.documentElement.classList.add('dark');
      localStorage.setItem('dark', '1');
    } else {
      document.documentElement.classList.remove('dark');
      localStorage.setItem('dark', '0');
    }
  }
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const stored = localStorage.getItem('dark');
  setTheme(stored === null ? prefersDark : stored === '1');

  toggleBtn.addEventListener('click', () => {
    const isDark = document.documentElement.classList.contains('dark');
    setTheme(!isDark);
  });
})();
</script>
</body>
</html>