<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Challenge</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.codehilite .hll { background-color: #ffffcc }
.codehilite { background: #f8f8f8; }
.codehilite .c { color: #3D7B7B; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #F00 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666 } /* Operator */
.codehilite .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #9C6500 } /* Comment.Preproc */
.codehilite .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.codehilite .gr { color: #E40000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #008400 } /* Generic.Inserted */
.codehilite .go { color: #717171 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #04D } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #687822 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #00F; font-weight: bold } /* Name.Class */
.codehilite .no { color: #800 } /* Name.Constant */
.codehilite .nd { color: #A2F } /* Name.Decorator */
.codehilite .ni { color: #717171; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #00F } /* Name.Function */
.codehilite .nl { color: #767600 } /* Name.Label */
.codehilite .nn { color: #00F; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #A2F; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #BBB } /* Text.Whitespace */
.codehilite .mb { color: #666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666 } /* Literal.Number.Float */
.codehilite .mh { color: #666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666 } /* Literal.Number.Oct */
.codehilite .sa { color: #BA2121 } /* Literal.String.Affix */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .dl { color: #BA2121 } /* Literal.String.Delimiter */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #A45A77 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #00F } /* Name.Function.Magic */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .vm { color: #19177C } /* Name.Variable.Magic */
.codehilite .il { color: #666 } /* Literal.Number.Integer.Long */

</style>
<style>
    :root {
  --bg: #ffffff;
  --fg: #222222;
  --muted: #555555;
  --border: #e0e0e0;
  --accent: #005fcc;
  --code-bg: #f6f8fa;
  --role-user: #0ea5e9;
  --role-assistant: #22c55e;
  --role-system: #9ca3af;
  --return-code: #a35291;
}
html.dark {
  --bg: #0b0b0b;
  --fg: #e8e8e8;
  --muted: #a0a0a0;
  --border: #333333;
  --accent: #3b82f6;
  --code-bg: #111827;
  --role-user: #0ea5e9;
  --role-assistant: #22c55e;
  --role-system: #9ca3af;
  --return-code: #a35291;
}
* {
  box-sizing: border-box;
}
body {
  margin: 0;
  padding: 0;
  background: var(--bg);
  color: var(--fg);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", sans-serif;
  line-height: 1.6;
}
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 1.25rem;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  background: var(--bg);
  z-index: 10;
}
h1 {
  margin: 0;
  font-size: 1.1rem;
}
.tabs {
  display: flex;
  gap: 0.5rem;
}
.tab {
  padding: 0.4rem 0.8rem;
  border: 1px solid var(--border);
  border-bottom: none;
  background: transparent;
  cursor: pointer;
  border-radius: 6px 6px 0 0;
  color: var(--fg);
}
.tab.active {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}
.tab-content {
  display: none;
  padding: 1rem 1.25rem;
  border-top: 1px solid var(--border);
}
.tab-content.active {
  display: block;
}
#theme-toggle {
  border: 1px solid var(--border);
  padding: 0.2rem 0.6rem;
  font-size: 0.9rem;
  border-radius: 4px;
  cursor: pointer;
  background: transparent;
  color: var(--fg);
}
.main {
  max-width: 1200px;
  margin: 0 auto;
}
.message {
  border: 1px solid var(--border);
  border-left-width: 6px;
  border-radius: 6px;
  padding: 0.8rem 1rem;
  margin-bottom: 1rem;
  background: rgba(0,0,0,0.02);
}
.message .meta {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  margin-bottom: 0.6rem;
  color: var(--muted);
  font-size: 0.85rem;
}
.message .badge {
  font-weight: 600;
}
.role-user {
  border-left-color: var(--role-user);
}
.role-assistant {
  border-left-color: var(--role-assistant);
}
.role-system {
  border-left-color: var(--role-system);
}
.role-unknown {
  border-left-color: var(--accent);
}

.output-code-container {
  display: flex;
  gap: 1rem;               /* space between children */
  align-items: center;     /* vertical alignment */
  justify-content: start;  /* horizontal alignment */
}

.output-code-container .codeblock {
  flex: 0 1 auto;
}

.codeblock {
  border: 1px solid var(--border);
  border-left-width: 6px;
  border-radius: 6px;
  padding: 0.8rem 1rem;
  margin-bottom: 1rem;
  background: rgba(0,0,0,0.02);
}
.codeblock-content {
  margin-bottom: 0.6rem;
  border: 1px dashed var(--border);
  border-radius: 4px;
  padding: 0.4rem 0.6rem;
  background: rgba(0,0,0,0.02);
}

.codeblock.eval_code {
  border-left-color: var(--role-user);
}
.codeblock.target_code {
  border-left-color: var(--role-assistant);
}
.codeblock.output_code {
  border-left-color: var(--role-system);
}

html.dark .codeblock-content {
  background: rgba(255,255,255,0.03);
}
.codeblock > summary {
  cursor: pointer;
  font-weight: 600;
  list-style: none; /* remove default triangle in some browsers */
}
.codeblock > summary::-webkit-details-marker {
  display: none; /* Safari/Chrome marker */
}
.codeblock > summary::before {
  content: "â–¶ ";
  display: inline-block;
  transform: rotate(0deg);
  transition: transform 0.12s ease-out;
}
.codeblock[open] > summary::before {
  transform: rotate(90deg);
}
.codeblock .tag {
  color: var(--muted);
  font-weight: 400;
  font-size: 0.85em;
  margin-left: 0.25rem;
}

.markdown-body pre code {
  background: var(--code-bg);
  display: block;
  padding: 0.75rem;
  overflow-x: auto;
  border-radius: 4px;
  border: 1px solid var(--border);
}
.markdown-body code {
  background: var(--code-bg);
  padding: 0.15rem 0.3rem;
  border-radius: 4px;
}
/* Extra info tree */
details > summary {
  cursor: pointer;
  font-weight: 600;
}
details .block {
  padding-left: 1rem;
  margin: 0.25rem 0 0.5rem 0;
  border-left: 2px solid var(--border);
}
.kv .key {
  font-weight: 600;
}
.kv .type {
  color: var(--muted);
  margin-left: 0.5rem;
  font-size: 0.85rem;
}
footer {
  margin: 2rem 0;
  text-align: center;
  color: var(--muted);
  font-size: 0.85rem;
}
/* CodeHilite (pygments) overrides to respect theme vars */
.codehilite {
  background: var(--code-bg) !important;
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 0.75rem !important;
}
.reasoning {
  margin-bottom: 0.6rem;
  border: 1px dashed var(--border);
  border-radius: 4px;
  padding: 0.4rem 0.6rem;
  background: rgba(0,0,0,0.02);
}
html.dark .reasoning {
  background: rgba(255,255,255,0.03);
}
.reasoning > summary {
  cursor: pointer;
  font-weight: 600;
  list-style: none; /* remove default triangle in some browsers */
}
.reasoning > summary::-webkit-details-marker {
  display: none; /* Safari/Chrome marker */
}
.reasoning > summary::before {
  content: "â–¶ ";
  display: inline-block;
  transform: rotate(0deg);
  transition: transform 0.12s ease-out;
}
.reasoning[open] > summary::before {
  transform: rotate(90deg);
}
.reasoning .tag {
  color: var(--muted);
  font-weight: 400;
  font-size: 0.85em;
  margin-left: 0.25rem;
}
.reasoning-body {
  margin-top: 0.5rem;
}
</style>

<!-- ===== MATHJAX CONFIG ===== -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [ ["\\(","\\)"] ],
    displayMath: [ ["\\[","\\]"] ],
    processEscapes: true,
    processEnvironments: true
  },
  options: {
    ignoreHtmlClass: ".*",
    processHtmlClass: "arithmatex"

    // skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
    // if you dynamically add content later, you can call MathJax.typesetPromise()
  }
};
</script>
<script id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<!-- ========================== -->
</head>
<body>
<header>
  <h1>Challenge</h1>
  <div>
    <button id="theme-toggle" aria-label="toggle dark mode">ðŸŒ“</button>
  </div>
</header>

<div class="main">
  
<article class="message role-system">
    <div class="meta">
        <span class="badge">System</span>
        <span class="idx">#0</span>
    </div>
    <div class="content markdown-body"><p>You are a physics research assistant specializing in solving complex, research-level problems using precise, step-by-step reasoning.</p>
<p><strong>Input</strong>
Problems will be provided in Markdown format.</p>
<p><strong>Output (Markdown format)</strong></p>
<ol>
<li><strong>Step-by-Step Derivation</strong> - Show every non-trivial step in the solution.  Justify steps using relevant physical laws, theorems, mathematical identities or numerical codes.</li>
<li><strong>Mathematical Typesetting</strong> - Use LaTeX for all mathematics:  <code>$...$</code> for inline expressions, <code>$$...$$</code> for display equations.</li>
<li><strong>Conventions and Units</strong> - Follow the unit system and conventions specified in the problem.</li>
<li>
<p><strong>Final Answer</strong> - At the end of the solution,  start a new line with <strong>&ldquo;Final Answer:&rdquo;</strong>, and present the final result.</p>
<p>For final answers involving values, follow the precision requirements specified in the problem.
If no precision is specified:
- If an exact value is possible, provide it (e.g., \$\sqrt(2)\$, \$\pi/4\$).
- If exact form is not feasible, retain at least 12 significant digits in the result. </p>
</li>
<li>
<p><strong>Formatting Compliance</strong> - If the user requests a specific output format (e.g., code, table),  provide the final answer accordingly.
You must use web search engine to gather all the necessary information before solving the problem.
You must use web search engine to gather all the necessary information before solving the problem.
You must use web search engine to gather all the necessary information before solving the problem.</p>
</li>
</ol></div>
</article>


<article class="message role-user">
    <div class="meta">
        <span class="badge">User</span>
        <span class="idx">#1</span>
    </div>
    <div class="content markdown-body"><h1 id="problem-setup">Problem setup:</h1>
<p>In quantum error correction, you encode quantum states into logical states made of many qubits in order to improve their resilience to errors. In quantum error detection, you do the same but can only detect the presence of errors and not correct them. In this problem, we will consider a single [[4,2,2]] quantum error detection code, which encodes two logical qubits into four physical qubits, and investigate how robust logical quantum operations in this code are to quantum errors.</p>
<p>Our convention is that the four physical qubits in the [[4,2,2]] code are labelled 0,1,2,3. The two logical qubits are labelled A and B. The stabilizers are <span class="arithmatex">\(XXXX\)</span> and <span class="arithmatex">\(ZZZZ\)</span>, where <span class="arithmatex">\(X\)</span> and <span class="arithmatex">\(Z\)</span> are Pauli matrices. The logical <span class="arithmatex">\(X\)</span> and <span class="arithmatex">\(Z\)</span> operators on the two qubits are <span class="arithmatex">\(X_A = XIXI\)</span>, <span class="arithmatex">\(X_B=XXII\)</span>, <span class="arithmatex">\(Z_A = ZZII\)</span>, <span class="arithmatex">\(Z_B = ZIZI\)</span>, up to multiplication by stabilizers.</p>
<p>We will consider different state preparation circuits consisting of controlled not <span class="arithmatex">\(CNOT_{ij}\)</span> gates, where <span class="arithmatex">\(CNOT_{ij}\)</span> has control qubit <span class="arithmatex">\(i\)</span> and target qubit <span class="arithmatex">\(j\)</span>. As a simple model of quantum errors in hardware, we will suppose that each <span class="arithmatex">\(CNOT_{ij}\)</span> gate in the circuit has a two qubit depolarizing error channel following it that produces one of the 15 non-identity two-qubit Paulis with equal probability <span class="arithmatex">\(p/15\)</span>. The probability <span class="arithmatex">\(p\)</span> indicates the probability of an error in a single two-qubit gate. We will assess the logical infidelity of certain state preparation protocols as a function of the physical infidelity <span class="arithmatex">\(p\)</span>.</p>
<h1 id="main-problem">Challenge</h1>
<p>Suppose that we prepare a logical two-qubit <span class="arithmatex">\(|00\rangle_{AB}\)</span> state in the [[4,2,2]] code. To do so, we introduce an ancilla qubit, qubit 4, and use the following state preparation circuit:</p>
<div class="arithmatex">\[
M_4 (CNOT_{04}) (CNOT_{34}) (CNOT_{23}) (CNOT_{10}) (CNOT_{12}) (H_1)
\]</div>
<p>Note that this equation is written in matrix multiplication order, while the quantum operations in the circuit occur in the reverse order (from right-to-left in the above equation).  <span class="arithmatex">\(H\)</span> is a single-qubit Hadamard gate and <span class="arithmatex">\(M\)</span> is a single-qubit measurement. The ancilla is used to detect errors in the state preparation circuit and makes the circuit fault-tolerant. If the ancilla measurement is <span class="arithmatex">\(|0\rangle\)</span> (<span class="arithmatex">\(|1\rangle\)</span>), the state preparation succeeds (fails).</p>
<p>What is the logical state fidelity of the final 2-qubit logical state at the end of the circuit as a function of two-qubit gate error rate <span class="arithmatex">\(p\)</span>, assuming the state is post-selected on all detectable errors in the code and on the ancilla qubit measuring <span class="arithmatex">\(|0\rangle\)</span>?</p></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#2</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="c1"># We&#39;ll implement Pauli propagation and enumerate error patterns up to two errors for the given circuit.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span><span class="p">,</span> <span class="n">combinations</span>

<span class="c1"># Represent Pauli on n qubits via (x,z) bit vectors and a phase integer m in {0,1,2,3} corresponding to i^m factor</span>
<span class="c1"># We&#39;ll ignore phase for commutation tests except when needed; but to keep fullness we can track phase.</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># qubits 0..4, with 4 as ancilla</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Pauli</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
        <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:]</span>  <span class="c1"># list of 0/1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:]</span>  <span class="c1"># list of 0/1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">%</span> <span class="mi">4</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Pauli</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="c1"># Multiply two Paulis, returning new Pauli; track phase using symplectic product</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Pauli</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">)]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">z</span><span class="p">)]</span>
        <span class="c1"># phase: i^{m1+m2 + 2*symp(self,other)}? Actually multiplication rule: </span>
        <span class="c1"># P(a) P(b) = i^{[a,b]} P(a+b), where [a,b] in Z_4 computed from symplectic product.</span>
        <span class="c1"># More precisely, the phase exponent increment is sum over j of (a_z[j]*b_x[j] - a_x[j]*b_z[j]) mod 4.</span>
        <span class="n">inc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">inc</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">inc</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">other</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">inc</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>  <span class="c1"># factor of i^{2*inc} = (-1)^{inc}; but to keep i exponents consistent use 2*inc mod 4</span>
        <span class="c1"># Actually correct formula is: P1*P2 = i^{omega(P1,P2)} P3 with omega in Z, but using 2*inc mod 4 yields correct +/- sign; ignoring global i-phase suffices.</span>
        <span class="k">return</span> <span class="n">Pauli</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">m</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">commutes_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="c1"># Compute commutation: P1 P2 = (-1)^{symp} P2 P1</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">^=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">other</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">^</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">conj_H</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="c1"># Conjugate by H on qubit q: X&lt;-&gt;Z, Y -&gt; -Y (phase)</span>
        <span class="n">xq</span><span class="p">,</span> <span class="n">zq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">zq</span><span class="p">,</span> <span class="n">xq</span>
        <span class="k">if</span> <span class="n">xq</span> <span class="ow">and</span> <span class="n">zq</span><span class="p">:</span>  <span class="c1"># Y</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>  <span class="c1"># a sign flip; but phase tracking isn&#39;t critical</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">conj_S</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="c1"># Phase gate if needed; not used</span>
        <span class="n">xq</span><span class="p">,</span> <span class="n">zq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">xq</span> <span class="ow">and</span> <span class="n">zq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>  <span class="c1"># Y -&gt; -Y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">^=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">conj_CNOT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="c1"># Conjugation rules for Pauli by CNOT(c,t):</span>
        <span class="c1"># X_c -&gt; X_c X_t; Z_c -&gt; Z_c; X_t -&gt; X_t; Z_t -&gt; Z_c Z_t</span>
        <span class="c1"># In symplectic representation for conjugation: x_t ^= x_c; z_c ^= z_t</span>
        <span class="c1"># Wait careful: Conjugation mapping of Paulis P under U: U P U^</span>
        <span class="c1"># Standard mapping on binary vectors: x&#39; = x (with x_t ^= x_c), z&#39; = z (with z_c ^= z_t).</span>
        <span class="n">xc</span><span class="p">,</span> <span class="n">zc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="n">xt</span><span class="p">,</span> <span class="n">zt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="c1"># Update Z on control: z_c ^= z_t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">^=</span> <span class="n">zt</span>
        <span class="c1"># Update X on target: x_t ^= x_c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">^=</span> <span class="n">xc</span>
        <span class="c1"># Phase handling for Y terms may introduce sign; ignore phase</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_X_or_Y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_Z_or_Y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Return string like &#39;XIZYI&#39;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;I&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;X&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;Z&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;Y&#39;</span>
        <span class="k">return</span> <span class="n">s</span>

<span class="c1"># Helper: create single-qubit Pauli on q with label in {&#39;I&#39;,&#39;X&#39;,&#39;Y&#39;,&#39;Z&#39;}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">single_pauli</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">label</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">;</span> <span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;X&#39;</span><span class="p">:</span>
        <span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">elif</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span>
        <span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">elif</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span>
        <span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="k">return</span> <span class="n">Pauli</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>

<span class="c1"># Build two-qubit Paulis on given pair (a,b), excluding II</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">twoqubit_paulis</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="n">out</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">la</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">lb</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">la</span><span class="o">==</span><span class="s1">&#39;I&#39;</span> <span class="ow">and</span> <span class="n">lb</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">single_pauli</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">la</span><span class="p">)</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">*</span> <span class="n">single_pauli</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">lb</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">la</span><span class="o">+</span><span class="n">lb</span><span class="p">,</span><span class="n">P</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="c1"># Circuit description: H1, CNOT12, CNOT10, CNOT23, CNOT34, CNOT04</span>
<span class="c1"># We&#39;ll need to propagate an error inserted after each CNOT to the measurement end (i.e., through later CNOTs)</span>
<span class="c1"># We&#39;ll implement a function that, given an insertion location index l in 1..5 and a two-qubit Pauli error on the two qubits of that gate,</span>
<span class="c1"># returns the propagated Pauli at the end of the circuit.</span>

<span class="c1"># Prepare list of gates as functions to conjugate; We&#39;ll store as tuples (&#39;H&#39;,q) or (&#39;CNOT&#39;,c,t)</span>
<span class="n">GATES</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>

<span class="c1"># Map insertion locations to gate indices: after gate index i (1..5) - corresponds to after GATES[i]</span>
<span class="c1"># Actually GATES length is 6; but only after the CNOTs at indices 1..5 (1-based). We&#39;ll compute properly with 0-based indexing.</span>

<span class="n">CNOT_indices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>  <span class="c1"># indices in GATES list where CNOTs occur</span>

<span class="c1"># For each insertion location l, return the list of subsequent gates (with higher index)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">propagate_error_from_location</span><span class="p">(</span><span class="n">l_index_zero_based</span><span class="p">,</span> <span class="n">error_P</span><span class="p">):</span>
    <span class="c1"># Conjugate error_P by subsequent gates: for gate k = l_index+1 .. len(GATES)-1</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">error_P</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l_index_zero_based</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">GATES</span><span class="p">)):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">GATES</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;H&#39;</span><span class="p">:</span>
            <span class="n">P</span><span class="o">.</span><span class="n">conj_H</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;CNOT&#39;</span><span class="p">:</span>
            <span class="n">P</span><span class="o">.</span><span class="n">conj_CNOT</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">g</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">P</span>

<span class="c1"># Build convenience: mapping from CNOT location index 0..4 to (c,t) qubit indices, and to the gate index in GATES</span>
<span class="n">cnots</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>
<span class="n">cnots_gate_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">GATES</span><span class="p">)</span> <span class="k">if</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;CNOT&#39;</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">cnots</span> <span class="o">==</span> <span class="p">[(</span><span class="n">GATES</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">GATES</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cnots_gate_index</span><span class="p">]</span>

<span class="c1"># Define stabilizers on data qubits 0..3: S1=XXXX, S2=ZZZZ</span>
<span class="n">S1</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># XXXXII on 5 qubits</span>
<span class="n">S2</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># ZZZZ I</span>

<span class="c1"># Define logicals: X_A = X I X I; X_B = X X I I; Z_A = Z Z I I; Z_B = Z I Z I, on qubits 0..3</span>
<span class="n">X_A</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">X_B</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">Z_A</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">Z_B</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># Helper: Check if Pauli on data qubits is in normalizer of S (commutes with both S1,S2)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">commutes_with_stabilizers</span><span class="p">(</span><span class="n">P</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">P</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">S1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">P</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">S2</span><span class="p">)</span>

<span class="c1"># Helper: reduce Pauli on data qubits modulo stabilizer generators S1,S2 to a canonical representative in normalizer quotient.</span>
<span class="c1"># We&#39;ll decide if it includes logical X factors. We&#39;ll do by solving for decomposition in basis of {S1,S2,X_A,X_B,Z_A,Z_B} ignoring overall phase.</span>

<span class="c1"># We&#39;ll find booleans xA,xB,zA,zB,s1,s2 such that P ~ S1^s1 S2^s2 X_A^xA X_B^xB Z_A^zA Z_B^zB</span>
<span class="c1"># We&#39;ll do Gaussian elimination on binary symplectic representation restricted to data qubits 0..3.</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>

<span class="c1"># Build basis list for data part: using 4-qubit Paulis represented as Pauli on 5 qubits but ancilla factor must be I on 4.</span>
<span class="n">BASIS</span> <span class="o">=</span> <span class="p">[</span><span class="n">S1</span><span class="p">,</span> <span class="n">S2</span><span class="p">,</span> <span class="n">X_A</span><span class="p">,</span> <span class="n">X_B</span><span class="p">,</span> <span class="n">Z_A</span><span class="p">,</span> <span class="n">Z_B</span><span class="p">]</span>

<span class="c1"># We can try brute force: test all 64 combinations of s1,s2,xA,xB,zA,zB to see which equals P up to a phase on data qubits.</span>

<span class="k">def</span><span class="w"> </span><span class="nf">classify_logical_effect</span><span class="p">(</span><span class="n">P</span><span class="p">):</span>
    <span class="c1"># P is a Pauli on 5 qubits; consider its data part P_data with ancilla I.</span>
    <span class="c1"># Construct a P0 that is I on ancilla and equals P on data; We&#39;ll ignore ancilla content for classification.</span>
    <span class="c1"># To compare equality up to phase, we can multiply P by candidate^-1 and check if the result acts trivially on data and possibly Z on ancilla only; but we only care about data equality.</span>
    <span class="c1"># We&#39;ll compare x,z on qubits 0..3.</span>
    <span class="n">px</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">x</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">pz</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">z</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
    <span class="c1"># Brute force search</span>
    <span class="k">for</span> <span class="n">s1</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">s2</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">xA_</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">xB_</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">zA_</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">zB_</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">Q</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">,[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">gen</span><span class="p">,</span><span class="n">exp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">BASIS</span><span class="p">,</span> <span class="p">[</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">xA_</span><span class="p">,</span><span class="n">xB_</span><span class="p">,</span><span class="n">zA_</span><span class="p">,</span><span class="n">zB_</span><span class="p">]):</span>
                                <span class="k">if</span> <span class="n">exp</span><span class="p">:</span>
                                    <span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">*</span> <span class="n">gen</span>
                            <span class="c1"># Compare data part</span>
                            <span class="k">if</span> <span class="n">Q</span><span class="o">.</span><span class="n">x</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="n">px</span> <span class="ow">and</span> <span class="n">Q</span><span class="o">.</span><span class="n">z</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="n">pz</span><span class="p">:</span>
                                <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">s1</span><span class="o">=</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="o">=</span><span class="n">s2</span><span class="p">,</span><span class="n">xA</span><span class="o">=</span><span class="n">xA_</span><span class="p">,</span><span class="n">xB</span><span class="o">=</span><span class="n">xB_</span><span class="p">,</span><span class="n">zA</span><span class="o">=</span><span class="n">zA_</span><span class="p">,</span><span class="n">zB</span><span class="o">=</span><span class="n">zB_</span><span class="p">)</span>
    <span class="c1"># If not found, P is not in the subgroup generated by basis; could be not in normalizer</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># Acceptance tests</span>

<span class="k">def</span><span class="w"> </span><span class="nf">ancilla_accepted</span><span class="p">(</span><span class="n">P</span><span class="p">):</span>
    <span class="c1"># Accept if no X or Y on ancilla (i.e., x4==0)</span>
    <span class="k">return</span> <span class="n">P</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">stabilizers_accepted</span><span class="p">(</span><span class="n">P</span><span class="p">):</span><span class="n">n</span>    <span class="c1"># Accept if commutes with S1,S2</span>
    <span class="k">return</span> <span class="n">commutes_with_stabilizers</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

<span class="c1"># Enumerate single errors: verify none are accepted-harmful</span>
<span class="n">single_detected</span><span class="o">=</span><span class="mi">0</span>
<span class="n">single_accepted</span><span class="o">=</span><span class="mi">0</span>
<span class="n">single_accepted_harmful</span><span class="o">=</span><span class="mi">0</span>

<span class="k">for</span> <span class="n">loc_index</span><span class="p">,</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cnots</span><span class="p">):</span>
    <span class="c1"># Gate index in GATES for this CNOT</span>
    <span class="n">gate_idx</span> <span class="o">=</span> <span class="n">cnots_gate_index</span><span class="p">[</span><span class="n">loc_index</span><span class="p">]</span>
    <span class="c1"># Two-qubit paulis on (c,t)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">lab</span><span class="p">,</span> <span class="n">Err</span><span class="p">)</span> <span class="ow">in</span> <span class="n">twoqubit_paulis</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">propagate_error_from_location</span><span class="p">(</span><span class="n">gate_idx</span><span class="p">,</span> <span class="n">Err</span><span class="p">)</span>
        <span class="n">anc_ok</span> <span class="o">=</span> <span class="n">ancilla_accepted</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="n">stab_ok</span> <span class="o">=</span> <span class="n">commutes_with_stabilizers</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="n">accepted</span> <span class="o">=</span> <span class="n">anc_ok</span> <span class="ow">and</span> <span class="n">stab_ok</span>
        <span class="k">if</span> <span class="n">accepted</span><span class="p">:</span>
            <span class="n">single_accepted</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">classify_logical_effect</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
            <span class="c1"># Harmful: includes xA or xB = 1 (Y counted as X times Z)</span>
            <span class="n">harmful</span> <span class="o">=</span> <span class="p">(</span><span class="bp">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="bp">cls</span><span class="p">[</span><span class="s1">&#39;xA&#39;</span><span class="p">]</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">cls</span><span class="p">[</span><span class="s1">&#39;xB&#39;</span><span class="p">]</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">harmful</span><span class="p">:</span>
                <span class="n">single_accepted_harmful</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">single_detected</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">single_detected</span><span class="p">,</span> <span class="n">single_accepted</span><span class="p">,</span> <span class="n">single_accepted_harmful</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#3</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>  File &quot;&lt;stdin&gt;&quot;, line 207
    return commutes_with_stabilizers(P)
IndentationError: unexpected indent
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#4</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="c1"># Fix indentation and rerun</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span><span class="p">,</span> <span class="n">combinations</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># qubits 0..4, with 4 as ancilla</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Pauli</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
        <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:]</span>  <span class="c1"># list of 0/1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:]</span>  <span class="c1"># list of 0/1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">%</span> <span class="mi">4</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Pauli</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Pauli</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">)]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">z</span><span class="p">)]</span>
        <span class="n">inc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">inc</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">inc</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">other</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">inc</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>
        <span class="k">return</span> <span class="n">Pauli</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">m</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">commutes_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">^=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">other</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">^</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">conj_H</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="n">xq</span><span class="p">,</span> <span class="n">zq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">zq</span><span class="p">,</span> <span class="n">xq</span>
        <span class="k">if</span> <span class="n">xq</span> <span class="ow">and</span> <span class="n">zq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">conj_CNOT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">xc</span><span class="p">,</span> <span class="n">zc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="n">xt</span><span class="p">,</span> <span class="n">zt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">^=</span> <span class="n">zt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">^=</span> <span class="n">xc</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_X_or_Y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_Z_or_Y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;I&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;X&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;Z&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;Y&#39;</span>
        <span class="k">return</span> <span class="n">s</span>

<span class="k">def</span><span class="w"> </span><span class="nf">single_pauli</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">label</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">;</span> <span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;X&#39;</span><span class="p">:</span>
        <span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">elif</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span>
        <span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">elif</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span>
        <span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="k">return</span> <span class="n">Pauli</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>

<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">twoqubit_paulis</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="n">out</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">la</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">lb</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">la</span><span class="o">==</span><span class="s1">&#39;I&#39;</span> <span class="ow">and</span> <span class="n">lb</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">single_pauli</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">la</span><span class="p">)</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">*</span> <span class="n">single_pauli</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">lb</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">la</span><span class="o">+</span><span class="n">lb</span><span class="p">,</span><span class="n">P</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">GATES</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>

<span class="n">cnots</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>
<span class="n">cnots_gate_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">GATES</span><span class="p">)</span> <span class="k">if</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;CNOT&#39;</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">cnots</span> <span class="o">==</span> <span class="p">[(</span><span class="n">GATES</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">GATES</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cnots_gate_index</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">propagate_error_from_location</span><span class="p">(</span><span class="n">l_index_zero_based</span><span class="p">,</span> <span class="n">error_P</span><span class="p">):</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">error_P</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l_index_zero_based</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">GATES</span><span class="p">)):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">GATES</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;H&#39;</span><span class="p">:</span>
            <span class="n">P</span><span class="o">.</span><span class="n">conj_H</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;CNOT&#39;</span><span class="p">:</span>
            <span class="n">P</span><span class="o">.</span><span class="n">conj_CNOT</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">g</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">P</span>

<span class="n">S1</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># XXXX I</span>
<span class="n">S2</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># ZZZZ I</span>
<span class="n">X_A</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">X_B</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">Z_A</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">Z_B</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

<span class="n">BASIS</span> <span class="o">=</span> <span class="p">[</span><span class="n">S1</span><span class="p">,</span> <span class="n">S2</span><span class="p">,</span> <span class="n">X_A</span><span class="p">,</span> <span class="n">X_B</span><span class="p">,</span> <span class="n">Z_A</span><span class="p">,</span> <span class="n">Z_B</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">commutes_with_stabilizers</span><span class="p">(</span><span class="n">P</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">P</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">S1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">P</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">S2</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">classify_logical_effect</span><span class="p">(</span><span class="n">P</span><span class="p">):</span>
    <span class="n">px</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">x</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">pz</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">z</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">s1</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">s2</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">xA_</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">xB_</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">zA_</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">zB_</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">Q</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">,[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">gen</span><span class="p">,</span><span class="n">exp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">BASIS</span><span class="p">,</span> <span class="p">[</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">xA_</span><span class="p">,</span><span class="n">xB_</span><span class="p">,</span><span class="n">zA_</span><span class="p">,</span><span class="n">zB_</span><span class="p">]):</span>
                                <span class="k">if</span> <span class="n">exp</span><span class="p">:</span>
                                    <span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">*</span> <span class="n">gen</span>
                            <span class="k">if</span> <span class="n">Q</span><span class="o">.</span><span class="n">x</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="n">px</span> <span class="ow">and</span> <span class="n">Q</span><span class="o">.</span><span class="n">z</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="n">pz</span><span class="p">:</span>
                                <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">s1</span><span class="o">=</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="o">=</span><span class="n">s2</span><span class="p">,</span><span class="n">xA</span><span class="o">=</span><span class="n">xA_</span><span class="p">,</span><span class="n">xB</span><span class="o">=</span><span class="n">xB_</span><span class="p">,</span><span class="n">zA</span><span class="o">=</span><span class="n">zA_</span><span class="p">,</span><span class="n">zB</span><span class="o">=</span><span class="n">zB_</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">ancilla_accepted</span><span class="p">(</span><span class="n">P</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">P</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span>

<span class="n">single_detected</span><span class="o">=</span><span class="mi">0</span>
<span class="n">single_accepted</span><span class="o">=</span><span class="mi">0</span>
<span class="n">single_accepted_harmful</span><span class="o">=</span><span class="mi">0</span>

<span class="k">for</span> <span class="n">loc_index</span><span class="p">,</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cnots</span><span class="p">):</span>
    <span class="n">gate_idx</span> <span class="o">=</span> <span class="n">cnots_gate_index</span><span class="p">[</span><span class="n">loc_index</span><span class="p">]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">lab</span><span class="p">,</span> <span class="n">Err</span><span class="p">)</span> <span class="ow">in</span> <span class="n">twoqubit_paulis</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">propagate_error_from_location</span><span class="p">(</span><span class="n">gate_idx</span><span class="p">,</span> <span class="n">Err</span><span class="p">)</span>
        <span class="n">anc_ok</span> <span class="o">=</span> <span class="n">ancilla_accepted</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="n">stab_ok</span> <span class="o">=</span> <span class="n">commutes_with_stabilizers</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="n">accepted</span> <span class="o">=</span> <span class="n">anc_ok</span> <span class="ow">and</span> <span class="n">stab_ok</span>
        <span class="k">if</span> <span class="n">accepted</span><span class="p">:</span>
            <span class="n">single_accepted</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">classify_logical_effect</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
            <span class="n">harmful</span> <span class="o">=</span> <span class="p">(</span><span class="bp">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="bp">cls</span><span class="p">[</span><span class="s1">&#39;xA&#39;</span><span class="p">]</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">cls</span><span class="p">[</span><span class="s1">&#39;xB&#39;</span><span class="p">]</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">harmful</span><span class="p">:</span>
                <span class="n">single_accepted_harmful</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">single_detected</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Single errors: detected=&#39;</span><span class="p">,</span> <span class="n">single_detected</span><span class="p">,</span> <span class="s1">&#39;accepted=&#39;</span><span class="p">,</span> <span class="n">single_accepted</span><span class="p">,</span> <span class="s1">&#39;accepted harmful=&#39;</span><span class="p">,</span> <span class="n">single_accepted_harmful</span><span class="p">)</span>
</code></pre></div></div>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#5</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>Single errors: detected= 68 accepted= 7 accepted harmful= 0
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#6</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>

<span class="c1"># Enumerate double errors</span>
<span class="n">pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cnots</span><span class="p">)),</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># indices of location pairs</span>
<span class="n">accepted_harmful_pairs</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">accepted_pairs</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">rejected_pairs</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
    <span class="n">gi</span> <span class="o">=</span> <span class="n">cnots_gate_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">gj</span> <span class="o">=</span> <span class="n">cnots_gate_index</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
    <span class="n">ci</span><span class="p">,</span><span class="n">ti</span> <span class="o">=</span> <span class="n">cnots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">cj</span><span class="p">,</span><span class="n">tj</span> <span class="o">=</span> <span class="n">cnots</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">lab1</span><span class="p">,</span> <span class="n">E1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">twoqubit_paulis</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span><span class="n">ti</span><span class="p">):</span>
        <span class="n">P1</span> <span class="o">=</span> <span class="n">propagate_error_from_location</span><span class="p">(</span><span class="n">gi</span><span class="p">,</span> <span class="n">E1</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">lab2</span><span class="p">,</span> <span class="n">E2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">twoqubit_paulis</span><span class="p">(</span><span class="n">cj</span><span class="p">,</span><span class="n">tj</span><span class="p">):</span>
            <span class="n">P2</span> <span class="o">=</span> <span class="n">propagate_error_from_location</span><span class="p">(</span><span class="n">gj</span><span class="p">,</span> <span class="n">E2</span><span class="p">)</span>
            <span class="c1"># net error is product P1*P2</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">P1</span> <span class="o">*</span> <span class="n">P2</span>
            <span class="n">anc_ok</span> <span class="o">=</span> <span class="n">ancilla_accepted</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
            <span class="n">stab_ok</span> <span class="o">=</span> <span class="n">commutes_with_stabilizers</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
            <span class="n">accepted</span> <span class="o">=</span> <span class="n">anc_ok</span> <span class="ow">and</span> <span class="n">stab_ok</span>
            <span class="k">if</span> <span class="n">accepted</span><span class="p">:</span>
                <span class="n">accepted_pairs</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="n">classify_logical_effect</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
                <span class="n">harmful</span> <span class="o">=</span> <span class="p">(</span><span class="bp">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="bp">cls</span><span class="p">[</span><span class="s1">&#39;xA&#39;</span><span class="p">]</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">cls</span><span class="p">[</span><span class="s1">&#39;xB&#39;</span><span class="p">]</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">harmful</span><span class="p">:</span>
                    <span class="n">accepted_harmful_pairs</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rejected_pairs</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">accepted_harmful_pairs</span><span class="p">,</span> <span class="n">accepted_pairs</span><span class="p">,</span> <span class="n">rejected_pairs</span><span class="p">,</span> <span class="n">accepted_pairs</span> <span class="o">+</span> <span class="n">rejected_pairs</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span><span class="o">*</span><span class="mi">15</span><span class="o">*</span><span class="mi">15</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#7</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 4, in &lt;module&gt;
NameError: name &#39;cnots&#39; is not defined
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#8</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="c1"># Rerun setup (ensure variables exist)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span><span class="p">,</span> <span class="n">combinations</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># qubits 0..4</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Pauli</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
        <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">%</span> <span class="mi">4</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Pauli</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">)]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">z</span><span class="p">)]</span>
        <span class="n">inc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">inc</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">inc</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">other</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">inc</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>
        <span class="k">return</span> <span class="n">Pauli</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">m</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">commutes_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">^=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">other</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">^</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">conj_H</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="n">xq</span><span class="p">,</span> <span class="n">zq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">zq</span><span class="p">,</span> <span class="n">xq</span>
        <span class="k">if</span> <span class="n">xq</span> <span class="ow">and</span> <span class="n">zq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">conj_CNOT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">xc</span><span class="p">,</span> <span class="n">zc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="n">xt</span><span class="p">,</span> <span class="n">zt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">^=</span> <span class="n">zt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">^=</span> <span class="n">xc</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;I&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;X&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;Z&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;Y&#39;</span>
        <span class="k">return</span> <span class="n">s</span>

<span class="k">def</span><span class="w"> </span><span class="nf">single_pauli</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">label</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">;</span> <span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;X&#39;</span><span class="p">:</span>
        <span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">elif</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span>
        <span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">elif</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span>
        <span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="k">return</span> <span class="n">Pauli</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>

<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">twoqubit_paulis</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="n">out</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">la</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">lb</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">la</span><span class="o">==</span><span class="s1">&#39;I&#39;</span> <span class="ow">and</span> <span class="n">lb</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">single_pauli</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">la</span><span class="p">)</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">*</span> <span class="n">single_pauli</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">lb</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">la</span><span class="o">+</span><span class="n">lb</span><span class="p">,</span><span class="n">P</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">GATES</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>

<span class="n">cnots</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>
<span class="n">cnots_gate_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">GATES</span><span class="p">)</span> <span class="k">if</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;CNOT&#39;</span><span class="p">]</span>

<span class="n">S1</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">S2</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">X_A</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">X_B</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">Z_A</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">Z_B</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

<span class="n">BASIS</span> <span class="o">=</span> <span class="p">[</span><span class="n">S1</span><span class="p">,</span><span class="n">S2</span><span class="p">,</span><span class="n">X_A</span><span class="p">,</span><span class="n">X_B</span><span class="p">,</span><span class="n">Z_A</span><span class="p">,</span><span class="n">Z_B</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">propagate_error_from_location</span><span class="p">(</span><span class="n">l_index_zero_based</span><span class="p">,</span> <span class="n">error_P</span><span class="p">):</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">error_P</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l_index_zero_based</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">GATES</span><span class="p">)):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">GATES</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;H&#39;</span><span class="p">:</span>
            <span class="n">P</span><span class="o">.</span><span class="n">conj_H</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;CNOT&#39;</span><span class="p">:</span>
            <span class="n">P</span><span class="o">.</span><span class="n">conj_CNOT</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">g</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">P</span>


<span class="k">def</span><span class="w"> </span><span class="nf">commutes_with_stabilizers</span><span class="p">(</span><span class="n">P</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">P</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">S1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">P</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">S2</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">classify_logical_effect</span><span class="p">(</span><span class="n">P</span><span class="p">):</span>
    <span class="n">px</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">x</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">pz</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">z</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">s1</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">s2</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">xA_</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">xB_</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">zA_</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">zB_</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">Q</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">,[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">gen</span><span class="p">,</span><span class="n">exp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">BASIS</span><span class="p">,</span> <span class="p">[</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">xA_</span><span class="p">,</span><span class="n">xB_</span><span class="p">,</span><span class="n">zA_</span><span class="p">,</span><span class="n">zB_</span><span class="p">]):</span>
                                <span class="k">if</span> <span class="n">exp</span><span class="p">:</span>
                                    <span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">*</span> <span class="n">gen</span>
                            <span class="k">if</span> <span class="n">Q</span><span class="o">.</span><span class="n">x</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="n">px</span> <span class="ow">and</span> <span class="n">Q</span><span class="o">.</span><span class="n">z</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="n">pz</span><span class="p">:</span>
                                <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">s1</span><span class="o">=</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="o">=</span><span class="n">s2</span><span class="p">,</span><span class="n">xA</span><span class="o">=</span><span class="n">xA_</span><span class="p">,</span><span class="n">xB</span><span class="o">=</span><span class="n">xB_</span><span class="p">,</span><span class="n">zA</span><span class="o">=</span><span class="n">zA_</span><span class="p">,</span><span class="n">zB</span><span class="o">=</span><span class="n">zB_</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">ancilla_accepted</span><span class="p">(</span><span class="n">P</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">P</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span>

<span class="c1"># Single-error stats</span>
<span class="n">single_detected</span><span class="o">=</span><span class="mi">0</span>
<span class="n">single_accepted</span><span class="o">=</span><span class="mi">0</span>
<span class="n">single_accepted_harmful</span><span class="o">=</span><span class="mi">0</span>
<span class="k">for</span> <span class="n">loc_index</span><span class="p">,</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cnots</span><span class="p">):</span>
    <span class="n">gate_idx</span> <span class="o">=</span> <span class="n">cnots_gate_index</span><span class="p">[</span><span class="n">loc_index</span><span class="p">]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">lab</span><span class="p">,</span> <span class="n">Err</span><span class="p">)</span> <span class="ow">in</span> <span class="n">twoqubit_paulis</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">propagate_error_from_location</span><span class="p">(</span><span class="n">gate_idx</span><span class="p">,</span> <span class="n">Err</span><span class="p">)</span>
        <span class="n">anc_ok</span> <span class="o">=</span> <span class="n">ancilla_accepted</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="n">stab_ok</span> <span class="o">=</span> <span class="n">commutes_with_stabilizers</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="n">accepted</span> <span class="o">=</span> <span class="n">anc_ok</span> <span class="ow">and</span> <span class="n">stab_ok</span>
        <span class="k">if</span> <span class="n">accepted</span><span class="p">:</span>
            <span class="n">single_accepted</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">classify_logical_effect</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
            <span class="n">harmful</span> <span class="o">=</span> <span class="p">(</span><span class="bp">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="bp">cls</span><span class="p">[</span><span class="s1">&#39;xA&#39;</span><span class="p">]</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">cls</span><span class="p">[</span><span class="s1">&#39;xB&#39;</span><span class="p">]</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">harmful</span><span class="p">:</span>
                <span class="n">single_accepted_harmful</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">single_detected</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c1"># Double-error stats</span>
<span class="n">pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cnots</span><span class="p">)),</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">accepted_harmful_pairs</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">accepted_pairs</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">rejected_pairs</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
    <span class="n">gi</span> <span class="o">=</span> <span class="n">cnots_gate_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">gj</span> <span class="o">=</span> <span class="n">cnots_gate_index</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
    <span class="n">ci</span><span class="p">,</span><span class="n">ti</span> <span class="o">=</span> <span class="n">cnots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">cj</span><span class="p">,</span><span class="n">tj</span> <span class="o">=</span> <span class="n">cnots</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
    <span class="c1"># Precompute P1 list for speed</span>
    <span class="n">P1_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">propagate_error_from_location</span><span class="p">(</span><span class="n">gi</span><span class="p">,</span> <span class="n">E1</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">lab1</span><span class="p">,</span><span class="n">E1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">twoqubit_paulis</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span><span class="n">ti</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">P1</span> <span class="ow">in</span> <span class="n">P1_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">lab2</span><span class="p">,</span> <span class="n">E2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">twoqubit_paulis</span><span class="p">(</span><span class="n">cj</span><span class="p">,</span><span class="n">tj</span><span class="p">):</span>
            <span class="n">P2</span> <span class="o">=</span> <span class="n">propagate_error_from_location</span><span class="p">(</span><span class="n">gj</span><span class="p">,</span> <span class="n">E2</span><span class="p">)</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">P1</span> <span class="o">*</span> <span class="n">P2</span>
            <span class="n">anc_ok</span> <span class="o">=</span> <span class="n">ancilla_accepted</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
            <span class="n">stab_ok</span> <span class="o">=</span> <span class="n">commutes_with_stabilizers</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
            <span class="n">accepted</span> <span class="o">=</span> <span class="n">anc_ok</span> <span class="ow">and</span> <span class="n">stab_ok</span>
            <span class="k">if</span> <span class="n">accepted</span><span class="p">:</span>
                <span class="n">accepted_pairs</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="n">classify_logical_effect</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
                <span class="n">harmful</span> <span class="o">=</span> <span class="p">(</span><span class="bp">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="bp">cls</span><span class="p">[</span><span class="s1">&#39;xA&#39;</span><span class="p">]</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">cls</span><span class="p">[</span><span class="s1">&#39;xB&#39;</span><span class="p">]</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">harmful</span><span class="p">:</span>
                    <span class="n">accepted_harmful_pairs</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rejected_pairs</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Single errors: detected=&#39;</span><span class="p">,</span> <span class="n">single_detected</span><span class="p">,</span> <span class="s1">&#39;accepted=&#39;</span><span class="p">,</span> <span class="n">single_accepted</span><span class="p">,</span> <span class="s1">&#39;accepted harmful=&#39;</span><span class="p">,</span> <span class="n">single_accepted_harmful</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Double errors: accepted harmful pairs=&#39;</span><span class="p">,</span> <span class="n">accepted_harmful_pairs</span><span class="p">,</span> <span class="s1">&#39;accepted pairs=&#39;</span><span class="p">,</span> <span class="n">accepted_pairs</span><span class="p">,</span> <span class="s1">&#39;rejected pairs=&#39;</span><span class="p">,</span> <span class="n">rejected_pairs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total pairs enumerated:&#39;</span><span class="p">,</span> <span class="n">accepted_pairs</span> <span class="o">+</span> <span class="n">rejected_pairs</span><span class="p">,</span> <span class="s1">&#39;expected:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span><span class="o">*</span><span class="mi">15</span><span class="o">*</span><span class="mi">15</span><span class="p">)</span>
</code></pre></div></div>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#9</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="n">Single</span><span class="w"> </span><span class="n">errors</span><span class="p">:</span><span class="w"> </span><span class="n">detected</span><span class="o">=</span><span class="w"> </span><span class="mi">68</span><span class="w"> </span><span class="n">accepted</span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">accepted</span><span class="w"> </span><span class="n">harmful</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">Double</span><span class="w"> </span><span class="n">errors</span><span class="p">:</span><span class="w"> </span><span class="n">accepted</span><span class="w"> </span><span class="n">harmful</span><span class="w"> </span><span class="n">pairs</span><span class="o">=</span><span class="w"> </span><span class="mi">144</span><span class="w"> </span><span class="n">accepted</span><span class="w"> </span><span class="n">pairs</span><span class="o">=</span><span class="w"> </span><span class="mi">282</span><span class="w"> </span><span class="n">rejected</span><span class="w"> </span><span class="n">pairs</span><span class="o">=</span><span class="w"> </span><span class="mi">1968</span>
<span class="n">Total</span><span class="w"> </span><span class="n">pairs</span><span class="w"> </span><span class="n">enumerated</span><span class="p">:</span><span class="w"> </span><span class="mi">2250</span><span class="w"> </span><span class="n">expected</span><span class="p">:</span><span class="w"> </span><span class="mi">2250</span>
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#10</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>

<span class="c1"># Precompute the list of 16 propagated error options per location: option 0 = identity (weight 1-p); options 1..15 = each two-qubit Pauli on that location propagated to end.</span>

<span class="c1"># Also store a vector indicating whether ancilla accepts and whether stabilizers accept and classification for each option; But acceptance/harmful classification depends only on net product, not individually.</span>
<span class="c1"># We&#39;ll use propagation: we need to multiply Paulis for selected options (non-identity) across 5 locations to get net P.</span>

<span class="c1"># Build error options per location</span>
<span class="n">error_options</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of lists length 16: [Pauli]</span>
<span class="k">for</span> <span class="n">loc_index</span><span class="p">,</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cnots</span><span class="p">):</span>
    <span class="n">gate_idx</span> <span class="o">=</span> <span class="n">cnots_gate_index</span><span class="p">[</span><span class="n">loc_index</span><span class="p">]</span>
    <span class="n">opts</span> <span class="o">=</span> <span class="p">[</span><span class="n">Pauli</span><span class="p">()]</span>  <span class="c1"># identity</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">lab</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span> <span class="ow">in</span> <span class="n">twoqubit_paulis</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">propagate_error_from_location</span><span class="p">(</span><span class="n">gate_idx</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span><span class="o">==</span><span class="mi">16</span>
    <span class="n">error_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>

<span class="c1"># Now enumerate all 16^5 patterns (1,048,576); compute A_k and H_k counts.</span>
<span class="n">A_k</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>
<span class="n">H_k</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>

<span class="c1"># We&#39;ll speed up by representing Pauli as (x,z) bit tuples; We&#39;ll implement multiplication using XOR; We&#39;ll circumvent phase.</span>

<span class="c1"># Convert Pauli to bit tuple for data &amp; ancilla x &amp; z</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pauli_bits</span><span class="p">(</span><span class="n">P</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>

<span class="c1"># Precompute bit pairs</span>
<span class="n">err_bits</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">opts</span> <span class="ow">in</span> <span class="n">error_options</span><span class="p">:</span>
    <span class="n">err_bits</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pauli_bits</span><span class="p">(</span><span class="n">P</span><span class="p">)</span> <span class="k">for</span> <span class="n">P</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">])</span>

<span class="c1"># Multiply two bit Paulis; ignoring phase</span>

<span class="k">def</span><span class="w"> </span><span class="nf">mul_bits</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">,</span><span class="n">az</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span> <span class="n">bx</span><span class="p">,</span><span class="n">bz</span> <span class="o">=</span> <span class="n">b</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="n">ai</span><span class="o">^</span><span class="n">bi</span> <span class="k">for</span> <span class="n">ai</span><span class="p">,</span><span class="n">bi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">bx</span><span class="p">)]),</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">ai</span><span class="o">^</span><span class="n">bi</span> <span class="k">for</span> <span class="n">ai</span><span class="p">,</span><span class="n">bi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">az</span><span class="p">,</span><span class="n">bz</span><span class="p">)]))</span>

<span class="c1"># Functions to build Pauli object from bits for classification/comms</span>

<span class="k">def</span><span class="w"> </span><span class="nf">bits_to_pauli</span><span class="p">(</span><span class="n">bits</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="n">z</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Pauli</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>

<span class="c1"># Acceptance tests on bits</span>

<span class="k">def</span><span class="w"> </span><span class="nf">ancilla_accepted_bits</span><span class="p">(</span><span class="n">bits</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">commutes_with_stabilizers_bits</span><span class="p">(</span><span class="n">bits</span><span class="p">):</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">bits_to_pauli</span><span class="p">(</span><span class="n">bits</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">P</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">S1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">P</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">S2</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">harmful_bits</span><span class="p">(</span><span class="n">bits</span><span class="p">):</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">bits_to_pauli</span><span class="p">(</span><span class="n">bits</span><span class="p">)</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="n">classify_logical_effect</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Not in normalizer; will be rejected anyway</span>
    <span class="k">return</span> <span class="p">(</span><span class="bp">cls</span><span class="p">[</span><span class="s1">&#39;xA&#39;</span><span class="p">]</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">cls</span><span class="p">[</span><span class="s1">&#39;xB&#39;</span><span class="p">]</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Enumerate patterns</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">idx0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="n">err_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">idx1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
        <span class="n">b01</span> <span class="o">=</span> <span class="n">mul_bits</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">err_bits</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">idx1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">idx2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
            <span class="n">b012</span> <span class="o">=</span> <span class="n">mul_bits</span><span class="p">(</span><span class="n">b01</span><span class="p">,</span> <span class="n">err_bits</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">idx2</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">idx3</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
                <span class="n">b0123</span> <span class="o">=</span> <span class="n">mul_bits</span><span class="p">(</span><span class="n">b012</span><span class="p">,</span> <span class="n">err_bits</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">idx3</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">idx4</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
                    <span class="n">bits</span> <span class="o">=</span> <span class="n">mul_bits</span><span class="p">(</span><span class="n">b0123</span><span class="p">,</span> <span class="n">err_bits</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">idx4</span><span class="p">])</span>
                    <span class="c1"># Determine k: number of non-identity selections</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx0</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">idx1</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">idx2</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">idx3</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">idx4</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="c1"># Acceptance</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ancilla_accepted_bits</span><span class="p">(</span><span class="n">bits</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">commutes_with_stabilizers_bits</span><span class="p">(</span><span class="n">bits</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">A_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">harmful_bits</span><span class="p">(</span><span class="n">bits</span><span class="p">):</span>
                        <span class="n">H_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A_k:&#39;</span><span class="p">,</span> <span class="n">A_k</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;H_k:&#39;</span><span class="p">,</span> <span class="n">H_k</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total accepted patterns counted:&#39;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">A_k</span><span class="p">))</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#11</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 10, in &lt;module&gt;
NameError: name &#39;cnots&#39; is not defined
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#12</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="c1"># Re-establish variables once more; combine everything in one cell and run enumeration</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">5</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Pauli</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
        <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">%</span> <span class="mi">4</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Pauli</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">)]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">z</span><span class="p">)]</span>
        <span class="n">inc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">inc</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">inc</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">other</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">inc</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>
        <span class="k">return</span> <span class="n">Pauli</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">m</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">commutes_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">^=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">other</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">^</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">conj_H</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="n">xq</span><span class="p">,</span> <span class="n">zq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">zq</span><span class="p">,</span> <span class="n">xq</span>
        <span class="k">if</span> <span class="n">xq</span> <span class="ow">and</span> <span class="n">zq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">conj_CNOT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">xc</span><span class="p">,</span> <span class="n">zc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="n">xt</span><span class="p">,</span> <span class="n">zt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">^=</span> <span class="n">zt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">^=</span> <span class="n">xc</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;I&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;X&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;Z&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;Y&#39;</span>
        <span class="k">return</span> <span class="n">s</span>

<span class="k">def</span><span class="w"> </span><span class="nf">single_pauli</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">label</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">;</span> <span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;X&#39;</span><span class="p">:</span>
        <span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">elif</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span>
        <span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">elif</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span>
        <span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="k">return</span> <span class="n">Pauli</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>

<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">twoqubit_paulis</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="n">out</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">la</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">lb</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">la</span><span class="o">==</span><span class="s1">&#39;I&#39;</span> <span class="ow">and</span> <span class="n">lb</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">single_pauli</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">la</span><span class="p">)</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">*</span> <span class="n">single_pauli</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">lb</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">la</span><span class="o">+</span><span class="n">lb</span><span class="p">,</span><span class="n">P</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">GATES</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>
<span class="n">cnots</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>
<span class="n">cnots_gate_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">GATES</span><span class="p">)</span> <span class="k">if</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;CNOT&#39;</span><span class="p">]</span>

<span class="n">S1</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">S2</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">X_A</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">X_B</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">Z_A</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">Z_B</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

<span class="n">BASIS</span> <span class="o">=</span> <span class="p">[</span><span class="n">S1</span><span class="p">,</span><span class="n">S2</span><span class="p">,</span><span class="n">X_A</span><span class="p">,</span><span class="n">X_B</span><span class="p">,</span><span class="n">Z_A</span><span class="p">,</span><span class="n">Z_B</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">propagate_error_from_location</span><span class="p">(</span><span class="n">l_index_zero_based</span><span class="p">,</span> <span class="n">error_P</span><span class="p">):</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">error_P</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l_index_zero_based</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">GATES</span><span class="p">)):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">GATES</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;H&#39;</span><span class="p">:</span>
            <span class="n">P</span><span class="o">.</span><span class="n">conj_H</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;CNOT&#39;</span><span class="p">:</span>
            <span class="n">P</span><span class="o">.</span><span class="n">conj_CNOT</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">g</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">P</span>


<span class="k">def</span><span class="w"> </span><span class="nf">commutes_with_stabilizers</span><span class="p">(</span><span class="n">P</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">P</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">S1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">P</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">S2</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">classify_logical_effect</span><span class="p">(</span><span class="n">P</span><span class="p">):</span>
    <span class="n">px</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">x</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">pz</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">z</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">s1</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">s2</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">xA_</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">xB_</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">zA_</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">zB_</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">Q</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">,[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">gen</span><span class="p">,</span><span class="n">exp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">BASIS</span><span class="p">,</span> <span class="p">[</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">xA_</span><span class="p">,</span><span class="n">xB_</span><span class="p">,</span><span class="n">zA_</span><span class="p">,</span><span class="n">zB_</span><span class="p">]):</span>
                                <span class="k">if</span> <span class="n">exp</span><span class="p">:</span>
                                    <span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">*</span> <span class="n">gen</span>
                            <span class="k">if</span> <span class="n">Q</span><span class="o">.</span><span class="n">x</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="n">px</span> <span class="ow">and</span> <span class="n">Q</span><span class="o">.</span><span class="n">z</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="n">pz</span><span class="p">:</span>
                                <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">s1</span><span class="o">=</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="o">=</span><span class="n">s2</span><span class="p">,</span><span class="n">xA</span><span class="o">=</span><span class="n">xA_</span><span class="p">,</span><span class="n">xB</span><span class="o">=</span><span class="n">xB_</span><span class="p">,</span><span class="n">zA</span><span class="o">=</span><span class="n">zA_</span><span class="p">,</span><span class="n">zB</span><span class="o">=</span><span class="n">zB_</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">ancilla_accepted</span><span class="p">(</span><span class="n">P</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">P</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span>

<span class="c1"># Precompute 16 error options per location (propagated to end)</span>
<span class="n">error_options</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">loc_index</span><span class="p">,</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cnots</span><span class="p">):</span>
    <span class="n">gate_idx</span> <span class="o">=</span> <span class="n">cnots_gate_index</span><span class="p">[</span><span class="n">loc_index</span><span class="p">]</span>
    <span class="n">opts</span> <span class="o">=</span> <span class="p">[</span><span class="n">Pauli</span><span class="p">()]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">lab</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span> <span class="ow">in</span> <span class="n">twoqubit_paulis</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">propagate_error_from_location</span><span class="p">(</span><span class="n">gate_idx</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">error_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>

<span class="c1"># Convert to bit tuples</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pauli_bits</span><span class="p">(</span><span class="n">P</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>

<span class="n">err_bits</span> <span class="o">=</span> <span class="p">[[</span><span class="n">pauli_bits</span><span class="p">(</span><span class="n">P</span><span class="p">)</span> <span class="k">for</span> <span class="n">P</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">]</span> <span class="k">for</span> <span class="n">opts</span> <span class="ow">in</span> <span class="n">error_options</span><span class="p">]</span>

<span class="c1"># Multiplication of bits</span>

<span class="k">def</span><span class="w"> </span><span class="nf">mul_bits</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">,</span><span class="n">az</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span> <span class="n">bx</span><span class="p">,</span><span class="n">bz</span> <span class="o">=</span> <span class="n">b</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="n">ai</span><span class="o">^</span><span class="n">bi</span> <span class="k">for</span> <span class="n">ai</span><span class="p">,</span><span class="n">bi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">bx</span><span class="p">)]),</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">ai</span><span class="o">^</span><span class="n">bi</span> <span class="k">for</span> <span class="n">ai</span><span class="p">,</span><span class="n">bi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">az</span><span class="p">,</span><span class="n">bz</span><span class="p">)]))</span>

<span class="c1"># Acceptance &amp; harm</span>

<span class="k">def</span><span class="w"> </span><span class="nf">ancilla_accepted_bits</span><span class="p">(</span><span class="n">bits</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">commutes_with_stabilizers_bits</span><span class="p">(</span><span class="n">bits</span><span class="p">):</span>
    <span class="c1"># Compute commutation with S1,S2 efficiently using bit dot products mod2</span>
    <span class="n">ax</span><span class="p">,</span><span class="n">az</span> <span class="o">=</span> <span class="n">bits</span>
    <span class="c1"># For commuting with XXXX: count qubits 0..3 where P has Z or Y =&gt; z_bit=1; parity must be even</span>
    <span class="c1"># Equivalent to sum_{q=0..3} az[q] mod 2 == 0</span>
    <span class="n">comm1</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">az</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># For commuting with ZZZZ: count qubits where P has X or Y =&gt; x_bit=1; parity even</span>
    <span class="n">comm2</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ax</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">comm1</span> <span class="ow">and</span> <span class="n">comm2</span>

<span class="c1"># For harmful classification using bits, we still need classify_logical_effect, but we can speed up with a small cache.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>

<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">harmful_bits_cached</span><span class="p">(</span><span class="n">bits</span><span class="p">):</span>
    <span class="c1"># bits is not hashable by default; convert to ints</span>
    <span class="n">ax</span><span class="p">,</span> <span class="n">az</span> <span class="o">=</span> <span class="n">bits</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ax</span><span class="p">);</span> <span class="n">az</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">az</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ax</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">az</span><span class="p">))</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="n">classify_logical_effect</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="p">(</span><span class="bp">cls</span><span class="p">[</span><span class="s1">&#39;xA&#39;</span><span class="p">]</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">cls</span><span class="p">[</span><span class="s1">&#39;xB&#39;</span><span class="p">]</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>

<span class="n">A_k</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>
<span class="n">H_k</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>

<span class="c1"># Enumerate all 16^5 patterns</span>
<span class="n">count</span><span class="o">=</span><span class="mi">0</span>
<span class="k">for</span> <span class="n">idx0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="n">err_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">idx1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
        <span class="n">b01</span> <span class="o">=</span> <span class="n">mul_bits</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">err_bits</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">idx1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">idx2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
            <span class="n">b012</span> <span class="o">=</span> <span class="n">mul_bits</span><span class="p">(</span><span class="n">b01</span><span class="p">,</span> <span class="n">err_bits</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">idx2</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">idx3</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
                <span class="n">b0123</span> <span class="o">=</span> <span class="n">mul_bits</span><span class="p">(</span><span class="n">b012</span><span class="p">,</span> <span class="n">err_bits</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">idx3</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">idx4</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
                    <span class="n">bits</span> <span class="o">=</span> <span class="n">mul_bits</span><span class="p">(</span><span class="n">b0123</span><span class="p">,</span> <span class="n">err_bits</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">idx4</span><span class="p">])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ancilla_accepted_bits</span><span class="p">(</span><span class="n">bits</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">commutes_with_stabilizers_bits</span><span class="p">(</span><span class="n">bits</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="c1"># count k</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx0</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">idx1</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">idx2</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">idx3</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">idx4</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">A_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">harmful_bits_cached</span><span class="p">((</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                        <span class="n">H_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A_k:&#39;</span><span class="p">,</span> <span class="n">A_k</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;H_k:&#39;</span><span class="p">,</span> <span class="n">H_k</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total accepted patterns counted:&#39;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">A_k</span><span class="p">),</span> <span class="s1">&#39;out of 16^5 =&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div></div>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#13</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>A_k: [1, 7, 282, 4222, 31637, 94923]
H_k: [0, 0, 144, 3024, 24240, 70896]
Total accepted patterns counted: 131072 out of 16^5 = 1048576
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#14</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>

<span class="n">A_k</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">282</span><span class="p">,</span> <span class="mi">4222</span><span class="p">,</span> <span class="mi">31637</span><span class="p">,</span> <span class="mi">94923</span><span class="p">]</span>
<span class="n">H_k</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">144</span><span class="p">,</span> <span class="mi">3024</span><span class="p">,</span> <span class="mi">24240</span><span class="p">,</span> <span class="mi">70896</span><span class="p">]</span>

<span class="c1"># Construct polynomials for numerator and denominator in terms of p, as Fractions for exactness.</span>
<span class="c1"># P_accept(p) = sum A_k * (1-p)^{5-k} * (p/15)^k</span>
<span class="c1"># P_harm(p)   = sum H_k * (1-p)^{5-k} * (p/15)^k</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">comb</span>

<span class="k">def</span><span class="w"> </span><span class="nf">poly_coeffs_from_weights</span><span class="p">(</span><span class="n">W</span><span class="p">):</span>
    <span class="c1"># Return list coeffs c0..c5 for polynomial in p up to degree 5 representing sum_k W_k (1-p)^{5-k} (p/15)^k</span>
    <span class="c1"># Expand (1-p)^{5-k} = sum_{m=0}^{5-k} comb(5-k, m) * (-p)^m</span>
    <span class="c1"># Then overall p-degree m+k. Coefficient accumulate accordingly.</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">W</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="o">-</span><span class="n">k</span><span class="p">):</span>
            <span class="n">deg</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="n">k</span>
            <span class="n">coeff</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="n">W</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">comb</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">m</span><span class="p">),</span> <span class="mi">15</span><span class="o">**</span><span class="n">k</span><span class="p">)</span>
            <span class="n">coeffs</span><span class="p">[</span><span class="n">deg</span><span class="p">]</span> <span class="o">+=</span> <span class="n">coeff</span>
    <span class="k">return</span> <span class="n">coeffs</span>

<span class="n">C_acc</span> <span class="o">=</span> <span class="n">poly_coeffs_from_weights</span><span class="p">(</span><span class="n">A_k</span><span class="p">)</span>
<span class="n">C_harm</span> <span class="o">=</span> <span class="n">poly_coeffs_from_weights</span><span class="p">(</span><span class="n">H_k</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;P_accept(p) coefficients (degree 0..5):&#39;</span><span class="p">,</span> <span class="n">C_acc</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;P_harm(p) coefficients (degree 0..5):&#39;</span><span class="p">,</span> <span class="n">C_harm</span><span class="p">)</span>

<span class="c1"># Optionally simplify to factored forms? Let&#39;s also print decimal approximations.</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;P_accept poly:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">C_acc</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;P_harm   poly:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">C_harm</span><span class="p">])</span>

<span class="c1"># Verify series expansion of F = 1 - P_harm/P_accept to order 5 using small p expansion.</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">P_acc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">C_acc</span><span class="p">))</span>
<span class="n">P_harm</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">C_harm</span><span class="p">))</span>
<span class="n">F</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">P_harm</span> <span class="o">/</span> <span class="n">P_acc</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F(p) simplified rational expression:&#39;</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">together</span><span class="p">(</span><span class="n">F</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Series expansion:&#39;</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#15</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="nx">P_accept</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span><span class="w"> </span><span class="nx">coefficients</span><span class="w"> </span><span class="p">(</span><span class="nx">degree</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="m m-Double">.5</span><span class="p">):</span><span class="w"> </span><span class="p">[</span><span class="nx">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="nx">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">68</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">),</span><span class="w"> </span><span class="nx">Fraction</span><span class="p">(</span><span class="mi">704</span><span class="p">,</span><span class="w"> </span><span class="mi">75</span><span class="p">),</span><span class="w"> </span><span class="nx">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">,</span><span class="w"> </span><span class="mi">3375</span><span class="p">),</span><span class="w"> </span><span class="nx">Fraction</span><span class="p">(</span><span class="mi">253952</span><span class="p">,</span><span class="w"> </span><span class="mi">50625</span><span class="p">),</span><span class="w"> </span><span class="nx">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">262144</span><span class="p">,</span><span class="w"> </span><span class="mi">253125</span><span class="p">)]</span>
<span class="nx">P_harm</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span><span class="w"> </span><span class="nx">coefficients</span><span class="w"> </span><span class="p">(</span><span class="nx">degree</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="m m-Double">.5</span><span class="p">):</span><span class="w"> </span><span class="p">[</span><span class="nx">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="nx">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="nx">Fraction</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">),</span><span class="w"> </span><span class="nx">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">125</span><span class="p">),</span><span class="w"> </span><span class="nx">Fraction</span><span class="p">(</span><span class="mi">2048</span><span class="p">,</span><span class="w"> </span><span class="mi">3375</span><span class="p">),</span><span class="w"> </span><span class="nx">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">,</span><span class="w"> </span><span class="mi">253125</span><span class="p">)]</span>
<span class="nx">P_accept</span><span class="w"> </span><span class="nx">poly</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="m m-Double">1.0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="m m-Double">4.533333333333333</span><span class="p">,</span><span class="w"> </span><span class="m m-Double">9.386666666666667</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="m m-Double">9.709037037037037</span><span class="p">,</span><span class="w"> </span><span class="m m-Double">5.016335802469136</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="m m-Double">1.0356306172839507</span><span class="p">]</span>
<span class="nx">P_harm</span><span class="w">   </span><span class="nx">poly</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="m m-Double">0.0</span><span class="p">,</span><span class="w"> </span><span class="m m-Double">0.0</span><span class="p">,</span><span class="w"> </span><span class="m m-Double">0.64</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="m m-Double">1.024</span><span class="p">,</span><span class="w"> </span><span class="m m-Double">0.6068148148148148</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="m m-Double">0.12945382716049383</span><span class="p">]</span>
<span class="nx">F</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span><span class="w"> </span><span class="nx">simplified</span><span class="w"> </span><span class="nx">rational</span><span class="w"> </span><span class="nx">expression</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="mi">262144</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1269760</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2457600</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">16</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">2048</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">9600</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16200</span><span class="o">*</span><span class="nx">p</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10125</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2376000</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1147500</span><span class="o">*</span><span class="nx">p</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">253125</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">262144</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1269760</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2457600</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2376000</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1147500</span><span class="o">*</span><span class="nx">p</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">253125</span><span class="p">)</span>
<span class="nx">Series</span><span class="w"> </span><span class="nx">expansion</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">16</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">25</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">704</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">375</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10496</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">4</span><span class="o">/</span><span class="mi">3375</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">216064</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">5</span><span class="o">/</span><span class="mi">84375</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">O</span><span class="p">(</span><span class="nx">p</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span>
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#16</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>
<span class="n">p</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
<span class="n">P_acc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">68</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">704</span><span class="p">,</span><span class="mi">75</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">,</span><span class="mi">3375</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">253952</span><span class="p">,</span><span class="mi">50625</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">262144</span><span class="p">,</span><span class="mi">253125</span><span class="p">)])</span> <span class="p">)</span>
<span class="n">P_harm</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">25</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">128</span><span class="p">,</span><span class="mi">125</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">2048</span><span class="p">,</span><span class="mi">3375</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">,</span><span class="mi">253125</span><span class="p">)])</span> <span class="p">)</span>
<span class="n">F</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">P_harm</span><span class="o">/</span><span class="n">P_acc</span><span class="p">)</span>
<span class="n">num</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">together</span><span class="p">(</span><span class="n">F</span><span class="p">)</span><span class="o">.</span><span class="n">as_numer_denom</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">den</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">together</span><span class="p">(</span><span class="n">F</span><span class="p">)</span><span class="o">.</span><span class="n">as_numer_denom</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Numerator expanded:&#39;</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Denominator expanded:&#39;</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">den</span><span class="p">))</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#17</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 3, in &lt;module&gt;
NameError: name &#39;Fraction&#39; is not defined
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#18</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>
<span class="n">p</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
<span class="n">P_acc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">68</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">704</span><span class="p">,</span><span class="mi">75</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">,</span><span class="mi">3375</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">253952</span><span class="p">,</span><span class="mi">50625</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">262144</span><span class="p">,</span><span class="mi">253125</span><span class="p">)])</span> <span class="p">)</span>
<span class="n">P_harm</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">25</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">128</span><span class="p">,</span><span class="mi">125</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">2048</span><span class="p">,</span><span class="mi">3375</span><span class="p">),</span> <span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">,</span><span class="mi">253125</span><span class="p">)])</span> <span class="p">)</span>
<span class="n">F</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">P_harm</span><span class="o">/</span><span class="n">P_acc</span><span class="p">)</span>
<span class="n">num</span><span class="p">,</span> <span class="n">den</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">together</span><span class="p">(</span><span class="n">F</span><span class="p">)</span><span class="o">.</span><span class="n">as_numer_denom</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Numerator expanded:&#39;</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Denominator expanded:&#39;</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">den</span><span class="p">))</span>
</code></pre></div></div>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#19</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>Numerator expanded: 229376*p**5 - 1116160*p**4 + 2198400*p**3 - 2214000*p**2 + 1147500*p - 253125
Denominator expanded: 262144*p**5 - 1269760*p**4 + 2457600*p**3 - 2376000*p**2 + 1147500*p - 253125
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#20</span>
    </div>
    <div class="content markdown-body"><p>1) Step-by-Step Derivation</p>
<p>Setup, notation, and what must be computed
- Physical data-qubit labels: 0,1,2,3. Ancilla: 4.
- [[4,2,2]] stabilizers: S = âŸ¨XXXX, ZZZZâŸ© on qubits 0â€“3. Logical Paulis (as given, up to stabilizers):
  X_A = X I X I, X_B = X X I I, Z_A = Z Z I I, Z_B = Z I Z I.
- Circuit (right-to-left execution): H1 â†’ CNOT12 â†’ CNOT10 â†’ CNOT23 â†’ CNOT34 â†’ CNOT04 â†’ measure Z4.
- Noise model: after each CNOTij, a two-qubit depolarizing channel acts on (i,j), i.e., it applies one of the 15 non-identity twoâ€‘qubit Paulis uniformly with probability p/15 and identity with probability 1âˆ’p. This is the standard two-qubit depolarizing model specialized to uniform sampling over the 15 non-identity two-qubit Paulis. (<a href="https://en.wikipedia.org/wiki/Quantum_depolarizing_channel?utm_source=openai">en.wikipedia.org</a>, <a href="https://algassert.com/post/2001?utm_source=openai">algassert.com</a>)
- Post-selection: keep only runs in which (i) the ancilla measurement yields 0 (i.e., no X or Y acting on qubit 4 at measurement time), and (ii) the data-qubit state lies in the code space (i.e., the final error commutes with XXXX and ZZZZ, so both stabilizers would report +1). This uses the fact that for a Z-basis measurement, an X or Y on the measured qubit flips the outcome, whereas I or Z does not. (<a href="https://en.wikipedia.org/wiki/Clifford_gate?utm_source=openai">en.wikipedia.org</a>)</p>
<p>Clifford propagation of Pauli faults
- The circuit is Clifford (H and CNOT only), so any Pauli error inserted at some point in the circuit propagates (by conjugation) to a Pauli at the end. Conjugation rules we use:
  H X H = Z, H Z H = X, H Y H = âˆ’Y; and for CNOTcâ†’t,
  Xc â†¦ XcXt, Zc â†¦ Zc, Xt â†¦ Xt, Zt â†¦ ZcZt. (<a href="https://en.wikipedia.org/wiki/Clifford_gate?utm_source=openai">en.wikipedia.org</a>)
- Therefore, to analyze acceptance and logical effect we may:
  (a) insert a Pauli fault immediately after a given CNOT,
  (b) propagate it through the remaining gates by the above rules,
  (c) test acceptance conditions, and
  (d) for accepted cases, classify its logical action modulo the stabilizer.</p>
<p>Acceptance and logical classification criteria
- Let Eend be the net Pauli on qubits 0â€“4 at the end (just before measuring Z4).
  1) Ancilla acceptance: require no X or Y on qubit 4, i.e., the X-component on qubit 4 must be 0 so that measuring Z4 yields the same outcome as in the noiseless circuit. (Equivalently, Eend must commute with Z4.) (<a href="https://en.wikipedia.org/wiki/Clifford_gate?utm_source=openai">en.wikipedia.org</a>)
  2) Code-space acceptance: require Eend|data commutes with XXXX and ZZZZ. (Otherwise stabilizer measurement would detect the error and we discard the run.)
- For accepted runs, write the data part of Eend as
  Eend|data = S1s1 S2s2 X_AxA X_BxB Z_AzA Z_BzB
  with s1,s2,xA,xB,zA,zB âˆˆ {0,1}. Any such operator is in the normalizer of the stabilizer group S. Logical action on the two logical qubits is determined by xA,xB and zA,zB. Since the target logical state is |00âŸ©AB, logical Z errors leave it invariant (Z|0âŸ©=|0âŸ©), while X or Y (= iXZ) flips the logical bit(s). Hence â€œharmfulâ€ means xA=1 or xB=1; â€œharmlessâ€ means xA=xB=0 (regardless of zA,zB and stabilizers). This is standard stabilizer-code logic. For the [[4,2,2]] code with XXXX and ZZZZ, many equivalent logical operator choices exist; the ones used here match common conventions up to stabilizers. (<a href="https://studylib.net/doc/11564746/quantum-computing-with-realistically-noisy-devices?utm_source=openai">studylib.net</a>, <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC4421819/?utm_source=openai">pmc.ncbi.nlm.nih.gov</a>)</p>
<p>Counting accepted and harmful patterns by exact enumeration
- There are 5 noisy CNOTs. At each such location â„“ we choose one of 16 possibilities: identity (prob. 1âˆ’p) or one of 15 two-qubit Paulis (prob. p/15).
- Because all gates are Clifford, we can propagate each of the 16 possibilities at each location to the end and multiply them (modulo phases) to get Eend for any of the 16^5 patterns. We then:
  (i) check acceptance (ancilla Z measurement not flipped and [Eend|data,XXXX]=[Eend|data,ZZZZ]=0),
  (ii) tag the pattern as harmful if xA=1 or xB=1 in the decomposition above.
- Let A_k be the number of accepted patterns with exactly k non-identity insertions; H_k the number of harmful patterns among those.
- A direct stabilizer/Clifford enumeration (using the above propagation and commutation tests) yields the exact integers:
  A0=1, A1=7, A2=282, A3=4222, A4=31637, A5=94923,
  H0=0, H1=0, H2=144, H3=3024, H4=24240, H5=70896.
  These counts are unique to the specified circuit, error model, and post-selection rules.
- From these counts we form the acceptance and harmful probabilities as polynomials in p:
  Pacc(p) = âˆ‘<em>{k=0}^5 A_k (1âˆ’p)^{5âˆ’k} (p/15)^k,
  Pharm(p) = âˆ‘</em>{k=0}^5 H_k (1âˆ’p)^{5âˆ’k} (p/15)^k.
  The desired conditional logical state fidelity is
  F(p) = 1 âˆ’ Pharm(p)/Pacc(p).</p>
<p>Closed-form polynomials
- Expanding the above sums gives
  Pacc(p) = 1 âˆ’ 68 p/15 + 704 p^2/75 âˆ’ 32768 p^3/3375 + 253952 p^4/50625 âˆ’ 262144 p^5/253125,
  Pharm(p) = 16 p^2/25 âˆ’ 128 p^3/125 + 2048 p^4/3375 âˆ’ 32768 p^5/253125.
- Therefore the exact conditional fidelity is the rational function
  F(p) = 1 âˆ’ Pharm(p)/Pacc(p)
       = (229376 p^5 âˆ’ 1116160 p^4 + 2198400 p^3 âˆ’ 2214000 p^2 + 1147500 p âˆ’ 253125)
         /(262144 p^5 âˆ’ 1269760 p^4 + 2457600 p^3 âˆ’ 2376000 p^2 + 1147500 p âˆ’ 253125).
- Smallâ€‘p series (from the exact rational function):
  F(p) = 1 âˆ’ (16/25) p^2 âˆ’ (704/375) p^3 âˆ’ (10496/3375) p^4 âˆ’ (216064/84375) p^5 + O(p^6).
  In particular, all singleâ€‘gate faults are either detected or harmless, so the leading degradation is O(p^2). The O(p^2) coefficient equals 144/225 = 16/25, consistent with counting the 144 acceptedâ€‘harmful twoâ€‘fault patterns out of 10Ã—15^2=2250 twoâ€‘fault possibilities.</p>
<p>Remarks on conventions and sources
- The stabilizers XXXX and ZZZZ and the fact that [[4,2,2]] encodes two logical qubits are standard; specific logical-operator representatives vary up to stabilizers and qubit relabelings. Our chosen set matches the problem statement and is consistent with common C4/C6 conventions. (<a href="https://studylib.net/doc/11564746/quantum-computing-with-realistically-noisy-devices?utm_source=openai">studylib.net</a>, <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC4421819/?utm_source=openai">pmc.ncbi.nlm.nih.gov</a>)
- Pauli propagation rules through H and CNOT (used above) are standard Clifford conjugation identities. (<a href="https://en.wikipedia.org/wiki/Clifford_gate?utm_source=openai">en.wikipedia.org</a>)
- The twoâ€‘qubit depolarizing assumption â€œone of 15 nonâ€‘identity twoâ€‘qubit Paulis with probability p/15â€ is a standard parameterization. (<a href="https://en.wikipedia.org/wiki/Quantum_depolarizing_channel?utm_source=openai">en.wikipedia.org</a>)</p>
<p>2) Mathematical Typesetting</p>
<p>See equations above. All expressions are given in LaTeX-ready form.</p>
<p>3) Conventions and Units</p>
<ul>
<li>No physical units are involved. The error probability p is per twoâ€‘qubit gate.</li>
</ul>
<p>4) Final Answer:
Let Pacc(p) and Pharm(p) be
Pacc(p) = 1 âˆ’ 68 p/15 + 704 p^2/75 âˆ’ 32768 p^3/3375 + 253952 p^4/50625 âˆ’ 262144 p^5/253125,
Pharm(p) = 16 p^2/25 âˆ’ 128 p^3/125 + 2048 p^4/3375 âˆ’ 32768 p^5/253125.</p>
<p>Then the postâ€‘selected logical state fidelity is
F(p) = 1 âˆ’ Pharm(p)/Pacc(p)
     = (229376 p^5 âˆ’ 1116160 p^4 + 2198400 p^3 âˆ’ 2214000 p^2 + 1147500 p âˆ’ 253125)
       /(262144 p^5 âˆ’ 1269760 p^4 + 2457600 p^3 âˆ’ 2376000 p^2 + 1147500 p âˆ’ 253125).</p>
<p>For small p,
F(p) = 1 âˆ’ (16/25) p^2 âˆ’ (704/375) p^3 âˆ’ (10496/3375) p^4 âˆ’ (216064/84375) p^5 + O(p^6).</p>
<p>Citations
- Clifford conjugation rules (H, CNOT) and measurement behavior under Paulis. (<a href="https://en.wikipedia.org/wiki/Clifford_gate?utm_source=openai">en.wikipedia.org</a>)
- Two-qubit depolarizing channel (uniform over the 15 non-identity Paulis). (<a href="https://en.wikipedia.org/wiki/Quantum_depolarizing_channel?utm_source=openai">en.wikipedia.org</a>)
- [[4,2,2]] (C4) code with stabilizers XXXX and ZZZZ; logical conventions differ up to stabilizers. (<a href="https://studylib.net/doc/11564746/quantum-computing-with-realistically-noisy-devices?utm_source=openai">studylib.net</a>, <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC4421819/?utm_source=openai">pmc.ncbi.nlm.nih.gov</a>)</p></div>
</article>


<article class="message role-user">
    <div class="meta">
        <span class="badge">User</span>
        <span class="idx">#21</span>
    </div>
    <div class="content markdown-body"><p>Populate your final answer into the code template provided below. This step is purely for formatting/display purposes. No additional reasoning or derivation should be performed. Do not import any modules or packages beyond what is provided in the template.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">answer</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the expression of the logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    at the end of the circuit as a function of two-qubit gate error rate $p$.</span>

<span class="sd">    Inputs</span>
<span class="sd">    ----------</span>
<span class="sd">    p: sympy.Symbol, two-qubit gate error rate, $p$</span>

<span class="sd">    Outputs</span>
<span class="sd">    ----------</span>
<span class="sd">    F_logical: sympy.Expr, logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------ FILL IN YOUR RESULTS BELOW ------------------</span>
    <span class="n">F_logical</span> <span class="o">=</span> <span class="o">...</span>  <span class="c1"># a SymPy expression of inputs</span>
    <span class="c1"># ---------------------------------------------------------------</span>

    <span class="k">return</span> <span class="n">F_logical</span>
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#22</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">answer</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the expression of the logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    at the end of the circuit as a function of two-qubit gate error rate $p$.</span>

<span class="sd">    Inputs</span>
<span class="sd">    ----------</span>
<span class="sd">    p: sympy.Symbol, two-qubit gate error rate, $p$</span>

<span class="sd">    Outputs</span>
<span class="sd">    ----------</span>
<span class="sd">    F_logical: sympy.Expr, logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------ FILL IN YOUR RESULTS BELOW ------------------</span>
    <span class="n">F_logical</span> <span class="o">=</span> <span class="p">(</span><span class="mi">229376</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">5</span> <span class="o">-</span> <span class="mi">1116160</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">2198400</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">2214000</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1147500</span><span class="o">*</span><span class="n">p</span> <span class="o">-</span> <span class="mi">253125</span><span class="p">)</span> <span class="o">/</span> \
                <span class="p">(</span><span class="mi">262144</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">5</span> <span class="o">-</span> <span class="mi">1269760</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">2457600</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">2376000</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1147500</span><span class="o">*</span><span class="n">p</span> <span class="o">-</span> <span class="mi">253125</span><span class="p">)</span>
    <span class="c1"># ---------------------------------------------------------------</span>

    <span class="k">return</span> <span class="n">F_logical</span>
</code></pre></div></div>
</article>

</div>

<footer>
  Generated at 2025-09-24T22:02:10.650567
</footer>

<script>
(function() {
  // Tabs
  const tabs = document.querySelectorAll('.tab');
  const panels = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      panels.forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      const target = document.querySelector(tab.dataset.target);
      if (target) target.classList.add('active');
    });
  });

  // Theme toggle
  const toggleBtn = document.getElementById('theme-toggle');
  function setTheme(dark) {
    if (dark) {
      document.documentElement.classList.add('dark');
      localStorage.setItem('dark', '1');
    } else {
      document.documentElement.classList.remove('dark');
      localStorage.setItem('dark', '0');
    }
  }
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const stored = localStorage.getItem('dark');
  setTheme(stored === null ? prefersDark : stored === '1');

  toggleBtn.addEventListener('click', () => {
    const isDark = document.documentElement.classList.contains('dark');
    setTheme(!isDark);
  });
})();
</script>
</body>
</html>