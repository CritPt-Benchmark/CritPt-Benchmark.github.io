<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Checkpoint-3</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.codehilite .hll { background-color: #ffffcc }
.codehilite { background: #f8f8f8; }
.codehilite .c { color: #3D7B7B; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #F00 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666 } /* Operator */
.codehilite .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #9C6500 } /* Comment.Preproc */
.codehilite .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.codehilite .gr { color: #E40000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #008400 } /* Generic.Inserted */
.codehilite .go { color: #717171 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #04D } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #687822 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #00F; font-weight: bold } /* Name.Class */
.codehilite .no { color: #800 } /* Name.Constant */
.codehilite .nd { color: #A2F } /* Name.Decorator */
.codehilite .ni { color: #717171; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #00F } /* Name.Function */
.codehilite .nl { color: #767600 } /* Name.Label */
.codehilite .nn { color: #00F; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #A2F; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #BBB } /* Text.Whitespace */
.codehilite .mb { color: #666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666 } /* Literal.Number.Float */
.codehilite .mh { color: #666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666 } /* Literal.Number.Oct */
.codehilite .sa { color: #BA2121 } /* Literal.String.Affix */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .dl { color: #BA2121 } /* Literal.String.Delimiter */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #A45A77 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #00F } /* Name.Function.Magic */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .vm { color: #19177C } /* Name.Variable.Magic */
.codehilite .il { color: #666 } /* Literal.Number.Integer.Long */

</style>
<style>
    :root {
  --bg: #ffffff;
  --fg: #222222;
  --muted: #555555;
  --border: #e0e0e0;
  --accent: #005fcc;
  --code-bg: #f6f8fa;
  --role-user: #0ea5e9;
  --role-assistant: #22c55e;
  --role-system: #9ca3af;
  --return-code: #a35291;
}
html.dark {
  --bg: #0b0b0b;
  --fg: #e8e8e8;
  --muted: #a0a0a0;
  --border: #333333;
  --accent: #3b82f6;
  --code-bg: #111827;
  --role-user: #0ea5e9;
  --role-assistant: #22c55e;
  --role-system: #9ca3af;
  --return-code: #a35291;
}
* {
  box-sizing: border-box;
}
body {
  margin: 0;
  padding: 0;
  background: var(--bg);
  color: var(--fg);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", sans-serif;
  line-height: 1.6;
}
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 1.25rem;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  background: var(--bg);
  z-index: 10;
}
h1 {
  margin: 0;
  font-size: 1.1rem;
}
.tabs {
  display: flex;
  gap: 0.5rem;
}
.tab {
  padding: 0.4rem 0.8rem;
  border: 1px solid var(--border);
  border-bottom: none;
  background: transparent;
  cursor: pointer;
  border-radius: 6px 6px 0 0;
  color: var(--fg);
}
.tab.active {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}
.tab-content {
  display: none;
  padding: 1rem 1.25rem;
  border-top: 1px solid var(--border);
}
.tab-content.active {
  display: block;
}
#theme-toggle {
  border: 1px solid var(--border);
  padding: 0.2rem 0.6rem;
  font-size: 0.9rem;
  border-radius: 4px;
  cursor: pointer;
  background: transparent;
  color: var(--fg);
}
.main {
  max-width: 1200px;
  margin: 0 auto;
}
.message {
  border: 1px solid var(--border);
  border-left-width: 6px;
  border-radius: 6px;
  padding: 0.8rem 1rem;
  margin-bottom: 1rem;
  background: rgba(0,0,0,0.02);
}
.message .meta {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  margin-bottom: 0.6rem;
  color: var(--muted);
  font-size: 0.85rem;
}
.message .badge {
  font-weight: 600;
}
.role-user {
  border-left-color: var(--role-user);
}
.role-assistant {
  border-left-color: var(--role-assistant);
}
.role-system {
  border-left-color: var(--role-system);
}
.role-unknown {
  border-left-color: var(--accent);
}

.output-code-container {
  display: flex;
  gap: 1rem;               /* space between children */
  align-items: center;     /* vertical alignment */
  justify-content: start;  /* horizontal alignment */
}

.output-code-container .codeblock {
  flex: 0 1 auto;
}

.codeblock {
  border: 1px solid var(--border);
  border-left-width: 6px;
  border-radius: 6px;
  padding: 0.8rem 1rem;
  margin-bottom: 1rem;
  background: rgba(0,0,0,0.02);
}
.codeblock-content {
  margin-bottom: 0.6rem;
  border: 1px dashed var(--border);
  border-radius: 4px;
  padding: 0.4rem 0.6rem;
  background: rgba(0,0,0,0.02);
}

.codeblock.eval_code {
  border-left-color: var(--role-user);
}
.codeblock.target_code {
  border-left-color: var(--role-assistant);
}
.codeblock.output_code {
  border-left-color: var(--role-system);
}

html.dark .codeblock-content {
  background: rgba(255,255,255,0.03);
}
.codeblock > summary {
  cursor: pointer;
  font-weight: 600;
  list-style: none; /* remove default triangle in some browsers */
}
.codeblock > summary::-webkit-details-marker {
  display: none; /* Safari/Chrome marker */
}
.codeblock > summary::before {
  content: "‚ñ∂ ";
  display: inline-block;
  transform: rotate(0deg);
  transition: transform 0.12s ease-out;
}
.codeblock[open] > summary::before {
  transform: rotate(90deg);
}
.codeblock .tag {
  color: var(--muted);
  font-weight: 400;
  font-size: 0.85em;
  margin-left: 0.25rem;
}

.markdown-body pre code {
  background: var(--code-bg);
  display: block;
  padding: 0.75rem;
  overflow-x: auto;
  border-radius: 4px;
  border: 1px solid var(--border);
}
.markdown-body code {
  background: var(--code-bg);
  padding: 0.15rem 0.3rem;
  border-radius: 4px;
}
/* Extra info tree */
details > summary {
  cursor: pointer;
  font-weight: 600;
}
details .block {
  padding-left: 1rem;
  margin: 0.25rem 0 0.5rem 0;
  border-left: 2px solid var(--border);
}
.kv .key {
  font-weight: 600;
}
.kv .type {
  color: var(--muted);
  margin-left: 0.5rem;
  font-size: 0.85rem;
}
footer {
  margin: 2rem 0;
  text-align: center;
  color: var(--muted);
  font-size: 0.85rem;
}
/* CodeHilite (pygments) overrides to respect theme vars */
.codehilite {
  background: var(--code-bg) !important;
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 0.75rem !important;
}
.reasoning {
  margin-bottom: 0.6rem;
  border: 1px dashed var(--border);
  border-radius: 4px;
  padding: 0.4rem 0.6rem;
  background: rgba(0,0,0,0.02);
}
html.dark .reasoning {
  background: rgba(255,255,255,0.03);
}
.reasoning > summary {
  cursor: pointer;
  font-weight: 600;
  list-style: none; /* remove default triangle in some browsers */
}
.reasoning > summary::-webkit-details-marker {
  display: none; /* Safari/Chrome marker */
}
.reasoning > summary::before {
  content: "‚ñ∂ ";
  display: inline-block;
  transform: rotate(0deg);
  transition: transform 0.12s ease-out;
}
.reasoning[open] > summary::before {
  transform: rotate(90deg);
}
.reasoning .tag {
  color: var(--muted);
  font-weight: 400;
  font-size: 0.85em;
  margin-left: 0.25rem;
}
.reasoning-body {
  margin-top: 0.5rem;
}
</style>

<!-- ===== MATHJAX CONFIG ===== -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [ ["\\(","\\)"] ],
    displayMath: [ ["\\[","\\]"] ],
    processEscapes: true,
    processEnvironments: true
  },
  options: {
    ignoreHtmlClass: ".*",
    processHtmlClass: "arithmatex"

    // skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
    // if you dynamically add content later, you can call MathJax.typesetPromise()
  }
};
</script>
<script id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<!-- ========================== -->
</head>
<body>
<header>
  <h1>Checkpoint-3</h1>
  <div>
    <button id="theme-toggle" aria-label="toggle dark mode">üåì</button>
  </div>
</header>

<div class="main">
  
<article class="message role-system">
    <div class="meta">
        <span class="badge">System</span>
        <span class="idx">#0</span>
    </div>
    <div class="content markdown-body"><p>You are a physics research assistant specializing in solving complex, research-level problems using precise, step-by-step reasoning.</p>
<p><strong>Input</strong>
Problems will be provided in Markdown format.</p>
<p><strong>Output (Markdown format)</strong></p>
<ol>
<li><strong>Step-by-Step Derivation</strong> - Show every non-trivial step in the solution.  Justify steps using relevant physical laws, theorems, mathematical identities or numerical codes.</li>
<li><strong>Mathematical Typesetting</strong> - Use LaTeX for all mathematics:  <code>$...$</code> for inline expressions, <code>$$...$$</code> for display equations.</li>
<li><strong>Conventions and Units</strong> - Follow the unit system and conventions specified in the problem.</li>
<li>
<p><strong>Final Answer</strong> - At the end of the solution,  start a new line with <strong>&ldquo;Final Answer:&rdquo;</strong>, and present the final result.</p>
<p>For final answers involving values, follow the precision requirements specified in the problem.
If no precision is specified:
- If an exact value is possible, provide it (e.g., \$\sqrt(2)\$, \$\pi/4\$).
- If exact form is not feasible, retain at least 12 significant digits in the result. </p>
</li>
<li>
<p><strong>Formatting Compliance</strong> - If the user requests a specific output format (e.g., code, table),  provide the final answer accordingly.
You must use web search engine to gather all the necessary information before solving the problem.
You must use web search engine to gather all the necessary information before solving the problem.
You must use web search engine to gather all the necessary information before solving the problem.</p>
</li>
</ol></div>
</article>


<article class="message role-user">
    <div class="meta">
        <span class="badge">User</span>
        <span class="idx">#1</span>
    </div>
    <div class="content markdown-body"><h1 id="problem-setup">Problem setup:</h1>
<p>In quantum error correction, you encode quantum states into logical states made of many qubits in order to improve their resilience to errors. In quantum error detection, you do the same but can only detect the presence of errors and not correct them. In this problem, we will consider a single [[4,2,2]] quantum error detection code, which encodes two logical qubits into four physical qubits, and investigate how robust logical quantum operations in this code are to quantum errors.</p>
<p>Our convention is that the four physical qubits in the [[4,2,2]] code are labelled 0,1,2,3. The two logical qubits are labelled A and B. The stabilizers are <span class="arithmatex">\(XXXX\)</span> and <span class="arithmatex">\(ZZZZ\)</span>, where <span class="arithmatex">\(X\)</span> and <span class="arithmatex">\(Z\)</span> are Pauli matrices. The logical <span class="arithmatex">\(X\)</span> and <span class="arithmatex">\(Z\)</span> operators on the two qubits are <span class="arithmatex">\(X_A = XIXI\)</span>, <span class="arithmatex">\(X_B=XXII\)</span>, <span class="arithmatex">\(Z_A = ZZII\)</span>, <span class="arithmatex">\(Z_B = ZIZI\)</span>, up to multiplication by stabilizers.</p>
<p>We will consider different state preparation circuits consisting of controlled not <span class="arithmatex">\(CNOT_{ij}\)</span> gates, where <span class="arithmatex">\(CNOT_{ij}\)</span> has control qubit <span class="arithmatex">\(i\)</span> and target qubit <span class="arithmatex">\(j\)</span>. As a simple model of quantum errors in hardware, we will suppose that each <span class="arithmatex">\(CNOT_{ij}\)</span> gate in the circuit has a two qubit depolarizing error channel following it that produces one of the 15 non-identity two-qubit Paulis with equal probability <span class="arithmatex">\(p/15\)</span>. The probability <span class="arithmatex">\(p\)</span> indicates the probability of an error in a single two-qubit gate. We will assess the logical infidelity of certain state preparation protocols as a function of the physical infidelity <span class="arithmatex">\(p\)</span>.</p>
<h1 id="subproblems">Checkpoints</h1>
<h2 id="subproblem-1">Checkpoint 1</h2>
<p>Suppose that we wish to prepare a logical two-qubit GHZ state  <span class="arithmatex">\((|00\rangle_{AB}+|11\rangle_{AB})/\sqrt{2}\)</span> in the [[4,2,2]] code. To do so, we use the following state preparation circuit:</p>
<div class="arithmatex">\[
(CNOT_{03}) (H_0) (CNOT_{21}) (H_2).
\]</div>
<p>Note that this equation is written in matrix multiplication order, while the quantum operations in the circuit occur in the reverse order (from right-to-left in the above equation). <span class="arithmatex">\(H\)</span> is a single-qubit Hadamard gate.</p>
<p>What is the physical state fidelity of the final physical 4-qubit state at the end of the circuit as a function of the two-qubit gate error rate <span class="arithmatex">\(p\)</span>?</p></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#2</span>
    </div>
    <div class="content markdown-body"><p>1) Step-by-Step Derivation</p>
<ul>
<li>Ideal state prepared by the circuit (no noise)</li>
<li>Start from |0000‚ü© on physical qubits 0,1,2,3.</li>
<li>The subcircuit H2 then CNOT21 prepares a Bell state on the pair (2,1): H on the control followed by CNOT maps |00‚ü© ‚Üí |Œ¶+‚ü© = (|00‚ü©+|11‚ü©)/‚àö2. Hence qubits (2,1) are in |Œ¶+‚ü©21. The subsequent gates act on other qubits, so this entanglement is unaffected. (<a href="https://en.wikipedia.org/wiki/Quantum_logic_gate?utm_source=openai">en.wikipedia.org</a>)</li>
<li>The subcircuit H0 then CNOT03 prepares a Bell state on the pair (0,3), giving |Œ¶+‚ü©03. (<a href="https://en.wikipedia.org/wiki/Quantum_logic_gate?utm_source=openai">en.wikipedia.org</a>)</li>
<li>Therefore, the ideal 4-qubit output state is the product of two Bell pairs:</li>
</ul>
<div class="arithmatex">\[
|\psi_{\mathrm{ideal}}\rangle = |\Phi^+\rangle_{21}\otimes|\Phi^+\rangle_{03}.
\]</div>
<ul>
<li>Noise model applied</li>
<li>After each CNOTij, a 2-qubit depolarizing Pauli channel acts on that pair: with probability 1‚àíp do nothing; with probability p choose uniformly one of the 15 non-identity 2-qubit Paulis P‚àà{IX,IY,IZ, ‚Ä¶ , ZZ} and apply P (probability p/15 for each). This is the standard ‚Äúuniform Pauli‚Äù description (the 16 two-qubit Paulis are II plus the 15 non-identity strings). (<a href="https://qiskit.github.io/qiskit-aer/stubs/qiskit_aer.noise.depolarizing_error.html">qiskit.github.io</a>, <a href="https://qiskit.qotlabs.org/docs/api/qiskit/2.0/qiskit.quantum_info.PauliList?utm_source=openai">qiskit.qotlabs.org</a>)</li>
<li>In our circuit, the two such channels act on disjoint pairs (2,1) and (0,3), and there are no subsequent gates touching those qubits after each error is applied; thus the final state is</li>
</ul>
<div class="arithmatex">\[
\rho_{\mathrm{out}}=\mathcal{E}_{21}\!\left(|\Phi^+\rangle\!\langle\Phi^+|_{21}\right)\;\otimes\;\mathcal{E}_{03}\!\left(|\Phi^+\rangle\!\langle\Phi^+|_{03}\right),
\]</div>
<div class="codehilite"><pre><span></span><code>i.e., a tensor product of two independently‚Äìnoisy Bell pairs.
</code></pre></div>

<ul>
<li>Fidelity for a single noisy Bell pair</li>
<li>For a target pure state |œà‚ü©, the fidelity with a state œÅ is F=‚ü®œà|œÅ|œà‚ü© (we use the ‚Äúsquared‚Äù fidelity convention). For our tensor-product target |œàideal‚ü© the total fidelity factorizes as the product of the two pairwise fidelities (see next bullet). (<a href="https://en.wikipedia.org/wiki/Fidelity_of_quantum_states?utm_source=openai">en.wikipedia.org</a>)</li>
<li>Because œÅout is a product and |œàideal‚ü© is a product, the fidelity factorizes:</li>
</ul>
<div class="arithmatex">\[
\]</div>
<div class="codehilite"><pre><span></span><code>This follows from ‚ü®a‚äób| (A‚äóB) |a‚äób‚ü© = ‚ü®a|A|a‚ü© ‚ü®b|B|b‚ü©.
</code></pre></div>

<ul>
<li>Evaluate Fpair for one pair subject to the 2-qubit Pauli channel:</li>
</ul>
<div class="arithmatex">\[
F_{\text{pair}}=\sum_{P} \Pr(P)\,|\langle\Phi^+|P|\Phi^+\rangle|^2,
\]</div>
<div class="codehilite"><pre><span></span><code>where P runs over {II}‚à™{15 non-identity Paulis}.
- The Bell state |Œ¶+‚ü© is a simultaneous eigenstate of X‚äóX and Z‚äóZ with eigenvalue +1, and of Y‚äóY with eigenvalue ‚àí1:
</code></pre></div>

<div class="arithmatex">\[
(X\!\otimes\!X)|\Phi^+\rangle=|\Phi^+\rangle,\quad (Z\!\otimes\!Z)|\Phi^+\rangle=|\Phi^+\rangle,\quad (Y\!\otimes\!Y)|\Phi^+\rangle=-|\Phi^+\rangle.
\]</div>
<div class="codehilite"><pre><span></span><code><span class="w">  </span><span class="n">Hence</span><span class="w"> </span><span class="n">these</span><span class="w"> </span><span class="n">three</span><span class="w"> </span><span class="n">two</span><span class="o">-</span><span class="n">qubit</span><span class="w"> </span><span class="n">Paulis</span><span class="w"> </span><span class="n">leave</span><span class="w"> </span><span class="o">|</span><span class="err">Œ¶</span><span class="o">+</span><span class="err">‚ü©</span><span class="w"> </span><span class="n">invariant</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">global</span><span class="w"> </span><span class="n">phase</span><span class="o">.</span><span class="w"> </span><span class="n">All</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">identity</span><span class="w"> </span><span class="n">two</span><span class="o">-</span><span class="n">qubit</span><span class="w"> </span><span class="n">Paulis</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">|</span><span class="err">Œ¶</span><span class="o">+</span><span class="err">‚ü©</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">three</span><span class="w"> </span><span class="p">(</span><span class="n">orthogonal</span><span class="p">)</span><span class="w"> </span><span class="n">Bell</span><span class="w"> </span><span class="n">states</span><span class="p">,</span><span class="w"> </span><span class="n">giving</span><span class="w"> </span><span class="n">zero</span><span class="w"> </span><span class="n">overlap</span><span class="o">.</span><span class="w"> </span><span class="p">([</span><span class="n">chem</span><span class="o">.</span><span class="n">libretexts</span><span class="o">.</span><span class="n">org</span><span class="p">](</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">chem</span><span class="o">.</span><span class="n">libretexts</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">Bookshelves</span><span class="o">/</span><span class="n">Physical_and_Theoretical_Chemistry_Textbook_Maps</span><span class="o">/</span><span class="n">Quantum_Tutorials_</span><span class="o">%</span><span class="mi">28</span><span class="n">Rioux</span><span class="o">%</span><span class="mi">29</span><span class="o">/</span><span class="mi">08</span><span class="o">%</span><span class="mi">3</span><span class="n">A_Quantum_Teleportation</span><span class="o">/</span><span class="mf">8.53</span><span class="o">%</span><span class="mi">3</span><span class="n">A_Bell_State_Exercises</span><span class="err">?</span><span class="n">utm_source</span><span class="o">=</span><span class="n">openai</span><span class="p">))</span>
<span class="o">-</span><span class="w"> </span><span class="n">Therefore</span><span class="p">,</span>
</code></pre></div>

<div class="arithmatex">\[
\]</div>
<ul>
<li>Total physical-state fidelity</li>
<li>Using Fphys = Fpair^2,</li>
</ul>
<div class="arithmatex">\[
F_{\mathrm{phys}}(p)=\Big(1-\frac{4}{5}p\Big)^2.
\]</div>
<p>2) Mathematical Identities Used</p>
<ul>
<li>Bell-state creation by H on the control followed by CNOT: CNOT(H‚äóI)|00‚ü© = (|00‚ü©+|11‚ü©)/‚àö2. (<a href="https://en.wikipedia.org/wiki/Quantum_logic_gate?utm_source=openai">en.wikipedia.org</a>)</li>
<li>The 2-qubit Pauli set has 16 elements (II and the 15 non-identity strings); ‚Äúuniform Pauli‚Äù depolarizing distributes weight equally over those non-identity Paulis. (<a href="https://qiskit.qotlabs.org/docs/api/qiskit/2.0/qiskit.quantum_info.PauliList?utm_source=openai">qiskit.qotlabs.org</a>, <a href="https://qiskit.github.io/qiskit-aer/stubs/qiskit_aer.noise.depolarizing_error.html">qiskit.github.io</a>)</li>
<li>Bell states are eigenstates of X‚äóX, Z‚äóZ (and Y‚äóY), so XX, YY, ZZ stabilize |Œ¶+‚ü© up to a phase; the four Bell states form an orthonormal basis. (<a href="https://chem.libretexts.org/Bookshelves/Physical_and_Theoretical_Chemistry_Textbook_Maps/Quantum_Tutorials_%28Rioux%29/08%3A_Quantum_Teleportation/8.53%3A_Bell_State_Exercises?utm_source=openai">chem.libretexts.org</a>, <a href="https://en.wikipedia.org/wiki/Bell_state">en.wikipedia.org</a>)</li>
<li>Fidelity with a pure target equals F = ‚ü®œà|œÅ|œà‚ü©. (<a href="https://en.wikipedia.org/wiki/Fidelity_of_quantum_states?utm_source=openai">en.wikipedia.org</a>)</li>
</ul>
<p>3) Conventions and Units</p>
<ul>
<li>Fidelity is taken as F(|œà‚ü©,œÅ) = ‚ü®œà|œÅ|œà‚ü© (not the root-fidelity). (<a href="https://en.wikipedia.org/wiki/Fidelity_of_quantum_states?utm_source=openai">en.wikipedia.org</a>)</li>
<li>Error rate p is the probability that a given CNOT is followed by a non-identity 2-qubit Pauli error; each of the 15 non-identity Paulis occurs with probability p/15. This channel acts once per CNOT, on that gate‚Äôs two qubits. (<a href="https://qiskit.github.io/qiskit-aer/stubs/qiskit_aer.noise.depolarizing_error.html">qiskit.github.io</a>, <a href="https://qiskit.qotlabs.org/docs/api/qiskit/2.0/qiskit.quantum_info.PauliList?utm_source=openai">qiskit.qotlabs.org</a>)</li>
</ul>
<p>4) Final Answer:
Fphys(p) = (1 ‚àí 4p/5)^2.</p></div>
</article>


<article class="message role-user">
    <div class="meta">
        <span class="badge">User</span>
        <span class="idx">#3</span>
    </div>
    <div class="content markdown-body"><p>The correct answer is:
$
F_{\rm{physical}}=(1-\frac{12}{15}p)^2
$</p>
<p>Now let&rsquo;s solve the next Checkpoint.</p>
<h2 id="subproblem-2">Checkpoint 2</h2>
<p>Suppose that we wish to prepare a logical two-qubit GHZ state  <span class="arithmatex">\((|00\rangle_{AB}+|11\rangle_{AB})/\sqrt{2}\)</span> in the [[4,2,2]] code. To do so, we use the following state preparation circuit:</p>
<div class="arithmatex">\[
(CNOT_{03}) (H_0) (CNOT_{21}) (H_2).
\]</div>
<p>Note that this equation is written in matrix multiplication order, while the quantum operations in the circuit occur in the reverse order (from right-to-left in the above equation). <span class="arithmatex">\(H\)</span> is a single-qubit Hadamard gate.</p>
<p>What is the logical state fidelity of the final 2-qubit logical state at the end of the circuit as a function of the two-qubit gate error rate <span class="arithmatex">\(p\)</span>, assuming the state is post-selected on all detectable errors in the code?</p></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#4</span>
    </div>
    <div class="content markdown-body"><p>1) Step-by-Step Derivation</p>
<ul>
<li>Ideal output of the circuit (no noise)</li>
<li>Start from |0000‚ü© on qubits (0,1,2,3).</li>
<li>The rightmost subcircuit H2 then CNOT21 prepares a Bell state on qubits (2,1): CNOT(H‚äóI)|00‚ü© = |Œ¶+‚ü© = (|00‚ü©+|11‚ü©)/‚àö2. Hence qubits (2,1) are in |Œ¶+‚ü©21. The later gates act only on (0,3). (<a href="https://en.wikipedia.org/wiki/Bell_state?utm_source=openai">en.wikipedia.org</a>)</li>
<li>The subcircuit H0 then CNOT03 similarly prepares |Œ¶+‚ü©03 on (0,3). Therefore the ideal 4-qubit output state is</li>
</ul>
<div class="arithmatex">\[
|\psi_{\mathrm{ideal}}\rangle = |\Phi^+\rangle_{21}\otimes|\Phi^+\rangle_{03}.
\]</div>
<ul>
<li>Noise model and its localization</li>
<li>
<p>After each CNOT, a two-qubit depolarizing Pauli channel acts on that gate‚Äôs two qubits: with probability 1‚àíp nothing happens, and with probability p one of the 15 non-identity two-qubit Paulis is applied uniformly (probability p/15 each). The two noisy channels act on disjoint pairs (2,1) and (0,3). (<a href="https://qiskit.github.io/qiskit-aer/stubs/qiskit_aer.noise.depolarizing_error.html?utm_source=openai">qiskit.github.io</a>, <a href="https://quantumchannelzoo.org/channel/depolarizing?utm_source=openai">quantumchannelzoo.org</a>)</p>
</li>
<li>
<p>How a two-qubit Pauli acts on a Bell state</p>
</li>
<li>The Bell states are simultaneous eigenstates of X‚äóX and Z‚äóZ; in particular,</li>
</ul>
<div class="arithmatex">\[
|\Phi^+\rangle \text{ has } (X\!\otimes\!X)=+1,\ (Z\!\otimes\!Z)=+1.
\]</div>
<div class="codehilite"><pre><span></span><code><span class="nv">The</span><span class="w"> </span><span class="nv">only</span><span class="w"> </span><span class="nv">two</span><span class="o">-</span><span class="nv">qubit</span><span class="w"> </span><span class="nv">Paulis</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">map</span><span class="w"> </span><span class="o">|</span>Œ¶<span class="o">+</span>‚ü©<span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">itself</span><span class="w"> </span><span class="ss">(</span><span class="nv">up</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">phase</span><span class="ss">)</span><span class="w"> </span><span class="nv">are</span><span class="w"> </span><span class="nv">XX</span>,<span class="w"> </span><span class="nv">YY</span>,<span class="w"> </span><span class="nv">ZZ</span><span class="c1">; all the other 12 map it to one of the other three Bell states {Œ¶‚àí, Œ®+, Œ®‚àí}. Consequently, for one noisy pair,</span>
</code></pre></div>

<div class="arithmatex">\[
\Pr(\Phi^+) = 1-\tfrac{12}{15}p,\qquad \Pr(\Phi^-)=\Pr(\Psi^+)=\Pr(\Psi^-)=\tfrac{4}{15}p.
\]</div>
<div class="codehilite"><pre><span></span><code>The two pairs are independent. ([qubit.guide](https://qubit.guide/7.3-single-stabiliser-states?utm_source=openai))
</code></pre></div>

<ul>
<li>Post-selection on the [[4,2,2]] code stabilizers</li>
<li>The code stabilizers are S = ‚ü®XXXX, ZZZZ‚ü©. On the product form, XXXX = (X0X3)(X2X1) and ZZZZ = (Z0Z3)(Z2Z1). Measuring XXXX (resp. ZZZZ) on the product of two Bell states returns the product of the XX (resp. ZZ) eigenvalues of the two pairs. We post-select runs with +1 for both stabilizers, which is equivalent to requiring that the two pairs have identical (XX, ZZ) eigenvalue pairs, i.e., they are the same Bell state. (<a href="https://ar5iv.labs.arxiv.org/html/1907.11157v1?utm_source=openai">ar5iv.labs.arxiv.org</a>)</li>
<li>Therefore the acceptance probability is</li>
</ul>
<div class="arithmatex">\[
    =(1-\tfrac{12}{15}p)^2+3\Big(\tfrac{4}{15}p\Big)^2
\]</div>
<ul>
<li>Logical state produced upon acceptance and its fidelity</li>
<li>Conditioning on acceptance, the four-qubit state is stabilized by XXXX, ZZZZ and also by IXXI and IZZI with eigenvalues inherited from the (2,1)-pair. Thus the accepted state is exactly the logical Bell state whose (XX, ZZ) logical stabilizers match the pair‚Äôs eigenvalues: if both pairs are Œ¶+, we get the target logical |Œ¶+‚ü©AB; if both are Œ¶‚àí, Œ®+, or Œ®‚àí, we obtain the corresponding other logical Bell state, orthogonal to the target. Hence the logical-state fidelity equals the conditional probability that both pairs are Œ¶+:</li>
</ul>
<div class="arithmatex">\[
      =\frac{\Pr(\Phi^+)^2}{P_{\rm acc}(p)}
\]</div>
<div class="codehilite"><pre><span></span><code>Equivalently,
</code></pre></div>

<div class="arithmatex">\[
\]</div>
<div class="codehilite"><pre><span></span><code>showing first-order error suppression under post-selection (distance-2 detection). ([qubit.guide](https://qubit.guide/7.3-single-stabiliser-states?utm_source=openai), [ar5iv.labs.arxiv.org](https://ar5iv.labs.arxiv.org/html/1907.11157v1?utm_source=openai))
</code></pre></div>

<p>2) Mathematical identities and checks used</p>
<ul>
<li>Factorization of stabilizer measurements across the two Bell pairs: XXXX = (X0X3)(X2X1), ZZZZ = (Z0Z3)(Z2Z1). The eigenvalue measured is the product of pairwise eigenvalues. This matches the Bell-state eigenvalue table for XX and ZZ. (<a href="https://qubit.guide/7.3-single-stabiliser-states?utm_source=openai">qubit.guide</a>)</li>
<li>Two-qubit depolarizing channel chooses uniformly among the 15 non-identity two-qubit Pauli operators. (<a href="https://qiskit.github.io/qiskit-aer/stubs/qiskit_aer.noise.depolarizing_error.html?utm_source=openai">qiskit.github.io</a>)</li>
</ul>
<p>3) Conventions and Units</p>
<ul>
<li>Fidelity with a pure target state |œà‚ü© is F = ‚ü®œà|œÅ|œà‚ü©.</li>
<li>Error rate p is the probability that a given CNOT is followed by a non-identity 2-qubit Pauli error (each of the 15 non-identity Paulis occurs with probability p/15). (<a href="https://qiskit.github.io/qiskit-aer/stubs/qiskit_aer.noise.depolarizing_error.html?utm_source=openai">qiskit.github.io</a>)</li>
</ul>
<p>4) Final Answer:</p>
<div class="arithmatex">\[
=\frac{(1-\frac{4}{5}p)^2}{1-\frac{8}{5}p+\frac{64}{75}p^2}
\]</div></div>
</article>


<article class="message role-user">
    <div class="meta">
        <span class="badge">User</span>
        <span class="idx">#5</span>
    </div>
    <div class="content markdown-body"><p>The correct answer is:
$
F_{\rm{logical}}=1 - \frac{\frac{16}{75}p^2}{1-\frac{8}{5}p + \frac{64}{75}p^2}
$</p>
<p>Now let&rsquo;s solve the next Checkpoint.</p>
<h2 id="subproblem-3">Checkpoint 3</h2>
<p>Suppose that we prepare a logical two-qubit <span class="arithmatex">\(|00\rangle_{AB}\)</span> state in the [[4,2,2]] code. To do so, we introduce an ancilla qubit, qubit 4, and use the following state preparation circuit:</p>
<div class="arithmatex">\[
M_4 (CNOT_{04}) (CNOT_{34}) (CNOT_{23}) (CNOT_{10}) (CNOT_{12}) (H_1)
\]</div>
<p>Note that this equation is written in matrix multiplication order, while the quantum operations in the circuit occur in the reverse order (from right-to-left in the above equation). <span class="arithmatex">\(H\)</span> is a single-qubit Hadamard gate and <span class="arithmatex">\(M\)</span> is a single-qubit measurement. The ancilla is used to detect errors in the state preparation circuit and makes the circuit fault-tolerant. If the ancilla measurement is <span class="arithmatex">\(|0\rangle\)</span> (<span class="arithmatex">\(|1\rangle\)</span>), the state preparation succeeds (fails).</p>
<p>What is the logical state fidelity of the final 2-qubit logical state at the end of the circuit as a function of two-qubit gate error rate <span class="arithmatex">\(p\)</span>, assuming the state is post-selected on all detectable errors in the code and on the ancilla qubit measuring <span class="arithmatex">\(|0\rangle\)</span>?</p></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#6</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>

<span class="c1"># Define single-qubit Pauli matrices</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">pauli_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span><span class="n">I</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">X</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="n">Y</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span><span class="n">Z</span><span class="p">}</span>
<span class="n">paulis</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>

<span class="c1"># Two-qubit CNOT gate (control c, target t) acting on two-qubit space (control first)</span>
<span class="n">CNOT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                 <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                 <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                 <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="c1"># Build mapping tables by explicit conjugation for 1-qubit H and 2-qubit CNOT</span>

<span class="k">def</span><span class="w"> </span><span class="nf">single_qubit_conj_map</span><span class="p">(</span><span class="n">U</span><span class="p">):</span>
    <span class="c1"># returns dict mapping &#39;I&#39;,&#39;X&#39;,&#39;Y&#39;,&#39;Z&#39; -&gt; (phase, pauli)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
        <span class="n">Pin</span> <span class="o">=</span> <span class="n">pauli_dict</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
        <span class="n">Pout</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">Pin</span> <span class="o">@</span> <span class="n">U</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># Find which Pauli (up to phase) equals Pout</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">pauli_dict</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
            <span class="c1"># Try factors 1, -1, 1j, -1j</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Pout</span><span class="p">,</span> <span class="n">c</span><span class="o">*</span><span class="n">Q</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;No match for H conjugation of&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">M</span>

<span class="n">H_map</span> <span class="o">=</span> <span class="n">single_qubit_conj_map</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>

<span class="c1"># Two-qubit conjugation map for CNOT (control first, target second)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">two_qubit_conj_map</span><span class="p">(</span><span class="n">U</span><span class="p">):</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
            <span class="n">Pin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">pauli_dict</span><span class="p">[</span><span class="n">pc</span><span class="p">],</span> <span class="n">pauli_dict</span><span class="p">[</span><span class="n">pt</span><span class="p">])</span>
            <span class="n">Pout</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">Pin</span> <span class="o">@</span> <span class="n">U</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">qc</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">qt</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">pauli_dict</span><span class="p">[</span><span class="n">qc</span><span class="p">],</span> <span class="n">pauli_dict</span><span class="p">[</span><span class="n">qt</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Pout</span><span class="p">,</span> <span class="n">c</span><span class="o">*</span><span class="n">Q</span><span class="p">):</span>
                            <span class="n">M</span><span class="p">[(</span><span class="n">pc</span><span class="p">,</span><span class="n">pt</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">qc</span><span class="p">,</span> <span class="n">qt</span><span class="p">)</span>
                            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;No match for CNOT conjugation of&#39;</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">pt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">M</span>

<span class="n">CNOT_map</span> <span class="o">=</span> <span class="n">two_qubit_conj_map</span><span class="p">(</span><span class="n">CNOT</span><span class="p">)</span>

<span class="c1"># Utility: multiply two single-qubit Paulis (with phases)</span>
<span class="c1"># returns (phase, resulting_pauli)</span>
<span class="n">mult_table</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">pauli_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">pauli_dict</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">A</span> <span class="o">@</span> <span class="n">B</span>
        <span class="n">found</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">c</span><span class="o">*</span><span class="n">pauli_dict</span><span class="p">[</span><span class="n">r</span><span class="p">]):</span>
                    <span class="n">mult_table</span><span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
                    <span class="n">found</span><span class="o">=</span><span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">found</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;No match for mult&#39;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="c1"># Multiply multi-qubit Pauli strings with phase tracking</span>
<span class="c1"># strings are like [&#39;X&#39;,&#39;I&#39;,&#39;Z&#39;,&#39;Y&#39;,&#39;I&#39;] for 5 qubits</span>

<span class="k">def</span><span class="w"> </span><span class="nf">multiply_strings</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">):</span>
        <span class="n">cb</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">mult_table</span><span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)]</span>
        <span class="n">c</span> <span class="o">*=</span> <span class="n">cb</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">out</span>

<span class="c1"># Build projectors as Pauli sums</span>
<span class="c1"># P_code on data qubits 0..3: (I + XXXX)(I + ZZZZ)/4 = (I + XXXX + ZZZZ - YYYY)/4</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pauli_string</span><span class="p">(</span><span class="n">qubits5</span><span class="p">,</span> <span class="n">letters</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="mi">1</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span><span class="p">):</span>
    <span class="c1"># letters length equals number of active qubits; we will place on 5 qubits with last being ancilla optionally</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">letters</span><span class="p">)</span>

<span class="c1"># Generate P_accept terms on 5 qubits: (1/8)*(I+Z4) tensor (I + XXXX + ZZZZ - YYYY)</span>
<span class="n">Pacc_terms</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">anc</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="p">[</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="p">]:</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">8</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">]:</span>
            <span class="n">coeff</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># because of minus sign</span>
        <span class="n">letters5</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="p">[</span><span class="n">anc</span><span class="p">]</span>
        <span class="n">Pacc_terms</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">coeff</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span><span class="p">,</span> <span class="n">letters5</span><span class="p">))</span>

<span class="c1"># Build target projector on data qubits: stabilized by XXXX, ZZZZ, Z_A=ZZII, Z_B=ZIZI with +1 eigenvalues</span>
<span class="c1"># P_target = (1/16) sum over group generated by these four independent commuting Paulis</span>

<span class="n">Ggens</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">],</span>  <span class="c1"># Z_A</span>
    <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">],</span>  <span class="c1"># Z_B</span>
<span class="p">]</span>

<span class="c1"># Enumerate group elements</span>
<span class="n">group_elems</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">product</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">],</span> <span class="n">Ggens</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">c2</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">multiply_strings</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="n">coeff</span> <span class="o">*=</span> <span class="n">c2</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c1"># Sum coefficients if same Pauli appears (shouldn&#39;t happen often)</span>
    <span class="n">group_elems</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_elems</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">coeff</span>

<span class="c1"># Convert to list of (coeff, letters)</span>
<span class="n">Ptarget_data_terms</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">letters</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="n">group_elems</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="c1"># Each term has coefficient 1/16 times its coeff from multiplication</span>
    <span class="n">Ptarget_data_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="n">coeff</span><span class="o">/</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">letters</span><span class="p">)))</span>

<span class="c1"># Build P_good terms on 5 qubits: (1/2)*(I+Z4) tensor P_target_data</span>
<span class="n">Pgood_terms</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">anc</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">letters4</span> <span class="ow">in</span> <span class="n">Ptarget_data_terms</span><span class="p">:</span>
        <span class="n">Pgood_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="n">coeff</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span><span class="p">,</span> <span class="n">letters4</span> <span class="o">+</span> <span class="p">[</span><span class="n">anc</span><span class="p">]))</span>

<span class="c1"># Define Heisenberg propagation through the full circuit</span>
<span class="c1"># Steps: [H1], [CNOT12 + E1], [CNOT10 + E2], [CNOT23 + E3], [CNOT34 + E4], [CNOT04 + E5]</span>
<span class="c1"># We implement backward propagation: for k=last..first: apply E_k^‚Ä† then conjugate by gate^</span>

<span class="c1"># Conjugation helpers</span>

<span class="k">def</span><span class="w"> </span><span class="nf">conj_H_on_qubit</span><span class="p">(</span><span class="n">term_letters</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
    <span class="n">letters</span> <span class="o">=</span> <span class="n">term_letters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">letters</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">q1</span> <span class="o">=</span> <span class="n">H_map</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
    <span class="n">letters</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">q1</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">letters</span>

<span class="k">def</span><span class="w"> </span><span class="nf">conj_CNOT_on_pair</span><span class="p">(</span><span class="n">term_letters</span><span class="p">,</span> <span class="n">c_idx</span><span class="p">,</span> <span class="n">t_idx</span><span class="p">):</span>
    <span class="n">letters</span> <span class="o">=</span> <span class="n">term_letters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="n">letters</span><span class="p">[</span><span class="n">c_idx</span><span class="p">]</span>
    <span class="n">pt</span> <span class="o">=</span> <span class="n">letters</span><span class="p">[</span><span class="n">t_idx</span><span class="p">]</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">qc</span><span class="p">,</span> <span class="n">qt</span> <span class="o">=</span> <span class="n">CNOT_map</span><span class="p">[(</span><span class="n">pc</span><span class="p">,</span><span class="n">pt</span><span class="p">)]</span>
    <span class="n">letters</span><span class="p">[</span><span class="n">c_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">qc</span>
    <span class="n">letters</span><span class="p">[</span><span class="n">t_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">qt</span>
    <span class="k">return</span> <span class="n">c1</span><span class="p">,</span> <span class="n">letters</span>

<span class="c1"># For depolarizing adjoint factor: if either of the two qubits at indices (a,b) is non-identity</span>

<span class="k">def</span><span class="w"> </span><span class="nf">E_dag_factor</span><span class="p">(</span><span class="n">term_letters</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">lam</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">lam</span> <span class="k">if</span> <span class="p">(</span><span class="n">term_letters</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span> <span class="ow">or</span> <span class="n">term_letters</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1.0</span>

<span class="c1"># Propagate a term and return its contribution factor to expectation on |00000&gt; (real scalar) as a function of lam</span>

<span class="k">def</span><span class="w"> </span><span class="nf">propagate_term</span><span class="p">(</span><span class="n">term_coeff</span><span class="p">,</span> <span class="n">term_letters</span><span class="p">,</span> <span class="n">lam</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">term_coeff</span>
    <span class="n">letters</span> <span class="o">=</span> <span class="n">term_letters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># k=6: E5 on (0,4) then CNOT04</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">E_dag_factor</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">letters</span> <span class="o">=</span> <span class="n">conj_CNOT_on_pair</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># k=5: E4 on (3,4) then CNOT34</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">E_dag_factor</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">letters</span> <span class="o">=</span> <span class="n">conj_CNOT_on_pair</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># k=4: E3 on (2,3) then CNOT23</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">E_dag_factor</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">letters</span> <span class="o">=</span> <span class="n">conj_CNOT_on_pair</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># k=3: E2 on (1,0) then CNOT10</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">E_dag_factor</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">letters</span> <span class="o">=</span> <span class="n">conj_CNOT_on_pair</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># k=2: E1 on (1,2) then CNOT12</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">E_dag_factor</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">letters</span> <span class="o">=</span> <span class="n">conj_CNOT_on_pair</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># k=1: H1</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">letters</span> <span class="o">=</span> <span class="n">conj_H_on_qubit</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># Now compute expectation on |00000&gt;: nonzero only if letters are only I or Z</span>
    <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="n">letters</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">L</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">0.0</span>
    <span class="c1"># For I/Z-only string, expectation equals real part of global coefficient c (since &lt;0|Z|0&gt;=1)</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real_if_close</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>

<span class="c1"># Compute A(lam) and G(lam)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">compute_A_G</span><span class="p">(</span><span class="n">lam</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">letters</span> <span class="ow">in</span> <span class="n">Pacc_terms</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">+=</span> <span class="n">propagate_term</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">letters</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
    <span class="n">G</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">letters</span> <span class="ow">in</span> <span class="n">Pgood_terms</span><span class="p">:</span>
        <span class="n">G</span> <span class="o">+=</span> <span class="n">propagate_term</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">letters</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">G</span>

<span class="c1"># Sanity checks: p=0 -&gt; lam=1; both A and G should be 1</span>
<span class="k">for</span> <span class="n">lam</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]:</span>
    <span class="n">A</span><span class="p">,</span> <span class="n">G</span> <span class="o">=</span> <span class="n">compute_A_G</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lam=&#39;</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="s1">&#39;A=&#39;</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="s1">&#39;G=&#39;</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="s1">&#39;F=G/A&#39;</span> <span class="k">if</span> <span class="n">A</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;A=0&#39;</span><span class="p">)</span>

<span class="c1"># Now, let&#39;s try to express A and G as polynomials in lam</span>
<span class="c1"># We can fit polynomials up to degree 5 since there are 5 noise channels</span>
<span class="n">L_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="n">A_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">L_vals</span><span class="p">,</span> <span class="p">[</span><span class="n">compute_A_G</span><span class="p">(</span><span class="n">l</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">L_vals</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">G_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">L_vals</span><span class="p">,</span> <span class="p">[</span><span class="n">compute_A_G</span><span class="p">(</span><span class="n">l</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">L_vals</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A(lam) poly coeffs (deg 5 -&gt; deg 0):&#39;</span><span class="p">,</span> <span class="n">A_coeffs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;G(lam) poly coeffs (deg 5 -&gt; deg 0):&#39;</span><span class="p">,</span> <span class="n">G_coeffs</span><span class="p">)</span>

<span class="c1"># For readability, round coefficients to rationals with small denominators</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>

<span class="k">def</span><span class="w"> </span><span class="nf">rationalize_coeffs</span><span class="p">(</span><span class="n">coeffs</span><span class="p">):</span>
    <span class="n">rats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coeffs</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real_if_close</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">))</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">rats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rats</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A rational coeffs:&#39;</span><span class="p">,</span> <span class="n">rationalize_coeffs</span><span class="p">(</span><span class="n">A_coeffs</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;G rational coeffs:&#39;</span><span class="p">,</span> <span class="n">rationalize_coeffs</span><span class="p">(</span><span class="n">G_coeffs</span><span class="p">))</span>

<span class="c1"># Convert lam to p: lam = 1 - 16p/15</span>
<span class="c1"># We can express A(p) and G(p) by substituting lam and expanding symbolic polynomial using numpy.poly1d</span>
<span class="n">A_poly_lam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">A_coeffs</span><span class="p">)</span>
<span class="n">G_poly_lam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">G_coeffs</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">lam</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span><span class="o">*</span><span class="n">p</span>
<span class="c1"># Convert numpy poly1d to sympy poly</span>
<span class="n">A_sym_lam</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">Fraction</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">))</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">))</span> <span class="o">*</span> <span class="n">lam</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">A_poly_lam</span><span class="o">.</span><span class="n">c</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">G_sym_lam</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">Fraction</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">))</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">))</span> <span class="o">*</span> <span class="n">lam</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">G_poly_lam</span><span class="o">.</span><span class="n">c</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">A_sym</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">A_sym_lam</span><span class="p">))</span>
<span class="n">G_sym</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">G_sym_lam</span><span class="p">))</span>
<span class="n">F_sym</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">factor</span><span class="p">(</span><span class="n">G_sym</span> <span class="o">/</span> <span class="n">A_sym</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A_sym(p)=&#39;</span><span class="p">,</span> <span class="n">A_sym</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;G_sym(p)=&#39;</span><span class="p">,</span> <span class="n">G_sym</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F_sym(p)=&#39;</span><span class="p">,</span> <span class="n">F_sym</span><span class="p">)</span>

<span class="c1"># Also expand series up to p^2</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Series F up to p^3:&#39;</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">F_sym</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#7</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>lam= 1.0 A= 0.5 G= 1.0 F=G/A
lam= 0.0 A= 0.125 G= 0.03125 F=G/A
lam= 0.5 A= 0.140625 G= 0.0947265625 F=G/A
A(lam) poly coeffs (deg 5 -&gt; deg 0): [ 2.50000000e-01  1.25000000e-01  5.85596233e-14 -2.33045049e-14
  3.38425206e-15  1.25000000e-01]
G(lam) poly coeffs (deg 5 -&gt; deg 0): [6.56250000e-01 1.25000000e-01 9.37500000e-02 9.37500000e-02
 6.23438555e-16 3.12500000e-02]
A rational coeffs: [Fraction(1, 4), Fraction(1, 8), Fraction(0, 1), Fraction(0, 1), Fraction(0, 1), Fraction(1, 8)]
G rational coeffs: [Fraction(21, 32), Fraction(1, 8), Fraction(3, 32), Fraction(3, 32), Fraction(0, 1), Fraction(1, 32)]
A_sym(p)= -262144*p**5/759375 + 90112*p**4/50625 - 4096*p**3/1125 + 832*p**2/225 - 28*p/15 + 1/2
G_sym(p)= -229376*p**5/253125 + 223232*p**4/50625 - 29312*p**3/3375 + 656*p**2/75 - 68*p/15 + 1
F_sym(p)= 6*(229376*p**5 - 1116160*p**4 + 2198400*p**3 - 2214000*p**2 + 1147500*p - 253125)/((8*p - 15)*(65536*p**4 - 215040*p**3 + 288000*p**2 - 162000*p + 50625))
Series F up to p^3: 2 - 8*p/5 - 736*p**2/225 - 3584*p**3/1125 + O(p**4)
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#8</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="c1"># 5-qubit size</span>
<span class="n">n</span><span class="o">=</span><span class="mi">5</span>

<span class="c1"># basis order qubits [0,1,2,3,4]</span>

<span class="c1"># Build 5-qubit identity</span>
<span class="n">I5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="c1"># Helper: build single-qubit gate on qubit q</span>

<span class="k">def</span><span class="w"> </span><span class="nf">single_on</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">U</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">ops</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">M</span>

<span class="c1"># Helper: build CNOT with control c, target t</span>
<span class="c1"># We&#39;ll implement using projector form</span>

<span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">CNOT_on</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
    <span class="c1"># U = |0&gt;&lt;0|_c ‚äó I + |1&gt;&lt;1|_c ‚äó X_t</span>
    <span class="n">ops0</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops1</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops0</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">P0</span>
    <span class="n">ops1</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">P1</span>
    <span class="c1"># Now we need X on t in ops1</span>
    <span class="n">ops1</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span>
    <span class="n">M0</span> <span class="o">=</span> <span class="n">ops0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="n">M0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">M0</span><span class="p">,</span> <span class="n">ops0</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="n">M1</span> <span class="o">=</span> <span class="n">ops1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="n">M1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">M1</span><span class="p">,</span> <span class="n">ops1</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">M0</span> <span class="o">+</span> <span class="n">M1</span>

<span class="c1"># Build P_code and P_anc0 operators</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pauli_on</span><span class="p">(</span><span class="n">qubit</span><span class="p">,</span> <span class="n">letter</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span><span class="n">I</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">X</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="n">Y</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span><span class="n">Z</span><span class="p">}[</span><span class="n">letter</span><span class="p">]</span>

<span class="c1"># Data qubits 0..3, ancilla 4</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pauli_string5</span><span class="p">(</span><span class="n">letters5</span><span class="p">):</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">pauli_on</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">letters5</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">pauli_on</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">letters5</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">M</span>

<span class="n">P_code</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="p">(</span><span class="n">pauli_string5</span><span class="p">([</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">])</span> <span class="o">+</span>
               <span class="n">pauli_string5</span><span class="p">([</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">])</span> <span class="o">+</span>
               <span class="n">pauli_string5</span><span class="p">([</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">])</span> <span class="o">-</span>
               <span class="n">pauli_string5</span><span class="p">([</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">]))</span>
<span class="n">P_anc0</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">pauli_string5</span><span class="p">([</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">pauli_string5</span><span class="p">([</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]))</span>
<span class="n">P_accept</span> <span class="o">=</span> <span class="n">P_anc0</span> <span class="o">@</span> <span class="n">P_code</span>  <span class="c1"># they commute, product equals tensor product</span>

<span class="c1"># Build target projector on data (0..3): stabilized by XXXX, ZZZZ, ZZII, ZIZI</span>
<span class="c1"># We can construct as the unique state vectors and then projector</span>

<span class="c1"># We&#39;ll compute U_total and |psi&gt;</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_on</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_on</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_on</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">single_on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>

<span class="c1"># Apply to |00000&gt;</span>
<span class="n">psi0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">psi0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">psi</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">psi0</span>

<span class="c1"># Compute acceptance probability</span>
<span class="n">A_direct</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">P_accept</span> <span class="o">@</span> <span class="n">psi</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A_direct=&#39;</span><span class="p">,</span> <span class="n">A_direct</span><span class="p">)</span>

<span class="c1"># Construct target logical |00&gt;_AB state on data; We need to find 16-term projector</span>
<span class="c1"># Build group projector formula</span>

<span class="c1"># We&#39;ll build projectors on data first using 4-qubit matrices</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pauli_string4</span><span class="p">(</span><span class="n">letters4</span><span class="p">):</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">pauli_on</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">letters4</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">pauli_on</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">letters4</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">M</span>

<span class="n">P_target_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="o">**</span><span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Ggens</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">],</span>
<span class="p">]</span>
<span class="c1"># enumerate group elements</span>
<span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">product</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">e</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">],</span> <span class="n">Ggens</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">M</span> <span class="o">@</span> <span class="n">pauli_string4</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">P_target_data</span> <span class="o">+=</span> <span class="n">M</span>
<span class="n">P_target_data</span> <span class="o">/=</span> <span class="mf">16.0</span>

<span class="c1"># Now compute P_good (ancilla 0 tensor target data)</span>
<span class="c1"># On 5 qubits, P_good = P_anc0 ‚äó P_target_data</span>
<span class="n">P_good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">P_target_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> \
         <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">P_target_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.5</span>
<span class="c1"># Wait above constructs (I + Z)/2 ‚äó P_target; But better use prior P_anc0 tensored with data projector</span>
<span class="n">P_good</span> <span class="o">=</span> <span class="n">P_anc0</span> <span class="o">@</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">P_target_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>  <span class="c1"># since P_anc0 acts on all 5; yes</span>

<span class="n">G_direct</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">P_good</span> <span class="o">@</span> <span class="n">psi</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;G_direct=&#39;</span><span class="p">,</span> <span class="n">G_direct</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F_direct=&#39;</span><span class="p">,</span> <span class="n">G_direct</span> <span class="o">/</span> <span class="n">A_direct</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#9</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 109, in &lt;module&gt;
NameError: name &#39;product&#39; is not defined

A_direct= (0.24999999999999994+0j)
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#10</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="n">n</span><span class="o">=</span><span class="mi">5</span>
<span class="n">I5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">single_on</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">U</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">ops</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">M</span>

<span class="k">def</span><span class="w"> </span><span class="nf">CNOT_on</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
    <span class="n">ops0</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops1</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops0</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">P0</span>
    <span class="n">ops1</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">P1</span>
    <span class="n">ops1</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span>
    <span class="n">M0</span> <span class="o">=</span> <span class="n">ops0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="n">M0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">M0</span><span class="p">,</span> <span class="n">ops0</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="n">M1</span> <span class="o">=</span> <span class="n">ops1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="n">M1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">M1</span><span class="p">,</span> <span class="n">ops1</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">M0</span> <span class="o">+</span> <span class="n">M1</span>


<span class="k">def</span><span class="w"> </span><span class="nf">pauli_on</span><span class="p">(</span><span class="n">letter</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span><span class="n">I</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">X</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="n">Y</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span><span class="n">Z</span><span class="p">}[</span><span class="n">letter</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pauli_string5</span><span class="p">(</span><span class="n">letters5</span><span class="p">):</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">pauli_on</span><span class="p">(</span><span class="n">letters5</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">pauli_on</span><span class="p">(</span><span class="n">letters5</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">M</span>

<span class="n">P_code</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="p">(</span><span class="n">pauli_string5</span><span class="p">([</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">])</span> <span class="o">+</span>
               <span class="n">pauli_string5</span><span class="p">([</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">])</span> <span class="o">+</span>
               <span class="n">pauli_string5</span><span class="p">([</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">])</span> <span class="o">-</span>
               <span class="n">pauli_string5</span><span class="p">([</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">]))</span>
<span class="n">P_anc0</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">pauli_string5</span><span class="p">([</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">pauli_string5</span><span class="p">([</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]))</span>
<span class="n">P_accept</span> <span class="o">=</span> <span class="n">P_anc0</span> <span class="o">@</span> <span class="n">P_code</span>

<span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_on</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_on</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_on</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">single_on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">psi0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">psi0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">psi</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">psi0</span>
<span class="n">A_direct</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">P_accept</span> <span class="o">@</span> <span class="n">psi</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A_direct=&#39;</span><span class="p">,</span> <span class="n">A_direct</span><span class="p">)</span>

<span class="c1"># Build P_target_data projector via group formula</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pauli_string4</span><span class="p">(</span><span class="n">letters4</span><span class="p">):</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">pauli_on</span><span class="p">(</span><span class="n">letters4</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">pauli_on</span><span class="p">(</span><span class="n">letters4</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">M</span>

<span class="n">Ggens</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">],</span>
<span class="p">]</span>
<span class="n">P_target_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="o">**</span><span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">product</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">e</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">],</span> <span class="n">Ggens</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">M</span> <span class="o">@</span> <span class="n">pauli_string4</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">P_target_data</span> <span class="o">+=</span> <span class="n">M</span>
<span class="n">P_target_data</span> <span class="o">/=</span> <span class="mf">16.0</span>

<span class="c1"># Lift to 5 qubits (data on 0..3, ancilla on 4)</span>
<span class="n">P_good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">P_target_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">@</span> <span class="n">P_anc0</span>  <span class="c1"># they commute</span>
<span class="n">G_direct</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">P_good</span> <span class="o">@</span> <span class="n">psi</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;G_direct=&#39;</span><span class="p">,</span> <span class="n">G_direct</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F_direct=&#39;</span><span class="p">,</span> <span class="n">G_direct</span> <span class="o">/</span> <span class="n">A_direct</span><span class="p">)</span>
</code></pre></div></div>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#11</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>A_direct= (0.24999999999999994+0j)
G_direct= (0.24999999999999994+0j)
F_direct= (1+0j)
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#12</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="c1"># Compute expectations individually</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">A_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">P_code</span> <span class="o">@</span> <span class="n">psi</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">A_anc0</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">P_anc0</span> <span class="o">@</span> <span class="n">psi</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A_code=&#39;</span><span class="p">,</span> <span class="n">A_code</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A_anc0=&#39;</span><span class="p">,</span> <span class="n">A_anc0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;product expected for commuting projectors? (not generally equal)&#39;</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#13</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 3, in &lt;module&gt;
NameError: name &#39;psi&#39; is not defined
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#14</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="c1"># Recreate variables quickly</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="n">n</span><span class="o">=</span><span class="mi">5</span>
<span class="n">I5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">single_on</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">U</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">ops</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">M</span>

<span class="k">def</span><span class="w"> </span><span class="nf">CNOT_on</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
    <span class="n">ops0</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops1</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops0</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">P0</span>
    <span class="n">ops1</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">P1</span>
    <span class="n">ops1</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span>
    <span class="n">M0</span> <span class="o">=</span> <span class="n">ops0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="n">M0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">M0</span><span class="p">,</span> <span class="n">ops0</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="n">M1</span> <span class="o">=</span> <span class="n">ops1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="n">M1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">M1</span><span class="p">,</span> <span class="n">ops1</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">M0</span> <span class="o">+</span> <span class="n">M1</span>


<span class="k">def</span><span class="w"> </span><span class="nf">pauli_on</span><span class="p">(</span><span class="n">letter</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span><span class="n">I</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">X</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="n">Y</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span><span class="n">Z</span><span class="p">}[</span><span class="n">letter</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pauli_string5</span><span class="p">(</span><span class="n">letters5</span><span class="p">):</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">pauli_on</span><span class="p">(</span><span class="n">letters5</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">pauli_on</span><span class="p">(</span><span class="n">letters5</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">M</span>

<span class="n">P_code</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="p">(</span><span class="n">pauli_string5</span><span class="p">([</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">])</span> <span class="o">+</span>
               <span class="n">pauli_string5</span><span class="p">([</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">])</span> <span class="o">+</span>
               <span class="n">pauli_string5</span><span class="p">([</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">])</span> <span class="o">-</span>
               <span class="n">pauli_string5</span><span class="p">([</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">]))</span>
<span class="n">P_anc0</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">pauli_string5</span><span class="p">([</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">pauli_string5</span><span class="p">([</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]))</span>
<span class="n">P_accept</span> <span class="o">=</span> <span class="n">P_anc0</span> <span class="o">@</span> <span class="n">P_code</span>

<span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_on</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_on</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_on</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">single_on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">psi0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">psi0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">psi</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">psi0</span>

<span class="n">A_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">P_code</span> <span class="o">@</span> <span class="n">psi</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">A_anc0</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">P_anc0</span> <span class="o">@</span> <span class="n">psi</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">A_accept</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">P_accept</span> <span class="o">@</span> <span class="n">psi</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A_code=&#39;</span><span class="p">,</span> <span class="n">A_code</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A_anc0=&#39;</span><span class="p">,</span> <span class="n">A_anc0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A_accept=&#39;</span><span class="p">,</span> <span class="n">A_accept</span><span class="p">)</span>
</code></pre></div></div>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#15</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>A_code= (0.24999999999999994+0j)
A_anc0= (0.9999999999999998+0j)
A_accept= (0.24999999999999994+0j)
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#16</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="n">n</span><span class="o">=</span><span class="mi">5</span>
<span class="n">I5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">single_on</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">U</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">ops</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">M</span>

<span class="k">def</span><span class="w"> </span><span class="nf">CNOT_on</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
    <span class="n">ops0</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops1</span> <span class="o">=</span> <span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">ops0</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">P0</span>
    <span class="n">ops1</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">P1</span>
    <span class="n">ops1</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span>
    <span class="n">M0</span> <span class="o">=</span> <span class="n">ops0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="n">M0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">M0</span><span class="p">,</span> <span class="n">ops0</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="n">M1</span> <span class="o">=</span> <span class="n">ops1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="n">M1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">M1</span><span class="p">,</span> <span class="n">ops1</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">M0</span> <span class="o">+</span> <span class="n">M1</span>

<span class="c1"># Build the overall U (no noise)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_on</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_on</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_on</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">CNOT_on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">single_on</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span> <span class="o">@</span> <span class="n">U</span>

<span class="c1"># Build acceptance Pauli terms</span>
<span class="n">letters_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">coeffs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">anc</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="p">[</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="p">]:</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">8</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">]:</span>
            <span class="n">coeff</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">letters5</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="p">[</span><span class="n">anc</span><span class="p">]</span>
        <span class="n">letters_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">letters5</span><span class="p">)</span>
        <span class="n">coeffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>

<span class="c1"># helper to get 5-qubit Pauli matrix from letters</span>
<span class="n">pauli_map</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span><span class="n">I</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">X</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="n">Y</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span><span class="n">Z</span><span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pauli5</span><span class="p">(</span><span class="n">letters</span><span class="p">):</span>
    <span class="n">M</span><span class="o">=</span><span class="n">pauli_map</span><span class="p">[</span><span class="n">letters</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">M</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">pauli_map</span><span class="p">[</span><span class="n">letters</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">M</span>

<span class="c1"># Compute direct transformed observable O0 = U^</span>
<span class="n">O0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">32</span><span class="p">,</span><span class="mi">32</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">letters</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">letters_list</span><span class="p">):</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">pauli5</span><span class="p">(</span><span class="n">letters</span><span class="p">)</span>
    <span class="n">O0</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">O</span> <span class="o">@</span> <span class="n">U</span><span class="p">)</span>

<span class="c1"># Now compute the expectation on |00000&gt;&lt;00000|</span>
<span class="n">psi0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">32</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">psi0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">val_direct</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi0</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">O0</span> <span class="o">@</span> <span class="n">psi0</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;direct val =&#39;</span><span class="p">,</span> <span class="n">val_direct</span><span class="p">)</span>

<span class="c1"># Now compute via our previous Pauli conjugation maps stepwise to confirm mismatch</span>
<span class="c1"># Rebuild mapping tables</span>
<span class="c1"># we need H on qubit 1 and CNOT on pairs (0,4),(3,4),(2,3),(1,0),(1,2)</span>

<span class="c1"># create single-qubit map for H</span>
<span class="n">paulis</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>
<span class="n">H_map</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
    <span class="n">Pin</span> <span class="o">=</span> <span class="n">pauli_map</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
    <span class="n">Pout</span> <span class="o">=</span> <span class="n">H</span> <span class="o">@</span> <span class="n">Pin</span> <span class="o">@</span> <span class="n">H</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">pauli_map</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Pout</span><span class="p">,</span> <span class="n">c</span><span class="o">*</span><span class="n">Q</span><span class="p">):</span>
                <span class="n">H_map</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">q</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">H_map</span><span class="p">:</span>
            <span class="k">break</span>

<span class="c1"># two-qubit CNOT conjugation map (control first)</span>
<span class="n">CNOT2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">CNOT_map</span><span class="o">=</span><span class="p">{}</span>
<span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
        <span class="n">Pin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">pauli_map</span><span class="p">[</span><span class="n">pc</span><span class="p">],</span><span class="n">pauli_map</span><span class="p">[</span><span class="n">pt</span><span class="p">])</span>
        <span class="n">Pout</span> <span class="o">=</span> <span class="n">CNOT2</span> <span class="o">@</span> <span class="n">Pin</span> <span class="o">@</span> <span class="n">CNOT2</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        <span class="k">for</span> <span class="n">qc</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">qt</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
                <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">pauli_map</span><span class="p">[</span><span class="n">qc</span><span class="p">],</span> <span class="n">pauli_map</span><span class="p">[</span><span class="n">qt</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Pout</span><span class="p">,</span> <span class="n">c</span><span class="o">*</span><span class="n">Q</span><span class="p">):</span>
                        <span class="n">CNOT_map</span><span class="p">[(</span><span class="n">pc</span><span class="p">,</span><span class="n">pt</span><span class="p">)]</span><span class="o">=</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">qc</span><span class="p">,</span><span class="n">qt</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span> <span class="ow">in</span> <span class="n">CNOT_map</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span> <span class="ow">in</span> <span class="n">CNOT_map</span><span class="p">:</span>
                <span class="k">break</span>

<span class="c1"># implement conjugation chain stepwise for each term and accumulate into O0_est</span>

<span class="c1"># Conjugation routines</span>

<span class="k">def</span><span class="w"> </span><span class="nf">conj_H_on</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
    <span class="n">letters</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">letters</span><span class="p">)</span>
    <span class="n">c</span><span class="p">,</span> <span class="n">qlet</span> <span class="o">=</span> <span class="n">H_map</span><span class="p">[</span><span class="n">letters</span><span class="p">[</span><span class="n">q</span><span class="p">]]</span>
    <span class="n">letters</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span><span class="n">qlet</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">letters</span>

<span class="k">def</span><span class="w"> </span><span class="nf">conj_CNOT</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="n">c_idx</span><span class="p">,</span> <span class="n">t_idx</span><span class="p">):</span>
    <span class="n">letters</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">letters</span><span class="p">)</span>
    <span class="n">cphase</span><span class="p">,</span> <span class="n">qc</span><span class="p">,</span> <span class="n">qt</span> <span class="o">=</span> <span class="n">CNOT_map</span><span class="p">[(</span><span class="n">letters</span><span class="p">[</span><span class="n">c_idx</span><span class="p">],</span> <span class="n">letters</span><span class="p">[</span><span class="n">t_idx</span><span class="p">])]</span>
    <span class="n">letters</span><span class="p">[</span><span class="n">c_idx</span><span class="p">]</span><span class="o">=</span><span class="n">qc</span>
    <span class="n">letters</span><span class="p">[</span><span class="n">t_idx</span><span class="p">]</span><span class="o">=</span><span class="n">qt</span>
    <span class="k">return</span> <span class="n">cphase</span><span class="p">,</span> <span class="n">letters</span>

<span class="c1"># Compose for each term: O0_est = sum coeff * conj sequence</span>

<span class="n">O0_est</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">letters</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">letters_list</span><span class="p">):</span>
    <span class="n">cplx</span> <span class="o">=</span> <span class="n">coeff</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">letters</span>
    <span class="c1"># sequence: U^</span>
    <span class="c1"># U = CNOT04*CNOT34*CNOT23*CNOT10*CNOT12*H1</span>
    <span class="c1"># So conjugation by U^ = H1 * CNOT12 * CNOT10 * CNOT23 * CNOT34 * CNOT04</span>
    <span class="c1"># Actually conjugation: O0 = U^</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_H_on</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">cplx</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">cplx</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">cplx</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">cplx</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">cplx</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">cplx</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># accumulate</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
    <span class="n">O0_est</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">O0_est</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">cplx</span>

<span class="c1"># Now compute expectation using the estimated O0_est</span>
<span class="c1"># It is sum over terms cplx * pauli5(L)</span>
<span class="n">expect_est</span> <span class="o">=</span> <span class="mi">0</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span>
<span class="k">for</span> <span class="n">L</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="n">O0_est</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="c1"># expectation on |00000&gt; is nonzero only if letters are I or Z</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">L</span><span class="p">):</span>
        <span class="c1"># expectation equals coeff * 1</span>
        <span class="n">expect_est</span> <span class="o">+=</span> <span class="n">coeff</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;expect_est=&#39;</span><span class="p">,</span> <span class="n">expect_est</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;difference:&#39;</span><span class="p">,</span> <span class="n">expect_est</span> <span class="o">-</span> <span class="n">val_direct</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#17</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>direct val = (0.24999999999999994+0j)
expect_est= (0.25+0j)
difference: (5.551115123125783e-17+0j)
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#18</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="n">pauli_map</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span><span class="n">I</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">X</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="n">Y</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span><span class="n">Z</span><span class="p">}</span>
<span class="n">paulis</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>
<span class="c1"># Build conjugation maps (as before)</span>
<span class="n">H_map</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
    <span class="n">Pin</span> <span class="o">=</span> <span class="n">pauli_map</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
    <span class="n">Pout</span> <span class="o">=</span> <span class="n">H</span> <span class="o">@</span> <span class="n">Pin</span> <span class="o">@</span> <span class="n">H</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">pauli_map</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Pout</span><span class="p">,</span> <span class="n">c</span><span class="o">*</span><span class="n">Q</span><span class="p">):</span>
                <span class="n">H_map</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">q</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">H_map</span><span class="p">:</span>
            <span class="k">break</span>

<span class="n">CNOT2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">CNOT_map</span><span class="o">=</span><span class="p">{}</span>
<span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
        <span class="n">Pin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">pauli_map</span><span class="p">[</span><span class="n">pc</span><span class="p">],</span><span class="n">pauli_map</span><span class="p">[</span><span class="n">pt</span><span class="p">])</span>
        <span class="n">Pout</span> <span class="o">=</span> <span class="n">CNOT2</span> <span class="o">@</span> <span class="n">Pin</span> <span class="o">@</span> <span class="n">CNOT2</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        <span class="k">for</span> <span class="n">qc</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">qt</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
                <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">pauli_map</span><span class="p">[</span><span class="n">qc</span><span class="p">],</span> <span class="n">pauli_map</span><span class="p">[</span><span class="n">qt</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Pout</span><span class="p">,</span> <span class="n">c</span><span class="o">*</span><span class="n">Q</span><span class="p">):</span>
                        <span class="n">CNOT_map</span><span class="p">[(</span><span class="n">pc</span><span class="p">,</span><span class="n">pt</span><span class="p">)]</span><span class="o">=</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">qc</span><span class="p">,</span><span class="n">qt</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span> <span class="ow">in</span> <span class="n">CNOT_map</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span> <span class="ow">in</span> <span class="n">CNOT_map</span><span class="p">:</span>
                <span class="k">break</span>

<span class="c1"># multiply table for building group terms</span>
<span class="n">mult_table</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">pauli_map</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">@</span> <span class="n">pauli_map</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">c</span><span class="o">*</span><span class="n">pauli_map</span><span class="p">[</span><span class="n">r</span><span class="p">]):</span>
                    <span class="n">mult_table</span><span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="n">mult_table</span><span class="p">:</span> <span class="k">break</span>


<span class="k">def</span><span class="w"> </span><span class="nf">multiply_strings</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">):</span>
        <span class="n">cb</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">mult_table</span><span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)]</span>
        <span class="n">c</span> <span class="o">*=</span> <span class="n">cb</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">out</span>

<span class="c1"># Build P_accept terms (with correct sign): (1/8)*(I+Z4) tensor (I + XXXX + ZZZZ - YYYY)</span>
<span class="n">Pacc_terms</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">anc</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="p">[</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="p">]:</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">8</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">]:</span>
            <span class="n">coeff</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">letters5</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="p">[</span><span class="n">anc</span><span class="p">]</span>
        <span class="n">Pacc_terms</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">coeff</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span><span class="p">,</span> <span class="n">letters5</span><span class="p">))</span>

<span class="c1"># P_good terms: (1/32)*(I+Z4) tensor sum over group generated by XXXX, ZZZZ, ZZII, ZIZI</span>
<span class="n">Ggens</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">],</span>
<span class="p">]</span>
<span class="c1"># enumerate group elements with signs</span>
<span class="n">Ptarget_terms_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">seen</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">product</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">],</span> <span class="n">Ggens</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">c2</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">multiply_strings</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="n">coeff</span> <span class="o">*=</span> <span class="n">c2</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">seen</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">coeff</span>
<span class="n">Ptarget_terms_data</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">coeff</span><span class="o">/</span><span class="mi">16</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">letters</span><span class="p">))</span> <span class="k">for</span> <span class="n">letters</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="n">seen</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">]</span>

<span class="n">Pgood_terms</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">anc</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">letters4</span> <span class="ow">in</span> <span class="n">Ptarget_terms_data</span><span class="p">:</span>
        <span class="n">Pgood_terms</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">coeff</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">letters4</span> <span class="o">+</span> <span class="p">[</span><span class="n">anc</span><span class="p">]))</span>

<span class="c1"># Heisenberg propagation with noise factors lam per CNOT</span>

<span class="k">def</span><span class="w"> </span><span class="nf">conj_H_on</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
    <span class="n">letters</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">letters</span><span class="p">)</span>
    <span class="n">c</span><span class="p">,</span><span class="n">qlet</span> <span class="o">=</span> <span class="n">H_map</span><span class="p">[</span><span class="n">letters</span><span class="p">[</span><span class="n">q</span><span class="p">]]</span>
    <span class="n">letters</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span><span class="n">qlet</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">letters</span>

<span class="k">def</span><span class="w"> </span><span class="nf">conj_CNOT</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="n">c_idx</span><span class="p">,</span> <span class="n">t_idx</span><span class="p">):</span>
    <span class="n">letters</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">letters</span><span class="p">)</span>
    <span class="n">cphase</span><span class="p">,</span> <span class="n">qc</span><span class="p">,</span> <span class="n">qt</span> <span class="o">=</span> <span class="n">CNOT_map</span><span class="p">[(</span><span class="n">letters</span><span class="p">[</span><span class="n">c_idx</span><span class="p">],</span> <span class="n">letters</span><span class="p">[</span><span class="n">t_idx</span><span class="p">])]</span>
    <span class="n">letters</span><span class="p">[</span><span class="n">c_idx</span><span class="p">]</span><span class="o">=</span><span class="n">qc</span>
    <span class="n">letters</span><span class="p">[</span><span class="n">t_idx</span><span class="p">]</span><span class="o">=</span><span class="n">qt</span>
    <span class="k">return</span> <span class="n">cphase</span><span class="p">,</span> <span class="n">letters</span>


<span class="k">def</span><span class="w"> </span><span class="nf">E_dag_factor</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">lam</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">lam</span> <span class="k">if</span> <span class="p">(</span><span class="n">letters</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span> <span class="ow">or</span> <span class="n">letters</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1.0</span>

<span class="c1"># propagate one term</span>

<span class="k">def</span><span class="w"> </span><span class="nf">propagate</span><span class="p">(</span><span class="n">term_coeff</span><span class="p">,</span> <span class="n">term_letters</span><span class="p">,</span> <span class="n">lam</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="nb">complex</span><span class="p">(</span><span class="n">term_coeff</span><span class="p">)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">term_letters</span><span class="p">)</span>
    <span class="c1"># Step 6: E5 then CNOT04</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">E_dag_factor</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># Step 5: E4 then CNOT34</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">E_dag_factor</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># Step 4: E3 then CNOT23</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">E_dag_factor</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># Step 3: E2 then CNOT10</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">E_dag_factor</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># Step 2: E1 then CNOT12</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">E_dag_factor</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># Step 1: H1</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_H_on</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># expectation on |00000&gt;: nonzero only if Z/I only</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">L</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_A_G</span><span class="p">(</span><span class="n">lam</span><span class="p">):</span>
    <span class="n">A</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">letters</span> <span class="ow">in</span> <span class="n">Pacc_terms</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">+=</span> <span class="n">propagate</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">letters</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
    <span class="n">G</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">letters</span> <span class="ow">in</span> <span class="n">Pgood_terms</span><span class="p">:</span>
        <span class="n">G</span> <span class="o">+=</span> <span class="n">propagate</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">letters</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">G</span>

<span class="c1"># Check values</span>
<span class="k">for</span> <span class="n">lam</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]:</span>
    <span class="n">A</span><span class="p">,</span><span class="n">G</span> <span class="o">=</span> <span class="n">compute_A_G</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lam&#39;</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">G</span><span class="o">/</span><span class="n">A</span><span class="p">)</span> <span class="k">if</span> <span class="n">A</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1"># Fit polynomials in lam of degree &lt;= 5</span>
<span class="n">L_vals</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
<span class="n">A_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">compute_A_G</span><span class="p">(</span><span class="n">l</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">L_vals</span><span class="p">]</span>
<span class="n">G_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">compute_A_G</span><span class="p">(</span><span class="n">l</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">L_vals</span><span class="p">]</span>
<span class="n">Acoeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">L_vals</span><span class="p">,</span> <span class="n">A_vals</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">Gcoeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">L_vals</span><span class="p">,</span> <span class="n">G_vals</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Acoeff:&#39;</span><span class="p">,</span> <span class="n">Acoeff</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Gcoeff:&#39;</span><span class="p">,</span> <span class="n">Gcoeff</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Acoeff rational approx:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Acoeff</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Gcoeff rational approx:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Gcoeff</span><span class="p">])</span>

<span class="c1"># convert to p with lam = 1 - 16p/15</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">lam</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span><span class="o">*</span><span class="n">p</span>
<span class="n">A_poly</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">Fraction</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">))</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">))</span> <span class="o">*</span> <span class="n">lam</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">Acoeff</span><span class="p">)</span><span class="o">.</span><span class="n">c</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">G_poly</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">Fraction</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">))</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">))</span> <span class="o">*</span> <span class="n">lam</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">Gcoeff</span><span class="p">)</span><span class="o">.</span><span class="n">c</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">A_sym</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">A_poly</span><span class="p">))</span>
<span class="n">G_sym</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">G_poly</span><span class="p">))</span>
<span class="n">F_sym</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">factor</span><span class="p">(</span><span class="n">G_sym</span> <span class="o">/</span> <span class="n">A_sym</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A_sym(p)=&#39;</span><span class="p">,</span> <span class="n">A_sym</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;G_sym(p)=&#39;</span><span class="p">,</span> <span class="n">G_sym</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F_sym(p)=&#39;</span><span class="p">,</span> <span class="n">F_sym</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;series F to p^3:&#39;</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">F_sym</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#19</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>lam 1.0 A 0.5 G 1.0 F 2.0
lam 0.0 A 0.125 G 0.03125 F 0.25
lam 0.5 A 0.140625 G 0.0947265625 F 0.6736111111111112
Acoeff: [ 2.50000000e-01  1.25000000e-01  5.56209701e-14 -2.32498098e-14
  3.83333001e-15  1.25000000e-01]
Gcoeff: [6.56250000e-01 1.25000000e-01 9.37500000e-02 9.37500000e-02
 7.25642502e-16 3.12500000e-02]
Acoeff rational approx: [Fraction(1, 4), Fraction(1, 8), Fraction(0, 1), Fraction(0, 1), Fraction(0, 1), Fraction(1, 8)]
Gcoeff rational approx: [Fraction(21, 32), Fraction(1, 8), Fraction(3, 32), Fraction(3, 32), Fraction(0, 1), Fraction(1, 32)]
A_sym(p)= -262144*p**5/759375 + 90112*p**4/50625 - 4096*p**3/1125 + 832*p**2/225 - 28*p/15 + 1/2
G_sym(p)= -229376*p**5/253125 + 223232*p**4/50625 - 29312*p**3/3375 + 656*p**2/75 - 68*p/15 + 1
F_sym(p)= 6*(229376*p**5 - 1116160*p**4 + 2198400*p**3 - 2214000*p**2 + 1147500*p - 253125)/((8*p - 15)*(65536*p**4 - 215040*p**3 + 288000*p**2 - 162000*p + 50625))
series F to p^3: 2 - 8*p/5 - 736*p**2/225 - 3584*p**3/1125 + O(p**4)
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#20</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="n">pauli_map</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span><span class="n">I</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">X</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="n">Y</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span><span class="n">Z</span><span class="p">}</span>
<span class="n">paulis</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>

<span class="c1"># Build conjugation maps</span>
<span class="n">H_map</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
    <span class="n">Pin</span> <span class="o">=</span> <span class="n">pauli_map</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
    <span class="n">Pout</span> <span class="o">=</span> <span class="n">H</span> <span class="o">@</span> <span class="n">Pin</span> <span class="o">@</span> <span class="n">H</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">pauli_map</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Pout</span><span class="p">,</span> <span class="n">c</span><span class="o">*</span><span class="n">Q</span><span class="p">):</span>
                <span class="n">H_map</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">q</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">H_map</span><span class="p">:</span>
            <span class="k">break</span>

<span class="n">CNOT2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">CNOT_map</span><span class="o">=</span><span class="p">{}</span>
<span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
        <span class="n">Pin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">pauli_map</span><span class="p">[</span><span class="n">pc</span><span class="p">],</span><span class="n">pauli_map</span><span class="p">[</span><span class="n">pt</span><span class="p">])</span>
        <span class="n">Pout</span> <span class="o">=</span> <span class="n">CNOT2</span> <span class="o">@</span> <span class="n">Pin</span> <span class="o">@</span> <span class="n">CNOT2</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        <span class="k">for</span> <span class="n">qc</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">qt</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
                <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">pauli_map</span><span class="p">[</span><span class="n">qc</span><span class="p">],</span> <span class="n">pauli_map</span><span class="p">[</span><span class="n">qt</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Pout</span><span class="p">,</span> <span class="n">c</span><span class="o">*</span><span class="n">Q</span><span class="p">):</span>
                        <span class="n">CNOT_map</span><span class="p">[(</span><span class="n">pc</span><span class="p">,</span><span class="n">pt</span><span class="p">)]</span><span class="o">=</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">qc</span><span class="p">,</span><span class="n">qt</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span> <span class="ow">in</span> <span class="n">CNOT_map</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span> <span class="ow">in</span> <span class="n">CNOT_map</span><span class="p">:</span>
                <span class="k">break</span>

<span class="c1"># multiply table for building group terms</span>
<span class="n">mult_table</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">pauli_map</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">@</span> <span class="n">pauli_map</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">c</span><span class="o">*</span><span class="n">pauli_map</span><span class="p">[</span><span class="n">r</span><span class="p">]):</span>
                    <span class="n">mult_table</span><span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="n">mult_table</span><span class="p">:</span> <span class="k">break</span>


<span class="k">def</span><span class="w"> </span><span class="nf">multiply_strings</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">):</span>
        <span class="n">cb</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">mult_table</span><span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)]</span>
        <span class="n">c</span> <span class="o">*=</span> <span class="n">cb</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">out</span>

<span class="c1"># Projector terms</span>
<span class="n">Pacc_terms</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">anc</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="p">[</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="p">]:</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">8</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">]:</span>
            <span class="n">coeff</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">Pacc_terms</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">coeff</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="p">[</span><span class="n">anc</span><span class="p">]))</span>

<span class="n">Ggens</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">]</span> <span class="p">]</span>
<span class="n">Ptarget_terms_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">seen</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>
<span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">product</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">e</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">],</span> <span class="n">Ggens</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">c2</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">multiply_strings</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="n">coeff</span> <span class="o">*=</span> <span class="n">c2</span>
    <span class="n">seen</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="mi">0</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">coeff</span>
<span class="n">Ptarget_terms_data</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">coeff</span><span class="o">/</span><span class="mi">16</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">letters</span><span class="p">))</span> <span class="k">for</span> <span class="n">letters</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="n">seen</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">]</span>

<span class="n">Pgood_terms</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">anc</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">letters4</span> <span class="ow">in</span> <span class="n">Ptarget_terms_data</span><span class="p">:</span>
        <span class="n">Pgood_terms</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">coeff</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">letters4</span> <span class="o">+</span> <span class="p">[</span><span class="n">anc</span><span class="p">]))</span>

<span class="c1"># Conjugation primitives</span>

<span class="k">def</span><span class="w"> </span><span class="nf">conj_H_on</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
    <span class="n">letters</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">letters</span><span class="p">)</span>
    <span class="n">c</span><span class="p">,</span><span class="n">qlet</span> <span class="o">=</span> <span class="n">H_map</span><span class="p">[</span><span class="n">letters</span><span class="p">[</span><span class="n">q</span><span class="p">]]</span>
    <span class="n">letters</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span><span class="n">qlet</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">letters</span>

<span class="k">def</span><span class="w"> </span><span class="nf">conj_CNOT</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="n">c_idx</span><span class="p">,</span> <span class="n">t_idx</span><span class="p">):</span>
    <span class="n">letters</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">letters</span><span class="p">)</span>
    <span class="n">cphase</span><span class="p">,</span> <span class="n">qc</span><span class="p">,</span> <span class="n">qt</span> <span class="o">=</span> <span class="n">CNOT_map</span><span class="p">[(</span><span class="n">letters</span><span class="p">[</span><span class="n">c_idx</span><span class="p">],</span> <span class="n">letters</span><span class="p">[</span><span class="n">t_idx</span><span class="p">])]</span>
    <span class="n">letters</span><span class="p">[</span><span class="n">c_idx</span><span class="p">]</span><span class="o">=</span><span class="n">qc</span>
    <span class="n">letters</span><span class="p">[</span><span class="n">t_idx</span><span class="p">]</span><span class="o">=</span><span class="n">qt</span>
    <span class="k">return</span> <span class="n">cphase</span><span class="p">,</span> <span class="n">letters</span>


<span class="k">def</span><span class="w"> </span><span class="nf">E_dag_factor</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">lam</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">lam</span> <span class="k">if</span> <span class="p">(</span><span class="n">letters</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span> <span class="ow">or</span> <span class="n">letters</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1.0</span>

<span class="c1"># Correct order: U1‚Ä†, then E1‚Ä† then U2‚Ä†, then E2‚Ä† then U3‚Ä†, ...</span>

<span class="k">def</span><span class="w"> </span><span class="nf">propagate</span><span class="p">(</span><span class="n">term_coeff</span><span class="p">,</span> <span class="n">term_letters</span><span class="p">,</span> <span class="n">lam</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="nb">complex</span><span class="p">(</span><span class="n">term_coeff</span><span class="p">)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">term_letters</span><span class="p">)</span>
    <span class="c1"># 1) U1‚Ä† = H1</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_H_on</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># 2) E1‚Ä† on (1,2) then U2‚Ä† = CNOT12</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">E_dag_factor</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># 3) E2‚Ä† on (1,0) then U3‚Ä† = CNOT10</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">E_dag_factor</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># 4) E3‚Ä† on (2,3) then U4‚Ä† = CNOT23</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">E_dag_factor</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># 5) E4‚Ä† on (3,4) then U5‚Ä† = CNOT34</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">E_dag_factor</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># 6) E5‚Ä† on (0,4) then U6‚Ä† = CNOT04</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">E_dag_factor</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># expectation on |00000&gt;</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">L</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_A_G</span><span class="p">(</span><span class="n">lam</span><span class="p">):</span>
    <span class="n">A</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">letters</span> <span class="ow">in</span> <span class="n">Pacc_terms</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">+=</span> <span class="n">propagate</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">letters</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
    <span class="n">G</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">letters</span> <span class="ow">in</span> <span class="n">Pgood_terms</span><span class="p">:</span>
        <span class="n">G</span> <span class="o">+=</span> <span class="n">propagate</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">letters</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">G</span>

<span class="k">for</span> <span class="n">lam</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]:</span>
    <span class="n">A</span><span class="p">,</span><span class="n">G</span> <span class="o">=</span> <span class="n">compute_A_G</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lam&#39;</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">G</span><span class="o">/</span><span class="n">A</span><span class="p">)</span> <span class="k">if</span> <span class="n">A</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1"># Fit polynomials</span>
<span class="n">L_vals</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
<span class="n">A_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">compute_A_G</span><span class="p">(</span><span class="n">l</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">L_vals</span><span class="p">]</span>
<span class="n">G_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">compute_A_G</span><span class="p">(</span><span class="n">l</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">L_vals</span><span class="p">]</span>
<span class="n">Acoeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">L_vals</span><span class="p">,</span> <span class="n">A_vals</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">Gcoeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">L_vals</span><span class="p">,</span> <span class="n">G_vals</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Acoeff:&#39;</span><span class="p">,</span> <span class="n">Acoeff</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Gcoeff:&#39;</span><span class="p">,</span> <span class="n">Gcoeff</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Acoeff rational approx:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Acoeff</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Gcoeff rational approx:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Gcoeff</span><span class="p">])</span>

<span class="c1"># Convert to p</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">lam</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span><span class="o">*</span><span class="n">p</span>
<span class="n">A_poly</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">Fraction</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">))</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">))</span> <span class="o">*</span> <span class="n">lam</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">Acoeff</span><span class="p">)</span><span class="o">.</span><span class="n">c</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">G_poly</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="n">Fraction</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">))</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">))</span> <span class="o">*</span> <span class="n">lam</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">Gcoeff</span><span class="p">)</span><span class="o">.</span><span class="n">c</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">A_sym</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">A_poly</span><span class="p">))</span>
<span class="n">G_sym</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">G_poly</span><span class="p">))</span>
<span class="n">F_sym</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">factor</span><span class="p">(</span><span class="n">G_sym</span> <span class="o">/</span> <span class="n">A_sym</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A_sym(p)=&#39;</span><span class="p">,</span> <span class="n">A_sym</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;G_sym(p)=&#39;</span><span class="p">,</span> <span class="n">G_sym</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F_sym(p)=&#39;</span><span class="p">,</span> <span class="n">F_sym</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;series F to p^3:&#39;</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">F_sym</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#21</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>lam 1.0 A 0.25 G 0.25 F 1.0
lam 0.0 A 0.125 G 0.03125 F 0.25
lam 0.5 A 0.15625 G 0.048828125 F 0.3125
Acoeff: [ 1.88379101e-15 -5.30289398e-15  6.16160601e-15  1.25000000e-01
  6.00522140e-16  1.25000000e-01]
Gcoeff: [6.25000000e-02 1.25000000e-01 1.53657775e-14 3.12500000e-02
 8.42049846e-16 3.12500000e-02]
Acoeff rational approx: [Fraction(0, 1), Fraction(0, 1), Fraction(0, 1), Fraction(1, 8), Fraction(0, 1), Fraction(1, 8)]
Gcoeff rational approx: [Fraction(1, 16), Fraction(1, 8), Fraction(0, 1), Fraction(1, 32), Fraction(0, 1), Fraction(1, 32)]
A_sym(p)= 32*p**2/225 - 4*p/15 + 1/4
G_sym(p)= -65536*p**5/759375 + 28672*p**4/50625 - 512*p**3/375 + 8*p**2/5 - 14*p/15 + 1/4
F_sym(p)= (-262144*p**5 + 1720320*p**4 - 4147200*p**3 + 4860000*p**2 - 2835000*p + 759375)/(3375*(128*p**2 - 240*p + 225))
series F to p^3: 1 - 8*p/3 + 224*p**2/75 - 512*p**3/675 + O(p**4)
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#22</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>
<span class="n">p</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">262144</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">5</span> <span class="o">+</span> <span class="mi">1720320</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">4</span> <span class="o">-</span> <span class="mi">4147200</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">4860000</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2835000</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="mi">759375</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">3375</span><span class="o">*</span><span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">240</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="mi">225</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F factorized:&#39;</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">factor</span><span class="p">(</span><span class="n">F</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F simplified rational:&#39;</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">together</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">F</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Partial fraction:&#39;</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">apart</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#23</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="nx">F</span><span class="w"> </span><span class="nx">factorized</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="mi">262144</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1720320</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4147200</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">4860000</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2835000</span><span class="o">*</span><span class="nx">p</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">759375</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">3375</span><span class="o">*</span><span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">240</span><span class="o">*</span><span class="nx">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">225</span><span class="p">))</span>
<span class="nx">F</span><span class="w"> </span><span class="nx">simplified</span><span class="w"> </span><span class="nx">rational</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="mi">262144</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1720320</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">4147200</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4860000</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2835000</span><span class="o">*</span><span class="nx">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">759375</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">3375</span><span class="o">*</span><span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">240</span><span class="o">*</span><span class="nx">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">225</span><span class="p">))</span>
<span class="nx">Partial</span><span class="w"> </span><span class="nx">fraction</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="mi">2048</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">3375</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">128</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">45</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">16</span><span class="o">*</span><span class="nx">p</span><span class="o">/</span><span class="mi">5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">15</span><span class="o">*</span><span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="nx">p</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">45</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="nx">p</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">240</span><span class="o">*</span><span class="nx">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">225</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span>
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#24</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>
<span class="n">p</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">lam</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;lam&#39;</span><span class="p">,</span> <span class="n">real</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">F_lam</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">lam</span><span class="o">**</span><span class="mi">5</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">lam</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="n">lam</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">lam</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<span class="n">F_p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">F_lam</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F_p expanded:&#39;</span><span class="p">,</span> <span class="n">F_p</span><span class="p">)</span>
<span class="c1"># Compare with previous F expression</span>
<span class="n">F_prev</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">262144</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">5</span> <span class="o">+</span> <span class="mi">1720320</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">4</span> <span class="o">-</span> <span class="mi">4147200</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">4860000</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2835000</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="mi">759375</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">3375</span><span class="o">*</span><span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">240</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="mi">225</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Are they equal?&#39;</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">F_p</span> <span class="o">-</span> <span class="n">F_prev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Series up to p^3:&#39;</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">F_p</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#25</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>F_p expanded: (-262144*p**5 + 1720320*p**4 - 4147200*p**3 + 4860000*p**2 - 2835000*p + 759375)/(3375*(128*p**2 - 240*p + 225))
Are they equal? True
Series up to p^3: 1 - 8*p/3 + 224*p**2/75 - 512*p**3/675 + O(p**4)
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#26</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">pauli_map</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span><span class="n">I</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">X</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="n">Y</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span><span class="n">Z</span><span class="p">}</span>
<span class="n">paulis</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>

<span class="c1"># conj maps</span>
<span class="n">H_map</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
    <span class="n">Pin</span> <span class="o">=</span> <span class="n">pauli_map</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
    <span class="n">Pout</span> <span class="o">=</span> <span class="n">H</span> <span class="o">@</span> <span class="n">Pin</span> <span class="o">@</span> <span class="n">H</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">pauli_map</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Pout</span><span class="p">,</span> <span class="n">c</span><span class="o">*</span><span class="n">Q</span><span class="p">):</span>
                <span class="n">H_map</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">q</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">H_map</span><span class="p">:</span> <span class="k">break</span>

<span class="n">CNOT2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">CNOT_map</span><span class="o">=</span><span class="p">{}</span>
<span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
        <span class="n">Pin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">pauli_map</span><span class="p">[</span><span class="n">pc</span><span class="p">],</span><span class="n">pauli_map</span><span class="p">[</span><span class="n">pt</span><span class="p">])</span>
        <span class="n">Pout</span><span class="o">=</span><span class="n">CNOT2</span> <span class="o">@</span> <span class="n">Pin</span> <span class="o">@</span> <span class="n">CNOT2</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        <span class="k">for</span> <span class="n">qc</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">qt</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
                <span class="n">Q</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">pauli_map</span><span class="p">[</span><span class="n">qc</span><span class="p">],</span><span class="n">pauli_map</span><span class="p">[</span><span class="n">qt</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Pout</span><span class="p">,</span> <span class="n">c</span><span class="o">*</span><span class="n">Q</span><span class="p">):</span>
                        <span class="n">CNOT_map</span><span class="p">[(</span><span class="n">pc</span><span class="p">,</span><span class="n">pt</span><span class="p">)]</span><span class="o">=</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">qc</span><span class="p">,</span><span class="n">qt</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span> <span class="ow">in</span> <span class="n">CNOT_map</span><span class="p">:</span> <span class="k">break</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span> <span class="ow">in</span> <span class="n">CNOT_map</span><span class="p">:</span> <span class="k">break</span>


<span class="c1"># acceptance terms</span>
<span class="n">Pacc_terms</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">anc</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="p">[</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="p">]:</span>
        <span class="n">coeff</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">8</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">]:</span>
            <span class="n">coeff</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">Pacc_terms</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">coeff</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="p">[</span><span class="n">anc</span><span class="p">]))</span>

<span class="c1"># propagation with count m of hits of E‚Ä†</span>

<span class="k">def</span><span class="w"> </span><span class="nf">conj_H</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">q</span><span class="p">):</span>
    <span class="n">c</span><span class="p">,</span> <span class="n">qlet</span> <span class="o">=</span> <span class="n">H_map</span><span class="p">[</span><span class="n">L</span><span class="p">[</span><span class="n">q</span><span class="p">]]</span>
    <span class="n">L</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
    <span class="n">L</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span><span class="n">qlet</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span>

<span class="k">def</span><span class="w"> </span><span class="nf">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">cq</span><span class="p">,</span><span class="n">tq</span><span class="p">):</span>
    <span class="n">cphase</span><span class="p">,</span> <span class="n">qc</span><span class="p">,</span> <span class="n">qt</span> <span class="o">=</span> <span class="n">CNOT_map</span><span class="p">[(</span><span class="n">L</span><span class="p">[</span><span class="n">cq</span><span class="p">],</span> <span class="n">L</span><span class="p">[</span><span class="n">tq</span><span class="p">])]</span>
    <span class="n">L</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
    <span class="n">L</span><span class="p">[</span><span class="n">cq</span><span class="p">]</span><span class="o">=</span><span class="n">qc</span>
    <span class="n">L</span><span class="p">[</span><span class="n">tq</span><span class="p">]</span><span class="o">=</span><span class="n">qt</span>
    <span class="k">return</span> <span class="n">cphase</span><span class="p">,</span> <span class="n">L</span>


<span class="k">def</span><span class="w"> </span><span class="nf">propagate_counts</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="nb">complex</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># 1) U1‚Ä† = H1</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_H</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># 2) E1‚Ä† on (1,2), then CNOT12</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span> <span class="ow">or</span> <span class="n">L</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">):</span> <span class="n">m</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># 3) E2‚Ä† on (1,0), then CNOT10</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span> <span class="ow">or</span> <span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">):</span> <span class="n">m</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># 4) E3‚Ä† on (2,3), then CNOT23</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">L</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span> <span class="ow">or</span> <span class="n">L</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">):</span> <span class="n">m</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># 5) E4‚Ä† on (3,4), then CNOT34</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">L</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span> <span class="ow">or</span> <span class="n">L</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">):</span> <span class="n">m</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># 6) E5‚Ä† on (0,4), then CNOT04</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span> <span class="ow">or</span> <span class="n">L</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">):</span> <span class="n">m</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">m</span>

<span class="n">survivors</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">letters</span> <span class="ow">in</span> <span class="n">Pacc_terms</span><span class="p">:</span>
    <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">propagate_counts</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span><span class="n">letters</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">L</span><span class="p">):</span>
        <span class="n">survivors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">letters</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;num survivors:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">survivors</span><span class="p">))</span>
<span class="k">for</span> <span class="n">init</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">survivors</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="s1">&#39;-&gt; final&#39;</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="s1">&#39; coefficient&#39;</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="s1">&#39;m=&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#27</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="n">num</span><span class="w"> </span><span class="n">survivors</span><span class="o">:</span><span class="w"> </span><span class="mi">2</span>
<span class="n">init</span><span class="w"> </span><span class="p">[</span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;I&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">final</span><span class="w"> </span><span class="p">[</span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;I&#39;</span><span class="p">]</span><span class="w">  </span><span class="n">coefficient</span><span class="w"> </span><span class="p">(</span><span class="mf">0.125</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">init</span><span class="w"> </span><span class="p">[</span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Z&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">final</span><span class="w"> </span><span class="p">[</span><span class="s">&#39;Z&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Z&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Z&#39;</span><span class="p">]</span><span class="w">  </span><span class="n">coefficient</span><span class="w"> </span><span class="p">(</span><span class="mf">0.125</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="n">m</span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#28</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>
<span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">],[</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="n">pauli_map</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span><span class="n">I</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">X</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="n">Y</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span><span class="n">Z</span><span class="p">}</span>
<span class="n">paulis</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>
<span class="c1"># conj maps</span>
<span class="n">H_map</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
    <span class="n">Pin</span> <span class="o">=</span> <span class="n">pauli_map</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
    <span class="n">Pout</span> <span class="o">=</span> <span class="n">H</span> <span class="o">@</span> <span class="n">Pin</span> <span class="o">@</span> <span class="n">H</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">pauli_map</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Pout</span><span class="p">,</span> <span class="n">c</span><span class="o">*</span><span class="n">Q</span><span class="p">):</span>
                <span class="n">H_map</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">q</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">H_map</span><span class="p">:</span> <span class="k">break</span>

<span class="n">CNOT2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">CNOT_map</span><span class="o">=</span><span class="p">{}</span>
<span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
        <span class="n">Pin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">pauli_map</span><span class="p">[</span><span class="n">pc</span><span class="p">],</span><span class="n">pauli_map</span><span class="p">[</span><span class="n">pt</span><span class="p">])</span>
        <span class="n">Pout</span><span class="o">=</span><span class="n">CNOT2</span> <span class="o">@</span> <span class="n">Pin</span> <span class="o">@</span> <span class="n">CNOT2</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        <span class="k">for</span> <span class="n">qc</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">qt</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
                <span class="n">Q</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">pauli_map</span><span class="p">[</span><span class="n">qc</span><span class="p">],</span> <span class="n">pauli_map</span><span class="p">[</span><span class="n">qt</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Pout</span><span class="p">,</span> <span class="n">c</span><span class="o">*</span><span class="n">Q</span><span class="p">):</span>
                        <span class="n">CNOT_map</span><span class="p">[(</span><span class="n">pc</span><span class="p">,</span><span class="n">pt</span><span class="p">)]</span><span class="o">=</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">qc</span><span class="p">,</span><span class="n">qt</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span> <span class="ow">in</span> <span class="n">CNOT_map</span><span class="p">:</span> <span class="k">break</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span> <span class="ow">in</span> <span class="n">CNOT_map</span><span class="p">:</span> <span class="k">break</span>

<span class="c1"># group for P_target</span>
<span class="n">mult_table</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">pauli_map</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">@</span> <span class="n">pauli_map</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">paulis</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">c</span><span class="o">*</span><span class="n">pauli_map</span><span class="p">[</span><span class="n">r</span><span class="p">]):</span>
                    <span class="n">mult_table</span><span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="n">mult_table</span><span class="p">:</span> <span class="k">break</span>


<span class="k">def</span><span class="w"> </span><span class="nf">multiply_strings</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">):</span>
        <span class="n">cb</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">mult_table</span><span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)]</span>
        <span class="n">c</span> <span class="o">*=</span> <span class="n">cb</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">out</span>

<span class="n">Ggens</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">]</span> <span class="p">]</span>

<span class="n">Ptarget_terms_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">seen</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">product</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">e</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">],</span> <span class="n">Ggens</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">c2</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">multiply_strings</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="n">coeff</span> <span class="o">*=</span> <span class="n">c2</span>
    <span class="n">seen</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="mi">0</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">coeff</span>
<span class="n">Ptarget_terms_data</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">coeff</span><span class="o">/</span><span class="mi">16</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">letters</span><span class="p">))</span> <span class="k">for</span> <span class="n">letters</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="n">seen</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">]</span>

<span class="c1"># P_good terms include anc=I and anc=Z factors of 1/2</span>
<span class="n">Pgood_terms</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">anc</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">letters4</span> <span class="ow">in</span> <span class="n">Ptarget_terms_data</span><span class="p">:</span>
        <span class="n">Pgood_terms</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">coeff</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">letters4</span> <span class="o">+</span> <span class="p">[</span><span class="n">anc</span><span class="p">]))</span>

<span class="c1"># Propagate function returning survivors and m counts</span>

<span class="k">def</span><span class="w"> </span><span class="nf">conj_H</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">q</span><span class="p">):</span>
    <span class="n">c</span><span class="p">,</span><span class="n">qlet</span><span class="o">=</span><span class="n">H_map</span><span class="p">[</span><span class="n">L</span><span class="p">[</span><span class="n">q</span><span class="p">]]</span>
    <span class="n">L</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
    <span class="n">L</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span><span class="n">qlet</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span>

<span class="k">def</span><span class="w"> </span><span class="nf">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">cq</span><span class="p">,</span><span class="n">tq</span><span class="p">):</span>
    <span class="n">cphase</span><span class="p">,</span> <span class="n">qc</span><span class="p">,</span> <span class="n">qt</span> <span class="o">=</span> <span class="n">CNOT_map</span><span class="p">[(</span><span class="n">L</span><span class="p">[</span><span class="n">cq</span><span class="p">],</span> <span class="n">L</span><span class="p">[</span><span class="n">tq</span><span class="p">])]</span>
    <span class="n">L</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
    <span class="n">L</span><span class="p">[</span><span class="n">cq</span><span class="p">]</span><span class="o">=</span><span class="n">qc</span>
    <span class="n">L</span><span class="p">[</span><span class="n">tq</span><span class="p">]</span><span class="o">=</span><span class="n">qt</span>
    <span class="k">return</span> <span class="n">cphase</span><span class="p">,</span> <span class="n">L</span>


<span class="k">def</span><span class="w"> </span><span class="nf">propagate_counts</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
    <span class="n">c</span><span class="o">=</span><span class="nb">complex</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>
    <span class="n">m</span><span class="o">=</span><span class="mi">0</span>
    <span class="c1"># 1) H1</span>
    <span class="n">c1</span><span class="p">,</span><span class="n">L</span> <span class="o">=</span> <span class="n">conj_H</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># 2) E1 on (1,2), CNOT12</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span> <span class="ow">or</span> <span class="n">L</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">):</span> <span class="n">m</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># 3) E2 on (1,0), CNOT10</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span> <span class="ow">or</span> <span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">):</span> <span class="n">m</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># 4) E3 on (2,3), CNOT23</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">L</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span> <span class="ow">or</span> <span class="n">L</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">):</span> <span class="n">m</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># 5) E4 on (3,4), CNOT34</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">L</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span> <span class="ow">or</span> <span class="n">L</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">):</span> <span class="n">m</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="c1"># 6) E5 on (0,4), CNOT04</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span> <span class="ow">or</span> <span class="n">L</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">):</span> <span class="n">m</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">conj_CNOT</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">*=</span> <span class="n">c1</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">m</span>

<span class="n">survivors</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">L</span> <span class="ow">in</span> <span class="n">Pgood_terms</span><span class="p">:</span>
    <span class="n">c</span><span class="p">,</span> <span class="n">Lf</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">propagate_counts</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">Lf</span><span class="p">):</span>
        <span class="n">survivors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">L</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">Lf</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;num survivors:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">survivors</span><span class="p">))</span>
<span class="c1"># Print unique m &amp; initial patterns summary</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>
<span class="n">ms</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">([</span><span class="n">m</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="n">survivors</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;m counts:&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
<span class="c1"># Sum contributions per m</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">isclose</span>
<span class="n">S</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">msum</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">init</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">Lf</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">survivors</span><span class="p">:</span>
    <span class="n">S</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
    <span class="n">msum</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">msum</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sum contrib =&#39;</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;by m:&#39;</span><span class="p">,</span> <span class="n">msum</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#29</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>num survivors: 8
m counts: Counter({4: 4, 5: 2, 0: 1, 2: 1})
sum contrib = 0.25
by m: {0: 0.03125, 4: 0.125, 2: 0.03125, 5: 0.0625}
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#30</span>
    </div>
    <div class="content markdown-body"><p>1) Step-by-Step Derivation</p>
<p>Goal and model
- We prepare the logical |00‚ü©AB of the [[4,2,2]] code using the circuit
  U = CNOT04 ¬∑ CNOT34 ¬∑ CNOT23 ¬∑ CNOT10 ¬∑ CNOT12 ¬∑ H1,
  with a two-qubit depolarizing channel after each CNOT (five CNOTs total). We post-select on
  (i) the ancilla (qubit 4) measuring |0‚ü© and
  (ii) passing both code stabilizer checks XXXX = +1 and ZZZZ = +1 on the data qubits 0‚Äì3.
- The two-qubit depolarizing channel applied to the pair (i,j) is
  E(œÅ) = (1 ‚àí p)œÅ + (p/15) ‚àëP‚â†I (P œÅ P),
  where the sum is over the 15 non-identity two-qubit Paulis on that pair. This is the standard 2-qubit Pauli-depolarizing model. (<a href="https://quantumcomputing.stackexchange.com/questions/39626/what-is-the-operator-sum-representation-of-the-two-qubit-depolarizing-channel?utm_source=openai">quantumcomputing.stackexchange.com</a>, <a href="https://en.wikipedia.org/wiki/Quantum_depolarizing_channel?utm_source=openai">en.wikipedia.org</a>)</p>
<p>Projectors for post-selection and the target logical state
- Codespace projector on data (qubits 0‚Äì3):
  Œ†code = 1/4 (I + XXXX)(I + ZZZZ) = 1/4 (I + XXXX + ZZZZ ‚àí YYYY).
  This is the usual stabilizer-projector identity Œ†S = 2‚àím ‚àëS‚ààS S (here m=2). (<a href="https://arthurpesah.me/blog/2023-03-16-stabilizer-formalism-2/?utm_source=openai">arthurpesah.me</a>)
- Ancilla post-selection projector:
  Œ†anc,0 = (I + Z4)/2. (<a href="https://en.wikipedia.org/wiki/Parity_measurement?utm_source=openai">en.wikipedia.org</a>)
- Overall acceptance operator:
  Pacc = Œ†anc,0 ‚äó Œ†code.
- Logical |00‚ü©AB is stabilized by XXXX, ZZZZ (the code stabilizers) and Z_A = ZZII, Z_B = ZIZI with +1 eigenvalues (given in the problem). Its projector is
  Œ†|00‚ü© = 1/16 ‚àëg‚àà‚ü®XXXX, ZZZZ, Z_A, Z_B‚ü© g
  on the data qubits. Thus the ‚Äúgood‚Äù operator used in the numerator is
  Pgood = Œ†anc,0 ‚äó Œ†|00‚ü©.</p>
<p>Heisenberg-picture evaluation with the Pauli transfer eigenvalue
- For any two-qubit depolarizing channel acting on a given pair, every non-identity Pauli on that pair is an eigen-operator of the adjoint channel E‚Ä† with the same eigenvalue
  Œª = 1 ‚àí 16p/15.
  Reason: among the 15 non-identity Paulis, 7 commute and 8 anticommute with a fixed non-identity Pauli Q on the pair, hence ‚àëP‚â†I P Q P = (7‚àí8) Q = ‚àíQ, so
  E(Q) = (1‚àíp)Q + (p/15)(‚àíQ) = (1 ‚àí 16p/15) Q and E‚Ä† = E for a Pauli channel. (<a href="https://quantumcomputing.stackexchange.com/questions/39626/what-is-the-operator-sum-representation-of-the-two-qubit-depolarizing-channel?utm_source=openai">quantumcomputing.stackexchange.com</a>)
- Conjugation of Pauli operators by the gates is Clifford:
  H X H = Z, H Z H = X, H Y H = ‚àíY, and for CNOTc‚Üít:
  Xc ‚Üí Xc Xt, Zt ‚Üí Zc Zt, while Xt ‚Üí Xt, Zc ‚Üí Zc. (<a href="https://en.wikipedia.org/wiki/Clifford_gate?utm_source=openai">en.wikipedia.org</a>)
- We compute (linearly) the two probabilities
  A(p) = Tr[Pacc ¬∑ œÅout],    G(p) = Tr[Pgood ¬∑ œÅout],
  with œÅout = (E5 ‚àò UCNOT04) ‚àò ¬∑¬∑¬∑ ‚àò (E1 ‚àò UCNOT12) ‚àò UH1 (|00000‚ü©‚ü®00000|).
  In the Heisenberg picture, this is Tr[ œÅin ¬∑ O(Œª) ] with O(Œª) = U1‚Ä† ‚àò (E1‚Ä†) ‚àò U2‚Ä† ‚àò (E2‚Ä†) ‚àò ‚Ä¶ ‚àò U6‚Ä† ‚àò (E5‚Ä†) (P), where œÅin = |00000‚ü©‚ü®00000| and P is Pacc or Pgood.
- Because Clifford conjugation maps Paulis to Paulis, and E‚Ä† multiplies any term that is non-identity on the acted pair by Œª, the operator O(Œª) becomes a weighted Pauli sum. Only terms that are Z/I on every qubit have nonzero expectation on |00000‚ü©, where ‚ü®0|Z|0‚ü© = 1 and ‚ü®0|X|0‚ü© = ‚ü®0|Y|0‚ü© = 0.</p>
<p>Carrying out the (finite) Pauli bookkeeping
- Acceptance A(Œª): expanding Pacc = (1/8)(I + Z4) ‚äó (I + XXXX + ZZZZ ‚àí YYYY) and propagating each Pauli term backward (using the rules above), only two terms survive on |00000‚ü©; one accrues zero factors of Œª and one accrues two factors. The result is
  A(Œª) = (1 + Œª^2)/8.
- Good probability G(Œª): expanding Pgood = (1/2)(I + Z4) ‚äó (1/16)‚àëg (data g), eight terms survive; they accrue 0, 2, 4, or 5 factors of Œª with respective weights. The sum is
  G(Œª) = (1/32) + (1/32)Œª^2 + (1/8)Œª^4 + (1/16)Œª^5.
- Therefore the post-selected logical fidelity is
  Flogical(p) = G(Œª)/A(Œª),  with Œª = 1 ‚àí 16p/15.</p>
<p>Closed forms
- In terms of Œª:
  Flogical(Œª) = [2 Œª^5 + 4 Œª^4 + Œª^2 + 1] / [4 (1 + Œª^2)].
- In terms of p (substitute Œª = 1 ‚àí 16p/15) and simplify:
  Flogical(p) = [‚àí262144 p^5 + 1720320 p^4 ‚àí 4147200 p^3 + 4860000 p^2 ‚àí 2835000 p + 759375] / [3375 (128 p^2 ‚àí 240 p + 225)].
- Small‚Äëp expansion:
  Flogical(p) = 1 ‚àí (8/3) p + (224/75) p^2 ‚àí (512/675) p^3 + O(p^4).</p>
<p>Remarks
- The calculation uses only Clifford conjugation identities and that the two‚Äëqubit depolarizing channel multiplies any nontrivial Pauli on the acted pair by Œª = 1 ‚àí 16p/15. (<a href="https://en.wikipedia.org/wiki/Clifford_gate?utm_source=openai">en.wikipedia.org</a>, <a href="https://quantumcomputing.stackexchange.com/questions/39626/what-is-the-operator-sum-representation-of-the-two-qubit-depolarizing-channel?utm_source=openai">quantumcomputing.stackexchange.com</a>)
- Œ†code and Œ†|00‚ü© are standard stabilizer projectors. (<a href="https://arthurpesah.me/blog/2023-03-16-stabilizer-formalism-2/?utm_source=openai">arthurpesah.me</a>)
- Œ†anc,0 implements a ZZ‚Äëparity‚Äëtype post‚Äëselection with an ancilla readout. (<a href="https://en.wikipedia.org/wiki/Parity_measurement?utm_source=openai">en.wikipedia.org</a>)</p>
<p>2) Mathematical Identities Used
- Stabilizer projector: Œ†S = 2‚àím ‚àëS‚ààS S; product form Œ†S = ‚àèi (I + Si)/2. (<a href="https://arthurpesah.me/blog/2023-03-16-stabilizer-formalism-2/?utm_source=openai">arthurpesah.me</a>)
- Clifford conjugation (Hadamard, CNOT) on Paulis. (<a href="https://en.wikipedia.org/wiki/Clifford_gate?utm_source=openai">en.wikipedia.org</a>)
- Two‚Äëqubit depolarizing acts as E‚Ä†(Q) = Œª Q on any non‚Äëidentity Pauli Q on the noisy pair, with Œª = 1 ‚àí 16p/15. (<a href="https://quantumcomputing.stackexchange.com/questions/39626/what-is-the-operator-sum-representation-of-the-two-qubit-depolarizing-channel?utm_source=openai">quantumcomputing.stackexchange.com</a>)</p>
<p>3) Conventions and Units
- Fidelity with a pure target is F = ‚ü®œàtarget| œÅ |œàtarget‚ü©; here we compute it conditionally on acceptance.
- Error rate p is the probability that a given CNOT is followed by a uniformly random non-identity two‚Äëqubit Pauli.</p>
<p>4) Final Answer:
Let Œª = 1 ‚àí (16/15) p. The logical state fidelity (post‚Äëselected on all detectable code errors and ancilla outcome |0‚ü©) is
Flogical(p) = [2 Œª^5 + 4 Œª^4 + Œª^2 + 1] / [4 (1 + Œª^2)]
= [‚àí262144 p^5 + 1720320 p^4 ‚àí 4147200 p^3 + 4860000 p^2 ‚àí 2835000 p + 759375] / [3375 (128 p^2 ‚àí 240 p + 225)].</p></div>
</article>


<article class="message role-user">
    <div class="meta">
        <span class="badge">User</span>
        <span class="idx">#31</span>
    </div>
    <div class="content markdown-body"><p>Populate your final answer into the code template provided below. This step is purely for formatting/display purposes. No additional reasoning or derivation should be performed. Do not import any modules or packages beyond what is provided in the template.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">answer</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the expression of the logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    at the end of the circuit as a function of two-qubit gate error rate $p$.</span>

<span class="sd">    Inputs</span>
<span class="sd">    ----------</span>
<span class="sd">    p: sympy.Symbol, two-qubit gate error rate, $p$</span>

<span class="sd">    Outputs</span>
<span class="sd">    ----------</span>
<span class="sd">    F_logical: sympy.Expr, logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------ FILL IN YOUR RESULTS BELOW ------------------</span>
    <span class="n">F_logical</span> <span class="o">=</span> <span class="o">...</span>  <span class="c1"># a SymPy expression of inputs</span>
    <span class="c1"># ---------------------------------------------------------------</span>

    <span class="k">return</span> <span class="n">F_logical</span>
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#32</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">answer</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the expression of the logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    at the end of the circuit as a function of two-qubit gate error rate $p$.</span>

<span class="sd">    Inputs</span>
<span class="sd">    ----------</span>
<span class="sd">    p: sympy.Symbol, two-qubit gate error rate, $p$</span>

<span class="sd">    Outputs</span>
<span class="sd">    ----------</span>
<span class="sd">    F_logical: sympy.Expr, logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------ FILL IN YOUR RESULTS BELOW ------------------</span>
    <span class="n">lam</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span>
    <span class="n">F_logical</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">lam</span><span class="o">**</span><span class="mi">5</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">lam</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="n">lam</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">lam</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="c1"># ---------------------------------------------------------------</span>

    <span class="k">return</span> <span class="n">F_logical</span>
</code></pre></div></div>
</article>

</div>

<footer>
  Generated at 2025-09-24T22:02:12.028857
</footer>

<script>
(function() {
  // Tabs
  const tabs = document.querySelectorAll('.tab');
  const panels = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      panels.forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      const target = document.querySelector(tab.dataset.target);
      if (target) target.classList.add('active');
    });
  });

  // Theme toggle
  const toggleBtn = document.getElementById('theme-toggle');
  function setTheme(dark) {
    if (dark) {
      document.documentElement.classList.add('dark');
      localStorage.setItem('dark', '1');
    } else {
      document.documentElement.classList.remove('dark');
      localStorage.setItem('dark', '0');
    }
  }
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const stored = localStorage.getItem('dark');
  setTheme(stored === null ? prefersDark : stored === '1');

  toggleBtn.addEventListener('click', () => {
    const isDark = document.documentElement.classList.contains('dark');
    setTheme(!isDark);
  });
})();
</script>
</body>
</html>