<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Challenge</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.codehilite .hll { background-color: #ffffcc }
.codehilite { background: #f8f8f8; }
.codehilite .c { color: #3D7B7B; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #F00 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666 } /* Operator */
.codehilite .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #9C6500 } /* Comment.Preproc */
.codehilite .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.codehilite .gr { color: #E40000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #008400 } /* Generic.Inserted */
.codehilite .go { color: #717171 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #04D } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #687822 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #00F; font-weight: bold } /* Name.Class */
.codehilite .no { color: #800 } /* Name.Constant */
.codehilite .nd { color: #A2F } /* Name.Decorator */
.codehilite .ni { color: #717171; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #00F } /* Name.Function */
.codehilite .nl { color: #767600 } /* Name.Label */
.codehilite .nn { color: #00F; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #A2F; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #BBB } /* Text.Whitespace */
.codehilite .mb { color: #666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666 } /* Literal.Number.Float */
.codehilite .mh { color: #666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666 } /* Literal.Number.Oct */
.codehilite .sa { color: #BA2121 } /* Literal.String.Affix */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .dl { color: #BA2121 } /* Literal.String.Delimiter */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #A45A77 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #00F } /* Name.Function.Magic */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .vm { color: #19177C } /* Name.Variable.Magic */
.codehilite .il { color: #666 } /* Literal.Number.Integer.Long */

</style>
<style>
    :root {
  --bg: #ffffff;
  --fg: #222222;
  --muted: #555555;
  --border: #e0e0e0;
  --accent: #005fcc;
  --code-bg: #f6f8fa;
  --role-user: #0ea5e9;
  --role-assistant: #22c55e;
  --role-system: #9ca3af;
  --return-code: #a35291;
}
html.dark {
  --bg: #0b0b0b;
  --fg: #e8e8e8;
  --muted: #a0a0a0;
  --border: #333333;
  --accent: #3b82f6;
  --code-bg: #111827;
  --role-user: #0ea5e9;
  --role-assistant: #22c55e;
  --role-system: #9ca3af;
  --return-code: #a35291;
}
* {
  box-sizing: border-box;
}
body {
  margin: 0;
  padding: 0;
  background: var(--bg);
  color: var(--fg);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", sans-serif;
  line-height: 1.6;
}
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 1.25rem;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  background: var(--bg);
  z-index: 10;
}
h1 {
  margin: 0;
  font-size: 1.1rem;
}
.tabs {
  display: flex;
  gap: 0.5rem;
}
.tab {
  padding: 0.4rem 0.8rem;
  border: 1px solid var(--border);
  border-bottom: none;
  background: transparent;
  cursor: pointer;
  border-radius: 6px 6px 0 0;
  color: var(--fg);
}
.tab.active {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}
.tab-content {
  display: none;
  padding: 1rem 1.25rem;
  border-top: 1px solid var(--border);
}
.tab-content.active {
  display: block;
}
#theme-toggle {
  border: 1px solid var(--border);
  padding: 0.2rem 0.6rem;
  font-size: 0.9rem;
  border-radius: 4px;
  cursor: pointer;
  background: transparent;
  color: var(--fg);
}
.main {
  max-width: 1200px;
  margin: 0 auto;
}
.message {
  border: 1px solid var(--border);
  border-left-width: 6px;
  border-radius: 6px;
  padding: 0.8rem 1rem;
  margin-bottom: 1rem;
  background: rgba(0,0,0,0.02);
}
.message .meta {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  margin-bottom: 0.6rem;
  color: var(--muted);
  font-size: 0.85rem;
}
.message .badge {
  font-weight: 600;
}
.role-user {
  border-left-color: var(--role-user);
}
.role-assistant {
  border-left-color: var(--role-assistant);
}
.role-system {
  border-left-color: var(--role-system);
}
.role-unknown {
  border-left-color: var(--accent);
}

.output-code-container {
  display: flex;
  gap: 1rem;               /* space between children */
  align-items: center;     /* vertical alignment */
  justify-content: start;  /* horizontal alignment */
}

.output-code-container .codeblock {
  flex: 0 1 auto;
}

.codeblock {
  border: 1px solid var(--border);
  border-left-width: 6px;
  border-radius: 6px;
  padding: 0.8rem 1rem;
  margin-bottom: 1rem;
  background: rgba(0,0,0,0.02);
}
.codeblock-content {
  margin-bottom: 0.6rem;
  border: 1px dashed var(--border);
  border-radius: 4px;
  padding: 0.4rem 0.6rem;
  background: rgba(0,0,0,0.02);
}

.codeblock.eval_code {
  border-left-color: var(--role-user);
}
.codeblock.target_code {
  border-left-color: var(--role-assistant);
}
.codeblock.output_code {
  border-left-color: var(--role-system);
}

html.dark .codeblock-content {
  background: rgba(255,255,255,0.03);
}
.codeblock > summary {
  cursor: pointer;
  font-weight: 600;
  list-style: none; /* remove default triangle in some browsers */
}
.codeblock > summary::-webkit-details-marker {
  display: none; /* Safari/Chrome marker */
}
.codeblock > summary::before {
  content: "â–¶ ";
  display: inline-block;
  transform: rotate(0deg);
  transition: transform 0.12s ease-out;
}
.codeblock[open] > summary::before {
  transform: rotate(90deg);
}
.codeblock .tag {
  color: var(--muted);
  font-weight: 400;
  font-size: 0.85em;
  margin-left: 0.25rem;
}

.markdown-body pre code {
  background: var(--code-bg);
  display: block;
  padding: 0.75rem;
  overflow-x: auto;
  border-radius: 4px;
  border: 1px solid var(--border);
}
.markdown-body code {
  background: var(--code-bg);
  padding: 0.15rem 0.3rem;
  border-radius: 4px;
}
/* Extra info tree */
details > summary {
  cursor: pointer;
  font-weight: 600;
}
details .block {
  padding-left: 1rem;
  margin: 0.25rem 0 0.5rem 0;
  border-left: 2px solid var(--border);
}
.kv .key {
  font-weight: 600;
}
.kv .type {
  color: var(--muted);
  margin-left: 0.5rem;
  font-size: 0.85rem;
}
footer {
  margin: 2rem 0;
  text-align: center;
  color: var(--muted);
  font-size: 0.85rem;
}
/* CodeHilite (pygments) overrides to respect theme vars */
.codehilite {
  background: var(--code-bg) !important;
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 0.75rem !important;
}
.reasoning {
  margin-bottom: 0.6rem;
  border: 1px dashed var(--border);
  border-radius: 4px;
  padding: 0.4rem 0.6rem;
  background: rgba(0,0,0,0.02);
}
html.dark .reasoning {
  background: rgba(255,255,255,0.03);
}
.reasoning > summary {
  cursor: pointer;
  font-weight: 600;
  list-style: none; /* remove default triangle in some browsers */
}
.reasoning > summary::-webkit-details-marker {
  display: none; /* Safari/Chrome marker */
}
.reasoning > summary::before {
  content: "â–¶ ";
  display: inline-block;
  transform: rotate(0deg);
  transition: transform 0.12s ease-out;
}
.reasoning[open] > summary::before {
  transform: rotate(90deg);
}
.reasoning .tag {
  color: var(--muted);
  font-weight: 400;
  font-size: 0.85em;
  margin-left: 0.25rem;
}
.reasoning-body {
  margin-top: 0.5rem;
}
</style>

<!-- ===== MATHJAX CONFIG ===== -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [ ["\\(","\\)"] ],
    displayMath: [ ["\\[","\\]"] ],
    processEscapes: true,
    processEnvironments: true
  },
  options: {
    ignoreHtmlClass: ".*",
    processHtmlClass: "arithmatex"

    // skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
    // if you dynamically add content later, you can call MathJax.typesetPromise()
  }
};
</script>
<script id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<!-- ========================== -->
</head>
<body>
<header>
  <h1>Challenge</h1>
  <div>
    <button id="theme-toggle" aria-label="toggle dark mode">ðŸŒ“</button>
  </div>
</header>

<div class="main">
  
<article class="message role-system">
    <div class="meta">
        <span class="badge">System</span>
        <span class="idx">#0</span>
    </div>
    <div class="content markdown-body"><p>You are a physics research assistant specializing in solving complex, research-level problems using precise, step-by-step reasoning.</p>
<p><strong>Input</strong>
Problems will be provided in Markdown format.</p>
<p><strong>Output (Markdown format)</strong></p>
<ol>
<li><strong>Step-by-Step Derivation</strong> - Show every non-trivial step in the solution.  Justify steps using relevant physical laws, theorems, mathematical identities or numerical codes.</li>
<li><strong>Mathematical Typesetting</strong> - Use LaTeX for all mathematics:  <code>$...$</code> for inline expressions, <code>$$...$$</code> for display equations.</li>
<li><strong>Conventions and Units</strong> - Follow the unit system and conventions specified in the problem.</li>
<li>
<p><strong>Final Answer</strong> - At the end of the solution,  start a new line with <strong>&ldquo;Final Answer:&rdquo;</strong>, and present the final result.</p>
<p>For final answers involving values, follow the precision requirements specified in the problem.
If no precision is specified:
- If an exact value is possible, provide it (e.g., \$\sqrt(2)\$, \$\pi/4\$).
- If exact form is not feasible, retain at least 12 significant digits in the result. </p>
</li>
<li>
<p><strong>Formatting Compliance</strong> - If the user requests a specific output format (e.g., code, table),  provide the final answer accordingly.
You must use web search engine to gather all the necessary information before solving the problem.
You must use web search engine to gather all the necessary information before solving the problem.
You must use web search engine to gather all the necessary information before solving the problem.</p>
</li>
</ol></div>
</article>


<article class="message role-user">
    <div class="meta">
        <span class="badge">User</span>
        <span class="idx">#1</span>
    </div>
    <div class="content markdown-body"><h1 id="problem-setup">Problem setup:</h1>
<p>In quantum error correction, you encode quantum states into logical states made of many qubits in order to improve their resilience to errors. In quantum error detection, you do the same but can only detect the presence of errors and not correct them. In this problem, we will consider a single [[4,2,2]] quantum error detection code, which encodes two logical qubits into four physical qubits, and investigate how robust logical quantum operations in this code are to quantum errors.</p>
<p>Our convention is that the four physical qubits in the [[4,2,2]] code are labelled 0,1,2,3. The two logical qubits are labelled A and B. The stabilizers are <span class="arithmatex">\(XXXX\)</span> and <span class="arithmatex">\(ZZZZ\)</span>, where <span class="arithmatex">\(X\)</span> and <span class="arithmatex">\(Z\)</span> are Pauli matrices. The logical <span class="arithmatex">\(X\)</span> and <span class="arithmatex">\(Z\)</span> operators on the two qubits are <span class="arithmatex">\(X_A = XIXI\)</span>, <span class="arithmatex">\(X_B=XXII\)</span>, <span class="arithmatex">\(Z_A = ZZII\)</span>, <span class="arithmatex">\(Z_B = ZIZI\)</span>, up to multiplication by stabilizers.</p>
<p>We will consider different state preparation circuits consisting of controlled not <span class="arithmatex">\(CNOT_{ij}\)</span> gates, where <span class="arithmatex">\(CNOT_{ij}\)</span> has control qubit <span class="arithmatex">\(i\)</span> and target qubit <span class="arithmatex">\(j\)</span>. As a simple model of quantum errors in hardware, we will suppose that each <span class="arithmatex">\(CNOT_{ij}\)</span> gate in the circuit has a two qubit depolarizing error channel following it that produces one of the 15 non-identity two-qubit Paulis with equal probability <span class="arithmatex">\(p/15\)</span>. The probability <span class="arithmatex">\(p\)</span> indicates the probability of an error in a single two-qubit gate. We will assess the logical infidelity of certain state preparation protocols as a function of the physical infidelity <span class="arithmatex">\(p\)</span>.</p>
<h1 id="main-problem">Challenge</h1>
<p>Suppose that we prepare a logical two-qubit <span class="arithmatex">\(|00\rangle_{AB}\)</span> state in the [[4,2,2]] code. To do so, we introduce an ancilla qubit, qubit 4, and use the following state preparation circuit:</p>
<div class="arithmatex">\[
M_4 (CNOT_{04}) (CNOT_{34}) (CNOT_{23}) (CNOT_{10}) (CNOT_{12}) (H_1)
\]</div>
<p>Note that this equation is written in matrix multiplication order, while the quantum operations in the circuit occur in the reverse order (from right-to-left in the above equation).  <span class="arithmatex">\(H\)</span> is a single-qubit Hadamard gate and <span class="arithmatex">\(M\)</span> is a single-qubit measurement. The ancilla is used to detect errors in the state preparation circuit and makes the circuit fault-tolerant. If the ancilla measurement is <span class="arithmatex">\(|0\rangle\)</span> (<span class="arithmatex">\(|1\rangle\)</span>), the state preparation succeeds (fails).</p>
<p>What is the logical state fidelity of the final 2-qubit logical state at the end of the circuit as a function of two-qubit gate error rate <span class="arithmatex">\(p\)</span>, assuming the state is post-selected on all detectable errors in the code and on the ancilla qubit measuring <span class="arithmatex">\(|0\rangle\)</span>?</p></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#2</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="c1"># We&#39;ll implement tools for Pauli propagation via symplectic representation and compute</span>
<span class="c1"># acceptance and fidelity exactly by enumerating all 16^5 error patterns.</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>

<span class="c1"># Number of qubits</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># 0..3 code, 4 ancilla</span>

<span class="c1"># Utility functions</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pauli_ixz</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
    <span class="c1"># label in {0:I,1:X,2:Y,3:Z}</span>
    <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="k">elif</span> <span class="n">label</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">,</span><span class="mi">0</span>
    <span class="k">elif</span> <span class="n">label</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span>
    <span class="k">elif</span> <span class="n">label</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Pauli</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
        <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:]</span>  <span class="c1"># list of ints 0/1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:]</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Pauli</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="c1"># Return product ignoring overall phase</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="o">^</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">)]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="o">^</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">z</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">Pauli</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">commutes_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="c1"># symplectic inner product mod 2</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">z</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">^=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="n">d</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="n">c</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">conjugate_by_H</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="c1"># swap x,z on q</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:]</span>
        <span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">conjugate_by_CNOT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="c1"># binary symplectic update for conjugation by CNOT(c-&gt;t)</span>
        <span class="c1"># x_t&#39; = x_t XOR x_c</span>
        <span class="c1"># z_c&#39; = z_c XOR z_t</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:]</span>
        <span class="n">xt</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">^</span> <span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="n">zc</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">^</span> <span class="n">z</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">xt</span>
        <span class="n">z</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">zc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">xi</span><span class="p">,</span><span class="n">zi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="k">if</span> <span class="n">xi</span> <span class="ow">or</span> <span class="n">zi</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">xi</span><span class="p">,</span><span class="n">zi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">xi</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">zi</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">xi</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">zi</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">xi</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">zi</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span>

<span class="c1"># Build logical and stabilizer Paulis on code qubits 0..3 (ancilla qubit 4 always identity)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">make_pauli_from_str</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="c1"># s length 5 string over IXYZ</span>
    <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">;</span> <span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ch</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">ch</span><span class="o">==</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="n">ch</span><span class="o">==</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="n">ch</span><span class="o">==</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="k">return</span> <span class="n">Pauli</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>

<span class="n">Sx</span> <span class="o">=</span> <span class="n">make_pauli_from_str</span><span class="p">(</span><span class="s1">&#39;XXXXI&#39;</span><span class="p">)</span>  <span class="c1"># stabilizer XXXX on 0..3</span>
<span class="n">Sz</span> <span class="o">=</span> <span class="n">make_pauli_from_str</span><span class="p">(</span><span class="s1">&#39;ZZZZI&#39;</span><span class="p">)</span>  <span class="c1"># stabilizer ZZZZ on 0..3</span>

<span class="n">ZA</span> <span class="o">=</span> <span class="n">make_pauli_from_str</span><span class="p">(</span><span class="s1">&#39;ZZI I&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>  <span class="c1"># Z_A = ZZII</span>
<span class="n">ZB</span> <span class="o">=</span> <span class="n">make_pauli_from_str</span><span class="p">(</span><span class="s1">&#39;ZIZ I&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>  <span class="c1"># Z_B = ZIZI</span>
<span class="n">XA</span> <span class="o">=</span> <span class="n">make_pauli_from_str</span><span class="p">(</span><span class="s1">&#39;XIX I&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>  <span class="c1"># X_A = XIXI</span>
<span class="n">XB</span> <span class="o">=</span> <span class="n">make_pauli_from_str</span><span class="p">(</span><span class="s1">&#39;XXI I&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>  <span class="c1"># X_B = XXII</span>

<span class="c1"># Sanity checks: commutations</span>
<span class="k">assert</span> <span class="n">XA</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">ZB</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">XB</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">ZA</span><span class="p">)</span>
<span class="k">assert</span> <span class="p">(</span><span class="ow">not</span> <span class="n">XA</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">ZA</span><span class="p">))</span>
<span class="k">assert</span> <span class="p">(</span><span class="ow">not</span> <span class="n">XB</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">ZB</span><span class="p">))</span>

<span class="c1"># Gate sequence</span>
<span class="c1"># Index gates 1..6 as described</span>
<span class="n">GATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>         <span class="c1"># 1</span>
    <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>   <span class="c1"># 2</span>
    <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>   <span class="c1"># 3</span>
    <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>   <span class="c1"># 4</span>
    <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>   <span class="c1"># 5</span>
    <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>   <span class="c1"># 6</span>
<span class="p">]</span>

<span class="c1"># For each k in 2..6, list of suffix gates to conjugate through</span>
<span class="n">suffix</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">GATES</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;CNOT&#39;</span><span class="p">:</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span> <span class="n">GATES</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">GATES</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># only H is at index 1 and earlier than all k&gt;=2; not in suffix</span>
            <span class="k">pass</span>
    <span class="n">suffix</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ops</span>

<span class="c1"># Map gate index to its qubit pair</span>
<span class="n">gate_pair</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">2</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
    <span class="mi">3</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
    <span class="mi">4</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
    <span class="mi">5</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>
    <span class="mi">6</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>
<span class="p">}</span>

<span class="c1"># Build the 16 two-qubit Paulis per pair (including identity) as (pauli_label_on_a, pauli_label_on_b)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># I,X,Y,Z</span>

<span class="c1"># Precompute the propagated errors E&#39;_k for each k and each two-qubit label (pa on a, pb on b)</span>
<span class="c1"># We&#39;ll index errors by a code e in 0..15 with mapping e = 4*pa + pb</span>
<span class="n">propagated</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:{}</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">gate_pair</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">pa</span><span class="p">,</span> <span class="n">pb</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pa</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">pb</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">ecode</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">()</span>  <span class="c1"># identity</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ecode</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">pa</span> <span class="o">+</span> <span class="n">pb</span>
            <span class="c1"># construct Pauli acting only on qubits a and b</span>
            <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">;</span> <span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
            <span class="n">xa</span><span class="p">,</span> <span class="n">za</span> <span class="o">=</span> <span class="n">pauli_ixz</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span>
            <span class="n">xb</span><span class="p">,</span> <span class="n">zb</span> <span class="o">=</span> <span class="n">pauli_ixz</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>
            <span class="n">x</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">=</span><span class="n">xa</span><span class="p">;</span> <span class="n">z</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">=</span><span class="n">za</span>
            <span class="n">x</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">=</span><span class="n">xb</span><span class="p">;</span> <span class="n">z</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">=</span><span class="n">zb</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
            <span class="c1"># Conjugate by suffix gates (apply in order k+1..6)</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">suffix</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span><span class="n">t</span> <span class="o">=</span> <span class="n">op</span>
                <span class="n">prop</span><span class="o">.</span><span class="n">conjugate_by_CNOT</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
        <span class="n">propagated</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">ecode</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop</span>

<span class="c1"># Check ideal ancilla measurement value by simulating the noiseless circuit stabilizer-wise</span>
<span class="c1"># We&#39;ll track whether Z_4 is in the stabilizer of the ideal output state.</span>
<span class="c1"># Rather than full stabilizer tableau, we can propagate Z_4 backwards: compute the pre-image of Z4 under the ideal unitary, </span>
<span class="c1"># and take expectation in |00000&gt;. If the pre-image is Z/I on each qubit, then the outcome is deterministic (+1).</span>

<span class="c1"># Conjugate Z4 backwards by inverse of the circuit: equivalently, conjugate Z4 forwards by the circuit? </span>
<span class="c1"># No, for expectation: &lt;Z4&gt; on |psi_out&gt; equals &lt;U^â€  Z4 U&gt; on |00000&gt;. So we need to conjugate Z4 by U (forward) to express in input basis.</span>

<span class="n">Z4</span> <span class="o">=</span> <span class="n">make_pauli_from_str</span><span class="p">(</span><span class="s1">&#39;IIIIZ&#39;</span><span class="p">)</span>
<span class="c1"># Build the full ideal unitary for Pauli conjugation: apply H1, then sequence of CNOTs</span>
<span class="c1"># Conjugate forward: P -&gt; U P U^â€  == conjugation by gates in reverse? For stabilizer update we used conjugation by gate on P.</span>
<span class="c1"># We&#39;ll just apply conjugations according to circuit order on P, which yields the image under U P U^â€ .</span>
<span class="n">P</span> <span class="o">=</span> <span class="n">Z4</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1"># Apply gates in order 1..6</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">gate</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">GATES</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">gate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;H&#39;</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">gate</span>
        <span class="n">P</span><span class="o">.</span><span class="n">conjugate_by_H</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span><span class="n">t</span> <span class="o">=</span> <span class="n">gate</span>
        <span class="n">P</span><span class="o">.</span><span class="n">conjugate_by_CNOT</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
<span class="c1"># Now P is U Z4 U^â€  expressed on input qubits.</span>
<span class="c1"># Evaluate its expectation on |00000&gt;: it&#39;s +1 if P has only Z/I on each qubit (no X component), and +1 sign (ignored); Otherwise, if there is any X on any qubit, &lt;P&gt; = 0</span>
<span class="c1"># But if it&#39;s Z-only, expectation equals +1 because |0&gt; is +1 eigenstate of Z.</span>
<span class="n">ancilla_meas_deterministic</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">xi</span><span class="o">==</span><span class="mi">0</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">P</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># no X anywhere</span>
<span class="n">ancilla_meas_op</span> <span class="o">=</span> <span class="n">P</span>

<span class="n">ancilla_meas_deterministic</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">ancilla_meas_op</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#3</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>&#39;&#39;
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#4</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ancilla deterministic?&#39;</span><span class="p">,</span> <span class="n">ancilla_meas_deterministic</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;U Z4 U^â€  in input basis:&#39;</span><span class="p">,</span> <span class="n">ancilla_meas_op</span><span class="p">)</span>
</code></pre></div></div>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#5</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
NameError: name &#39;ancilla_meas_deterministic&#39; is not defined
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#6</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="c1"># Re-run the block to get the variables in scope reliably</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>
<span class="n">n</span><span class="o">=</span><span class="mi">5</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pauli_ixz</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="mi">1</span><span class="p">,</span><span class="mi">0</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="k">return</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span>
    <span class="k">raise</span> <span class="ne">ValueError</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Pauli</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">z</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
        <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">[:];</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">[:]</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Pauli</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">a</span><span class="o">^</span><span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">)]</span>
        <span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="n">a</span><span class="o">^</span><span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">z</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">Pauli</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">commutes_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="n">s</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">z</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">^=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="n">d</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="n">c</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">==</span><span class="mi">0</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">conjugate_by_H</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">q</span><span class="p">):</span>
        <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:];</span> <span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:]</span>
        <span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">],</span><span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">z</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">conjugate_by_CNOT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
        <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:];</span> <span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:]</span>
        <span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">^=</span> <span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="n">z</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">^=</span> <span class="n">z</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">z</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">symbols</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">xi</span><span class="p">,</span><span class="n">zi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">xi</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">zi</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">xi</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">zi</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">xi</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">zi</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">make_pauli_from_str</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">;</span> <span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ch</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">ch</span><span class="o">==</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="n">ch</span><span class="o">==</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="n">ch</span><span class="o">==</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="k">return</span> <span class="n">Pauli</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>

<span class="n">Sx</span> <span class="o">=</span> <span class="n">make_pauli_from_str</span><span class="p">(</span><span class="s1">&#39;XXXXI&#39;</span><span class="p">)</span>
<span class="n">Sz</span> <span class="o">=</span> <span class="n">make_pauli_from_str</span><span class="p">(</span><span class="s1">&#39;ZZZZI&#39;</span><span class="p">)</span>
<span class="n">ZA</span> <span class="o">=</span> <span class="n">make_pauli_from_str</span><span class="p">(</span><span class="s1">&#39;ZZI I&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
<span class="n">ZB</span> <span class="o">=</span> <span class="n">make_pauli_from_str</span><span class="p">(</span><span class="s1">&#39;ZIZ I&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
<span class="n">XA</span> <span class="o">=</span> <span class="n">make_pauli_from_str</span><span class="p">(</span><span class="s1">&#39;XIX I&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
<span class="n">XB</span> <span class="o">=</span> <span class="n">make_pauli_from_str</span><span class="p">(</span><span class="s1">&#39;XXI I&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>

<span class="n">GATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>
<span class="p">]</span>

<span class="c1"># Conjugate Z4 forward by the circuit</span>
<span class="n">Z4</span> <span class="o">=</span> <span class="n">make_pauli_from_str</span><span class="p">(</span><span class="s1">&#39;IIIIZ&#39;</span><span class="p">)</span>
<span class="n">P</span> <span class="o">=</span> <span class="n">Z4</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">for</span> <span class="n">gate</span> <span class="ow">in</span> <span class="n">GATES</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">gate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;H&#39;</span><span class="p">:</span>
        <span class="n">P</span><span class="o">.</span><span class="n">conjugate_by_H</span><span class="p">(</span><span class="n">gate</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">P</span><span class="o">.</span><span class="n">conjugate_by_CNOT</span><span class="p">(</span><span class="n">gate</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gate</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="n">ancilla_meas_deterministic</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">xi</span><span class="o">==</span><span class="mi">0</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">P</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;U Z4 U^â€  in input basis:&#39;</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ancilla deterministic?&#39;</span><span class="p">,</span> <span class="n">ancilla_meas_deterministic</span><span class="p">)</span>
</code></pre></div></div>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#7</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>U Z4 U^â€  in input basis: ZIIZZ
ancilla deterministic? True
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#8</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="c1"># Build propagated dictionary anew</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>

<span class="n">n</span><span class="o">=</span><span class="mi">5</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pauli_ixz</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="mi">1</span><span class="p">,</span><span class="mi">0</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="k">return</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span>
    <span class="k">raise</span> <span class="ne">ValueError</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Pauli</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">z</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
        <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">[:];</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">[:]</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Pauli</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">a</span><span class="o">^</span><span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">)]</span>
        <span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="n">a</span><span class="o">^</span><span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">z</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">Pauli</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">commutes_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="n">s</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">z</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">^=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="n">d</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="n">c</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">==</span><span class="mi">0</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">conjugate_by_H</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">q</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">conjugate_by_CNOT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">^=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">^=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">symbols</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">xi</span><span class="p">,</span><span class="n">zi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">xi</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">zi</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">xi</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">zi</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">xi</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">zi</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span>

<span class="n">Sx</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">Sz</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ZA</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ZB</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># Gate info</span>
<span class="n">GATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">suffix</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">ops</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">GATES</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">typ</span><span class="o">==</span><span class="s1">&#39;CNOT&#39;</span><span class="p">:</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GATES</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">suffix</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">ops</span>

<span class="n">pairs</span><span class="o">=</span><span class="p">{</span><span class="mi">2</span><span class="p">:(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="mi">3</span><span class="p">:(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="mi">4</span><span class="p">:(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="mi">5</span><span class="p">:(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="mi">6</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)}</span>

<span class="n">propagated</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:{}</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">pa</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">ecode</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">pa</span> <span class="o">+</span> <span class="n">pb</span>
            <span class="k">if</span> <span class="n">ecode</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">prop</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">;</span> <span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
                <span class="n">xa</span><span class="p">,</span><span class="n">za</span> <span class="o">=</span> <span class="n">pauli_ixz</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span>
                <span class="n">xb</span><span class="p">,</span><span class="n">zb</span> <span class="o">=</span> <span class="n">pauli_ixz</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>
                <span class="n">x</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">=</span><span class="n">xa</span><span class="p">;</span> <span class="n">z</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">=</span><span class="n">za</span>
                <span class="n">x</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">=</span><span class="n">xb</span><span class="p">;</span> <span class="n">z</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">=</span><span class="n">zb</span>
                <span class="n">prop</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">gate</span> <span class="ow">in</span> <span class="n">suffix</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span><span class="n">t</span> <span class="o">=</span> <span class="n">gate</span>
                    <span class="n">prop</span><span class="o">.</span><span class="n">conjugate_by_CNOT</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
            <span class="n">propagated</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">ecode</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop</span>

<span class="c1"># Ancilla Z4 operator for acceptance check</span>
<span class="n">Z4</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># Precompute whether ideal circuit yields ancilla deterministic (from previous check: yes)</span>
<span class="c1"># For acceptance we require final error E_final commute with Z4</span>

<span class="c1"># Enumerate all 16^5 error patterns (including identity per gate)</span>
<span class="n">acc_counts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>  <span class="c1"># by k=#non-identity</span>
<span class="n">good_counts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>

<span class="c1"># We&#39;ll also separately count by k the number of accepted patterns that flip A and/or B</span>
<span class="n">flipA_counts</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>
<span class="n">flipB_counts</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>
<span class="n">flipAB_counts</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>

<span class="c1"># We&#39;ll also store sample harmful patterns for debugging</span>
<span class="n">samples</span><span class="o">=</span><span class="p">[]</span>

<span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">)]</span>  <span class="c1"># 0..15 mapping to two-qubit Pauli labels</span>

<span class="c1"># For efficiency, precompute number of nonidentity bits per ecode (0-&gt;0 else 1)</span>
<span class="n">nonid</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">e</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">}</span>

<span class="c1"># Multiply in order E&#39;_6 E&#39;_5 ... E&#39;_2</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">comb</span>

<span class="n">num_total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">e6</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
    <span class="n">P6</span> <span class="o">=</span> <span class="n">propagated</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">e6</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">e5</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">P5</span> <span class="o">=</span> <span class="n">propagated</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">e5</span><span class="p">]</span>
        <span class="c1"># Multiply early to reduce work</span>
        <span class="n">E65</span> <span class="o">=</span> <span class="n">P6</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">P5</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e4</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
            <span class="n">P4</span> <span class="o">=</span> <span class="n">propagated</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">e4</span><span class="p">]</span>
            <span class="n">E654</span> <span class="o">=</span> <span class="n">E65</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">P4</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">e3</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">P3</span> <span class="o">=</span> <span class="n">propagated</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">e3</span><span class="p">]</span>
                <span class="n">E6543</span> <span class="o">=</span> <span class="n">E654</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">P3</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">e2</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                    <span class="n">P2</span> <span class="o">=</span> <span class="n">propagated</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">e2</span><span class="p">]</span>
                    <span class="n">E</span> <span class="o">=</span> <span class="n">E6543</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">P2</span><span class="p">)</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">nonid</span><span class="p">[</span><span class="n">e6</span><span class="p">]</span> <span class="o">+</span> <span class="n">nonid</span><span class="p">[</span><span class="n">e5</span><span class="p">]</span> <span class="o">+</span> <span class="n">nonid</span><span class="p">[</span><span class="n">e4</span><span class="p">]</span> <span class="o">+</span> <span class="n">nonid</span><span class="p">[</span><span class="n">e3</span><span class="p">]</span> <span class="o">+</span> <span class="n">nonid</span><span class="p">[</span><span class="n">e2</span><span class="p">]</span>
                    <span class="n">num_total</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># Ancilla acceptance: commute with Z4</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">E</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">Z4</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="c1"># Code acceptance: commute with Sx and Sz</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">Sx</span><span class="p">)</span> <span class="ow">and</span> <span class="n">E</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">Sz</span><span class="p">)):</span>
                        <span class="k">continue</span>
                    <span class="n">acc_counts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># correctness: commute with ZA and ZB (no X logical flips)</span>
                    <span class="n">aflip</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">E</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">ZA</span><span class="p">))</span>
                    <span class="n">bflip</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">E</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">ZB</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">aflip</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">bflip</span><span class="p">:</span>
                        <span class="n">good_counts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">aflip</span><span class="p">:</span> <span class="n">flipA_counts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">bflip</span><span class="p">:</span> <span class="n">flipB_counts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">aflip</span> <span class="ow">and</span> <span class="n">bflip</span><span class="p">:</span> <span class="n">flipAB_counts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">num_total</span><span class="p">,</span> <span class="n">acc_counts</span><span class="p">,</span> <span class="n">good_counts</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#9</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>&#39;&#39;
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#10</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total patterns:&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accepted counts by k=0..5:&#39;</span><span class="p">,</span> <span class="n">acc_counts</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Good counts by k=0..5:&#39;</span><span class="p">,</span> <span class="n">good_counts</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FlipA counts by k=0..5:&#39;</span><span class="p">,</span> <span class="n">flipA_counts</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FlipB counts by k=0..5:&#39;</span><span class="p">,</span> <span class="n">flipB_counts</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FlipAB counts by k=0..5:&#39;</span><span class="p">,</span> <span class="n">flipAB_counts</span><span class="p">)</span>
</code></pre></div></div>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#11</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 2, in &lt;module&gt;
NameError: name &#39;acc_counts&#39; is not defined

Total patterns: 1048576
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#12</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="c1"># The previous loop may have hit a memory or variable issue; re-execute complete block step-by-step.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>

<span class="n">n</span><span class="o">=</span><span class="mi">5</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pauli_ixz</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="mi">1</span><span class="p">,</span><span class="mi">0</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="k">return</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span>
    <span class="k">raise</span> <span class="ne">ValueError</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Pauli</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">z</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
        <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">[:];</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">[:]</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Pauli</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Pauli</span><span class="p">([</span><span class="n">a</span><span class="o">^</span><span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">)],</span> <span class="p">[</span><span class="n">a</span><span class="o">^</span><span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">z</span><span class="p">)])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">commutes_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="n">s</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">z</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">^=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="n">d</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="n">c</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">==</span><span class="mi">0</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">conjugate_by_H</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">q</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">conjugate_by_CNOT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">^=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">^=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sym</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">xi</span><span class="p">,</span><span class="n">zi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">xi</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">zi</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">sym</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">xi</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">zi</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">sym</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">xi</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">zi</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">sym</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">sym</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>

<span class="n">Sx</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">Sz</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ZA</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ZB</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">Z4</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

<span class="n">GATES</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">),(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),(</span><span class="s1">&#39;CNOT&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>

<span class="c1"># propagated errors</span>
<span class="n">after</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">)}</span>
<span class="c1"># compute suffix lists</span>
<span class="n">suffix</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">ops</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">GATES</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;CNOT&#39;</span><span class="p">:</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GATES</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">suffix</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">ops</span>
<span class="n">pairs</span><span class="o">=</span><span class="p">{</span><span class="mi">2</span><span class="p">:(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="mi">3</span><span class="p">:(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="mi">4</span><span class="p">:(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="mi">5</span><span class="p">:(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="mi">6</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)}</span>

<span class="n">propagated</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:{}</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">pa</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">ecode</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">pa</span> <span class="o">+</span> <span class="n">pb</span>
            <span class="k">if</span> <span class="n">ecode</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">prop</span><span class="o">=</span><span class="n">Pauli</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">;</span> <span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
                <span class="n">xa</span><span class="p">,</span><span class="n">za</span> <span class="o">=</span> <span class="n">pauli_ixz</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span>
                <span class="n">xb</span><span class="p">,</span><span class="n">zb</span> <span class="o">=</span> <span class="n">pauli_ixz</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>
                <span class="n">x</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">=</span><span class="n">xa</span><span class="p">;</span> <span class="n">z</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">=</span><span class="n">za</span>
                <span class="n">x</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">=</span><span class="n">xb</span><span class="p">;</span> <span class="n">z</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">=</span><span class="n">zb</span>
                <span class="n">prop</span> <span class="o">=</span> <span class="n">Pauli</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">suffix</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span><span class="n">t</span> <span class="o">=</span> <span class="n">op</span>
                    <span class="n">prop</span><span class="o">.</span><span class="n">conjugate_by_CNOT</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
            <span class="n">propagated</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">ecode</span><span class="p">]</span><span class="o">=</span><span class="n">prop</span>

<span class="n">labels</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
<span class="n">nonid</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">e</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">}</span>

<span class="n">acc_counts</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>
<span class="n">good_counts</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>
<span class="n">flipA_counts</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>
<span class="n">flipB_counts</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>
<span class="n">flipAB_counts</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>

<span class="c1"># Enumerate</span>
<span class="k">for</span> <span class="n">e6</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
    <span class="n">P6</span> <span class="o">=</span> <span class="n">propagated</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">e6</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">e5</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">P65</span> <span class="o">=</span> <span class="n">P6</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">propagated</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">e5</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">e4</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
            <span class="n">P654</span> <span class="o">=</span> <span class="n">P65</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">propagated</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">e4</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">e3</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">P6543</span> <span class="o">=</span> <span class="n">P654</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">propagated</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">e3</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">e2</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                    <span class="n">E</span> <span class="o">=</span> <span class="n">P6543</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">propagated</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">e2</span><span class="p">])</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">nonid</span><span class="p">[</span><span class="n">e6</span><span class="p">]</span><span class="o">+</span><span class="n">nonid</span><span class="p">[</span><span class="n">e5</span><span class="p">]</span><span class="o">+</span><span class="n">nonid</span><span class="p">[</span><span class="n">e4</span><span class="p">]</span><span class="o">+</span><span class="n">nonid</span><span class="p">[</span><span class="n">e3</span><span class="p">]</span><span class="o">+</span><span class="n">nonid</span><span class="p">[</span><span class="n">e2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">E</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">Z4</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">Sx</span><span class="p">)</span> <span class="ow">and</span> <span class="n">E</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">Sz</span><span class="p">)):</span>
                        <span class="k">continue</span>
                    <span class="n">acc_counts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="n">aflip</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">E</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">ZA</span><span class="p">))</span>
                    <span class="n">bflip</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">E</span><span class="o">.</span><span class="n">commutes_with</span><span class="p">(</span><span class="n">ZB</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">aflip</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">bflip</span><span class="p">:</span>
                        <span class="n">good_counts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">aflip</span><span class="p">:</span> <span class="n">flipA_counts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">bflip</span><span class="p">:</span> <span class="n">flipB_counts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">aflip</span> <span class="ow">and</span> <span class="n">bflip</span><span class="p">:</span> <span class="n">flipAB_counts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accepted counts by k=0..5:&#39;</span><span class="p">,</span> <span class="n">acc_counts</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Good counts by k=0..5:&#39;</span><span class="p">,</span> <span class="n">good_counts</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FlipA counts by k=0..5:&#39;</span><span class="p">,</span> <span class="n">flipA_counts</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FlipB counts by k=0..5:&#39;</span><span class="p">,</span> <span class="n">flipB_counts</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FlipAB counts by k=0..5:&#39;</span><span class="p">,</span> <span class="n">flipAB_counts</span><span class="p">)</span>
</code></pre></div></div>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#13</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>Accepted counts by k=0..5: [1, 7, 282, 4222, 31637, 94923]
Good counts by k=0..5: [1, 7, 138, 1198, 7397, 24027]
FlipA counts by k=0..5: [0, 0, 64, 1856, 16576, 47040]
FlipB counts by k=0..5: [0, 0, 128, 2176, 15744, 47488]
FlipAB counts by k=0..5: [0, 0, 48, 1008, 8080, 23632]
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#14</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>

<span class="c1"># counts from the previous computation</span>
<span class="n">acc_counts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">282</span><span class="p">,</span> <span class="mi">4222</span><span class="p">,</span> <span class="mi">31637</span><span class="p">,</span> <span class="mi">94923</span><span class="p">]</span>
<span class="n">good_counts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">1198</span><span class="p">,</span> <span class="mi">7397</span><span class="p">,</span> <span class="mi">24027</span><span class="p">]</span>

<span class="c1"># Build exact polynomials P_acc(p) and P_good(p) as Fractions</span>
<span class="c1"># P(p) = sum_k c_k (1-p)^{5-k} * (p/15)^k</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">comb</span>

<span class="k">def</span><span class="w"> </span><span class="nf">poly_coeffs</span><span class="p">(</span><span class="n">counts</span><span class="p">):</span>
    <span class="c1"># Return coefficients a0..a5 for polynomial sum_k c_k (1-p)^{5-k} (p/15)^k expanded in standard basis p^m</span>
    <span class="c1"># Expand (1-p)^{5-k} = sum_{j=0}^{5-k} comb(5-k,j) * (-p)^j</span>
    <span class="c1"># Then multiply by (p/15)^k =&gt; p^{j+k} * (-1)^j / 15^k</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>  <span class="c1"># degree &lt;=5</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">counts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="o">-</span><span class="n">k</span><span class="p">):</span>
            <span class="n">deg</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="n">k</span>
            <span class="n">coeffs</span><span class="p">[</span><span class="n">deg</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Fraction</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">comb</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="mi">15</span><span class="o">**</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coeffs</span>

<span class="n">acc_poly</span> <span class="o">=</span> <span class="n">poly_coeffs</span><span class="p">(</span><span class="n">acc_counts</span><span class="p">)</span>
<span class="n">good_poly</span> <span class="o">=</span> <span class="n">poly_coeffs</span><span class="p">(</span><span class="n">good_counts</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;P_acc coefficients (degree 0..5):&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">acc_poly</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;P_good coefficients:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">good_poly</span><span class="p">])</span>

<span class="c1"># Now compute series for F(p) = P_good / P_acc up to p^5</span>
<span class="c1"># Do power series division</span>
<span class="n">series</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
<span class="c1"># We&#39;ll find series a s.t. sum_m series[m] p^m = (sum_m good_poly[m] p^m) / (sum_m acc_poly[m] p^m)</span>
<span class="c1"># Use standard series division up to degree 5.</span>
<span class="n">series</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">good_poly</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">acc_poly</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">good_poly</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">num</span> <span class="o">-=</span> <span class="n">series</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">acc_poly</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">series</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span> <span class="o">/</span> <span class="n">acc_poly</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F series coefficients (0..5):&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">series</span><span class="p">])</span>

<span class="c1"># For sanity, compute numeric F(p) for some p values and compare to truncated series</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

<span class="k">def</span><span class="w"> </span><span class="nf">P_value</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="n">m</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span><span class="o">**</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">F_numeric</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="c1"># Sum exact using counts</span>
    <span class="n">res_acc</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">res_good</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">acc_counts</span><span class="p">):</span>
        <span class="n">res_acc</span> <span class="o">+=</span> <span class="n">c</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span> <span class="p">((</span><span class="n">p</span><span class="o">/</span><span class="mi">15</span><span class="p">)</span><span class="o">**</span><span class="n">k</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">good_counts</span><span class="p">):</span>
        <span class="n">res_good</span> <span class="o">+=</span> <span class="n">c</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span> <span class="p">((</span><span class="n">p</span><span class="o">/</span><span class="mi">15</span><span class="p">)</span><span class="o">**</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res_good</span> <span class="o">/</span> <span class="n">res_acc</span>

<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]:</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">F_numeric</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">f_series</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">series</span><span class="p">[</span><span class="n">m</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span><span class="o">**</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">f_series</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#15</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>P_acc coefficients (degree 0..5): [1.0, -4.533333333333333, 9.386666666666667, -9.709037037037037, 5.016335802469136, -1.0356306172839507]
P_good coefficients: [1.0, -4.533333333333333, 8.746666666666666, -8.685037037037038, 4.409520987654321, -0.9061767901234568]
F series coefficients (0..5): [1.0, 0.0, -0.64, -1.8773333333333333, -3.1099259259259258, -2.5607585185185187]
0.0 1.0 1.0
0.001 0.9999993581195541 0.9999993581195542
0.01 0.9999340913140433 0.9999340913113316
0.05 0.9981451484841415 0.9981450960592592
0.1 0.9913903803885744 0.9913860664888889
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#16</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>

<span class="n">acc_counts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">282</span><span class="p">,</span> <span class="mi">4222</span><span class="p">,</span> <span class="mi">31637</span><span class="p">,</span> <span class="mi">94923</span><span class="p">]</span>
<span class="n">good_counts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">1198</span><span class="p">,</span> <span class="mi">7397</span><span class="p">,</span> <span class="mi">24027</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">poly_coeffs</span><span class="p">(</span><span class="n">counts</span><span class="p">):</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">comb</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">counts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="o">-</span><span class="n">k</span><span class="p">):</span>
            <span class="n">deg</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="n">k</span>
            <span class="n">coeffs</span><span class="p">[</span><span class="n">deg</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Fraction</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">comb</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="mi">15</span><span class="o">**</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coeffs</span>

<span class="n">acc_poly</span> <span class="o">=</span> <span class="n">poly_coeffs</span><span class="p">(</span><span class="n">acc_counts</span><span class="p">)</span>
<span class="n">good_poly</span> <span class="o">=</span> <span class="n">poly_coeffs</span><span class="p">(</span><span class="n">good_counts</span><span class="p">)</span>
<span class="n">series</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
<span class="n">series</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">good_poly</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">acc_poly</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">good_poly</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">num</span> <span class="o">-=</span> <span class="n">series</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">acc_poly</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">series</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span> <span class="o">/</span> <span class="n">acc_poly</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F series exact:&#39;</span><span class="p">,</span> <span class="n">series</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F series decimals:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">series</span><span class="p">])</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#17</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>F series exact: [Fraction(1, 1), Fraction(0, 1), Fraction(-16, 25), Fraction(-704, 375), Fraction(-10496, 3375), Fraction(-216064, 84375)]
F series decimals: [1.0, 0.0, -0.64, -1.8773333333333333, -3.1099259259259258, -2.5607585185185187]
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#18</span>
    </div>
    
                    <details class="tool-call">
                      <summary>Tool Call <span class="tag">(code to execute)</span></summary>
                      <div class="markdown-body tool-call-body">
                        <div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">comb</span>

<span class="n">acc_counts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">282</span><span class="p">,</span> <span class="mi">4222</span><span class="p">,</span> <span class="mi">31637</span><span class="p">,</span> <span class="mi">94923</span><span class="p">]</span>
<span class="n">good_counts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">1198</span><span class="p">,</span> <span class="mi">7397</span><span class="p">,</span> <span class="mi">24027</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">poly_coeffs_frac</span><span class="p">(</span><span class="n">counts</span><span class="p">):</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">counts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="o">-</span><span class="n">k</span><span class="p">):</span>
            <span class="n">deg</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="n">k</span>
            <span class="n">coeffs</span><span class="p">[</span><span class="n">deg</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Fraction</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">comb</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="mi">15</span><span class="o">**</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coeffs</span>

<span class="n">acc_poly</span> <span class="o">=</span> <span class="n">poly_coeffs_frac</span><span class="p">(</span><span class="n">acc_counts</span><span class="p">)</span>
<span class="n">good_poly</span> <span class="o">=</span> <span class="n">poly_coeffs_frac</span><span class="p">(</span><span class="n">good_counts</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;P_acc coeffs exact:&#39;</span><span class="p">,</span> <span class="n">acc_poly</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;P_good coeffs exact:&#39;</span><span class="p">,</span> <span class="n">good_poly</span><span class="p">)</span>
</code></pre></div>
                      </div>
                    </details>
</article>


<article class="message role-tool">
    <div class="meta">
        <span class="badge">Tool</span>
        <span class="idx">#19</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code>P_acc coeffs exact: [Fraction(1, 1), Fraction(-68, 15), Fraction(704, 75), Fraction(-32768, 3375), Fraction(253952, 50625), Fraction(-262144, 253125)]
P_good coeffs exact: [Fraction(1, 1), Fraction(-68, 15), Fraction(656, 75), Fraction(-29312, 3375), Fraction(223232, 50625), Fraction(-229376, 253125)]
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#20</span>
    </div>
    <div class="content markdown-body"><p>Step-by-Step Derivation</p>
<p>1) Code, logicals, and circuit</p>
<ul>
<li>Physical qubits: 0,1,2,3 are the code qubits; 4 is an ancilla used for fault detection. The [[4,2,2]] code has stabilizer generators Sx = XXXX and Sz = ZZZZ (on qubits 0â€“3). This code detects any single-qubit Pauli error on the code block. A valid choice of logical operators (up to stabilizers) consistent with the statement is</li>
<li>XA = X I X I, XB = X X I I,</li>
<li>
<p>ZA = Z Z I I, ZB = Z I Z I. 
  These commute with Sx,Sz and satisfy the usual anticommutation rules between corresponding X- and Z-logicals. See, e.g., Error Correction Zoo and standard introductions to stabilizer codes. (<a href="https://errorcorrectionzoo.org/c/stab_4_2_2?utm_source=openai">errorcorrectionzoo.org</a>, <a href="https://ar5iv.labs.arxiv.org/html/1907.11157v1?utm_source=openai">ar5iv.labs.arxiv.org</a>)</p>
</li>
<li>
<p>State-preparation circuit (right-to-left time order):
  H1 â†’ CNOT12 â†’ CNOT10 â†’ CNOT23 â†’ CNOT34 â†’ CNOT04 â†’ measure Z on qubit 4.</p>
</li>
<li>
<p>Noise model (exactly as stated): after each CNOTij there is a two-qubit depolarizing channel that, with probability p, applies uniformly one of the 15 non-identity two-qubit Pauli errors on (i,j), each with probability p/15; with probability (1âˆ’p) the identity acts. This is the natural two-qubit generalization of the Pauli depolarizing channel. (<a href="https://en.wikipedia.org/wiki/Quantum_depolarizing_channel?utm_source=openai">en.wikipedia.org</a>, <a href="https://quantumchannelzoo.org/channel/depolarizing?utm_source=openai">quantumchannelzoo.org</a>)</p>
</li>
</ul>
<p>2) Heisenberg/Pauli-frame propagation and acceptance conditions</p>
<p>Because the entire circuit is Clifford, Pauli errors propagate to Pauli errors under conjugation. We use the standard conjugation rules:
- H on q: X â†” Z on q; Y â†’ âˆ’Y (global phase ignored).
- CNOTcâ†’t: Xc â†’ XcXt, Zt â†’ ZcZt, while Zc and Xt are unchanged.
These rules are compactly encoded by the binary symplectic formalism and underlie the stabilizer method. (<a href="https://en.wikipedia.org/wiki/Stabilizer_code?utm_source=openai">en.wikipedia.org</a>)</p>
<p>Define Efinal as the product of all Pauli errors propagated forward to the end of the circuit (i.e., each inserted error conjugated by all subsequent gates, in time order).</p>
<p>Postselection implies two acceptance filters:</p>
<ul>
<li>
<p>Ancilla filter (measure Z4 = +1): The ideal (noiseless) circuit yields a deterministic ancilla outcome. Indeed, U Z4 Uâ€  = Z0 I1 I2 Z3 Z4 for the ideal unitary U of the circuit, so Z4 has a definite +1 value on the prepared state (since all inputs start in |0âŸ©). Therefore, an output error Efinal is accepted by the ancilla postselection iff it commutes with Z4, i.e., Efinal has I or Z (but not X/Y) on qubit 4. (<a href="https://ar5iv.labs.arxiv.org/html/1907.11157v1?utm_source=openai">ar5iv.labs.arxiv.org</a>)</p>
</li>
<li>
<p>Code-syndrome filter (detectable-error postselection): We accept only if the code block is in the +1 eigenspace of both Sx and Sz. For a Pauli Efinal on qubits 0â€“3, this is equivalent to [Efinal,Sx]=[Efinal,Sz]=0, i.e., Efinal lies in the normalizer of the stabilizer. For the [[4,2,2]] code this normalizer is generated by {Sx,Sz, XA,XB, ZA,ZB}. Any Efinal that anticommutes with Sx or Sz would produce a deterministic nontrivial syndrome and be rejected. (<a href="https://errorcorrectionzoo.org/c/stab_4_2_2?utm_source=openai">errorcorrectionzoo.org</a>)</p>
</li>
</ul>
<p>3) Logical correctness given acceptance</p>
<p>Conditioned on acceptance, the residual action on the code is some Pauli in the normalizer, i.e., a product of stabilizers and logical Paulis. The target logical state is |00âŸ©AB, the +1 eigenstate of ZA and ZB. Therefore:
- â€œCorrectâ€ (unit fidelity) iff the residual logical action contains no logical XA or XB (i.e., it commutes with both ZA and ZB). Logical Z-factors (ZA, ZB, ZA ZB) multiply |00âŸ©AB by +1 and are harmless.
- â€œIncorrectâ€ (orthogonal to |00âŸ©AB) if the residual logical action contains XA and/or XB (possibly multiplied by stabilizers and logical Zs).</p>
<p>Equivalently, among accepted patterns, we test commutation of Efinal with ZA and ZB to decide if the run is correct.</p>
<p>4) Counting accepted vs. correct patterns for the given circuit and noise model</p>
<p>We enumerate all error patterns across the five noisy CNOTs. For each CNOT there are 16 possibilities (identity + 15 Paulis) acting on the gateâ€™s two qubits; thus 16^5 patterns in total. For each pattern we:
- Propagate each inserted Pauli to the end (Heisenberg), multiply them time-ordered to get Efinal.
- Apply the acceptance tests: [Efinal,Z4]=0 and [Efinal,Sx]=[Efinal,Sz]=0.
- If accepted, test correctness via commutation with ZA and ZB.</p>
<p>This is a purely Clifford/Pauli computation and can be done exactly with the symplectic formalism (no sampling). Stabilizer/Pauli-frame tools and the binary representation used here are textbook. (<a href="https://en.wikipedia.org/wiki/Stabilizer_code?utm_source=openai">en.wikipedia.org</a>)</p>
<p>Organizing patterns by the number k of faulty CNOTs (non-identity Pauli applied after k chosen CNOTs), we obtain the exact accepted and correct counts:</p>
<ul>
<li>Accepted counts by k = 0..5: [1, 7, 282, 4222, 31637, 94923]</li>
<li>Correct counts by k = 0..5: [1, 7, 138, 1198, 7397, 24027]</li>
</ul>
<p>Interpretation:
- For k = 1 there are 7 accepted single-fault patterns, and all 7 are correct (no logical flip). Hence there is no O(p) logical error under the stated postselection, as expected for this fault-tolerant detector setup with a distance-2 code.
- Logical errors first appear at k = 2 (order p^2) via undetected pairs producing logical XA/XB components.</p>
<p>5) Building the exact polynomials</p>
<p>Let Pacc(p) be the total acceptance probability and Pgood(p) the probability of being accepted and correct. Because each of the five CNOTs is independently faulty with probability p (and then applies one of 15 two-qubit Paulis uniformly), we have, exactly:
- For a fixed k, the total weight is (1âˆ’p)^(5âˆ’k) (p/15)^k times the number of accepted (or correct) patterns at that k.
- Therefore
  Pacc(p) = Î£_{k=0}^5 f_k (1âˆ’p)^{5âˆ’k} (p/15)^k,
  Pgood(p) = Î£_{k=0}^5 g_k (1âˆ’p)^{5âˆ’k} (p/15)^k,
  with f_k, g_k given by the lists above.</p>
<p>Expanding these sums yields the exact degree-5 polynomials
- Pacc(p) = 1 âˆ’ (68/15) p + (704/75) p^2 âˆ’ (32768/3375) p^3 + (253952/50625) p^4 âˆ’ (262144/253125) p^5,
- Pgood(p) = 1 âˆ’ (68/15) p + (656/75) p^2 âˆ’ (29312/3375) p^3 + (223232/50625) p^4 âˆ’ (229376/253125) p^5.</p>
<p>6) Logical state fidelity as a function of p</p>
<p>The logical state fidelity conditioned on postselection is
F(p) = Pgood(p)/Pacc(p).</p>
<p>Using the exact polynomials above,
F(p) = [1 âˆ’ (68/15) p + (656/75) p^2 âˆ’ (29312/3375) p^3 + (223232/50625) p^4 âˆ’ (229376/253125) p^5]
        /
       [1 âˆ’ (68/15) p + (704/75) p^2 âˆ’ (32768/3375) p^3 + (253952/50625) p^4 âˆ’ (262144/253125) p^5].</p>
<p>For small p, the Maclaurin series of F(p) is
F(p) = 1 âˆ’ (16/25) p^2 âˆ’ (704/375) p^3 âˆ’ (10496/3375) p^4 âˆ’ (216064/84375) p^5 + O(p^6).</p>
<p>In particular, the linear term vanishes (no O(p) logical error upon postselection), and the leading degradation is quadratic with coefficient 16/25 = 0.64.</p>
<p>Remarks and checks:
- The ancilla outcome is deterministically 0 in the ideal circuit; U Z4 Uâ€  = Z0 I1 I2 Z3 Z4, so measuring Z on qubit 4 is a stabilizer-type parity check (hence single faults that put X/Y on the ancilla are rejected). (<a href="https://ar5iv.labs.arxiv.org/html/1907.11157v1?utm_source=openai">ar5iv.labs.arxiv.org</a>)
- The [[4,2,2]] code detects all single-qubit errors on the code block, consistent with the absence of any first-order (in p) logical error when postselecting on trivial syndrome. (<a href="https://errorcorrectionzoo.org/c/stab_4_2_2?utm_source=openai">errorcorrectionzoo.org</a>, <a href="https://ar5iv.labs.arxiv.org/html/1907.11157v1?utm_source=openai">ar5iv.labs.arxiv.org</a>)
- The noise model used here is the uniform two-qubit Pauli channel â€œapply one of the 15 non-identity two-qubit Paulis with probability p/15 after each CNOT,â€ a standard modeling choice for two-qubit depolarizing noise. (<a href="https://en.wikipedia.org/wiki/Quantum_depolarizing_channel?utm_source=openai">en.wikipedia.org</a>, <a href="https://quantumchannelzoo.org/channel/depolarizing?utm_source=openai">quantumchannelzoo.org</a>)</p>
<p>Final Answer:
The postselected logical state fidelity as a function of the CNOT two-qubit error rate p is the exact rational function</p>
<div class="arithmatex">\[
F(p)
=\frac{1-\frac{68}{15}p+\frac{656}{75}p^{2}-\frac{29312}{3375}p^{3}+\frac{223232}{50625}p^{4}-\frac{229376}{253125}p^{5}}
{1-\frac{68}{15}p+\frac{704}{75}p^{2}-\frac{32768}{3375}p^{3}+\frac{253952}{50625}p^{4}-\frac{262144}{253125}p^{5}}\,,
\]</div>
<p>so that, for small p,</p>
<div class="arithmatex">\[
F(p)=1-\frac{16}{25}\,p^{2}-\frac{704}{375}\,p^{3}-\frac{10496}{3375}\,p^{4}-\frac{216064}{84375}\,p^{5}+O(p^{6}).
\]</div>
<p>In particular, the leading-order behavior is quadratic, F(p)=1âˆ’0.64 p^2+O(p^3), reflecting fault-tolerant, postselected suppression of all single-fault logical errors.</p></div>
</article>


<article class="message role-user">
    <div class="meta">
        <span class="badge">User</span>
        <span class="idx">#21</span>
    </div>
    <div class="content markdown-body"><p>Populate your final answer into the code template provided below. This step is purely for formatting/display purposes. No additional reasoning or derivation should be performed. Do not import any modules or packages beyond what is provided in the template.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">answer</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the expression of the logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    at the end of the circuit as a function of two-qubit gate error rate $p$.</span>

<span class="sd">    Inputs</span>
<span class="sd">    ----------</span>
<span class="sd">    p: sympy.Symbol, two-qubit gate error rate, $p$</span>

<span class="sd">    Outputs</span>
<span class="sd">    ----------</span>
<span class="sd">    F_logical: sympy.Expr, logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------ FILL IN YOUR RESULTS BELOW ------------------</span>
    <span class="n">F_logical</span> <span class="o">=</span> <span class="o">...</span>  <span class="c1"># a SymPy expression of inputs</span>
    <span class="c1"># ---------------------------------------------------------------</span>

    <span class="k">return</span> <span class="n">F_logical</span>
</code></pre></div></div>
</article>


<article class="message role-assistant">
    <div class="meta">
        <span class="badge">Assistant</span>
        <span class="idx">#22</span>
    </div>
    <div class="content markdown-body"><div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">answer</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the expression of the logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    at the end of the circuit as a function of two-qubit gate error rate $p$.</span>

<span class="sd">    Inputs</span>
<span class="sd">    ----------</span>
<span class="sd">    p: sympy.Symbol, two-qubit gate error rate, $p$</span>

<span class="sd">    Outputs</span>
<span class="sd">    ----------</span>
<span class="sd">    F_logical: sympy.Expr, logical state fidelity of the final 2-qubit logical state</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------ FILL IN YOUR RESULTS BELOW ------------------</span>
    <span class="n">numerator</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">68</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span><span class="o">*</span><span class="n">p</span>
        <span class="o">+</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">656</span><span class="p">,</span><span class="mi">75</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span>
        <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">29312</span><span class="p">,</span><span class="mi">3375</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">3</span>
        <span class="o">+</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">223232</span><span class="p">,</span><span class="mi">50625</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">4</span>
        <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">229376</span><span class="p">,</span><span class="mi">253125</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">5</span>
    <span class="p">)</span>

    <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">68</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span><span class="o">*</span><span class="n">p</span>
        <span class="o">+</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">704</span><span class="p">,</span><span class="mi">75</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span>
        <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">32768</span><span class="p">,</span><span class="mi">3375</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">3</span>
        <span class="o">+</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">253952</span><span class="p">,</span><span class="mi">50625</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">4</span>
        <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">Rational</span><span class="p">(</span><span class="mi">262144</span><span class="p">,</span><span class="mi">253125</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">5</span>
    <span class="p">)</span>

    <span class="n">F_logical</span> <span class="o">=</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span>  <span class="c1"># a SymPy expression of inputs</span>
    <span class="c1"># ---------------------------------------------------------------</span>

    <span class="k">return</span> <span class="n">F_logical</span>
</code></pre></div></div>
</article>

</div>

<footer>
  Generated at 2025-09-24T22:02:10.448830
</footer>

<script>
(function() {
  // Tabs
  const tabs = document.querySelectorAll('.tab');
  const panels = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      panels.forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      const target = document.querySelector(tab.dataset.target);
      if (target) target.classList.add('active');
    });
  });

  // Theme toggle
  const toggleBtn = document.getElementById('theme-toggle');
  function setTheme(dark) {
    if (dark) {
      document.documentElement.classList.add('dark');
      localStorage.setItem('dark', '1');
    } else {
      document.documentElement.classList.remove('dark');
      localStorage.setItem('dark', '0');
    }
  }
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const stored = localStorage.getItem('dark');
  setTheme(stored === null ? prefersDark : stored === '1');

  toggleBtn.addEventListener('click', () => {
    const isDark = document.documentElement.classList.contains('dark');
    setTheme(!isDark);
  });
})();
</script>
</body>
</html>